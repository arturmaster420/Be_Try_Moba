(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&t(l)}).observe(document,{childList:!0,subtree:!0});function o(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(r){if(r.ep)return;r.ep=!0;const s=o(r);fetch(r.href,s)}})();const se=new Set;function vn(){vn._initialized||(vn._initialized=!0,window.addEventListener("keydown",e=>{["KeyW","KeyA","KeyS","KeyD","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)&&(se.add(e.code),e.preventDefault())}),window.addEventListener("keyup",e=>{se.delete(e.code)}))}function rt(){let e=0,n=0;return(se.has("KeyA")||se.has("ArrowLeft"))&&(e-=1),(se.has("KeyD")||se.has("ArrowRight"))&&(e+=1),(se.has("KeyW")||se.has("ArrowUp"))&&(n-=1),(se.has("KeyS")||se.has("ArrowDown"))&&(n+=1),{x:e,y:n}}const C={mouseX:0,mouseY:0,mouseDown:!1,moveTouchId:null,moveBaseX:0,moveBaseY:0,moveVecX:0,moveVecY:0,aimTouchId:null,aimBaseX:0,aimBaseY:0,aimVecX:0,aimVecY:0,controlMode:"oneHand"},at="btm_control_mode";if(typeof window<"u")try{const e=window.localStorage&&window.localStorage.getItem(at);(e==="oneHand"||e==="twoHand")&&(C.controlMode=e)}catch{}function Dt(e,n){C.mouseX=e,C.mouseY=n}function Ft(e,n,o){e===0&&(C.mouseDown=!0,C.mouseX=n,C.mouseY=o)}function Ot(e){e===0&&(C.mouseDown=!1)}function Vt(e,n,o,t){const r=C.controlMode==="oneHand",s=n<t/2;if(r){C.moveTouchId===null&&(C.moveTouchId=e,C.moveBaseX=n,C.moveBaseY=o,C.moveVecX=0,C.moveVecY=0);return}if(s){if(C.moveTouchId===null){C.moveTouchId=e,C.moveBaseX=n,C.moveBaseY=o,C.moveVecX=0,C.moveVecY=0;return}if(C.aimTouchId===null){C.aimTouchId=e,C.aimBaseX=n,C.aimBaseY=o,C.aimVecX=0,C.aimVecY=0;return}}else{if(C.aimTouchId===null){C.aimTouchId=e,C.aimBaseX=n,C.aimBaseY=o,C.aimVecX=0,C.aimVecY=0;return}if(C.moveTouchId===null){C.moveTouchId=e,C.moveBaseX=n,C.moveBaseY=o,C.moveVecX=0,C.moveVecY=0;return}}}function $t(e,n,o){const t=C.controlMode==="oneHand",r=80;if(t){if(e===C.moveTouchId){let s=n-C.moveBaseX,l=o-C.moveBaseY;const f=Math.hypot(s,l);if(f>4){const i=Math.min(1,f/r);s=s/f*i,l=l/f*i,C.moveVecX=s,C.moveVecY=l}else C.moveVecX=0,C.moveVecY=0}return}if(e===C.moveTouchId){let s=n-C.moveBaseX,l=o-C.moveBaseY;const f=Math.hypot(s,l);if(f>4){const i=Math.min(1,f/r);s=s/f*i,l=l/f*i,C.moveVecX=s,C.moveVecY=l}else C.moveVecX=0,C.moveVecY=0}else if(e===C.aimTouchId){let s=n-C.aimBaseX,l=o-C.aimBaseY;const f=Math.hypot(s,l);if(f>4){const i=Math.min(1,f/r);s=s/f*i,l=l/f*i,C.aimVecX=s,C.aimVecY=l}else C.aimVecX=0,C.aimVecY=0}}function lt(e){const n=C.controlMode==="oneHand";e===C.moveTouchId&&(C.moveTouchId=null,C.moveVecX=0,C.moveVecY=0,n)||e===C.aimTouchId&&(C.aimTouchId=null,C.aimVecX=0,C.aimVecY=0)}function ct(){return{x:C.moveVecX,y:C.moveVecY}}function ut(){return C.controlMode==="oneHand"?!0:C.mouseDown||C.aimTouchId!==null}function ft(e,n,o,t,r,s=0){if(C.controlMode==="oneHand"){const d=Array.isArray(t)&&t.length>0,y=r&&r>0?r:0;if(!d||y<=0)return null;const b=y*y,x=3,h=v=>{if(!v||v.hp<=0)return!1;const k=v.x-e.x,R=v.y-e.y;return!(k*k+R*R>b||t.indexOf(v)===-1)};if(e.lastPlayerTarget&&typeof e.lastPlayerTargetAt=="number"&&s-e.lastPlayerTargetAt<=x&&h(e.lastPlayerTarget)){const v=e.lastPlayerTarget.x-e.x,k=e.lastPlayerTarget.y-e.y,R=Math.hypot(v,k)||1;return{x:v/R,y:k/R}}if(e.lastAttacker&&typeof e.lastAttackerAt=="number"&&s-e.lastAttackerAt<=x&&h(e.lastAttacker)){const v=e.lastAttacker.x-e.x,k=e.lastAttacker.y-e.y,R=Math.hypot(v,k)||1;return{x:v/R,y:k/R}}let g=null;for(const v of t){if(!v||v.hp<=0)continue;const k=v.x-e.x,R=v.y-e.y,P=k*k+R*R;if(P>b)continue;const A=v.maxHp>0?v.maxHp:1,T=v.hp/A;(!g||T<g.hpPct-1e-6||Math.abs(T-g.hpPct)<=1e-6&&P<g.d2)&&(g={e:v,hpPct:T,d2:P,dx:k,dy:R})}if(g){const v=Math.sqrt(g.d2)||1;return{x:g.dx/v,y:g.dy/v}}return null}if(C.aimTouchId!==null){const d=C.aimVecX,y=C.aimVecY,b=Math.hypot(d,y);if(b>.1)return{x:d/b,y:y/b}}const f=o.width,i=o.height,a=(C.mouseX-f/2)/(n.zoom||1)+n.x,p=(C.mouseY-i/2)/(n.zoom||1)+n.y;let u=a-e.x,c=p-e.y;const m=Math.hypot(u,c);return m<.001?null:(u/=m,c/=m,{x:u,y:c})}function En(e){if(e==="oneHand"||e==="portraitAuto")C.controlMode="oneHand";else if(e==="twoHand"||e==="classic")C.controlMode="twoHand";else return;if(typeof window<"u")try{window.localStorage&&window.localStorage.setItem(at,C.controlMode)}catch{}}function Dn(){return C.controlMode||(C.controlMode="oneHand"),C.controlMode}const Te=300,Hn=70;function Ve(e,n,o=0){const t=Te+o,r=Math.min(Hn+o,t),s=Math.max(t-r,0),l=Math.abs(e),f=Math.abs(n);if(l>t||f>t)return!1;if(l<=s||f<=s)return!0;const i=l-s,a=f-s;return i*i+a*a<=r*r}const z={0:Te,1:5e3,2:1e4,3:15e3,4:2e4,5:25e3,6:3e4},Z=z[6],pn=[{x:Z,y:Z},{x:-Z,y:Z},{x:Z,y:-Z},{x:-Z,y:-Z}];function Ie(e,n){if(typeof n>"u"){const i=e;return i<z[1]?1:i<z[2]?2:i<z[3]?3:i<z[4]?4:i<z[5]?5:6}if(Ve(e,n))return 0;const o=Math.hypot(e,n),t=z[1],r=z[2],s=z[3],l=z[4],f=z[5];return o<t?1:o<r?2:o<s?3:o<l?4:o<f?5:6}function ce(e){const n=Math.max(0,(e|0)-1);return{hp:1+n*.65+n*n*.05,damage:1+n*.35+n*n*.03,speed:1+n*.08+n*n*.01,xp:1+n*.55}}const Ce=Z,Fn=Ce*2,On=Ce*2;function Gt(){return{minX:-Ce,maxX:Ce,minY:-Ce,maxY:Ce}}const ae=["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ¤£","ðŸ˜‚","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Š","ðŸ˜‡","ðŸ¥°","ðŸ˜","ðŸ¤©","ðŸ˜˜","ðŸ˜—","ðŸ˜š","ðŸ˜™","ðŸ˜‹","ðŸ˜›","ðŸ˜œ","ðŸ¤ª","ðŸ˜","ðŸ¤‘","ðŸ¤—","ðŸ¤­","ðŸ¤«","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜‘","ðŸ˜¶","ðŸ«¥","ðŸ˜","ðŸ˜’","ðŸ™„","ðŸ˜¬","ðŸ˜®â€ðŸ’¨","ðŸ˜Œ","ðŸ˜”","ðŸ˜ª","ðŸ¤¤","ðŸ˜´","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤¢","ðŸ¤®","ðŸ¥µ","ðŸ¥¶","ðŸ˜µ","ðŸ˜µâ€ðŸ’«","ðŸ¤¯","ðŸ˜Ž","ðŸ¥³","ðŸ˜ˆ","ðŸ‘¿","ðŸ’€","ðŸ‘¶","ðŸ§’","ðŸ‘¦","ðŸ‘§","ðŸ§‘","ðŸ‘¨","ðŸ‘©","ðŸ§”","ðŸ‘¨â€ðŸ¦±","ðŸ‘©â€ðŸ¦°","ðŸ§™","ðŸ§š","ðŸ§›","ðŸ§Ÿ","ðŸ§ž","ðŸ§œ","ðŸ§","ðŸ¥·","ðŸ¦¸","ðŸ¦¹","ðŸ¶","ðŸ±","ðŸ­","ðŸ¹","ðŸ°","ðŸ¦Š","ðŸ»","ðŸ¼","ðŸ¨","ðŸ¯","ðŸ¦","ðŸ®","ðŸ·","ðŸ¸","ðŸµ","ðŸ™ˆ","ðŸ™‰","ðŸ™Š","ðŸ”","ðŸ§","ðŸ¦","ðŸ¦‰","ðŸ¦‡","ðŸº","ðŸ—","ðŸ´","ðŸ¦„","ðŸ","ðŸª²","ðŸ¦‹","ðŸŒµ","ðŸŒ²","ðŸŒ³","ðŸŒ´","ðŸŒ±","ðŸ€","ðŸŒ¿","ðŸŒº","ðŸŒ¸","ðŸŒ¼","ðŸŒ™","â­","ðŸŒŸ","âœ¨","âš¡","ðŸ”¥","ðŸ’§","â„ï¸","ðŸŒˆ","â˜€ï¸","ðŸŽ¯","ðŸŽ®","ðŸ•¹ï¸","ðŸŽ²","â™Ÿï¸","ðŸ§©","ðŸŽ§","ðŸŽµ","ðŸŽ¸","ðŸ¥","ðŸ“Œ","ðŸ“Ž","ðŸ’Ž","ðŸ”®","ðŸ§ª","ðŸ§¬","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸ¤–","ðŸ‘¾","ðŸ§ ","ðŸ›¡ï¸","âš”ï¸","ðŸ¹","ðŸ”«","ðŸ’£","ðŸ§¨","ðŸ”§","âš™ï¸","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ¤","ðŸ–¤","ðŸ’”","ðŸ’¥","âœ…","âŒ","âš ï¸","ðŸ’«","ðŸ’¤","ðŸŒ€","ðŸ‘‘","ðŸ†","ðŸ¥‡","ðŸ”±"];function an(e){const n=Math.max(0,e|0);return Math.max(2,Math.min(ae.length,2*(n+1)))}function Xt(e,n){const o=n|0;return o<0?!1:o<an(e)}function Wt(e,n){const o=Math.max(0,n|0),t=an(e);return Math.min(o,Math.max(0,t-1))}class ln{constructor(n,o){this.x=n.x,this.y=n.y,this.vx=0,this.vy=0,this.radius=18,this.color="#8fe3ff",this.nickname="",this.avatarIndex=0,this.level=o||0,this._runStartLevel=this.level,this.xp=0,this.baseMaxHP=100,this.baseMoveSpeed=220,this.baseDamage=4,this.baseAttackSpeed=2,this.baseRange=1,this.maxHP=this.baseMaxHP,this.hp=this.maxHP,this.moveSpeed=this.baseMoveSpeed,this.damage=this.baseDamage,this.attackSpeed=this.baseAttackSpeed,this.range=this.baseRange,this.maxAttackSpeed=4,this.maxDamage=20,this.maxMoveSpeed=380,this.rangeLimit=1,this.laserHeat=0,this.laserMaxHeat=100,this.laserHeatRate=1,this.laserOverheated=!1,this.attackCooldown=0,this.rocketCooldown=0,this.lightningCooldown=0,this._pendingLevelUps=0,this.runSkills={bullets:1,bombs:0,rockets:0,satellites:0,energyBarrier:0,spirit:0,electricZone:0,laser:0,lightning:0},this.runEvolutions={},this.runPassives={damage:0,attackSpeed:0,moveSpeed:0,hp:0,hpRegen:0,range:0,pickupRadius:0,xpGain:0,critChance:0,critDamage:0,lifeSteal:0},this._runBaseMaxHP=void 0,this.runDamageMult=1,this.runAttackMult=1,this.runMoveMult=1,this.runRangeMult=1,this.runPickupBonusRadius=0,this.runXpGainMult=1,this.runCritChanceAdd=0,this.runCritDamageMult=1,this.runLifeSteal=0,this.runHpRegen=0,this.weaponStage=1,this.lastAimDir={x:0,y:1},this.lastPlayerTarget=null,this.lastPlayerTargetAt=-1/0,this.lastAttacker=null,this.lastAttackerAt=-1/0,this._lastCombatAt=-1/0}reset(n,o){this.x=n.x,this.y=n.y,this.vx=0,this.vy=0,this.level=o||0,this._runStartLevel=this.level,this.xp=0,this.maxHP=this.baseMaxHP,this.hp=this.maxHP,this.moveSpeed=this.baseMoveSpeed,this.damage=this.baseDamage,this.attackSpeed=this.baseAttackSpeed,this.range=this.baseRange,this.attackCooldown=0,this.rocketCooldown=0,this.lightningCooldown=0,this.weaponStage=1,this.laserHeat=0,this.laserOverheated=!1,this._pendingLevelUps=0,this.runSkills={bullets:1,bombs:0,rockets:0,satellites:0,energyBarrier:0,spirit:0,electricZone:0,laser:0,lightning:0},this.runEvolutions={},this.runPassives={damage:0,attackSpeed:0,moveSpeed:0,hp:0,hpRegen:0,range:0,pickupRadius:0,xpGain:0,critChance:0,critDamage:0,lifeSteal:0},this._runBaseMaxHP=void 0,this.runDamageMult=1,this.runAttackMult=1,this.runMoveMult=1,this.runRangeMult=1,this.runPickupBonusRadius=0,this.runXpGainMult=1,this.runCritChanceAdd=0,this.runCritDamageMult=1,this.runLifeSteal=0,this.runHpRegen=0,this.lastPlayerTarget=null,this.lastPlayerTargetAt=-1/0,this.lastAttacker=null,this.lastAttackerAt=-1/0,this._lastCombatAt=-1/0}xpToNext(){const n=Math.max(0,(this.level|0)-(this._runStartLevel|0||0));return Math.max(1,Math.floor(180+n*60+n*n*8))}gainXP(n,o){this.xp+=n;let t=!1;for(;this.xp>=this.xpToNext();)this.xp-=this.xpToNext(),this.level+=1,t=!0,this._pendingLevelUps=(this._pendingLevelUps||0)+1,this.hp=this.maxHP;if(t&&o){if(o.net&&o.net.isHost){const r=o.player?String(o.player.id):"",s=String(this.id||"");if(r&&s&&r!==s)return}o.floatingTexts&&o.floatingTexts.push({x:this.x,y:this.y-30,text:"LEVEL UP!",time:1.2}),o.popups&&o.popups.push({text:"Level Up! Lv "+this.level,time:2})}}update(n,o){const t=ct();let r=t.x,s=t.y;if(Math.hypot(r,s)<.1){const c=rt();r=c.x,s=c.y}const l=Math.hypot(r,s);l>.001?(r/=l,s/=l):(r=0,s=0),this.vx=r*this.moveSpeed,this.vy=s*this.moveSpeed,this.x+=this.vx*n,this.y+=this.vy*n;const f=Gt(),i=f.minX+this.radius,a=f.maxX-this.radius,p=f.minY+this.radius,u=f.maxY-this.radius;this.x<i&&(this.x=i),this.x>a&&(this.x=a),this.y<p&&(this.y=p),this.y>u&&(this.y=u),this.y<p&&(this.y=p),this.y>u&&(this.y=u),this.attackCooldown>0&&(this.attackCooldown-=n)}render(n){n.save();const o=this.color||"#8fe3ff",t=this.radius||18,r=this.avatarIndex|0,s=ae[r]||ae[0]||"ðŸ˜€",l=Math.max(12,Math.round(t*1.95));n.font=`${l}px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",sans-serif`,n.textAlign="center",n.textBaseline="middle";const f=s?n.measureText(s).width:l,a=Math.max(f,l)*.5;s&&(n.fillStyle="rgba(255,255,255,1)",n.fillText(s,this.x,this.y)),n.save(),n.globalCompositeOperation="destination-over",n.beginPath(),n.arc(this.x,this.y,a,0,Math.PI*2),n.strokeStyle=o,n.lineWidth=2,n.globalAlpha=.55,n.stroke(),n.restore();const p=Math.hypot(this.lastAimDir.x,this.lastAimDir.y)||1,u=this.lastAimDir.x/p,c=this.lastAimDir.y/p,m=this.x+u*(a+1),d=this.y+c*(a+1),y=this.x+u*(a+14),b=this.y+c*(a+14);n.beginPath(),n.strokeStyle="rgba(255,255,255,0.85)",n.lineWidth=2,n.moveTo(m,d),n.lineTo(y,b),n.stroke(),n.restore()}}class jt{constructor(n){this.canvas=n,this.x=0,this.y=0,this.zoom=1,this.positionLerp=8,this.zoomLerp=4,this._lastW=0,this._lastH=0,this._aspect=1,this._isMobile=!1,this._isLandscape=!0,this._zoomLockRange=null}_updateCanvasInfo(){const n=this.canvas.width||1,o=this.canvas.height||1;if(n===this._lastW&&o===this._lastH)return;this._lastW=n,this._lastH=o,this._aspect=n/o;const t=n>o?n:o;this._isMobile=t<1e3,this._isLandscape=this._aspect>=1}update(n,o){this._updateCanvasInfo();const t=this._lastW,r=this._lastH,s=n.x,l=n.y,f=o*this.positionLerp,i=f>1?1:f;this.x+=(s-this.x)*i,this.y+=(l-this.y)*i;const a=Number.isFinite(n.range)?n.range:220,p=a>1?a:220,u=this._isMobile?760:660,m=p/240,d=Math.log(m)/Math.log(2),y=Math.max(-.08,Math.min(.2,d*.12)),b=u*(1+y);let h=(t<r?t:r)/Math.max(1,b);const g=this._isMobile?.65:.55,v=this._isMobile?1.85:2.1;h<g&&(h=g),h>v&&(h=v);const k=o*this.zoomLerp,R=k>1?1:k;this.zoom+=(h-this.zoom)*R}applyTransform(n){const o=this.canvas.width,t=this.canvas.height;n.save(),n.translate(o/2,t/2),n.scale(this.zoom,this.zoom),n.translate(-this.x,-this.y)}resetTransform(n){n.restore()}}function Zt(e,n,o,t){const{projectiles:r}=n,s=Math.atan2(o.dy??o.y,o.dx??o.x),l=t.count,f=t.spread*Math.PI/180;for(let i=0;i<l;i++){const p=((l===1?.5:i/(l-1))-.5)*f,u=s+p,c=900,m=n._nextProjectileId=(n._nextProjectileId||0)+1;r.push({id:m,x:e.x,y:e.y,ownerId:e.id||"local",vx:Math.cos(u)*c,vy:Math.sin(u)*c,speed:c,damage:t.damage,range:t.range,travel:0,radius:4,type:"bullet"})}}function Yt(e,n,o,t){const{rockets:r}=n,s=Math.atan2(o.dy??o.y,o.dx??o.x),l=t.count,f=12*Math.PI/180;for(let i=0;i<l;i++){const p=((l===1?.5:i/(l-1))-.5)*f,u=s+p,c=550,m=n._nextRocketId=(n._nextRocketId||0)+1;r.push({id:m,x:e.x,y:e.y,ownerId:e.id||"local",vx:Math.cos(u)*c,vy:Math.sin(u)*c,speed:c,damage:t.damage,range:t.range,travel:0,radius:6,splashRadius:t.splashRadius,type:"rocket"})}}function zt(e,n,o,t){const{rockets:r}=n,s=Math.atan2(o.dy??o.y,o.dx??o.x),l=t.count||1,f=18*Math.PI/180;for(let i=0;i<l;i++){const p=((l===1?.5:i/(l-1))-.5)*f,u=s+p,c=t.speed||320,m=n._nextRocketId=(n._nextRocketId||0)+1;r.push({id:m,x:e.x,y:e.y,ownerId:e.id||"local",vx:Math.cos(u)*c,vy:Math.sin(u)*c,speed:c,damage:t.damage,range:t.range,travel:0,radius:t.radius||7,splashRadius:t.splashRadius,type:"bomb"})}}const dt="btm_progress",$e=15,xn={attackSpeed:{baseMax:10,perRes:5,unlockRTier:1},damage:{baseMax:15,perRes:10,unlockRTier:1},moveSpeed:{baseMax:10,perRes:5,unlockRTier:1},hp:{baseMax:20,perRes:20,unlockRTier:2},hpRegen:{baseMax:10,perRes:5,unlockRTier:2},range:{baseMax:10,perRes:5,unlockRTier:3},pickupRadius:{baseMax:10,perRes:5,unlockRTier:3},score:{baseMax:10,perRes:5,unlockRTier:4},xpGain:{baseMax:10,perRes:5,unlockRTier:4}},kn={critChance:{unlockRTier:5,basePercent:5,perResPercent:5,stepPercent:.1},critDamage:{unlockRTier:5,basePercent:20,perResPercent:20,stepPercent:1},lifeSteal:{unlockRTier:6,basePercent:2,perResPercent:2,stepPercent:.1}};function ze(){return{nickname:"Player",avatarIndex:0,roomCode:"",totalScore:0,upgradePoints:0,coins:0,skillMeta:{},shopOffers:{active:[],passive:[]},shopRerollCount:0,metaVersion:6,resurrectedTier:$e,resGuardianKills:0,limits:{attackSpeed:0,damage:0,moveSpeed:0,hp:0,range:0,laserOverheat:0,hpRegen:0,xpGain:0,score:0,pickupRadius:0,critChance:0,critDamage:0,lifeSteal:0}}}function pt(e){if(!e)return 0;let n=0;for(const o in e){const t=e[o];typeof t=="number"&&!Number.isNaN(t)&&(n+=t)}return n}function He(e,n){const o=Math.max(1,Math.min($e,e||1)),t=xn[n];if(t)return o<t.unlockRTier?0:t.baseMax+t.perRes*(o-t.unlockRTier);const r=kn[n];if(r){if(o<r.unlockRTier)return 0;const s=o-r.unlockRTier;return(r.basePercent+r.perResPercent*s)/r.stepPercent}return 1/0}function ht(e){const n=Math.max(1,Math.min($e,e||1));let o=0;for(const t in xn){const r=xn[t];n<r.unlockRTier||(o+=r.baseMax+r.perRes*(n-r.unlockRTier))}for(const t in kn){const r=kn[t];if(n<r.unlockRTier)continue;const s=n-r.unlockRTier,f=(r.basePercent+r.perResPercent*s)/r.stepPercent;o+=f}return o}function qt(e){if(!e)return!1;const n=e.limits||{},o=e.resurrectedTier||1,t=ht(o);return!t||!Number.isFinite(t)?!1:pt(n)/t>=.7}function Kt(){try{const e=localStorage.getItem(dt);if(!e)return ze();const n=JSON.parse(e)||{},o=ze(),t={nickname:typeof n.nickname=="string"&&n.nickname.trim().length?n.nickname.trim().slice(0,16):o.nickname,avatarIndex:typeof n.avatarIndex=="number"?Math.max(0,n.avatarIndex|0):o.avatarIndex,roomCode:typeof n.roomCode=="string"?n.roomCode.trim().toUpperCase().slice(0,8):o.roomCode,totalScore:typeof n.totalScore=="number"?n.totalScore:o.totalScore,upgradePoints:typeof n.upgradePoints=="number"?n.upgradePoints:o.upgradePoints,coins:typeof n.coins=="number"&&Number.isFinite(n.coins)?Math.max(0,Math.floor(n.coins)):o.coins||0,skillMeta:n.skillMeta&&typeof n.skillMeta=="object"?n.skillMeta:o.skillMeta||{},shopOffers:n.shopOffers&&typeof n.shopOffers=="object"?n.shopOffers:o.shopOffers||{active:[],passive:[]},shopRerollCount:typeof n.shopRerollCount=="number"&&Number.isFinite(n.shopRerollCount)?Math.max(0,Math.floor(n.shopRerollCount)):o.shopRerollCount||0,metaVersion:6,resurrectedTier:typeof n.resurrectedTier=="number"?n.resurrectedTier:1,resGuardianKills:typeof n.resGuardianKills=="number"?n.resGuardianKills:0,limits:{}};t.resurrectedTier=$e;const r=n.limits&&typeof n.limits=="object"?n.limits:{},s=o.limits;for(const i in s){const a=r[i];t.limits[i]=typeof a=="number"&&!Number.isNaN(a)?a:0}const l=t.resurrectedTier||1;for(const i in t.limits){const a=He(l,i),p=t.limits[i];Number.isFinite(a)&&p>a&&(t.limits[i]=a)}const f=Math.min(100,Math.floor((t.totalScore||0)/1e3));return t.avatarIndex=Wt(f,t.avatarIndex),t}catch(e){return console.error("[Progression] Failed to load progression",e),ze()}}function ee(e){try{localStorage.setItem(dt,JSON.stringify(e))}catch(n){console.error("[Progression] Failed to save progression",n)}}function Re(e){const n=(e==null?void 0:e.totalScore)||0;return Math.min(100,Math.floor(n/1e3))}function Ge(e,n){if(!n)return null;const o=n.attackSpeed||0,t=n.damage||0,r=n.moveSpeed||0,s=n.hp||0,l=n.range||0,f=n.hpRegen||0,i=n.xpGain||0,a=n.score||0,p=n.pickupRadius||0,u=n.critChance||0,c=n.critDamage||0,m=n.lifeSteal||0,d=.02,y=.02,b=.01,x=.02;e.metaAttackMult=1+o*d,e.metaDamageMult=1+t*y,e.metaMoveMult=1+r*b,e.metaRangeMult=1+l*x;const h=e.baseMaxHP??e.maxHP??100,g=s*5;e.baseMaxHP=h,e.maxHP=h+g,e.hp>e.maxHP&&(e.hp=e.maxHP),e.metaHpRegen=f*.25,e.metaCritChance=u*.1/100,e.metaCritDamageMult=1+c*.01,e.metaLifeSteal=m*.001;const v=1+i*.005,k=1+a*.02,R=p*1;return{xpGainMult:v,scoreMult:k,pickupBonusRadius:R}}function Le(e,n){const o=((e==null?void 0:e.metaCritChance)||0)+((e==null?void 0:e.runCritChanceAdd)||0),t=((e==null?void 0:e.metaCritDamageMult)||1)*((e==null?void 0:e.runCritDamageMult)||1);return o>0&&Math.random()<o?n*t:n}function Pe(e,n){if(!e||!Number.isFinite(n)||n<=0)return;const o=(e.metaLifeSteal||0)+(e.runLifeSteal||0);if(!o||o<=0)return;const t=n*o;if(!Number.isFinite(t)||t<=0)return;const r=e.maxHP??e.baseMaxHP??100;e.hp=Math.min(r,e.hp+t)}function Jt(e){if(!e)return;const n=e.resurrectedTier||1,o=Math.min($e,n+1);e.resurrectedTier=o,e.totalScore=0;const t=ze(),r={};for(const s in t.limits)r[s]=0;e.limits=r,ee(e)}function mt(e,n,o){let t=null;const r=(o||999999)*(o||999999);for(const s of n){if(s.hp<=0)continue;const l=s.x-e.x,f=s.y-e.y,i=l*l+f*f;i<r&&(!t||i<t.d2)&&(t={e:s,d2:i})}return t?t.e:null}function Qt(e,n,o,t){const r=[e];let s=e;for(;r.length<o;){let l=null;const f=t*t;for(const i of n){if(i===s||i.hp<=0||r.includes(i))continue;const a=i.x-s.x,p=i.y-s.y,u=a*a+p*p;u<=f&&(!l||u<l.d2)&&(l={e:i,d2:u})}if(!l)break;r.push(l.e),s=l.e}return r}function eo(e){return(e&&e.players&&e.players.length?e.players:e&&e.player?[e.player]:[]).filter(o=>o&&o.hp>0)}function ue(e,n,o={}){const t=eo(n);if(!t.length)return(n==null?void 0:n.player)||null;const r=(e==null?void 0:e.x)||0,s=(e==null?void 0:e.y)||0,l=Number.isFinite(o.aggroRange)?o.aggroRange:Number.isFinite(e==null?void 0:e.aggroRange)?e.aggroRange:520,f=Number.isFinite(o.attackerMemorySec)?o.attackerMemorySec:3,i=Number.isFinite(o.allowSwitchDist)?o.allowSwitchDist:l*1.8;let a=t[0],p=1/0;for(const d of t){const y=d.x-r,b=d.y-s,x=y*y+b*b;x<p&&(p=x,a=d)}const u=(n==null?void 0:n.time)||0,c=e&&typeof e._lastHitAt=="number"?e._lastHitAt:null,m=e&&e._lastHitBy!=null?String(e._lastHitBy):null;if(c!=null&&m&&u-c<=f){const d=t.find(y=>String(y.id)===m);if(d){const y=d.x-r,b=d.y-s;if(y*y+b*b<=i*i)return d}}return a}function no(e,n,o,t){const{enemies:r,floatingTexts:s}=n;let l;if(t){let u=null;const c=o.chainRange,m=c*c;for(const d of r){if(d.hp<=0)continue;const y=d.x-e.x,b=d.y-e.y,x=y*y+b*b;if(x>m)continue;const h=Math.sqrt(x),g=y/h,v=b/h;g*t.x+v*t.y<.4||(!u||x<u.d2)&&(u={e:d,d2:x})}l=u?u.e:null}else l=mt(e,r,o.chainRange);if(!l)return;e._lastCombatAt=n.time;const f=Math.max(2,o.maxTargets||2),i=Qt(l,r,f,o.chainRange);let a=o.damage;const p=[{x:e.x,y:e.y}];if(i&&i.length>0){e.lastPlayerTarget=i[0],e.lastPlayerTargetAt=n.time;for(const u of i)u&&(u._lastHitAt=n.time,u._lastHitBy=e.id||"local",u.aggroed=!0)}for(const u of i){p.push({x:u.x,y:u.y});const c=Le(e,a);u.hp-=c,Pe(e,c),s.push({x:u.x,y:u.y-20,text:Math.round(c).toString(),time:.5}),a*=.75}n._lightningVisuals&&typeof n._lightningVisuals.set=="function"?n._lightningVisuals.set(String(e.id||"local"),p):n._lightningVisual=p}function Vn(e,n,o,t,r,s=null){const{enemies:l}=n,f=s&&Number.isFinite(s.range)?s.range:oo(e.level);n._laserVisuals&&typeof n._laserVisuals.delete=="function"?n._laserVisuals.delete(String(e.id||"local")):n._laserVisual=null;const i=Number.isFinite(e.laserMaxHeat)?e.laserMaxHeat:100,a=Number.isFinite(e.laserHeatRate)&&e.laserHeatRate>2?e.laserHeatRate:26,p=a*.85;if(e.laserHeat=Number.isFinite(e.laserHeat)?e.laserHeat:0,!r||!t){e.laserHeat=Math.max(0,e.laserHeat-p*o),e._laserOverheated&&e.laserHeat<=i*.3&&(e._laserOverheated=!1);return}if(e._laserOverheated){e.laserHeat=Math.max(0,e.laserHeat-p*1.15*o),e.laserHeat<=i*.3&&(e._laserOverheated=!1);return}if(e.laserHeat=Math.min(i,e.laserHeat+a*o),e.laserHeat>=i){e._laserOverheated=!0;return}const u=e.x,c=e.y,m=[];let d=0;for(const g of l){if(g.hp<=0)continue;const v=g.x-u,k=g.y-c,R=v*t.x+k*t.y;if(R<=0||R>f)continue;const P=t.x*R,A=t.y*R,T=v-P,S=k-A,w=(g.radius||20)+6;T*T+S*S<=w*w&&(m.push({enemy:g,dist:R}),R>d&&(d=R))}if(m.length>0){let g=m[0];for(const v of m)v.dist<g.dist&&(g=v),v.enemy&&(v.enemy._lastHitAt=n.time,v.enemy._lastHitBy=e.id||"local",v.enemy.aggroed=!0);e.lastPlayerTarget=g.enemy,e.lastPlayerTargetAt=n.time}const b=(s&&Number.isFinite(s.dps)?s.dps:to(e.level))*o;for(const g of m)g.enemy.hp-=b,Pe(e,b);m.length>0&&(e._lastCombatAt=n.time);const x=m.length>0?d:f,h={x1:u,y1:c,x2:u+t.x*x,y2:c+t.y*x};n._laserVisuals&&typeof n._laserVisuals.set=="function"?n._laserVisuals.set(String(e.id||"local"),h):n._laserVisual=h}function to(e){return 40+Math.max(0,Math.min(150,(e|0)-150))/150*110}function oo(e){return 200+Math.max(0,Math.min(150,(e|0)-150))/150*150}function io(e,n,o,t){const r=(t==null?void 0:t.level)|0;if(!e||!n||r<=0){e&&(e._satelliteVis=null);return}const s=n.enemies||[],l=n.time||0,f=Math.max(1,t.count|0),i=t.orbitR,a=t.orbR,p=t.hitDamage,u=t.tick;if(e._satelliteVis={count:f,orbitR:i,orbR:a,speed:t.orbitSpeed||1.2},e._satelliteTick=(e._satelliteTick||0)-o,e._satelliteTick>0)return;e._satelliteTick=u;const c=l*(t.orbitSpeed||1.2),m=Math.PI*2/Math.max(1,f);let d=!1;for(let y=0;y<f;y++){const b=c+y*m,x=e.x+Math.cos(b)*i,h=e.y+Math.sin(b)*i;for(const g of s){if(!g||g.hp<=0)continue;const v=g.x-x,k=g.y-h,R=(g.radius||20)+a;if(v*v+k*k<=R*R){const P=Le(e,p);g.hp-=P,Pe(e,P),d=!0,g._lastHitAt=n.time,g._lastHitBy=e.id||"local",g.aggroed=!0}}}d&&(e._lastCombatAt=n.time)}function so(e,n,o,t){const r=(t==null?void 0:t.level)|0;if(!e||!n||r<=0){e&&(e._energyBarrierVis=null);return}const s=n.enemies||[],l=t.radius||0,f=t.pushSpeed||0,i=t.pulseDamage||0,a=t.tick||.3,p=t.slowMult??.85,u=t.dmgMult??.95,c=.45;e._energyBarrierVis={radius:l,lvl:r};const m=l*l;for(const y of s){if(!y||y.hp<=0)continue;const b=y.x-e.x,x=y.y-e.y;b*b+x*x>m||(y._barrierDebuffUntil=n.time+c,y._barrierSlowMult=p,y._barrierDmgMult=u)}if(f>0){const y=Math.max(0,l-26),b=y*y;for(const x of s){if(!x||x.hp<=0)continue;const h=x.x-e.x,g=x.y-e.y,v=h*h+g*g;if(v>b)continue;const k=Math.sqrt(v)||1e-4,R=h/k,P=g/k,A=f*o;x.x+=R*A,x.y+=P*A}}if(i<=0||(e._energyBarrierTick=(e._energyBarrierTick||0)-o,e._energyBarrierTick>0))return;e._energyBarrierTick=a;let d=!1;for(const y of s){if(!y||y.hp<=0)continue;const b=y.x-e.x,x=y.y-e.y,h=l+(y.radius||20);if(b*b+x*x<=h*h){const g=Le(e,i);y.hp-=g,Pe(e,g),d=!0,y._lastHitAt=n.time,y._lastHitBy=e.id||"local",y.aggroed=!0}}d&&(e._lastCombatAt=n.time)}function ro(e,n,o,t){const r=(t==null?void 0:t.level)|0;if(!e||!n||r<=0){e&&(e._spiritVis=null);return}const s=n.time||0,l=n.projectiles||(n.projectiles=[]),f=Math.max(1,t.count|0),i=t.orbitR,a=t.orbR;if(e._spiritVis={count:f,orbitR:i,orbR:a,speed:t.orbitSpeed||1},e._spiritCd=(e._spiritCd||0)-o,e._spiritCd>0)return;e._spiritCd=t.cooldown;const p=mt(e,n.enemies||[],t.range);if(!p)return;const u=s*(t.orbitSpeed||1),c=Math.PI*2/Math.max(1,f);for(let m=0;m<f;m++){const d=u+m*c,y=e.x+Math.cos(d)*i,b=e.y+Math.sin(d)*i,x=p.x-y,h=p.y-b,g=Math.hypot(x,h)||1e-4,v=x/g,k=h/g,R=t.projectileSpeed,P=n._nextProjectileId=(n._nextProjectileId||0)+1;l.push({id:P,x:y,y:b,ownerId:e.id||"local",vx:v*R,vy:k*R,speed:R,damage:t.damage,range:t.range,travel:0,radius:3,type:"spirit"})}}function ao(e,n,o,t){const r=(t==null?void 0:t.level)|0;if(!e||!n||r<=0){e&&(e._electricZoneVis=null);return}const s=n.enemies||[],l=t.radius;if(e._electricZoneVis={radius:l},e._electricZoneTick=(e._electricZoneTick||0)-o,e._electricZoneTick>0)return;e._electricZoneTick=t.tick;const f=l*l;let i=!1;for(const a of s){if(!a||a.hp<=0)continue;const p=a.x-e.x,u=a.y-e.y;if(p*p+u*u<=f){const c=Le(e,t.pulseDamage);a.hp-=c,Pe(e,c),i=!0,a._lastHitAt=n.time,a._lastHitBy=e.id||"local",a.aggroed=!0}}i&&(e._lastCombatAt=n.time)}function lo(e,n){return e/(n||1)}function ie(e){const n=(e==null?void 0:e.metaRangeMult)||1,o=(e==null?void 0:e.runRangeMult)||1,t=n*o,r=2.2;return!Number.isFinite(t)||t<=r?t:r+(t-r)*.25}function pe(e){const n=(e==null?void 0:e.baseDamage)||4,o=Number.isFinite(e==null?void 0:e.damage)?e.damage:n;return lo(o,n||1)}function yt(e){if(!e)return 220;const n=ie(e),o=e.runSkills||{},t=(o.bullets||0)|0,r=t>0?(220+(t-1)*12)*n:0,s=(o.bombs||0)|0,l=s>0?(200+(s-1)*8)*n:0,f=(o.rockets||0)|0,i=f>0?(280+(f-1)*10)*n:0,a=(o.lightning||0)|0,p=a>0?(240+(a-1)*10)*n:0,u=(o.laser||0)|0,c=u>0?(260+(u-1)*15)*n:0;return Math.max(220*n,r,l,i,p,c)}function gt(e){if(!e)return 200;const n=ie(e),o=e.runSkills||{},t=(o.bullets||0)|0,r=t>0?(220+(t-1)*12)*n:0,s=(o.bombs||0)|0,l=s>0?(200+(s-1)*8)*n:0,f=(o.rockets||0)|0,i=f>0?(280+(f-1)*10)*n:0,a=(o.lightning||0)|0,p=a>0?(240+(a-1)*10)*n:0,u=(o.laser||0)|0,c=u>0?(260+(u-1)*15)*n:0;return Math.max(220*n,r,l,i,p,c)}function co(e){var a;const n=(((a=e.runSkills)==null?void 0:a.bullets)??0)|0;if(n<=0)return null;const o=ie(e),t=pe(e),r=1+Math.floor((n-1)/4),s=r<=1?0:14,l=4+(n-1)*1.1,i=(e.attackSpeed||e.baseAttackSpeed||2)*(1+(n-1)*.05);return{count:r,spread:s,damage:l*t,range:(220+(n-1)*12)*o,rate:i}}function uo(e){var a;const n=(((a=e.runSkills)==null?void 0:a.bombs)||0)|0;if(n<=0)return null;const o=ie(e),t=pe(e),r=1+Math.floor((n-1)/5),s=12+(n-1)*4.2,l=(200+(n-1)*8)*o,f=60+(n-1)*4,i=Math.max(1.2,2.8-(n-1)*.06);return{count:r,damage:s*t,range:l,splashRadius:f,cooldown:i,speed:320}}function fo(e){var a;const n=(((a=e.runSkills)==null?void 0:a.rockets)||0)|0;if(n<=0)return null;const o=ie(e),t=pe(e),r=1+Math.floor((n-1)/4),s=150+(n-1)*28,l=(300+(n-1)*12)*o,f=85+(n-1)*5,i=Math.max(.65,.85-(n-1)*.02);return{count:r,damage:s*t,range:l,splashRadius:f,cooldown:i}}function po(e){var i;const n=(((i=e.runSkills)==null?void 0:i.lightning)||0)|0;if(n<=0)return null;const o=ie(e),t=pe(e),r=Math.min(7,2+Math.floor((n-1)/4)),s=22+(n-1)*5,l=(240+(n-1)*10)*o,f=Math.max(.95,2.1-(n-1)*.05);return{maxTargets:r,damage:s*t,chainRange:l,cooldown:f}}function ho(e){var l;const n=(((l=e.runSkills)==null?void 0:l.laser)||0)|0;if(n<=0)return null;const o=ie(e),t=pe(e),r=(260+(n-1)*15)*o,s=30+(n-1)*14;return{range:r,dps:s*t}}function mo(e){var c;const n=(((c=e.runSkills)==null?void 0:c.satellites)||0)|0;if(n<=0)return null;const o=ie(e),t=pe(e),r=[0,1,1,2,2,3,3,4,4,5,6],s=[0,0,0,1,1,1,2,2,3,3,4],l=Math.min(8,r[n]||1),f=9+(s[n]||0),i=(54+(n-1)*2.2+Math.max(0,l-1)*1.5)*(.85+(o-1)*.35),a=(10+(n-1)*2.2)*t,p=Math.max(.12,.22-(n-1)*.007),u=1.15+(n-1)*.045;return{level:n,count:l,orbitR:i,orbR:f,hitDamage:a,tick:p,orbitSpeed:u}}function yo(e){var u;const n=(((u=e.runSkills)==null?void 0:u.energyBarrier)||0)|0;if(n<=0)return null;const o=ie(e),t=pe(e),s=(n<=3?66+(n-1)*4:78+(n-1)*5)*(.9+(o-1)*.5),l=.85,f=.95;let i=0,a=0;n>=4&&n<=6?(i=140+(n-4)*35,a=(10+(n-4)*4)*t):n>=7&&(i=260+(n-7)*24,a=(16+(n-7)*5.5)*t);const p=a>0?Math.max(.18,.38-(n-1)*.012):.35;return{level:n,radius:s,pushSpeed:i,pulseDamage:a,tick:p,slowMult:l,dmgMult:f}}function go(e){var c;const n=(((c=e.runSkills)==null?void 0:c.spirit)||0)|0;if(n<=0)return null;const o=ie(e),t=pe(e),r=Math.min(3,1+Math.floor((n-1)/5)),s=46+(n-1)*1.5,l=7,f=(300+(n-1)*10)*o,i=(16+(n-1)*5.5)*t,a=Math.max(.55,1.45-(n-1)*.05),p=680,u=.9+(n-1)*.02;return{level:n,count:r,orbitR:s,orbR:l,range:f,damage:i,cooldown:a,projectileSpeed:p,orbitSpeed:u}}function bo(e){var f;const n=(((f=e.runSkills)==null?void 0:f.electricZone)||0)|0;if(n<=0)return null;const o=ie(e),t=pe(e),r=(140+(n-1)*9)*o,s=Math.max(.16,.34-(n-1)*.01),l=(22+(n-1)*7)*t;return{level:n,radius:r,tick:s,pulseDamage:l}}function vo(e,n,o){if(!e||e.hp<=0)return;const t=yt(e),r=ft(e,n.camera,n.canvas,n.enemies,t,n.time),s=ut();return bt(e,n,o,{aimDir:r,firing:s})}function xo(e,n,o,{aimDir:t,firing:r}={}){if(!(!e||e.hp<=0))return bt(e,n,o,{aimDir:t,firing:r})}function bt(e,n,o,{aimDir:t,firing:r}={}){t&&Number.isFinite(t.x)&&Number.isFinite(t.y)&&(e.lastAimDir={x:t.x,y:t.y}),e.range=gt(e);const s=co(e);e.attackCooldown=(e.attackCooldown||0)-o,s&&r&&t&&e.attackCooldown<=0&&(Zt(e,n,t,{count:s.count,spread:s.spread,damage:s.damage,range:s.range}),e.attackCooldown=1/Math.max(.01,s.rate));const l=uo(e);l&&(e.bombCooldown=(e.bombCooldown||0)-o,r&&t&&e.bombCooldown<=0&&(zt(e,n,t,{count:l.count,damage:l.damage,range:l.range,splashRadius:l.splashRadius,speed:l.speed}),e.bombCooldown=l.cooldown));const f=fo(e);f&&(e.rocketCooldown=(e.rocketCooldown||0)-o,r&&t&&e.rocketCooldown<=0&&(Yt(e,n,t,{count:f.count,damage:f.damage,range:f.range,splashRadius:f.splashRadius}),e.rocketCooldown=f.cooldown));const i=po(e);i&&(e.lightningCooldown=(e.lightningCooldown||0)-o,r&&e.lightningCooldown<=0&&(no(e,n,{damage:i.damage,chainRange:i.chainRange,maxTargets:i.maxTargets},t||null),e.lightningCooldown=i.cooldown));const a=ho(e);a?Vn(e,n,o,t||null,!!r,a):Vn(e,n,o,null,!1,null);const p=mo(e);p?io(e,n,o,p):e._satelliteVis=null;const u=yo(e);u?so(e,n,o,u):e._energyBarrierVis=null;const c=go(e);c?ro(e,n,o,c):e._spiritVis=null;const m=bo(e);m?ao(e,n,o,m):e._electricZoneVis=null}function ke(e,n){const o=ce(e),t=30,r=6,s=90,l=10,f={type:"basic",zone:e,x:n.x,y:n.y,radius:20,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:10*e,isBoss:!1,isGateEnemy:!1,isElite:!1};return f.update=(i,a,p)=>{const u=ue(i,p,{aggroRange:i.aggroRange||450});if(!u)return;const c=u.x-i.x,m=u.y-i.y,d=Math.hypot(c,m)||1,y=typeof i._barrierDebuffUntil=="number"&&p.time<i._barrierDebuffUntil,b=y&&i._barrierSlowMult||1,x=y&&i._barrierDmgMult||1,h=i.speed*b;let g=c/d*h,v=m/d*h;const k=i.aiMode;if(k&&!i.aggroed){const P=i.aggroRange||450,A=c*c+m*m,T=typeof i._lastHitAt=="number"&&p.time-i._lastHitAt<=3,S=k==="camp"&&i.campCenter&&typeof i.campRadius=="number"&&A<=i.campRadius*i.campRadius;if(A<=P*P||T||S)i.aggroed=!0;else if(k==="patrol"&&i.patrolCenter){i._patrolAngle=(i._patrolAngle||0)+a*.9;const w=i.patrolRadius||360,M=i.patrolCenter.x+Math.cos(i._patrolAngle)*w,B=i.patrolCenter.y+Math.sin(i._patrolAngle)*w,I=M-i.x,L=B-i.y,H=Math.hypot(I,L)||1;g=I/H*h*.45,v=L/H*h*.45}else{const w=k==="camp"?i.campCenter:i.herdCenter;if(w){i._idleAngle=(i._idleAngle||0)+a*.6;const M=k==="camp"?i.campRadius||650:i.herdRadius||420,B=w.x+Math.cos(i._idleAngle)*M*.4,I=w.y+Math.sin(i._idleAngle)*M*.4,L=B-i.x,H=I-i.y,N=Math.hypot(L,H)||1;g=L/N*h*.35,v=H/N*h*.35}else g=0,v=0}}i.x+=g*a,i.y+=v*a;const R=(u.radius||18)+i.radius;if(c*c+m*m<=R*R&&!u._ghostActive&&!u._lvlUpInvuln&&!u._lvlUpChoosing){const P=u._shieldActive?.2:1;u.hp-=i.damage*x*a*P,u.lastAttacker=i,u.lastAttackerAt=p.time}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#ff5f6f",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.restore()},f.onDeath=(i,a)=>{Math.random()<.22?a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"coin",coins:1,age:0}):a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"xp",xp:i.xpValue,age:0})},f}function Ae(e,n){const o=ce(e),t=2.5,r=40,s=8,l=110,f=15,i={type:"elite",zone:e,x:n.x,y:n.y,radius:26,hp:r*o.hp*t,maxHp:r*o.hp*t,damage:s*o.damage*t,speed:l*o.speed*1.1,xpValue:f*o.xp*t,scoreValue:20*e,isBoss:!1,isGateEnemy:!1,isElite:!0};return i.update=(a,p,u)=>{const c=ue(a,u,{aggroRange:a.aggroRange||450});if(!c)return;const m=c.x-a.x,d=c.y-a.y,y=Math.hypot(m,d)||1,b=typeof a._barrierDebuffUntil=="number"&&u.time<a._barrierDebuffUntil,x=b&&a._barrierSlowMult||1,h=b&&a._barrierDmgMult||1,g=a.speed*x;let v=m/y*g,k=d/y*g;const R=a.aiMode;if(R&&!a.aggroed){const A=a.aggroRange||450,T=m*m+d*d,S=typeof a._lastHitAt=="number"&&u.time-a._lastHitAt<=3,w=R==="camp"&&a.campCenter&&typeof a.campRadius=="number"&&T<=a.campRadius*a.campRadius;if(T<=A*A||S||w)a.aggroed=!0;else if(R==="patrol"&&a.patrolCenter){a._patrolAngle=(a._patrolAngle||0)+p*.9;const M=a.patrolRadius||360,B=a.patrolCenter.x+Math.cos(a._patrolAngle)*M,I=a.patrolCenter.y+Math.sin(a._patrolAngle)*M,L=B-a.x,H=I-a.y,N=Math.hypot(L,H)||1;v=L/N*g*.45,k=H/N*g*.45}else{const M=R==="camp"?a.campCenter:a.herdCenter;if(M){a._idleAngle=(a._idleAngle||0)+p*.6;const B=R==="camp"?a.campRadius||650:a.herdRadius||420,I=M.x+Math.cos(a._idleAngle)*B*.4,L=M.y+Math.sin(a._idleAngle)*B*.4,H=I-a.x,N=L-a.y,$=Math.hypot(H,N)||1;v=H/$*g*.35,k=N/$*g*.35}else v=0,k=0}}a.x+=v*p,a.y+=k*p;const P=(c.radius||18)+a.radius;if(m*m+d*d<=P*P&&!c._ghostActive&&!c._lvlUpInvuln&&!c._lvlUpChoosing){const A=c._shieldActive?.25:1;c.hp-=a.damage*h*p*A,c.lastAttacker=a,c.lastAttackerAt=u.time}},i.render=(a,p)=>{p.save(),p.beginPath(),p.fillStyle="#ffa43c",p.arc(a.x,a.y,a.radius,0,Math.PI*2),p.fill(),p.restore()},i.onDeath=(a,p)=>{if(Math.random()<.55){const c=2+(Math.random()*3|0);p.xpOrbs.push({x:a.x,y:a.y,radius:10,kind:"coin",coins:c,age:0})}else p.xpOrbs.push({x:a.x,y:a.y,radius:10,kind:"xp",xp:a.xpValue,age:0});if(Math.random()<.3){const c=["damage","attackSpeed","moveSpeed","regen","shield","xpGain"],m=c[Math.floor(Math.random()*c.length)];p.buffs.push({type:m,timeLeft:m==="regen"?15:m==="shield"?8:20,multiplier:.4,amount:m==="regen"?5:0});const d=m==="damage"?"Damage":m==="attackSpeed"?"Attack Speed":m==="moveSpeed"?"Move Speed":m==="regen"?"Regen":m==="shield"?"Shield":"XP Gain";p.floatingTexts.push({x:a.x,y:a.y-20,text:"BUFF: "+d,time:1}),p.popups.push({text:"Temporary buff: "+d,time:2})}},i}function hn(e,n){const o=e|0;if(o>=6){const t=[$n,Gn,Xn,Wn,jn],r=t[Math.floor(Math.random()*t.length)];return r(e,n)}switch(o){case 1:return $n(o,n);case 2:return Gn(o,n);case 3:return Xn(o,n);case 4:return Wn(o,n);case 5:default:return jn(o||5,n)}}function $n(e,n){const o=ce(e),t=90,r=10,s=65,l=20,f={type:"zone1Bruiser",zone:e,x:n.x,y:n.y,radius:26,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:20*e,isBoss:!1,isGateEnemy:!1,isElite:!0};return f.update=(i,a,p)=>{const u=ue(i,p,{aggroRange:900});if(!u)return;const c=u.x-i.x,m=u.y-i.y,d=Math.hypot(c,m)||1,y=typeof i._barrierDebuffUntil=="number"&&p.time<i._barrierDebuffUntil,b=y&&i._barrierSlowMult||1,x=y&&i._barrierDmgMult||1,g=i.speed*b,v=c/d*g,k=m/d*g;i.x+=v*a,i.y+=k*a;const R=(u.radius||18)+i.radius;if(c*c+m*m<=R*R&&!u._ghostActive&&!u._lvlUpInvuln&&!u._lvlUpChoosing){const P=u._shieldActive?.2:1;u.hp-=i.damage*x*a*P,u.lastAttacker=i,u.lastAttackerAt=p.time}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#ffb347",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.restore()},f.onDeath=(i,a)=>{if(Math.random()<.35){const u=1+(Math.random()*2|0);a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"coin",coins:u,age:0})}else a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"xp",xp:i.xpValue,age:0})},f}function Gn(e,n){const o=ce(e),t=45,r=7,s=150,l=18,f={type:"zone2Runner",zone:e,x:n.x,y:n.y,radius:18,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:22*e,isBoss:!1,isGateEnemy:!1,isElite:!0};return f.update=(i,a,p)=>{const u=ue(i,p,{aggroRange:950});if(!u)return;const c=u.x-i.x,m=u.y-i.y,d=Math.hypot(c,m)||1,y=typeof i._barrierDebuffUntil=="number"&&p.time<i._barrierDebuffUntil,b=y&&i._barrierSlowMult||1,x=y&&i._barrierDmgMult||1;let v=i.speed*b;d>260?v*=1.8:d>140&&(v*=1.3);const k=c/d*v,R=m/d*v;i.x+=k*a,i.y+=R*a;const P=(u.radius||18)+i.radius;if(c*c+m*m<=P*P&&!u._ghostActive&&!u._lvlUpInvuln&&!u._lvlUpChoosing){const A=u._shieldActive?.2:1;u.hp-=i.damage*x*a*A,u.lastAttacker=i,u.lastAttackerAt=p.time}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#f4ff5a",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.restore()},f.onDeath=(i,a)=>{a.xpOrbs.push({x:i.x,y:i.y,radius:9,xp:i.xpValue,age:0})},f}function Xn(e,n){const o=ce(e),t=35,r=12,s=85,l=24,f={type:"zone3Sniper",zone:e,x:n.x,y:n.y,radius:18,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:26*e,isBoss:!1,isGateEnemy:!1,isElite:!0,_shootTimer:0,_shootInterval:2.4,_shootFlash:0,_aimDx:0,_aimDy:0};return f.update=(i,a,p)=>{const u=ue(i,p,{aggroRange:1250});if(!u)return;const c=u.x-i.x,m=u.y-i.y,d=Math.hypot(c,m)||1,y=typeof i._barrierDebuffUntil=="number"&&p.time<i._barrierDebuffUntil,b=y&&i._barrierSlowMult||1,x=y&&i._barrierDmgMult||1,g=i.speed*b,v=420;let k=g*.8;if(d>v+80||(d<v-80?k*=-1:k=0),k!==0){const P=c/d*k,A=m/d*k;i.x+=P*a,i.y+=A*a}if(i._shootTimer+=a,i._shootFlash=Math.max(0,i._shootFlash-a*3),i._aimDx=c/d,i._aimDy=m/d,d<325&&i._shootTimer>=i._shootInterval&&(i._shootTimer=0,i._shootFlash=.25,!u._ghostActive&&!u._lvlUpInvuln&&!u._lvlUpChoosing)){const P=u._shieldActive?.4:1;u.hp-=i.damage*x*P,u.lastAttacker=i,u.lastAttackerAt=p.time}},f.render=(i,a)=>{if(a.save(),a.beginPath(),a.fillStyle="#70d6ff",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),i._shootFlash>0){const u=i.x+(i._aimDx||1)*260,c=i.y+(i._aimDy||0)*260;a.beginPath(),a.globalAlpha=i._shootFlash,a.moveTo(i.x,i.y),a.lineTo(u,c),a.lineWidth=3,a.strokeStyle="#ffffff",a.stroke(),a.globalAlpha=1}a.restore()},f.onDeath=(i,a)=>{a.xpOrbs.push({x:i.x,y:i.y,radius:10,xp:i.xpValue,age:0})},f}function Wn(e,n){const o=ce(e),t=70,r=6,s=60,l=30,f={type:"zone4Spawner",zone:e,x:n.x,y:n.y,radius:24,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:30*e,isBoss:!1,isGateEnemy:!1,isElite:!0,_spawnTimer:0,_spawnInterval:6};return f.update=(i,a,p)=>{const{enemies:u}=p,c=ue(i,p,{aggroRange:1100});if(!c)return;const m=c.x-i.x,d=c.y-i.y,y=Math.hypot(m,d)||1,b=typeof i._barrierDebuffUntil=="number"&&p.time<i._barrierDebuffUntil,x=b&&i._barrierSlowMult||1,h=b&&i._barrierDmgMult||1,v=i.speed*x,k=m/y*v*.6,R=d/y*v*.6;i.x+=k*a,i.y+=R*a;const P=(c.radius||18)+i.radius;if(m*m+d*d<=P*P&&!c._ghostActive&&!c._lvlUpInvuln&&!c._lvlUpChoosing){const A=c._shieldActive?.2:1;c.hp-=i.damage*h*a*A,c.lastAttacker=i,c.lastAttackerAt=p.time}if(i._spawnTimer+=a,i._spawnTimer>=i._spawnInterval){i._spawnTimer=0;let A=0;const T=10;for(const S of u){if(S===i||S.type!=="basic")continue;const w=S.x-i.x,M=S.y-i.y;if(w*w+M*M<=500*500&&(A++,A>=T))break}if(A<T)for(let w=0;w<2;w++){const M=Math.random()*Math.PI*2,B=120+Math.random()*60,I=i.x+Math.cos(M)*B,L=i.y+Math.sin(M)*B;u.push(ke(e,{x:I,y:L}))}}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#b388ff",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.beginPath(),a.fillStyle="#ffffff",a.arc(i.x,i.y,i.radius*.45,0,Math.PI*2),a.fill(),a.restore()},f.onDeath=(i,a)=>{a.xpOrbs.push({x:i.x,y:i.y,radius:12,xp:i.xpValue,age:0})},f}function jn(e,n){const o=ce(e),t=200,r=16,s=75,l=80,f={type:"zone5Champion",zone:e,x:n.x,y:n.y,radius:30,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:60*e,isBoss:!1,isGateEnemy:!1,isElite:!0};return f.update=(i,a,p)=>{const u=ue(i,p,{aggroRange:1200});if(!u)return;const c=u.x-i.x,m=u.y-i.y,d=Math.hypot(c,m)||1,y=typeof i._barrierDebuffUntil=="number"&&p.time<i._barrierDebuffUntil,b=y&&i._barrierSlowMult||1,x=y&&i._barrierDmgMult||1,g=i.speed*b,v=c/d*g*.9,k=m/d*g*.9;i.x+=v*a,i.y+=k*a;const R=(u.radius||18)+i.radius;if(c*c+m*m<=R*R&&!u._ghostActive&&!u._lvlUpInvuln&&!u._lvlUpChoosing){const P=u._shieldActive?.25:1;u.hp-=i.damage*x*a*P,u.lastAttacker=i,u.lastAttackerAt=p.time}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#ff4b5c",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.beginPath(),a.lineWidth=3,a.strokeStyle="#ffffff",a.arc(i.x,i.y,i.radius+4,0,Math.PI*2),a.stroke(),a.restore()},f.onDeath=(i,a)=>{a.xpOrbs.push({x:i.x,y:i.y,radius:14,xp:i.xpValue,age:0})},f}function Zn(e,n){const o=ce(e),t=30,r=80,s=10,l=70,f=50,i={type:"roamingBoss",isRoamingBoss:!0,zone:e,x:n.x,y:n.y,radius:45,hp:r*o.hp*t,maxHp:r*o.hp*t,damage:s*o.damage*2,speed:l*o.speed*1.1,xpValue:f*o.xp*5,scoreValue:300*e,isBoss:!0,isGateEnemy:!1};return i.update=(a,p,u)=>{const c=ue(a,u,{aggroRange:1600});if(!c)return;const m=c.x-a.x,d=c.y-a.y,y=typeof a._barrierDebuffUntil=="number"&&u.time<a._barrierDebuffUntil,b=y&&a._barrierSlowMult||1,x=y&&a._barrierDmgMult||1,h=a.speed*b,g=Math.atan2(d,m),v=Math.sin(u.time*.6)*.8,k=g+v,R=Math.cos(k)*h,P=Math.sin(k)*h;a.x+=R*p,a.y+=P*p;const A=(c.radius||18)+a.radius;if(m*m+d*d<=A*A&&!c._ghostActive&&!c._lvlUpInvuln&&!c._lvlUpChoosing){const T=c._shieldActive?.4:1;c.hp-=a.damage*x*p*T,c.lastAttacker=a,c.lastAttackerAt=u.time}},i.render=(a,p)=>{p.save(),p.beginPath(),p.fillStyle="#ff3cbe",p.arc(a.x,a.y,a.radius,0,Math.PI*2),p.fill();const u=a.hp/a.maxHp;p.strokeStyle="#ffffff",p.lineWidth=3,p.beginPath(),p.arc(a.x,a.y,a.radius+6,-Math.PI/2,-Math.PI/2+Math.PI*2*u),p.stroke(),p.restore()},i.onDeath=(a,p)=>{if(Math.random()<.85){const c=8+(Math.random()*9|0);p.xpOrbs.push({x:a.x,y:a.y,radius:8,kind:"coin",coins:c,age:0})}else p.xpOrbs.push({x:a.x,y:a.y,radius:8,kind:"xp",xp:a.xpValue,age:0})},i}function ko(e,n){const o=ce(e),t=400,r=35,s=80,l=200,f={type:"resurrectionGuardian",isResGuardian:!0,isResurrectionGuardian:!0,zone:e,x:n.x,y:n.y,radius:40,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:200,isBoss:!0,isGateEnemy:!1};return f.update=(i,a,p)=>{const u=ue(i,p,{aggroRange:1600});if(!u)return;const c=u.x-i.x,m=u.y-i.y,d=Math.hypot(c,m)||1,y=typeof i._barrierDebuffUntil=="number"&&p.time<i._barrierDebuffUntil,b=y&&i._barrierSlowMult||1;y&&i._barrierDmgMult;const x=i.speed*b,h=c/d*x,g=m/d*x;i.x+=h*a,i.y+=g*a},f.onHitPlayer=(i,a,p)=>{!a._lvlUpInvuln&&!a._lvlUpChoosing&&(a.hp-=i.damage*(typeof i._barrierDebuffUntil=="number"&&p&&p.time<i._barrierDebuffUntil&&i._barrierDmgMult||1)),a.lastAttacker=i,a.lastAttackerAt=p&&p.time||0},f.onDeath=(i,a)=>{a.flags&&(a.flags.resGuardianKilledThisRun=!0),a.progression&&(a.progression.resGuardianKills=(a.progression.resGuardianKills||0)+1),a.popups&&a.popups.push({text:"Guardian of Resurrection defeated!",time:3}),a.floatingTexts&&a.floatingTexts.push({x:i.x,y:i.y-24,text:"RESURECTION READY",time:1.8})},f.render=(i,a)=>{a.save(),a.fillStyle="#ffdd44",a.beginPath(),a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill();const p=i.hp/i.maxHp;a.strokeStyle="#ffffff",a.lineWidth=4,a.beginPath(),a.arc(i.x,i.y,i.radius+6,-Math.PI/2,-Math.PI/2+Math.PI*2*p),a.stroke(),a.restore()},f}function Mo(e,n){const o=ce(e),t=220,r=18,s=70,l=250,f={type:"zone6SuperBoss",isBoss:!0,isZone6SuperBoss:!0,zone:e,x:n.x,y:n.y,radius:60,hp:t*o.hp*12,maxHp:t*o.hp*12,damage:r*o.damage,speed:s*o.speed*.6,regenPerSec:8*o.hp,xpValue:l*o.xp*6,scoreValue:2e3,spawnTimer:0};return f.update=(i,a,p)=>{const{enemies:u}=p,c=ue(i,p,{aggroRange:1800});if(!c)return;const m=c.x-i.x,d=c.y-i.y,y=Math.hypot(m,d)||1,b=typeof i._barrierDebuffUntil=="number"&&p.time<i._barrierDebuffUntil,x=b&&i._barrierSlowMult||1,h=b&&i._barrierDmgMult||1,g=i.speed*x,v=600,k=900;let R=0,P=0;y<v?(R=-(m/y)*g,P=-(d/y)*g):y>k&&(R=m/y*(g*.5),P=d/y*(g*.5)),i.x+=R*a,i.y+=P*a,i.regenPerSec>0&&i.hp>0&&(i.hp=Math.min(i.maxHp,i.hp+i.regenPerSec*a)),i.spawnTimer+=a;const A=4.5;if(i.spawnTimer>=A){i.spawnTimer=0;const S=3+Math.floor(Math.random()*2);for(let w=0;w<S;w++){const M=Math.random()*Math.PI*2,B=i.radius+80+Math.random()*80,I=i.x+Math.cos(M)*B,L=i.y+Math.sin(M)*B,H=ke(e,{x:I,y:L});H.isFromSuperBoss=!0,u.push(H)}}const T=(c.radius||18)+i.radius;if(m*m+d*d<=T*T&&!c._ghostActive&&!c._lvlUpInvuln&&!c._lvlUpChoosing){const S=c._shieldActive?.4:1;c.hp-=i.damage*h*a*S,c.lastAttacker=i,c.lastAttackerAt=p.time}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#1be7ff",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.beginPath(),a.strokeStyle="#ffed00",a.lineWidth=4,a.arc(i.x,i.y,i.radius+6,0,Math.PI*2),a.stroke();const p=i.hp/i.maxHp;a.beginPath(),a.strokeStyle="#ffffff",a.lineWidth=3,a.arc(i.x,i.y,i.radius+12,-Math.PI/2,-Math.PI/2+Math.PI*2*p),a.stroke(),a.restore()},f.onDeath=(i,a)=>{if(Math.random()<.9){const u=14+(Math.random()*15|0);a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"coin",coins:u,age:0})}else a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"xp",xp:i.xpValue,age:0})},f}function ne(e,n){return e+Math.random()*(n-e)}function Ue(e,n){return e+Math.floor(Math.random()*(n-e+1))}const So={1:[1,2],2:[1,2],3:[2,3],4:[2,3],5:[3,4],6:[3,4]},Yn={1:{herd:.6,patrol:.4,camp:0},2:{herd:.5,patrol:.35,camp:.15},3:{herd:.45,patrol:.35,camp:.2},4:{herd:.4,patrol:.35,camp:.25},5:{herd:.35,patrol:.35,camp:.3},6:{herd:.3,patrol:.35,camp:.35}};function _o(e){const n=Yn[e]||Yn[3],o=Math.random();return o<n.camp?"camp":o<n.camp+n.patrol?"patrol":"herd"}function Ro(e){return e<=1?[4,7]:e===2?[5,8]:e===3?[6,10]:e===4?[7,12]:[8,14]}function Po(e){return e<=1?[3,5]:e===2?[4,6]:e===3?[5,8]:e===4?[6,9]:[7,11]}function wo(e){return e<=1?[3,5]:e===2?[4,6]:e===3?[5,8]:e===4?[6,10]:[7,12]}function zn(e,n,o){return Math.max(n,Math.min(o,e))}function Ne(e,n,o){if(!e)return;const t=zn(n|0,1,6),s=(zn(o|0,1,500)-1)/499,l=[0,.7,.9,1.4,2,2.7,3.4][t],f=[0,.2,.26,.38,.52,.66,.82][t],i=[0,.18,.2,.24,.3,.36,.42][t],a=1+s*l,p=1+s*f,u=1+s*i;Number.isFinite(e.hp)&&(e.hp*=a),Number.isFinite(e.maxHp)&&(e.maxHp*=a),Number.isFinite(e.damage)&&(e.damage*=p),Number.isFinite(e.xpValue)&&(e.xpValue*=u),Number.isFinite(e.scoreValue)&&(e.scoreValue*=u)}function be(e,n){const o=Math.random()*Math.PI*2,t=Math.sqrt(Math.random()*(n*n-e*e)+e*e);return{x:Math.cos(o)*t,y:Math.sin(o)*t}}function je(e){const n=z[1],o=z[2],t=z[3],r=z[4],s=z[5];if(e===0)return{x:0,y:0};if(e===1){for(let l=0;l<40;l++){const f=Math.random()*Math.PI*2,i=Math.sqrt(Math.random())*n,a={x:Math.cos(f)*i,y:Math.sin(f)*i};if(!Ve(a.x,a.y))return a}return be(n*.15,n)}if(e===2)return be(n,o);if(e===3)return be(o,t);if(e===4)return be(t,r);if(e===5)return be(r,s);for(let l=0;l<20;l++){const f=Math.random()<.35;let i;if(f?i={x:ne(-Z,Z),y:ne(-Z,Z)}:i=be(s,Z),Math.hypot(i.x,i.y)>=s)return i}return be(s,Z)}function Ao(e,n){return e+","+n}class Co{constructor(n){this.state=n,this.cellSize=1800,this.generatedCells=new Set,this.groups=new Map,this.nextGroupId=1,this.nextEnemyId=1,this.roamingTimer=0,this.cornerBossNextRespawnAt=[0,0,0,0],this.cornerBossAlive=[!1,!1,!1,!1],this.guardianSpawned=!1,this.superBossSpawned=!1,this.superBossPoint=null}reset(){this.generatedCells.clear(),this.groups.clear(),this.nextGroupId=1,this.nextEnemyId=1,this.roamingTimer=0,this.cornerBossNextRespawnAt=[0,0,0,0],this.cornerBossAlive=[!1,!1,!1,!1],this.guardianSpawned=!1,this.superBossSpawned=!1;const n=je(6);this.superBossPoint={x:n.x,y:n.y}}ensureEnemyId(n){n&&(n.id==null&&(n.id=`e${this.nextEnemyId++}`),n._id==null&&(n._id=n.id))}onZoneChanged(n){this.roamingTimer=0,this.cornerBossNextRespawnAt=[0,0,0,0],this.cornerBossAlive=[!1,!1,!1,!1]}onEnemyRemoved(n,o){if(n&&n.isZone6CornerBoss){const s=n.cornerIndex|0;s>=0&&s<4&&(this.cornerBossAlive[s]=!1,this.cornerBossNextRespawnAt[s]=o.time+90)}const t=n&&n.groupId;if(!t)return;const r=this.groups.get(t);r&&(r.aliveCount=Math.max(0,(r.aliveCount|0)-1),r.aliveCount<=0&&r.spawned&&!r.isWiped&&(r.isWiped=!0,r.spawned=!1,r.wipedAt=o.time,r.nextRespawnAt=o.time+(r.respawnDelaySec||20)))}createGroup(n,o,t){const r="g"+this.nextGroupId++,s=Math.max(0,Math.min(6,n|0)),l=s<=2?14:s===3?16:s===4?18:20,f=o==="camp"?l+14:o==="patrol"?l+6:l,i={id:r,zone:n,type:o,center:{x:t.x,y:t.y},spawned:!1,aliveCount:0,isWiped:!1,wipedAt:0,nextRespawnAt:0,respawnDelaySec:f,activationDist:(o==="camp"?5400:o==="patrol"?5200:4800)+s*220};return this.groups.set(r,i),i}spawnGroup(n,o){const{enemies:t,player:r}=this.state,s=n.zone,l=n.center.x,f=n.center.y,i=o&&o.level||r&&r.level||1,a=[],p=(u,c)=>{u&&(u.id==null&&(u.id=`e${this.nextEnemyId++}`),u._id==null&&(u._id=u.id),u.zone=s,u.groupId=n.id,u.aiMode=c,u.aggroed=!1,u.aggroRange=c==="camp"||c==="patrol"?520:c==="herdPassive"?360:500,c==="camp"?(u.campCenter={x:l,y:f},u.campRadius=700):c==="patrol"?(u.patrolCenter={x:l,y:f},u.patrolRadius=ne(260,520),u._patrolAngle=Math.random()*Math.PI*2):c==="herdPassive"&&(u.herdCenter={x:l,y:f},u.herdRadius=ne(280,520),u._idleAngle=Math.random()*Math.PI*2),Ne(u,s,i),t.push(u),a.push(u))};if(n.type==="herd"){const[u,c]=Ro(s),m=Ue(u,c);for(let d=0;d<m;d++){const y=Math.random()*Math.PI*2,b=ne(50,260),x={x:l+Math.cos(y)*b,y:f+Math.sin(y)*b};s===6?Math.random()<.6?p(Ae(6,x),"herdPassive"):p(hn(6,x),"herdPassive"):p(ke(s,x),"herdPassive")}}if(n.type==="patrol"){const[u,c]=Po(s),m=Ue(u,c);for(let d=0;d<m;d++){const y=Math.random()*Math.PI*2,b=ne(80,340),x={x:l+Math.cos(y)*b,y:f+Math.sin(y)*b};s===6?Math.random()<.75?p(Ae(6,x),"patrol"):p(hn(6,x),"patrol"):s===1?p(ke(1,x),"patrol"):Math.random()<.25?p(Ae(s,x),"patrol"):p(ke(s,x),"patrol")}}if(n.type==="camp")if(s===1){const u=Ue(6,10);for(let c=0;c<u;c++){const m=Math.random()*Math.PI*2,d=ne(80,360),y={x:l+Math.cos(m)*d,y:f+Math.sin(m)*d};p(ke(1,y),"herdPassive")}}else{const u={x:l+ne(-60,60),y:f+ne(-60,60)},c=Ae(s===0?1:s,u);c.isMiniBoss=!0;const m=Math.max(1,s|0),d=m<=1?2:m===2?2.3:m===3?2.6:2.8,y=m<=1?1.2:m===2?1.25:1.35;c.hp*=d,c.maxHp*=d,c.damage*=y,c.radius=(c.radius||26)+(m<=2?6:8),c.xpValue=(c.xpValue||20)*2,c.scoreValue=(c.scoreValue||20)*2.5,p(c,"camp");const[b,x]=wo(s),h=Ue(b,x);for(let g=0;g<h;g++){const v=Math.random()*Math.PI*2,k=ne(120,420),R={x:l+Math.cos(v)*k,y:f+Math.sin(v)*k};s===6?Math.random()<.6?p(Ae(6,R),"camp"):p(hn(6,R),"camp"):Math.random()<.2?p(Ae(s,R),"camp"):p(ke(s,R),"camp")}}n.spawned=!0,n.isWiped=!1,n.aliveCount=a.length}ensureCellsAroundPlayer(n){if(!n)return;const o=this.cellSize,t=Math.floor(n.x/o),r=Math.floor(n.y/o),l=(this.state.players&&this.state.players.length?this.state.players.length:1)>=4?3:4;for(let f=-l;f<=l;f++)for(let i=-l;i<=l;i++){const a=t+i,p=r+f,u=Ao(a,p);if(this.generatedCells.has(u))continue;this.generatedCells.add(u);const c={x:(a+.5)*o+ne(-o*.25,o*.25),y:(p+.5)*o+ne(-o*.25,o*.25)},m=Ie(c.x,c.y);if(m===0)continue;const[d,y]=So[m]||[2,3],b=Ue(d,y);for(let x=0;x<b;x++){const h={x:c.x+ne(-o*.25,o*.25),y:c.y+ne(-o*.25,o*.25)},g=Ie(h.x,h.y);if(g===0)continue;const v=_o(g);this.createGroup(g,v,h)}}}update(n){const o=this.state,t=o.enemies,r=o.players&&o.players.length?o.players.filter(Boolean):o.player?[o.player]:[],s=r.filter(b=>b&&b.hp>0),l=s.length?s:r;if(!l.length)return;const f=l.map(b=>({p:b,z:Ie(b.x,b.y)}));let i=0,a=!1;for(const b of f)b&&(i=Math.max(i,b.z|0),b.z|0&&(a=!0));if(a)for(const b of f)!b||!(b.z|0)||this.ensureCellsAroundPlayer(b.p);for(const b of this.groups.values())b.isWiped&&o.time>=b.nextRespawnAt&&(b.isWiped=!1,b.spawned=!1,b.aliveCount=0);let u=(i>=6?5:i>=5?4:i>=4||i>=3?3:(i>=2,2))+Math.min(6,Math.max(0,l.length-1)*2);if(u=Math.min(12,u),a)for(const b of this.groups.values()){if(u<=0)break;if(!b||b.isWiped||b.spawned)continue;let x=null;for(const h of f){if(!h||!(h.z|0)||(h.z|0)!==(b.zone|0))continue;const g=b.center.x-h.p.x,v=b.center.y-h.p.y,k=g*g+v*v,R=b.activationDist||4500;if(k<=R*R){x=h.p;break}}x&&(this.spawnGroup(b,x),u--)}if(a&&this.groups.size>0){const g=[];for(const v of this.groups.values()){if(!v||!v.spawned||v.isWiped)continue;let k=1/0;for(const R of f){if(!R||!(R.z|0))continue;const P=v.center.x-R.p.x,A=v.center.y-R.p.y,T=P*P+A*A;if(T<k&&(k=T),k<=324e6)break}if(k<=324e6){v._farSince=0;continue}v._farSince||(v._farSince=o.time),o.time-v._farSince>=8&&(g.push(v.id),v.spawned=!1,v.aliveCount=0,v._farSince=0)}if(g.length){const v=new Set(g);for(let k=t.length-1;k>=0;k--){const R=t[k];!R||!R.groupId||v.has(R.groupId)&&t.splice(k,1)}}}if(a&&u>0){const b=f.filter(h=>h&&(h.z|0)!==0),x=b.length;if(x>0){this._densityCursor==null&&(this._densityCursor=0);const h=Math.min(x,2);for(let g=0;g<h&&u>0;g++){const v=b[(this._densityCursor+g)%x],k=v.p,R=v.z|0,P=8200,A=P*P;let T=0;const S=R>=6?32:R>=5?28:R>=4?24:R>=3?20:R>=2?16:12;for(const w of t){if(!w||w.dead)continue;const M=w.x-k.x,B=w.y-k.y;if(M*M+B*B<=A&&(T++,T>=S))break}if(T<S){const w=[];for(const H of this.groups.values()){if(!H||H.spawned||H.isWiped||(H.zone|0)!==R)continue;const N=H.center.x-k.x,$=H.center.y-k.y,F=N*N+$*$;F<=196e6&&w.push({g:H,d2:F})}w.sort((H,N)=>H.d2-N.d2);let I=0;const L=R<=2?1:R<=4?2:3;for(const H of w)if(u<=0||T>=S||(this.spawnGroup(H.g,k),u--,I++,T+=H.g.aliveCount||0,I>=L))break}}this._densityCursor=(this._densityCursor+h)%x}}const c=f.filter(b=>b&&(b.z|0)===6);if(c.length&&Array.isArray(pn))for(let x=0;x<pn.length;x++){const h=pn[x];if(!h)continue;const g=t.some(P=>P&&P.isZone6CornerBoss&&P.cornerIndex===x);if(this.cornerBossAlive[x]=g,g||o.time<(this.cornerBossNextRespawnAt[x]||0))continue;let v=null;for(const P of c){const A=h.x-P.p.x,T=h.y-P.p.y;if(A*A+T*T<=14e3*14e3){v=P.p;break}}if(!v)continue;const k=Zn(6,{x:h.x,y:h.y});k.isZone6CornerBoss=!0,k.cornerIndex=x,k.name="Corner Boss",k.hp*=4.8,k.maxHp*=4.8,k.damage*=2,k.speed*=1.05,k.radius*=1.15,k.xpValue*=3;const R=k.onDeath;k.onDeath=(P,A)=>{R&&R(P,A);const T=["damage","attackSpeed","moveSpeed","regen","shield"],S=T[Math.floor(Math.random()*T.length)];A.buffs.push({type:S,timeLeft:S==="regen"?18:S==="shield"?10:25,multiplier:.35,amount:S==="regen"?6:0})},this.ensureEnemyId(k),Ne(k,6,v&&v.level||1),t.push(k),this.cornerBossAlive[x]=!0}if(c.length&&!this.superBossSpawned&&!t.some(x=>x&&x.isZone6SuperBoss)){const x=this.superBossPoint||je(6);let h=1;for(const v of c)h=Math.max(h,v.p&&v.p.level||1);const g=Mo(6,{x:x.x,y:x.y});this.ensureEnemyId(g),Ne(g,6,h),t.push(g),this.superBossSpawned=!0}const m=o.progression&&o.progression.resurrectedTier||1,d=Math.max(2,Math.min(5,(m|0)+1));if(!this.guardianSpawned&&qt(o.progression)){const b=f.filter(x=>x&&(x.z|0)===d);if(b.length&&!t.some(h=>h&&(h.isResGuardian||h.isResurrectionGuardian||h.type==="resurrectionGuardian"))){const h=b[0].p,g=Math.random()*Math.PI*2,v=900+Math.random()*400,k=h.x+Math.cos(g)*v,R=h.y+Math.sin(g)*v,P=ko(d,{x:k,y:R});this.ensureEnemyId(P),Ne(P,d,h&&h.level||1),t.push(P),this.guardianSpawned=!0}}if(this.roamingTimer+=n,!t.some(b=>b&&b.isRoamingBoss)&&a){if((i|0)<2)return;const b=Math.max(2,Math.min(6,i|0)),x=30+b*10;if(this.roamingTimer>=x){this.roamingTimer=0;let h=null;for(const k of f)if(!(!k||!(k.z|0))&&(k.z|0)===b){h=k.p;break}if(!h){const k=f.find(R=>R&&(R.z|0)!==0);h=k?k.p:l[0]}let g=je(b);for(let k=0;k<30;k++){let R=!0;for(const P of f){if(!P||!(P.z|0))continue;const A=g.x-P.p.x,T=g.y-P.p.y;if(A*A+T*T<1400*1400){R=!1;break}}if(R)break;g=je(b)}const v=Zn(b,{x:g.x,y:g.y});this.ensureEnemyId(v),Ne(v,b,h&&h.level||1),t.push(v)}}}}function To(e,n){const o=n.canvas,t=n.player,r=n.progression,s=n.runScore||0,l=n.buffs||[],f=o.width,i=o.height;e.save();const p=Math.min(f,i)<700?.7:1;e.scale(p,p);const u=1/p,c=f*u,m=i*u,d=16,y=16,b=260,x=96;e.fillStyle="rgba(0,0,0,0.35)",e.fillRect(d,y,b,x);const h=t.hp/t.maxHP,g=d+8,v=y+8,k=200,R=16;e.fillStyle="#ff4b6e",e.fillRect(g,v,k*h,R),e.strokeStyle="#ffffff",e.strokeRect(g,v,k,R),e.fillStyle="#ffffff",e.font="14px sans-serif",e.textAlign="left",e.fillText("HP: "+Math.max(0,Math.round(t.hp))+" / "+Math.round(t.maxHP),g,v-4);const P=r&&typeof r.nickname=="string"&&r.nickname.trim().length?r.nickname.trim().slice(0,16):"Player";e.textAlign="right",e.fillText(P,d+b-8,v-4),e.textAlign="left";const A=t.xp/t.xpToNext(),T=v+24;if(n.net&&n.net.status==="connected"){const V=(n.net.roomCode||(r==null?void 0:r.roomCode)||"").toString().trim();V&&(e.fillStyle="rgba(255,255,255,0.78)",e.font="12px sans-serif",e.textAlign="right",e.fillText(`Room ${V}`,d+b-8,T-6),e.font="14px sans-serif",e.textAlign="left")}e.fillStyle="#3bd1ff",e.fillRect(g,T,k*A,10),e.strokeStyle="#ffffff",e.strokeRect(g,T,k,10),e.fillStyle="#ffffff",e.fillText("Lv "+t.level,g+208,T+10);const S=Ie(t.x,t.y),w=T+20,M=w+16;e.fillText("Zone "+S,g,w);const B=t.runSkills||{};e.fillText(`Skills Shot:${B.bullets||0} Bombs:${B.bombs||0} Rockets:${B.rockets||0} Laser:${B.laser||0} Chain:${B.lightning||0}`,g+120,w),e.fillText("Score: "+Math.floor(s),g,M);const I=(t.metaHpRegen||0)+(t.runHpRegen||0);I>0&&e.fillText("HP Regen: "+I.toFixed(2)+" HP/s",g+120,M);let L=c-32;const H=m-40;for(let V=0;V<l.length;V++){const j=l[V];e.fillStyle=Io(j.type),e.beginPath(),e.arc(L,H,10,0,Math.PI*2),e.fill(),L-=26}const N=40,$=16,F=c-N-$,Q=$;if(e.fillStyle=n.paused?"rgba(255,80,80,0.9)":"rgba(0,0,0,0.6)",e.fillRect(F,Q,N,N),e.strokeStyle="#ffffff",e.strokeRect(F,Q,N,N),e.fillStyle="#ffffff",e.font="18px sans-serif",e.textAlign="center",e.textBaseline="middle",n.paused)e.fillText("â–¶",F+N/2,Q+N/2+1);else{const G=F+N/2,Y=Q+10,O=Q+N-10;e.beginPath(),e.moveTo(G-6/2-6,Y),e.lineTo(G-6/2-6,O),e.moveTo(G+6/2+6,Y),e.lineTo(G+6/2+6,O),e.stroke()}n._pauseButtonRect={x:F*p,y:Q*p,w:N*p,h:N*p};const he=(n._runUpPending!=null?n._runUpPending:t._pendingLevelUps||0)|0;if(he>0){const G=c-112-$,Y=Q+N+10,O=!!n._runUpReady;if(e.fillStyle=O?"rgba(80,160,255,0.9)":"rgba(0,0,0,0.45)",e.fillRect(G,Y,112,40),e.strokeStyle="#ffffff",e.strokeRect(G,Y,112,40),e.fillStyle="#ffffff",e.textAlign="center",e.textBaseline="middle",e.font="12px sans-serif",e.fillText(`UPGRADE x${he}`,G+112/2,Y+40/2-6),O)e.font="11px sans-serif",e.fillText("press U",G+112/2,Y+40/2+10);else{e.font="11px sans-serif";const K=n._runUpBlockReason||"";if(K==="combat"){const ye=Math.max(0,Number(n._runUpReadyIn||0));e.fillText(`${ye.toFixed(1)}s`,G+112/2,Y+40/2+10)}else K==="enemies"?e.fillText("DANGER",G+112/2,Y+40/2+10):e.fillText("â€¦",G+112/2,Y+40/2+10)}n._runUpgradeButtonRect={x:G*p,y:Y*p,w:112*p,h:40*p}}else n._runUpgradeButtonRect=null;if(n.mode==="playing"&&n.paused){let un=function(fn,dn,Ut,Nt){const Et=Lt===Nt;e.fillStyle=Et?"rgba(80,160,255,0.9)":"rgba(0,0,0,0.6)",e.fillRect(fn,dn,O,K),e.strokeStyle="#ffffff",e.strokeRect(fn,dn,O,K),e.fillStyle="#ffffff",e.textAlign="center",e.textBaseline="middle",e.font="16px sans-serif",e.fillText(Ut,fn+O/2,dn+K/2)};var me=un;const V=c*.7,j=130,G=(c-V)/2,Y=m*.2;e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(G,Y,V,j),e.strokeStyle="#ffffff",e.strokeRect(G,Y,V,j),e.fillStyle="#ffffff",e.font="20px sans-serif",e.textAlign="center",e.textBaseline="top",e.fillText("Control System",G+V/2,Y+10);const O=V*.4,K=36,ye=12,ge=Y+60,we=G+V*.5-O-ye*.5,Nn=G+V*.5+ye*.5,Lt=Dn?Dn():"oneHand";un(we,ge,"1-Hand","oneHand"),un(Nn,ge,"2-Hand","twoHand"),n._controlModeClassicRect={x:we*p,y:ge*p,w:O*p,h:K*p},n._controlModePortraitAutoRect={x:Nn*p,y:ge*p,w:O*p,h:K*p}}else n._controlModeClassicRect=null,n._controlModePortraitAutoRect=null;e.restore()}function Io(e){switch(e){case"damage":return"#ff4b7a";case"attackSpeed":return"#ffdd57";case"moveSpeed":return"#57ff9b";case"regen":return"#57c8ff";case"shield":return"#b857ff";case"ghost":return"#ffffff";default:return"#aaaaaa"}}let xe=[];const Ho=[{key:"attackSpeed",label:"Attack Speed Bonus",step:1},{key:"damage",label:"Damage Bonus",step:1},{key:"moveSpeed",label:"Move Speed Bonus",step:1},{key:"hp",label:"Max HP Bonus",step:1},{key:"hpRegen",label:"HP Regen",step:1},{key:"range",label:"Range Bonus",step:1},{key:"pickupRadius",label:"Pickup Radius Bonus",step:1},{key:"score",label:"Score Bonus",step:1},{key:"xpGain",label:"XP Gain Bonus",step:1},{key:"critChance",label:"Crit Chance Bonus",step:1},{key:"critDamage",label:"Crit Damage Bonus",step:1},{key:"lifeSteal",label:"Life Steal",step:1}];function Bo(e){return Ho.filter(n=>{const o=He(e,n.key);return Number.isFinite(o)&&o>0})}function mn(e,n){const{canvas:o,progression:t,lastRunSummary:r}=n,s=o.width,l=o.height,i=Math.max(s,l)<900,a=s>=l,p=i?22:28,u=i?13:16,c=i?12:14;e.save(),e.fillStyle="rgba(0,0,0,0.75)",e.fillRect(0,0,s,l),e.fillStyle="#ffffff",e.font=p+"px sans-serif",e.textAlign="center";const m=i&&!a?l*.15:l*.12,d=n.mode==="stats";e.fillText(d?"STATS & UP":"YOU DIED",s/2,m),e.font=u+"px sans-serif";const y=r?r.runScore:Math.floor(n.runScore),b=r?r.totalScore:t.totalScore,x=r?r.gainedPoints:0;let h=m+u*1.8;if(d||(e.fillText("Score this run: "+y,s/2,h),h+=u*1.5),e.fillText("Total Score: "+b,s/2,h),h+=u*1.5,d||(e.fillText("Upgrade Points earned: +"+x,s/2,h),h+=u*1.5),e.fillText("Available Points: "+t.upgradePoints,s/2,h),d){h+=u*1.5;const I=Re(t);e.fillText("Start level: "+I,s/2,h)}const g=t.limits||{},v=t.resurrectedTier||1,k=pt(g),R=ht(v),P=R>0?Math.round(k/R*100):0;h+=u*1.5,e.fillText("R-Tier: "+v+" (Used Points: "+k+" / "+R+") "+P+"%",s/2,h),xe=[];function A(I,L){if(I.key==="hpRegen"){const H=(L*.25).toFixed(2);return`${I.label}: ${H} HP/s`}else if(I.key==="attackSpeed"||I.key==="damage"||I.key==="range"){const H=(L*2).toFixed(2);return`${I.label}: +${H}%`}else if(I.key==="moveSpeed"){const H=(L*1).toFixed(2);return`${I.label}: +${H}%`}else if(I.key==="xpGain"){const H=(L*.5).toFixed(2);return`${I.label}: +${H}%`}else if(I.key==="score"){const H=(L*2).toFixed(2);return`${I.label}: +${H}%`}else if(I.key==="hp"){const H=(L*5).toFixed(0);return`${I.label}: +${H} HP`}else if(I.key==="pickupRadius"){const H=(L*1).toFixed(0);return`${I.label}: +${H} radius`}else if(I.key==="critChance"){const H=(L*.1).toFixed(2);return`${I.label}: +${H}%`}else if(I.key==="critDamage"){const H=(L*1).toFixed(2);return`${I.label}: +${H}%`}else if(I.key==="lifeSteal"){const H=(L*.1).toFixed(2);return`${I.label}: +${H}%`}return`${I.label}: ${L}`}const T=Bo(v);e.font=c+"px sans-serif",e.textAlign="left";let S=h;if(i&&!a){const I=h+c*2,L=c*1.9,H=s*.08,N=H,$=s-H-40;let F=I;for(const Q of T){const he=g[Q.key]??0,me=A(Q,he);e.textAlign="left",e.fillStyle="#ffffff",e.fillText(me,N,F);const V={x:$,y:F-16,w:40,h:24,key:Q.key,step:Q.step,type:"upgrade"},j=He(v,Q.key),G=Number.isFinite(j)&&he>=j,Y=t.upgradePoints>0&&!G;if(e.fillStyle=Y?"#3cff9f":"#555555",e.fillRect(V.x,V.y,V.w,V.h),e.fillStyle="#000000",e.textAlign="center",e.fillText("+",V.x+V.w/2,V.y+17),Number.isFinite(j)){e.textAlign="right",e.fillStyle="#ffffff";const O=`${he}/${j}`;e.fillText(O,V.x-6,F-2)}xe.push(V),F+=L}S=F}else{const I=h+c*2,L=c*1.9,H=T.slice(0,6),N=T.slice(6),$=s*.1,F=s*.38,Q=s*.55,he=s*.83;let me=I,V=I;for(const j of H){const G=g[j.key]??0,Y=A(j,G);e.textAlign="left",e.fillStyle="#ffffff",e.fillText(Y,$,me);const O={x:F,y:me-16,w:40,h:24,key:j.key,step:j.step,type:"upgrade"},K=He(v,j.key),ye=Number.isFinite(K)&&G>=K,ge=t.upgradePoints>0&&!ye;if(e.fillStyle=ge?"#3cff9f":"#555555",e.fillRect(O.x,O.y,O.w,O.h),e.fillStyle="#000000",e.textAlign="center",e.fillText("+",O.x+O.w/2,O.y+17),Number.isFinite(K)){e.textAlign="right",e.fillStyle="#ffffff";const we=`${G}/${K}`;e.fillText(we,O.x-6,me-2)}xe.push(O),me+=L}for(const j of N){const G=g[j.key]??0,Y=A(j,G);e.textAlign="left",e.fillStyle="#ffffff",e.fillText(Y,Q,V);const O={x:he,y:V-16,w:40,h:24,key:j.key,step:j.step,type:"upgrade"},K=He(v,j.key),ye=Number.isFinite(K)&&G>=K,ge=t.upgradePoints>0&&!ye;if(e.fillStyle=ge?"#3cff9f":"#555555",e.fillRect(O.x,O.y,O.w,O.h),e.fillStyle="#000000",e.textAlign="center",e.fillText("+",O.x+O.w/2,O.y+17),Number.isFinite(K)){e.textAlign="right",e.fillStyle="#ffffff";const we=`${G}/${K}`;e.fillText(we,O.x-6,V-2)}xe.push(O),V+=L}S=Math.max(me,V)}const w=40;let M=S+c*2;const B=i?16:32;if(M+w>l-B&&(M=l-B-w),d){const N=s/2-209,$={x:N,y:M,w:200,h:w,type:"back"},F={x:N+200+18,y:M,w:200,h:w,type:"start"};e.fillStyle="#333333",e.fillRect($.x,$.y,$.w,$.h),e.fillStyle="#ffffff",e.textAlign="center",e.fillText("BACK",$.x+$.w/2,$.y+26),e.fillStyle="#111111",e.fillRect(F.x,F.y,F.w,F.h),e.fillStyle="#3cff9f",e.fillText("START",F.x+F.w/2,F.y+26),xe.push($,F)}else{const L=Math.max(140,Math.min(200,Math.floor((s*.86-16)/2))),H=L*2+16,N=s/2-H/2,$={x:N,y:M,w:L,h:w,type:"menu"},F={x:N+L+16,y:M,w:L,h:w,type:"start"};e.fillStyle="#222222",e.fillRect($.x,$.y,$.w,$.h),e.fillStyle="#ffffff",e.textAlign="center",e.fillText("MENU/",$.x+$.w/2,$.y+26),e.fillStyle="#333333",e.fillRect(F.x,F.y,F.w,F.h),e.fillStyle="#ffffff",e.fillText("START",F.x+F.w/2,F.y+26),xe.push($,F)}e.restore()}function Ze(e,n,o){const t=xe.find(r=>e>=r.x&&e<=r.x+r.w&&n>=r.y&&n<=r.y+r.h);if(!t)return null;if(t.type==="upgrade"){const r=o.progression,s=r.limits||{};if(r.upgradePoints<=0)return null;const l=t.key,f=t.step,i=r.resurrectedTier||1,a=He(i,l),u=(s[l]??0)+f;return Number.isFinite(a)&&u>a?null:(s[l]=u,r.limits=s,r.upgradePoints-=1,ee(r),"upgrade")}return t.type==="start"?"start":t.type==="menu"?"menu":t.type==="back"?"back":null}let Mn=[];function qn(e,n){const{canvas:o,progression:t,lastRunSummary:r}=n,s=o.width,l=o.height,i=Math.max(s,l)<900,a=i?22:28,p=i?13:16;e.save(),e.fillStyle="rgba(0,0,0,0.85)",e.fillRect(0,0,s,l),e.fillStyle="#ffffff",e.font=a+"px sans-serif",e.textAlign="center",e.fillText("RESURRECTION",s/2,l/2-150),e.font=p+"px sans-serif";const u=r?r.runScore:Math.floor(n.runScore),c=r?r.totalScore:t.totalScore,m=r?r.gainedPoints:0,d=t.resurrectedTier||1;e.fillText("Guardian of Resurrection defeated!",s/2,l/2-120),e.fillText("Score this run: "+u,s/2,l/2-100),e.fillText("Total Score: "+c,s/2,l/2-80),e.fillText("Upgrade Points earned: +"+m,s/2,l/2-60),e.fillText("Current R-Tier: "+d,s/2,l/2-40),e.fillText("Resurrect to increase R-Tier (up to 15) and reset all meta-limits for a new build.",s/2,l/2-10),Mn=[];const y={x:s/2-140,y:l/2+40,w:120,h:36,type:"resurrect"},b={x:s/2+20,y:l/2+40,w:120,h:36,type:"skip"};e.strokeStyle="#00ff88",e.lineWidth=2,e.strokeRect(y.x,y.y,y.w,y.h),e.fillStyle="#00ff88",e.textAlign="center",e.fillText("RESURECT",y.x+y.w/2,y.y+24),e.strokeStyle="#ffffff",e.lineWidth=2,e.strokeRect(b.x,b.y,b.w,b.h),e.fillStyle="#ffffff",e.fillText("SKIP",b.x+b.w/2,b.y+24),Mn.push(y,b),e.restore()}function Kn(e,n,o){const t=Mn.find(r=>e>=r.x&&e<=r.x+r.w&&n>=r.y&&n<=r.y+r.h);return t?t.type==="resurrect"?(Jt(o.progression),o.flags&&(o.flags.resGuardianKilledThisRun=!1),"resurrect"):t.type==="skip"?(o.flags&&(o.flags.resGuardianKilledThisRun=!1),"skip"):null:null}function yn(e,n){const o=[],t=e.slice();for(let r=0;r<n&&t.length>0;r++){let s=0;for(const i of t)s+=Math.max(0,i.weight||0);if(s<=0){const i=Math.random()*t.length|0;o.push(t.splice(i,1)[0]);continue}let l=Math.random()*s,f=0;for(let i=0;i<t.length;i++)if(l-=Math.max(0,t[i].weight||0),l<=0){f=i;break}o.push(t.splice(f,1)[0])}return o}function Jn(e,n){const o=e&&e._metaSkillMeta&&typeof e._metaSkillMeta=="object"?e._metaSkillMeta:null,t=o?o[n]:0;return typeof t=="number"&&Number.isFinite(t)?Math.max(0,t|0):0}const Bn=[{key:"bullets",name:"Basic Shot",kind:"skill"},{key:"bombs",name:"Bombs",kind:"skill"},{key:"satellites",name:"Satellites",kind:"skill"},{key:"energyBarrier",name:"Energy Barrier",kind:"skill"},{key:"spirit",name:"Spirit",kind:"skill"},{key:"electricZone",name:"Electric Zone",kind:"skill"},{key:"laser",name:"Laser",kind:"skill"},{key:"lightning",name:"Chain Lightning",kind:"skill"},{key:"rockets",name:"Rockets",kind:"skill"}],Ln=[{key:"damage",name:"Damage",kind:"passive"},{key:"attackSpeed",name:"Attack Speed",kind:"passive"},{key:"moveSpeed",name:"Move Speed",kind:"passive"},{key:"hp",name:"Max HP",kind:"passive"},{key:"hpRegen",name:"HP Regen",kind:"passive"},{key:"range",name:"Range",kind:"passive"},{key:"pickupRadius",name:"Pickup Radius",kind:"passive"},{key:"xpGain",name:"XP Gain",kind:"passive"},{key:"critChance",name:"Crit Chance",kind:"passive"},{key:"critDamage",name:"Crit Damage",kind:"passive"},{key:"lifeSteal",name:"Life Steal",kind:"passive"}];function Xe(e){if(!e)return;const n=e.runSkills||{};e.runSkills={bullets:(n.bullets??1)|0,bombs:(n.bombs??0)|0,rockets:(n.rockets??0)|0,satellites:(n.satellites??0)|0,energyBarrier:(n.energyBarrier??0)|0,spirit:(n.spirit??0)|0,electricZone:(n.electricZone??0)|0,laser:(n.laser??0)|0,lightning:(n.lightning??0)|0},e.runEvolutions=e.runEvolutions||{};const o=e.runPassives||{};e.runPassives={damage:(o.damage??0)|0,attackSpeed:(o.attackSpeed??0)|0,moveSpeed:(o.moveSpeed??0)|0,hp:(o.hp??0)|0,hpRegen:(o.hpRegen??0)|0,range:(o.range??0)|0,pickupRadius:(o.pickupRadius??0)|0,xpGain:(o.xpGain??0)|0,critChance:(o.critChance??0)|0,critDamage:(o.critDamage??0)|0,lifeSteal:(o.lifeSteal??0)|0},Number.isFinite(e._runBaseMaxHP)||(e._runBaseMaxHP=Number.isFinite(e.maxHP)?e.maxHP:e.baseMaxHP||100),Sn(e)}function Sn(e){if(!e)return;const n=e.runPassives||{};e.runDamageMult=1+(n.damage||0)*.08,e.runAttackMult=1+(n.attackSpeed||0)*.05,e.runMoveMult=1+(n.moveSpeed||0)*.05,e.runRangeMult=1+(n.range||0)*.045,e.runPickupBonusRadius=(n.pickupRadius||0)*10,e.runXpGainMult=1+(n.xpGain||0)*.045,e.runCritChanceAdd=(n.critChance||0)*.015,e.runCritDamageMult=1+(n.critDamage||0)*.12,e.runLifeSteal=(n.lifeSteal||0)*.004,e.runHpRegen=(n.hpRegen||0)*.35;const o=(n.hp||0)*12,t=Number.isFinite(e._runBaseMaxHP)?e._runBaseMaxHP:e.maxHP||100;e.maxHP=t+o,e.hp>e.maxHP&&(e.hp=e.maxHP)}function vt(e,n=3){if(!e)return[];Xe(e);const o=e.runSkills||{},t=e.runPassives||{},r=e.level|0,s=[],l=[],f={bullets:10,bombs:10,rockets:10,satellites:10,energyBarrier:10,spirit:10,electricZone:10,laser:10,lightning:10},i=e.runEvolutions||{},p=["bullets","bombs","satellites","energyBarrier","spirit","electricZone","laser","lightning","rockets"].reduce((d,y)=>d+((o[y]||0)>0?1:0),0);!i.rocketFusion&&(o.bullets|0)>=f.bullets&&(o.bombs|0)>=f.bombs&&(o.rockets|0)<=0&&s.push({id:"evo:rocketFusion",kind:"evolution",key:"rocketFusion",name:"Fuse â†’ Rockets",from:"MAX",to:"Rockets",weight:999});for(const d of Bn){const y=`skill:${d.key}`,b=Jn(e,y);if(d.key!=="bullets"&&b<=0||i.rocketFusion&&(d.key==="bullets"||d.key==="bombs")||d.key==="laser"&&r<6||d.key==="lightning"&&r<8)continue;const x=o[d.key]|0;if(d.key==="rockets"&&x<=0&&!i.rocketFusion)continue;const h=f[d.key]||9999;if(x>=h)continue;const g=d.key==="bullets";let v;if(g?v=1:x<=0?v=d.key==="bombs"?9:6:v=Math.max(1.6,3.6-(x-1)*.14),b>1){const R=1+Math.min(.6,(b-1)*.12);v*=R}const k=d.key==="energyBarrier"||d.key==="spirit"||d.key==="electricZone";!g&&x<=0&&!k&&(p>=3?v*=.12:p>=2&&(v*=.25)),s.push({id:`skill:${d.key}`,kind:"skill",key:d.key,name:d.name,from:x,to:x+1,weight:v})}for(const d of Ln){const y=d.key,b=`passive:${y}`,x=Jn(e,b);if(x<=0||(y==="critChance"||y==="critDamage")&&r<8||y==="lifeSteal"&&r<12||y==="xpGain"&&r<4)continue;const h=t[y]|0;let g=h<=0?3.2:Math.max(.8,2.6-h*.12);if(x>1){const v=1+Math.min(.5,(x-1)*.1);g*=v}y==="damage"&&(g*=1.1),y==="hp"&&(g*=1.05),y==="pickupRadius"&&(g*=.9),y==="xpGain"&&(g*=.85),y==="range"&&(g*=.95),y==="hpRegen"&&(g*=.9),(y==="critChance"||y==="critDamage")&&(g*=.75),y==="lifeSteal"&&(g*=.6),l.push({id:`passive:${y}`,kind:"passive",key:y,name:d.name,from:h,to:h+1,weight:g})}const c=(o.bombs||0)>0||(o.satellites||0)>0||(o.energyBarrier||0)>0||(o.spirit||0)>0||(o.electricZone||0)>0||(o.laser||0)>0||(o.lightning||0)>0||(o.rockets||0)>0,m=[];if(n>=1&&s.length){const d=s.find(y=>y.kind==="evolution");d?m.push(d):m.push(...yn(s,1))}if(n>=2&&l.length){const d=yn(l,1);d.length&&m.push(d[0])}for(;m.length<n;){const d=[...s,...l].filter(b=>!m.some(x=>x.id===b.id));if(d.length<=0)break;const y=yn(d,1);if(!y.length)break;m.push(y[0])}if(!c&&!m.some(y=>y.kind==="skill"&&y.key!=="bullets")){const y="bombs",b=s.find(x=>x.kind==="skill"&&x.key===y);if(b){const x=m.findIndex(h=>h.kind!=="skill");x>=0?m[x]=b:m.length>0&&(m[m.length-1]=b)}}for(const d of m)d.desc=Lo(e,d);return m}function xt(e,n){if(!(!e||!n)){if(Xe(e),n.kind==="evolution"){n.key==="rocketFusion"&&(e.runEvolutions=e.runEvolutions||{},e.runEvolutions.rocketFusion=!0,e.runSkills.bullets=0,e.runSkills.bombs=0,e.runSkills.rockets=Math.max(e.runSkills.rockets|0,1),e.attackCooldown=0,e.rocketCooldown=0),Sn(e);return}n.kind==="skill"?e.runSkills[n.key]=(e.runSkills[n.key]|0)+1:n.kind==="passive"&&(e.runPassives[n.key]=(e.runPassives[n.key]|0)+1),Sn(e)}}function Lo(e,n){if(!e||!n)return"";if(n.kind==="evolution")return n.key==="rocketFusion"?"Fuse Basic Shot (MAX) + Bombs (MAX) â†’ Rockets (Lv1). Consumes both.":"Evolution";if(n.kind==="skill")return n.key==="bullets"?`Lv ${n.from} â†’ ${n.to}: +shot power / sometimes +extra bullets`:n.key==="bombs"?n.from<=0?"Unlock bombs (AoE)":`Lv ${n.from} â†’ ${n.to}: +damage / +AoE / faster`:n.key==="rockets"?n.from<=0?"Rockets (via fusion)":`Lv ${n.from} â†’ ${n.to}: +damage / +AoE / faster`:n.key==="laser"?n.from<=0?"Unlock laser beam":`Lv ${n.from} â†’ ${n.to}: +DPS / +range`:n.key==="lightning"?n.from<=0?"Unlock chain lightning":`Lv ${n.from} â†’ ${n.to}: +targets / +damage`:n.key==="satellites"?n.from<=0?"Orbiting satellites (contact damage)":`Lv ${n.from} â†’ ${n.to}: +count / +damage`:n.key==="energyBarrier"?n.from<=0?"Energy barrier (repel + pulse)":`Lv ${n.from} â†’ ${n.to}: +radius / +damage`:n.key==="spirit"?n.from<=0?"Summon a spirit (shoots enemies)":`Lv ${n.from} â†’ ${n.to}: +damage / faster`:n.key==="electricZone"?n.from<=0?"Electric zone (AoE pulses)":`Lv ${n.from} â†’ ${n.to}: +radius / +damage`:`Lv ${n.from} â†’ ${n.to}`;const o=n.key;return o==="damage"?"+10% damage (stacking)":o==="attackSpeed"?"+6% attack speed (stacking)":o==="moveSpeed"?"+5% move speed (stacking)":o==="hp"?"+12 Max HP (stacking)":o==="hpRegen"?"+0.35 HP/s (stacking)":o==="range"?"+6% range (stacking)":o==="pickupRadius"?"+10 pickup radius (stacking)":o==="xpGain"?"+6% XP gain (stacking)":o==="critChance"?"+1.5% crit chance (stacking)":o==="critDamage"?"+12% crit damage (stacking)":o==="lifeSteal"?"+0.4% life steal (stacking)":`Lv ${n.from} â†’ ${n.to}`}function Qn(e,n){const{buffs:o}=e,t=e.players&&e.players.length?e.players:e.player?[e.player]:[];let r=0,s=0,l=0,f=0,i=0,a=!1,p=!1;for(let c=o.length-1;c>=0;c--){const m=o[c];m.timeLeft-=n,m.type==="damage"&&(r+=m.multiplier||.3),m.type==="attackSpeed"&&(s+=m.multiplier||.3),m.type==="moveSpeed"&&(l+=m.multiplier||.3),m.type==="xpGain"&&(f+=m.multiplier||.4),m.type==="regen"&&(i+=m.amount||4),m.type==="shield"&&(a=!0),m.type==="ghost"&&(p=!0),m.timeLeft<=0&&o.splice(c,1)}e.tempXpGainBoost=Math.min(f,.6);function u(c,m,d){return!Number.isFinite(c)||c<=m?c:m+(c-m)*(d||.35)}for(const c of t){const m=c.metaDamageMult||1,d=c.metaAttackMult||1,y=c.metaMoveMult||1,b=c.runDamageMult||1,x=c.runAttackMult||1,h=c.runMoveMult||1,g=(c.baseDamage||4)*m*b,v=(c.baseAttackSpeed||2)*d*x;c.damage=g*(1+r);const k=v*(1+s);c.attackSpeed=u(k,6,.35),c.moveSpeed=(c.baseMoveSpeed||260)*y*h*(1+l);const R=(c.metaRangeMult||1)*(c.runRangeMult||1),P=u(R,2.2,.25);c._totalRangeMult=P,i>0&&(c.hp=Math.min(c.maxHP,c.hp+i*n)),c._shieldActive=a,c._ghostActive=p}}function kt(){const e=location.protocol==="https:"?"wss":"ws",n=location.hostname||"localhost";return`${e}://${n}:8080`}function Uo(e){try{return JSON.parse(e)}catch{return null}}function et(){const e={ws:null,url:null,status:"offline",error:null,playerId:null,roomCode:null,isHost:!1,maxPlayers:7,roomPlayers:[],ready:!1,pingMs:0,_pingSentAt:0,_pingTimer:0,latestSnapshot:null,latestPlayerState:null,remoteInputs:new Map,onMessage:null};function n(o){if(!(!e.ws||e.ws.readyState!==1))try{e.ws.send(JSON.stringify(o))}catch{}}return e.connect=function(t){if(e.ws&&(e.ws.readyState===0||e.ws.readyState===1))return;e.url=t||kt(),e.status="connecting",e.error=null,e.latestSnapshot=null,e.remoteInputs.clear();const r=new WebSocket(e.url);e.ws=r,r.onopen=()=>{e.status="connected",e.error=null},r.onmessage=s=>{const l=Uo(String(s.data));if(!(!l||!l.type)){if(l.type==="hello"){e.maxPlayers=l.maxPlayers||e.maxPlayers;return}if(l.type==="joined"&&(e.playerId=l.playerId,e.roomCode=l.roomCode,e.isHost=!!l.isHost,e.maxPlayers=l.maxPlayers||e.maxPlayers),l.type==="roomInfo"&&(e.roomPlayers=Array.isArray(l.players)?l.players:[]),l.type==="pong"){const f=performance.now()-(e._pingSentAt||performance.now());e.pingMs=Math.max(0,Math.round(f))}l.type==="snapshot"&&(e.latestSnapshot=l.snapshot),l.type==="pstate"&&(e.latestPlayerState=l.state),l.type==="input"&&l.from&&e.remoteInputs.set(String(l.from),l.input||{}),l.type==="error"&&(e.error=l.message||l.code||"error"),l.type==="hostLeft"&&(e.error="Host left",e.roomCode=null,e.playerId=null,e.isHost=!1,e.roomPlayers=[]),typeof e.onMessage=="function"&&e.onMessage(l)}},r.onclose=()=>{e.status="offline",e.ws=null,e.playerId=null,e.roomCode=null,e.isHost=!1,e.roomPlayers=[],e.latestSnapshot=null,e.remoteInputs.clear()},r.onerror=()=>{e.status="error",e.error="WS error"}},e.disconnect=function(){if(e.ws)try{e.ws.close()}catch{}e.ws=null,e.status="offline",e.error=null,e.playerId=null,e.roomCode=null,e.isHost=!1,e.roomPlayers=[],e.latestSnapshot=null,e.remoteInputs.clear()},e.host=function(t,r,s){n({type:"host",roomCode:t,nickname:r,avatarIndex:s})},e.join=function(t,r,s){n({type:"join",roomCode:t,nickname:r,avatarIndex:s})},e.fastJoin=function(t,r){n({type:"fastJoin",nickname:t,avatarIndex:r})},e.sendInput=function(t){n({type:"input",input:t})},e.sendSnapshot=function(t){n({type:"snapshot",snapshot:t})},e.sendPlayerState=function(t){n({type:"pstate",state:t})},e.startRun=function(){n({type:"startRun"})},e.setProfile=function(t,r){n({type:"setProfile",nickname:t,avatarIndex:r})},e.setReady=function(t){e.ready=!!t,n({type:"ready",ready:!!t})},e.sendMeta=function(t){n({type:"syncMeta",meta:t||null})},e.requestRespawn=function(t){n({type:"respawn",meta:t||null})},e.sendRunPause=function(t,r){n({type:"runPause",reason:t||"levelUp",by:r!=null?String(r):void 0})},e.sendRunResume=function(){n({type:"runResume"})},e.sendRunChoices=function(t,r,s){n({type:"runChoices",to:t!=null?String(t):"",choices:Array.isArray(r)?r:[],metaText:s||""})},e.sendRunPick=function(t){n({type:"runPick",choiceId:t||""}),e.sendRunRequest=function(){n({type:"runRequest"})}},e}let J=null,qe=null,Se=null;function No(){if(J)return J;const e=document.createElement("style");return e.textContent=`
    #runUpOverlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:60;
      background: rgba(0,0,0,0.55); backdrop-filter: blur(3px); }
    #runUpOverlay .panel{ width:min(980px, 96vw); max-height: 92vh; overflow:auto;
      border:1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 14px 16px;
      background: rgba(12,16,22,0.92); box-shadow: 0 12px 50px rgba(0,0,0,0.45); }
    #runUpOverlay .head{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
    #runUpOverlay h2{ margin:0; font-size: 18px; }
    #runUpOverlay .muted{ opacity:0.75; font-size:12px; line-height:1.25; }
    #runUpOverlay .cards{ display:flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    #runUpOverlay .card{ flex: 1; min-width: 240px; border-radius: 12px; padding: 12px 12px;
      border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.03);
      cursor:pointer; user-select:none; }
    #runUpOverlay .card:hover{ background: rgba(120,170,255,0.10); border-color: rgba(200,220,255,0.22); }
    #runUpOverlay .titleRow{ display:flex; align-items:baseline; justify-content:space-between; gap: 8px; }
    #runUpOverlay .name{ font-size: 14px; font-weight: 700; }
    #runUpOverlay .lvl{ font-size: 12px; opacity: 0.8; }
    #runUpOverlay .desc{ margin-top: 6px; font-size: 12px; opacity: 0.85; line-height: 1.3; }
    #runUpOverlay .hint{ margin-top: 10px; font-size: 12px; opacity: 0.72; }
    @media (max-width: 780px){ #runUpOverlay .cards{ flex-direction: column; } }
  `,document.head.appendChild(e),J=document.createElement("div"),J.id="runUpOverlay",J.innerHTML=`
    <div class="panel" tabindex="0">
      <div class="head">
        <div>
          <h2>Level Up</h2>
          <div class="muted">Choose one upgrade</div>
        </div>
        <div class="muted" id="runUpMeta"></div>
      </div>
      <div class="cards" id="runUpCards"></div>
      <div class="hint">Tip: press 1 / 2 / 3</div>
    </div>
  `,document.body.appendChild(J),J.querySelector(".panel").addEventListener("keydown",o=>{if(!J||J.style.display!=="flex")return;const t=o.key;if(t==="1"||t==="2"||t==="3"){const r=t.charCodeAt(0)-49|0;Se&&Se[r]&&(o.preventDefault(),Mt(Se[r]))}}),J}function Mt(e){if(typeof qe=="function"){const n=qe;qe=null,Qe(),n(e)}}function St(e,n,o){if(typeof document>"u")return;No(),qe=o,Se=Array.isArray(e)?e.slice(0,3):[];const t=J.querySelector("#runUpCards"),r=J.querySelector("#runUpMeta");t.innerHTML="",r.textContent=n||"";for(let l=0;l<Se.length;l++){const f=Se[l],i=document.createElement("div");i.className="card",i.innerHTML=`
      <div class="titleRow">
        <div class="name">${l+1}. ${f.name}</div>
        <div class="lvl">Lv ${f.from} â†’ ${f.to}</div>
      </div>
      <div class="desc">${f.desc||""}</div>
    `,i.addEventListener("click",()=>Mt(f)),t.appendChild(i)}J.style.display="flex";const s=J.querySelector(".panel");try{s.focus()}catch{}}function Qe(){J&&(J.style.display="none",Se=null)}const Oe=10,nt={"skill:bullets":1,"skill:bombs":1,"skill:satellites":1,"skill:energyBarrier":0,"skill:spirit":0,"skill:electricZone":0,"skill:laser":0,"skill:lightning":0,"skill:rockets":0};function en(e,n,o){return e=e|0,Math.max(n,Math.min(o,e))}function te(e){if(!e||typeof e!="object")return e;Number.isFinite(e.coins)||(e.coins=0),e.coins=Math.max(0,Math.floor(e.coins)),(!e.skillMeta||typeof e.skillMeta!="object")&&(e.skillMeta={});const n=e.skillMeta;for(const o of Bn){const t=`skill:${o.key}`,r=t in nt?nt[t]:1;Number.isFinite(n[t])||(n[t]=r),n[t]=en(n[t],0,Oe)}for(const o of Ln){const t=`passive:${o.key}`;Number.isFinite(n[t])||(n[t]=1),n[t]=en(n[t],0,Oe)}return(!e.shopOffers||typeof e.shopOffers!="object")&&(e.shopOffers={active:[],passive:[],newSkills:[]}),Array.isArray(e.shopOffers.active)||(e.shopOffers.active=[]),Array.isArray(e.shopOffers.passive)||(e.shopOffers.passive=[]),Array.isArray(e.shopOffers.newSkills)||(e.shopOffers.newSkills=[]),Number.isFinite(e.shopRerollCount)||(e.shopRerollCount=0),e.shopRerollCount=Math.max(0,Math.floor(e.shopRerollCount)),e.skillMeta&&(e.skillMeta["skill:satellites"]|0)<=0&&(e.skillMeta["skill:satellites"]=1),e}function Eo(){const e=Bn.filter(t=>t&&t.kind==="skill").filter(t=>t.key!=="rockets").map(t=>({id:`skill:${t.key}`,key:t.key,kind:"skill",name:t.name||t.key})),n=Ln.filter(t=>t&&t.kind==="passive").map(t=>({id:`passive:${t.key}`,key:t.key,kind:"passive",name:t.name||t.key})),o=new Map;for(const t of[...e,...n])o.set(t.id,t);return{active:e,passive:n,byId:o}}const re=Eo();function le(e,n){const o=e==null?void 0:e.skillMeta,t=o&&typeof o=="object"?o[n]:0;return Number.isFinite(t)?en(t,0,Oe):0}function _t(e,n,o){!e||typeof e!="object"||(te(e),e.skillMeta[n]=en(o,0,Oe))}function nn(e,n){const o=e.startsWith("skill:"),t=o?50:30,r=o?35:22;if((n|0)<=0)return t;const s=r*Math.pow(1.55,Math.max(0,(n|0)-1));return Math.max(1,Math.round(s))}function Ke(e,n){if(!e||e.length===0)return null;for(let o=0;o<12;o++){const t=e[Math.random()*e.length|0];if(t&&!(n&&n.has(t.id)))return t}for(const o of e)if(o&&!(n&&n.has(o.id)))return o;return null}function We(e){te(e);const n=e.shopOffers,o=new Set;n.active=Array.isArray(n.active)?n.active.filter(Boolean).map(String):[],n.passive=Array.isArray(n.passive)?n.passive.filter(Boolean).map(String):[],n.newSkills=Array.isArray(n.newSkills)?n.newSkills.filter(Boolean).map(String):[],n.active=n.active.filter(s=>re.byId.has(s)),n.passive=n.passive.filter(s=>re.byId.has(s)),n.newSkills=n.newSkills.filter(s=>re.byId.has(s)),n.active=n.active.filter(s=>le(e,s)>0),n.newSkills=n.newSkills.filter(s=>le(e,s)<=0);const t=re.active.filter(s=>le(e,s.id)>0),r=re.active.filter(s=>le(e,s.id)<=0);for(const s of n.active)o.add(s);for(const s of n.passive)o.add(s);for(const s of n.newSkills)o.add(s);for(;n.active.length<3;){const s=Ke(t,o);if(!s)break;n.active.push(s.id),o.add(s.id)}for(;n.passive.length<3;){const s=Ke(re.passive,o);if(!s)break;n.passive.push(s.id),o.add(s.id)}for(;n.newSkills.length<3;){const s=Ke(r,o);if(!s)break;n.newSkills.push(s.id),o.add(s.id)}return n.active=n.active.slice(0,3),n.passive=n.passive.slice(0,3),n.newSkills=n.newSkills.slice(0,3),n}function Rt(e){te(e);const n=e.shopOffers;return n.active=[],n.passive=[],n.newSkills=[],We(e),e.shopRerollCount=(e.shopRerollCount|0)+1,n}function Pt(e,n,o){te(e);const t=We(e),r=re.active.filter(u=>le(e,u.id)>0),s=re.active.filter(u=>le(e,u.id)<=0),l=n==="passive"?t.passive:n==="new"?t.newSkills:t.active,f=n==="passive"?re.passive:n==="new"?s:r,i=new Set([...t.active,...t.passive,...t.newSkills||[]]),a=l[o];a&&i.delete(a);const p=Ke(f,i);return p?l[o]=p.id:l[o]=a||null,t}function wt(e){return re.byId.get(e)||null}function At(){return Oe}const Un=[{id:"shop",kind:"shop",name:"Merchant",emoji:"ðŸ›’",x:-150,y:0,r:120},{id:"tier",kind:"tier",name:"Tier Master",emoji:"ðŸ§™",x:150,y:0,r:120}];function tt(e){if(!e||!Ve(e.x,e.y,10))return null;let n=null,o=1/0;for(const t of Un){const r=e.x-t.x,s=e.y-t.y,l=r*r+s*s,f=t.r||120;l<=f*f&&l<o&&(n=t,o=l)}return n}function Do(e,n){if(!n||n.mode!=="playing")return;const o=n.player;if(!(!o||!Ve(o.x,o.y,400)))for(const t of Un){e.save(),e.globalAlpha=.9;const r=46,s=54;e.beginPath(),e.strokeStyle="rgba(255,255,255,0.22)",e.lineWidth=4,e.arc(t.x,t.y,s,0,Math.PI*2),e.stroke(),e.font=r+"px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.fillText(t.emoji||"ðŸ™‚",t.x,t.y+2),e.globalAlpha=.75,e.font="16px sans-serif",e.fillStyle="rgba(255,255,255,0.9)",e.fillText(t.name||"",t.x,t.y+56),e.restore()}}function Fo(e,n,o){const t=o.camera,r=o.canvas,s=r.width,l=r.height,f=t.zoom||1,i=(e-s/2)/f+t.x,a=(n-l/2)/f+t.y;return{x:i,y:a}}function Oo(e,n){for(const o of Un){const t=e-o.x,r=n-o.y,s=(o.r||120)*.9;if(t*t+r*r<=s*s)return o}return null}function Vo(e,n,o){vn();try{te(o)}catch{}const t={canvas:e,ctx:n,progression:o,mode:"startMenu",paused:!1,player:null,players:[],camera:null,enemies:[],projectiles:[],rockets:[],xpOrbs:[],buffs:[],floatingTexts:[],popups:[],flags:{resGuardianKilledThisRun:!1},runScore:0,lastRunSummary:null,spawnSystem:null,time:0,currentZone:1,_laserVisual:null,_lightningVisual:null,_pauseButtonRect:null,players:[],net:null,_netLastInputSentAt:0,_netLastSnapshotSentAt:0,_netLastAppliedSnapshotAt:0,_netLastAppliedPStateAt:0,meta:{xpGainMult:1,scoreMult:1,pickupBonusRadius:0},net:et(),_netLastInputSendAt:0,_netLastSnapshotSendAt:0,overlayMode:null,_deathHandled:!1,_waitingRespawnAck:!1,_netMetaById:new Map,_runUpNet:{sessions:new Map}};t.net=et();try{const u=new URLSearchParams(location.search||""),c=u.get("code")||u.get("room");if(c&&t.progression){const m=c.toString().trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,8);m&&(t.progression.roomCode=m)}}catch{}ve(t),t.mode="startMenu",t.paused=!1,t.net.onMessage=u=>{var c,m,d,y,b,x,h,g,v,k,R,P;if(u.type==="joined"){try{const A=(u.roomCode||"").toString().trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,8);A&&t.progression&&(t.progression.roomCode=A,ee(t.progression),t.popups&&t.popups.push({text:`Room: ${A}`,time:6}))}catch{}t.net.isHost?(t.player&&(t.player.id=String(t.net.playerId),t.player.color=fe(t.player.id),t.player.nickname=((c=t.progression)==null?void 0:c.nickname)||t.player.nickname,typeof((m=t.progression)==null?void 0:m.avatarIndex)=="number"&&(t.player.avatarIndex=t.progression.avatarIndex|0)),_n(t),t.mode="playing",t.paused=!1):(t.player&&t.net.playerId&&(t.player.id=String(t.net.playerId),t.player.color=fe(t.player.id),t.player.nickname=((d=t.progression)==null?void 0:d.nickname)||t.player.nickname,typeof((y=t.progression)==null?void 0:y.avatarIndex)=="number"&&(t.player.avatarIndex=t.progression.avatarIndex|0)),t.mode="playing",t.paused=!1),t.net&&t.net.status==="connected"&&!t.net.isHost&&t.net.sendMeta(Ee(t.progression))}if(u.type==="roomInfo"&&t.net.isHost&&_n(t),u.type==="hostLeft"){if(t.net.isHost)return;t._runUpgradeActive=!1;try{Qe()}catch{}t.player&&(t.player._lvlUpChoosing=!1,t.player._lvlUpInvuln=!1),t.overlayMode=null,t.mode="startMenu",t.paused=!1;return}if(u.type==="syncMeta"){if(!t.net.isHost)return;const A=String(u.from||"");if(!A)return;const T=u.meta||null;T&&t._netMetaById.set(A,T);const S=_e(t,A);S&&T&&tn(t,S,T);return}if(u.type==="respawn"){if(!t.net.isHost)return;const A=String(u.from||"");if(!A)return;const T=u.meta||null;T&&t._netMetaById.set(A,T);const S=_e(t,A);S&&(S._netRespawnRequested=!0);return}if(u.type==="startRun"){if(t.net.isHost)return;ve(t),t.player&&t.net.playerId&&(t.player.id=String(t.net.playerId),t.player.color=fe(t.player.id),t.player.nickname=((b=t.progression)==null?void 0:b.nickname)||t.player.nickname,typeof((x=t.progression)==null?void 0:x.avatarIndex)=="number"&&(t.player.avatarIndex=t.progression.avatarIndex|0)),t.mode="playing",t.paused=!1,t.net&&(t.net.latestSnapshot=null,t.net.latestPlayerState=null),t.enemies=[],t.projectiles=[],t.rockets=[],t.xpOrbs=[],t.buffs=[],t.floatingTexts=[],t.popups=[];return}if(u.type==="runPause"){if(t.net.isHost)return;const A=(h=t.net)!=null&&h.playerId?String(t.net.playerId):(g=t.player)!=null&&g.id?String(t.player.id):"local",T=u.by!=null?String(u.by):"";if(T&&T!==A)return;t._runUpgradeActive=!0,t.player&&(t.player._lvlUpChoosing=!0,t.player._lvlUpInvuln=!0,t.player.vx=0,t.player.vy=0);return}if(u.type==="runResume"){if(t.net.isHost)return;t._runUpgradeActive=!1;try{Qe()}catch{}t.player&&(t.player._lvlUpChoosing=!1,t.player._lvlUpInvuln=!1);return}if(u.type==="runChoices"){if(t.net.isHost)return;const A=(v=t.net)!=null&&v.playerId?String(t.net.playerId):(k=t.player)!=null&&k.id?String(t.player.id):"local",T=u.to!=null?String(u.to):"";if(T&&T!==A)return;const S=Array.isArray(u.choices)?u.choices:[];if(!S.length)return;t._runUpgradeActive=!0,t.player&&(t.player._lvlUpChoosing=!0,t.player._lvlUpInvuln=!0,t.player.vx=0,t.player.vy=0),St(S,u.metaText||`Lv ${((R=t.player)==null?void 0:R.level)||0}`,w=>{t.net&&t.net.status==="connected"&&(t.net.sendRunPick((w==null?void 0:w.id)||""),t.player&&(t.player._pendingLevelUps=Math.max(0,(t.player._pendingLevelUps||0)-1))),t._runUpgradeActive=!1,t.player&&(t.player._lvlUpChoosing=!1,t.player._lvlUpInvuln=!1)});return}if(u.type==="runRequest"){if(!((P=t.net)!=null&&P.isHost))return;const A=String(u.from||"");if(!A)return;t._runUpNet||(t._runUpNet={sessions:new Map,requests:new Map}),t._runUpNet.requests||(t._runUpNet.requests=new Map),t._runUpNet.requests.set(A,t.time||0);return}if(u.type==="runPick"){if(!t.net.isHost)return;const A=String(u.from||""),T=String(u.choiceId||"");if(!A||!T)return;Zo(t,A,T);return}};function r(u){var b,x;t.time+=u,t._hubNearbyNpc=null;const c=oe(t);if(c&&!t.net.isHost){if(t.mode!=="playing"&&t.net&&t.net.latestSnapshot&&(ve(t),t.player&&t.net.playerId&&(t.player.id=String(t.net.playerId),t.player.color=fe(t.player.id),t.player.nickname=((b=t.progression)==null?void 0:b.nickname)||t.player.nickname,typeof((x=t.progression)==null?void 0:x.avatarIndex)=="number"&&(t.player.avatarIndex=t.progression.avatarIndex|0)),t.mode="playing",t.paused=!1),t.mode==="playing"&&!t.paused&&!t._runUpgradeActive&&t.player&&typeof t.player.update=="function"&&t.player.hp>0&&!t.overlayMode&&!t.player._lvlUpChoosing&&t.player.update(u,t),Ye(t,u),t.mode==="playing"){if(Yo(t),t.net.latestPlayerState&&qo(t,t.net.latestPlayerState),t.net.latestSnapshot&&Jo(t,t.net.latestSnapshot),t.buffs)try{Qn(t,0)}catch{}ei(t,u),ni(t,u),t.camera&&t.player&&t.camera.update(t.player,u),!t.overlayMode&&t.player&&(t._hubNearbyNpc=tt(t.player)),it(t)}return}if(t.mode!=="playing"){Ye(t,u);return}if(t.paused){Ye(t,u);return}t._laserVisuals&&typeof t._laserVisuals.clear=="function"&&t._laserVisuals.clear(),t._lightningVisuals&&typeof t._lightningVisuals.clear=="function"&&t._lightningVisuals.clear(),t._laserVisual=null,t._lightningVisual=null,Qn(t,u),Go(t,u,c);const m=(t.player.metaHpRegen||0)+(t.player.runHpRegen||0);m>0&&t.player.hp>0&&(t.player.hp=Math.min(t.player.maxHP,t.player.hp+m*u));const d=Ie(t.player.x,t.player.y);d!==t.currentZone&&(t.currentZone=d,t.floatingTexts&&t.floatingTexts.push({x:t.player.x,y:t.player.y-80,text:d===0?"Hub":"Zone "+d,time:1.6}),t.popups&&t.popups.push({text:d===0?"Entered Hub":"Entered Zone "+d,time:2.4}),t.spawnSystem&&typeof t.spawnSystem.onZoneChanged=="function"&&t.spawnSystem.onZoneChanged(d)),Xo(t,u,c),t.spawnSystem.update(u);const y=new Map;for(const h of de(t))h&&y.set(String(h.id||"local"),h.hp);ri(t,u);for(const h of de(t)){if(!h)continue;const g=y.get(String(h.id||"local"));typeof g=="number"&&h.hp<g-1e-6&&(h._lastCombatAt=t.time)}Wo(t,u),ai(t,u),ci(t,u),c&&t.net&&t.net.isHost&&jo(t),Rn(t),ui(t,u),Ye(t,u),t.camera.update(t.player,u),!t.overlayMode&&t.player&&(t._hubNearbyNpc=tt(t.player)),c?(it(t),si(t),ti(t,u),oi(t,u)):xi(t)}function s(u){if(!!(oe(t)&&t.net&&t.net.isHost)&&t.mode==="playing"&&!t.paused){const d=.016666666666666666;t._simAcc=(t._simAcc||0)+u;const y=.25;t._simAcc>y&&(t._simAcc=y);let b=0;const x=10;for(;t._simAcc>=d&&b<x;)r(d),t._simAcc-=d,b++;b===0&&r(Math.min(u,d));return}r(u)}function l(){const{canvas:u,ctx:c,player:m}=t,d=u.width,y=u.height;if(c.clearRect(0,0,d,y),t.camera.applyTransform(c),di(t,c),Do(c,t),mi(t,c),pi(t,c),hi(t,c),yi(t,c),gi(t,c),bi(t,c),t.camera.resetTransform(c),fi(c,t),t.mode==="playing"&&To(c,t),vi(c,t),t.overlayMode==="resurrection"){qn(c,t);return}if(t.overlayMode==="upgrade"){mn(c,t);return}if(t.overlayMode==="stats"){mn(c,{...t,mode:"stats"});return}t.mode==="resurrection"?qn(c,t):t.mode==="upgrade"||t.mode==="stats"?mn(c,t):t.mode==="startMenu"||t.mode}function f(u,c){if(t.overlayMode==="resurrection"){const g=Kn(u,c,t);if(g==="resurrect"){applyResurrection(t.progression);try{ee(t.progression)}catch{}oe(t)&&t.net&&t.net.status==="connected"&&!t.net.isHost&&t.net.sendMeta(Ee(t.progression)),t.overlayMode="upgrade"}else g==="skip"&&(t.overlayMode="upgrade");return}if(t.overlayMode==="upgrade"){const g=Ze(u,c,t);if(g==="upgrade")oe(t)&&t.net&&t.net.status==="connected"&&!t.net.isHost&&t.net.sendMeta(Ee(t.progression));else if(g==="start")if(oe(t)){const v=Ee(t.progression);t.player&&(tn(t,t.player,v),t.net&&t.net.isHost&&(t.player.hp=t.player.maxHP,t.player.x=0,t.player.y=0,t.player.vx=0,t.player.vy=0)),t.net&&t.net.status==="connected"&&(t.net.isHost?t.player&&(t.player._netRespawnRequested=!0):t.net.requestRespawn(v)),t._waitingRespawnAck=!0,t._deathHandled=!0,t.overlayMode=null}else ve(t);else g==="menu"&&(t.overlayMode=null,t.mode="startMenu");return}if(t.overlayMode==="stats"){const g=Ze(u,c,{...t,mode:"stats"});g==="upgrade"?oe(t)&&t.net&&t.net.status==="connected"&&!t.net.isHost&&t.net.sendMeta(Ee(t.progression)):(g==="back"||g==="menu")&&(t.overlayMode=null);return}if(t.mode!=="startMenu"&&t.mode!=="settings"){if(t.mode==="stats"){const g=Ze(u,c,t);g==="back"?t.mode="startMenu":g==="start"&&ve(t);return}if(t.mode==="resurrection"){var m=Kn(u,c,t);(m==="resurrect"||m==="skip")&&(t.mode="upgrade");return}if(t.mode==="upgrade"){var d=Ze(u,c,t);d==="start"?ve(t):d==="menu"&&(t.mode="startMenu");return}if(t.mode==="playing"&&!t.overlayMode&&t._hubNearbyNpc){const g=Fo(u,c,t),v=Oo(g.x,g.y);if(v&&v.id===t._hubNearbyNpc.id){t._hubNpcTap=v.kind;return}}var y=t._runUpgradeButtonRect;if(t.mode==="playing"&&y&&u>=y.x&&u<=y.x+y.w&&c>=y.y&&c<=y.y+y.h){ot(t);return}var b=t._pauseButtonRect;if(b&&u>=b.x&&u<=b.x+b.w&&c>=b.y&&c<=b.y+b.h){t.paused=!t.paused;return}if(t.mode==="playing"&&t.paused){var x=t._controlModeClassicRect,h=t._controlModePortraitAutoRect;if(x&&u>=x.x&&u<=x.x+x.w&&c>=x.y&&c<=x.y+x.h){En("oneHand");return}if(h&&u>=h.x&&u<=h.x+h.w&&c>=h.y&&c<=h.y+h.h){En("twoHand");return}}}}function i(u,c){t.mode}function a(u,c){}function p(){if(typeof document>"u")return!1;const u=document.activeElement;if(!u)return!1;const c=(u.tagName||"").toLowerCase();return c==="input"||c==="textarea"||u.isContentEditable}return typeof window<"u"&&!t._runUpKeyBound&&(t._runUpKeyBound=!0,window.addEventListener("keydown",u=>{if(u.repeat||u.code!=="KeyU"||!t||t.mode!=="playing"||p()||t.overlayMode)return;ot(t)&&u.preventDefault()})),{state:t,get player(){return t.player},startOfflineRun(){var u,c;try{(c=(u=t.net)==null?void 0:u.disconnect)==null||c.call(u)}catch{}ve(t),t.mode="playing",t.overlayMode=null,t.paused=!1},update:s,render:l,handlePointerDown:f,handlePointerMove:i,handlePointerUp:a}}function ve(e){var s,l,f,i;try{te(e.progression)}catch{}const n=Re(e.progression);e.flags&&(e.flags.resGuardianKilledThisRun=!1);const o={x:0,y:0},t=new ln(o,n);t.id||(t.id=(s=e.net)!=null&&s.playerId?String(e.net.playerId):"local"),t.nickname=((l=e.progression)==null?void 0:l.nickname)||"Player",t.avatarIndex=((f=e.progression)==null?void 0:f.avatarIndex)||0,t._metaSkillMeta=((i=e.progression)==null?void 0:i.skillMeta)||{};const r=Ge(t,e.progression.limits);e.player=t,e.players=[t],e.meta={xpGainMult:(r==null?void 0:r.xpGainMult)??1,scoreMult:(r==null?void 0:r.scoreMult)??1,pickupBonusRadius:(r==null?void 0:r.pickupBonusRadius)??0},Xe(t),e.camera=new jt(e.canvas),e.currentZone=Ie(t.x,t.y),e.enemies=[],e.projectiles=[],e.rockets=[],e.xpOrbs=[],e.buffs=[],e.floatingTexts=[],e.popups=[],e.runScore=0,e.lastRunSummary=null,e._laserVisual=null,e._lightningVisual=null,e._runUpgradeActive=!1,e._runUpgradeChoices=null,e._runUpNet&&e._runUpNet.sessions&&typeof e._runUpNet.sessions.clear=="function"&&e._runUpNet.sessions.clear(),e._laserVisuals=new Map,e._lightningVisuals=new Map,e.spawnSystem=new Co(e),e.mode="playing",oe(e)&&e.net.isHost&&_n(e)}function oe(e){return!!(e.net&&e.net.status==="connected"&&e.net.roomCode)}function de(e){return e.players&&e.players.length?e.players:e.player?[e.player]:[]}function _e(e,n){if(!n)return null;const o=String(n);for(const t of de(e))if(t&&String(t.id)===o)return t;return null}function fe(e){const n=String(e);let o=0;for(let r=0;r<n.length;r++)o=o*31+n.charCodeAt(r)>>>0;return`hsl(${o%360}, 80%, 65%)`}function Ee(e){return e?{nickname:e.nickname||"Player",avatarIndex:e.avatarIndex||0,resurrectedTier:e.resurrectedTier||1,totalScore:e.totalScore||0,upgradePoints:e.upgradePoints||0,limits:e.limits||{},skillMeta:e.skillMeta||{}}:null}function tn(e,n,o){!n||!o||(typeof o.nickname=="string"&&(n.nickname=o.nickname),typeof o.avatarIndex=="number"&&(n.avatarIndex=o.avatarIndex|0),o.limits&&Ge(n,o.limits),o.skillMeta&&typeof o.skillMeta=="object"&&(n._metaSkillMeta=o.skillMeta))}function _n(e){var r,s;const n=Array.isArray(e.net.roomPlayers)?e.net.roomPlayers:[],o=new Set(n.map(l=>String(l.id)));e.player&&e.net.playerId&&(e.player.id=String(e.net.playerId),o.add(String(e.player.id)));for(const l of n){const f=String(l.id);if(_e(e,f)){const i=_e(e,f);i&&l.nickname&&(i.nickname=l.nickname),i&&typeof l.avatarIndex=="number"&&(i.avatarIndex=l.avatarIndex|0)}else{const i=new ln({x:0,y:0},Re(e.progression));i.id=f;const a=((r=e._netMetaById)==null?void 0:r.get(f))||null;i._metaSkillMeta=a&&a.skillMeta&&typeof a.skillMeta=="object"?a.skillMeta:((s=e.progression)==null?void 0:s.skillMeta)||{},i.nickname=l.nickname||`P${f}`,i.avatarIndex=l.avatarIndex||0,i.color=fe(f);const p=a;p?tn(e,i,p):Ge(i,e.progression.limits),Xe(i),e.players.push(i)}}const t=e.player?String(e.player.id):null;e.players=e.players.filter(l=>{if(!l)return!1;const f=String(l.id);return t&&f===t?!0:o.has(f)})}function $o(e,n,o,t){var y;if(!e||e.hp<=0)return;if(e._lvlUpChoosing){e.vx=0,e.vy=0;return}const r=Math.max(-1,Math.min(1,(n==null?void 0:n.mx)??0)),s=Math.max(-1,Math.min(1,(n==null?void 0:n.my)??0)),l=Math.hypot(r,s),f=l>.001?r/l:0,i=l>.001?s/l:0,a=e.moveSpeed||e.baseMoveSpeed||220;e.vx=f*a,e.vy=i*a,e.x+=e.vx*o,e.y+=e.vy*o;const p=(y=t.spawnSystem)!=null&&y.getWorldBounds?t.spawnSystem.getWorldBounds():null,u=((p==null?void 0:p.minX)??-Fn/2)+e.radius,c=((p==null?void 0:p.maxX)??Fn/2)-e.radius,m=((p==null?void 0:p.minY)??-On/2)+e.radius,d=((p==null?void 0:p.maxY)??On/2)-e.radius;e.x<u&&(e.x=u),e.x>c&&(e.x=c),e.y<m&&(e.y=m),e.y>d&&(e.y=d)}function Go(e,n,o){const t=de(e);if(o&&e.player&&e.net.playerId&&(e.player.id=String(e.net.playerId)),e.player&&typeof e.player.update=="function"){const r=!!(o&&e.overlayMode),s=!!e._runUpgradeActive||!!e.player._lvlUpChoosing;e.player.hp>0&&!r&&!s&&e.player.update(n,e)}if(!o){e.players=[e.player];return}if(e.net.isHost)for(const r of t){if(!r||String(r.id)===String(e.player.id))continue;const s=e.net.remoteInputs.get(String(r.id))||{};$o(r,s,n,e)}}function Xo(e,n,o){if(e.player){const t=!!(o&&e.overlayMode),r=!!e._runUpgradeActive||!!e.player._lvlUpChoosing;e.player.hp>0&&!t&&!r&&vo(e.player,e,n)}if(o&&e.net.isHost)for(const t of de(e)){if(!t||String(t.id)===String(e.player.id)||t.hp<=0||t._lvlUpChoosing)continue;const r=e.net.remoteInputs.get(String(t.id))||{},s=r==null?void 0:r.aim,l=s&&typeof s.x=="number"&&typeof s.y=="number"?s:null,f=typeof(r==null?void 0:r.fire)=="boolean"?r.fire:void 0;xo(t,e,n,{aimDir:l,firing:f})}}function Rn(e){const n=e==null?void 0:e.player,o=n&&n._pendingLevelUps||0;if(e._runUpPending=o,e._runUpReady=!1,e._runUpReadyIn=0,e._runUpBlockReason="",!e||e.mode!=="playing"||!n||n.hp<=0||e.overlayMode||e.paused||e._runUpgradeActive||o<=0)return;const t=3,r=e.time-(Number.isFinite(n._lastCombatAt)?n._lastCombatAt:-1/0);if(r<t){e._runUpReady=!1,e._runUpReadyIn=Math.max(0,t-r),e._runUpBlockReason="combat";return}e._runUpReady=!0}function Wo(e,n){if(!e||!e._repelUntil||e.time>=e._repelUntil)return;const o=e.player;if(!o)return;const t=Array.isArray(e.enemies)?e.enemies:[],r=520,s=r*r,l=980;for(const f of t){if(!f||f.hp<=0||f._remove)continue;const i=f.x-o.x,a=f.y-o.y,p=i*i+a*a;if(p<=1e-6||p>s)continue;const u=Math.sqrt(p),c=i/u,m=a/u,d=Math.max(0,Math.min(1,1-u/r)),y=l*(.25+.75*d);f.x+=c*y*n,f.y+=m*y*n}}function Ct(e){if(!e||e.mode!=="playing")return!1;if(e._runUpgradeActive)return!0;if(e.overlayMode||e.paused)return!1;const n=e.player;if(!n||n.hp<=0)return!1;const o=n._pendingLevelUps||0;if(o<=0)return!1;e._runUpgradeActive=!0,n._lvlUpChoosing=!0,n._lvlUpInvuln=!0,n.vx=0,n.vy=0,e._repelUntil=e.time+1.6;const t=vt(n,3);return e._runUpgradeChoices=t,St(t,`Lv ${n.level} Â· Pending ${o}`,r=>{if(xt(n,r),n._pendingLevelUps=Math.max(0,(n._pendingLevelUps||0)-1),(n._pendingLevelUps||0)>0){e._runUpgradeActive=!1,setTimeout(()=>{e.mode==="playing"&&Ct(e)},0);return}e._runUpgradeActive=!1,n._lvlUpChoosing=!1,n._lvlUpInvuln=!1}),!0}function ot(e){if(!e||e.mode!=="playing")return!1;if(e._runUpgradeActive)return!0;if(!!(oe(e)&&e.net&&!e.net.isHost)){if(Rn(e),e._runUpReady){const t=e.time||0;return t-(e._runUpLastReqAt||0)<.5?!0:(e._runUpLastReqAt=t,e.net&&e.net.status==="connected"&&typeof e.net.sendRunRequest=="function"?(e.net.sendRunRequest(),e.popups&&e.popups.push({text:"Upgrade requested",time:1}),!0):(e.popups&&e.popups.push({text:"Not connected",time:1.2}),!1))}if(e.popups){let t="Can't upgrade yet";e._runUpBlockReason==="combat"?t=`Upgrade: out of combat in ${Math.max(0,e._runUpReadyIn).toFixed(1)}s`:(e._runUpPending||0)<=0&&(t="No upgrades pending"),e.popups.push({text:t,time:1.3})}return!1}if(Rn(e),e._runUpReady)return Ct(e);if(e.popups){let t="Can't upgrade yet";e._runUpBlockReason==="combat"?t=`Upgrade: out of combat in ${Math.max(0,e._runUpReadyIn).toFixed(1)}s`:(e._runUpPending||0)<=0&&(t="No upgrades pending"),e.popups.push({text:t,time:1.3})}return!1}function jo(e){var s;if(!e||e.mode!=="playing"||!oe(e)||!((s=e.net)!=null&&s.isHost))return;e._runUpNet||(e._runUpNet={sessions:new Map,requests:new Map}),e._runUpNet.sessions||(e._runUpNet.sessions=new Map),e._runUpNet.requests||(e._runUpNet.requests=new Map);const n=e._runUpNet.sessions,o=e._runUpNet.requests,t=e.player?String(e.player.id):"",r=e.time||0;for(const l of de(e)){if(!l)continue;const f=String(l.id),i=l._pendingLevelUps||0;if(f===t){n.delete(f),o.delete(f);continue}if(l.hp<=0||i<=0){l._lvlUpChoosing&&(l._lvlUpChoosing=!1,l._lvlUpInvuln=!1),n.delete(f),o.delete(f);continue}const a=n.get(f);if(!a){if(l._lvlUpChoosing&&(l._lvlUpChoosing=!1,l._lvlUpInvuln=!1),!o.has(f))continue;const p=3;if(r-(Number.isFinite(l._lastCombatAt)?l._lastCombatAt:-1/0)<p)continue;const c=vt(l,3),m=`${l.nickname||"Player"} Â· Lv ${l.level} Â· Pending ${i}`;n.set(f,{choices:c,metaText:m,sentAt:r}),l._lvlUpChoosing=!0,l._lvlUpInvuln=!0,l.vx=0,l.vy=0,e.net&&e.net.status==="connected"&&e.net.sendRunChoices(f,c,m);continue}l._lvlUpChoosing=!0,l._lvlUpInvuln=!0,l.vx=0,l.vy=0,r-(a.sentAt||0)>2.5&&(a.sentAt=r,e.net&&e.net.status==="connected"&&e.net.sendRunChoices(f,a.choices,a.metaText))}}function Zo(e,n,o){var u;if(!e||!((u=e.net)!=null&&u.isHost))return;const t=String(n||"");if(!t)return;e._runUpNet||(e._runUpNet={sessions:new Map}),e._runUpNet.sessions||(e._runUpNet.sessions=new Map);const r=e._runUpNet.sessions;e._runUpNet.requests||(e._runUpNet.requests=new Map);const s=e._runUpNet.requests,l=r.get(t);if(!l)return;const f=_e(e,t);if(!f){r.delete(t);try{s.delete(t)}catch{}return}const i=Array.isArray(l.choices)?l.choices:[],a=i.find(c=>c&&c.id===o)||i[0];if(!a)return;xt(f,a),f._pendingLevelUps=Math.max(0,(f._pendingLevelUps||0)-1),r.delete(t);try{s.delete(t)}catch{}f._lvlUpChoosing=!1,f._lvlUpInvuln=!1;const p=e.player?String(e.player.id):"";if(t===p){e._runUpgradeActive=!1;try{Qe()}catch{}}}function Yo(e){if(e.mode!=="playing"||e.paused||e._runUpgradeActive)return;const n=e.time;if(n-(e._netLastInputSendAt||0)<.05)return;e._netLastInputSendAt=n;const o=e.player;if(!o||o.hp<=0||e.overlayMode||e.mode!=="playing")return;const t=ct();let r=t.x,s=t.y;if(Math.hypot(r,s)<.01){const i=rt();r=i.x,s=i.y}const l=ft(o,e.camera,e.canvas,e.enemies,yt(o),e.time),f={mx:r,my:s,aim:l?{x:l.x,y:l.y}:null,fire:ut()};e.net.sendInput(f)}function zo(e){const n=r=>Number.isFinite(r)?Math.round(r*10)/10:0,o=de(e),t=r=>{const s=(r==null?void 0:r.runSkills)||{};return[s.bullets|0,s.bombs|0,s.rockets|0,s.satellites|0,s.energyBarrier|0,s.spirit|0,s.electricZone|0,s.laser|0,s.lightning|0].join(",")};return{t:e.time,players:o.map(r=>{var s,l;return{id:String(r.id),x:n(r.x),y:n(r.y),vx:n(r.vx),vy:n(r.vy),hp:r.hp,maxHP:r.maxHP,level:r.level,weaponStage:r.weaponStage||1,range:n(Number.isFinite(r.range)?r.range:gt(r)),nickname:r.nickname||"",avatarIndex:r.avatarIndex||0,color:r.color||fe(r.id),aim:{x:n(((s=r.lastAimDir)==null?void 0:s.x)||0),y:n(((l=r.lastAimDir)==null?void 0:l.y)||0)},rs:t(r)}})}}function qo(e,n){var i,a,p,u;if(!n||typeof n!="object")return;const o=typeof n.t=="number"?n.t:null;if(o!=null){const c=typeof e._netLastAppliedPStateAt=="number"?e._netLastAppliedPStateAt:-1/0;if(o<=c+1e-6)return;e._netLastAppliedPStateAt=o}const t=(i=e.net)!=null&&i.playerId?String(e.net.playerId):(a=e.player)!=null&&a.id?String(e.player.id):"local";e._netCache||(e._netCache={players:new Map,enemies:new Map,projectilesById:new Map,rocketsById:new Map,projectiles:[],rockets:[],xpOrbs:[]});const r=e._netCache.players,s=e._netCache.playersArr||(e._netCache.playersArr=[]);s.length=0;const l=o??(e.time||0);for(const c of n.players||[]){const m=String(c.id);let d=r.get(m);if(!d){d=new ln({x:c.x||0,y:c.y||0},c.level||Re(e.progression)),d.id=m,d.color=c.color||fe(m),d.nickname=c.nickname||`P${m}`,d.avatarIndex=typeof c.avatarIndex=="number"?c.avatarIndex|0:0,Ge(d,e.progression.limits);const g=((p=e._netMetaById)==null?void 0:p.get(m))||null;d._metaSkillMeta=g&&g.skillMeta&&typeof g.skillMeta=="object"?g.skillMeta:((u=e.progression)==null?void 0:u.skillMeta)||{},Xe(d),d._netTx=d.x,d._netTy=d.y,r.set(m,d)}d._netSeenAt=l;const y=Number.isFinite(c.x)?c.x:d.x,b=Number.isFinite(c.y)?c.y:d.y;d._netTx=y,d._netTy=b,d._netVx=Number.isFinite(c.vx)?c.vx:d._netVx||0,d._netVy=Number.isFinite(c.vy)?c.vy:d._netVy||0;const x=y-d.x,h=b-d.y;if(x*x+h*h>500*500&&(d.x=y,d.y=b),d.hp=c.hp,d.maxHP=c.maxHP,d.level=c.level,typeof c.weaponStage=="number"&&(d.weaponStage=c.weaponStage),typeof c.range=="number"&&Number.isFinite(c.range)&&(d.range=c.range),d.nickname=c.nickname||d.nickname,d.avatarIndex=typeof c.avatarIndex=="number"?c.avatarIndex|0:d.avatarIndex,d.color=c.color||d.color,c.aim&&(d.lastAimDir.x=c.aim.x||0,d.lastAimDir.y=c.aim.y||0),typeof c.rs=="string"&&c.rs.length){const g=c.rs.split(",");if(g.length>=9){const v=g[0]|0,k=g[1]|0,R=g[2]|0,P=g[3]|0,A=g[4]|0,T=g[5]|0,S=g[6]|0,w=g[7]|0,M=g[8]|0;d.runSkills=d.runSkills||{},d.runSkills.bullets=v,d.runSkills.bombs=k,d.runSkills.rockets=R,d.runSkills.satellites=P,d.runSkills.energyBarrier=A,d.runSkills.spirit=T,d.runSkills.electricZone=S,d.runSkills.laser=w,d.runSkills.lightning=M}}s.push(d)}for(const[c,m]of r)(!m||m._netSeenAt!=l)&&r.delete(c);e.players=s;const f=s.find(c=>String(c.id)===t)||s[0]||e.player;if(e.player=f,e.net&&!e.net.isHost&&f){const c=f.level|0;if(typeof e._netLocalLevel!="number")e._netLocalLevel=c;else{const m=e._netLocalLevel|0;if(c<m&&(f._pendingLevelUps=0),c>m){const d=c-m;f._pendingLevelUps=(f._pendingLevelUps||0)+d,e.floatingTexts&&e.floatingTexts.push({x:f.x,y:f.y-30,text:"LEVEL UP!",time:1.2}),e.popups&&e.popups.push({text:d>1?`Level Up! +${d} (Lv ${c})`:`Level Up! Lv ${c}`,time:2})}e._netLocalLevel=c}}}function Ko(e){const n=h=>Number.isFinite(h)?Math.round(h*10)/10:0,o=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent:"",t=/Android|iPhone|iPad|iPod|Mobile/i.test(o),r=de(e),s=r.filter(h=>h&&h.hp>0),l=s.length?s:r,f=t?15e3:16500,i=f*f,a=(h,g)=>{let v=1/0;for(const k of l){if(!k)continue;const R=h-k.x,P=g-k.y,A=R*R+P*P;if(A<v&&(v=A),v<=1200*1200)break}return v},p=t?260:420,u=t?220:420,c=t?90:160,m=t?260:420,d=[];for(const h of e.enemies||[]){if(!h||h.dead)continue;const g=a(h.x,h.y);g>i||d.push({e:h,d2:g})}d.length>p&&(d.sort((h,g)=>h.d2-g.d2),d.length=p);const y=[];for(const h of e.projectiles||[]){if(!h)continue;const g=a(h.x,h.y);g>i||y.push({b:h,d2:g})}y.length>u&&(y.sort((h,g)=>h.d2-g.d2),y.length=u);const b=[];for(const h of e.rockets||[]){if(!h)continue;const g=a(h.x,h.y);g>i||b.push({r:h,d2:g})}b.length>c&&(b.sort((h,g)=>h.d2-g.d2),b.length=c);const x=[];for(const h of e.xpOrbs||[]){if(!h)continue;const g=a(h.x,h.y);g>i||x.push({o:h,d2:g})}return x.length>m&&(x.sort((h,g)=>h.d2-g.d2),x.length=m),{t:e.time,runScore:e.runScore,zone:e.currentZone,flags:{resGuardianKilledThisRun:!!(e.flags&&e.flags.resGuardianKilledThisRun)},players:r.map(h=>{var g,v;return{id:String(h.id),x:n(h.x),y:n(h.y),hp:h.hp,maxHP:h.maxHP,level:h.level,xp:h.xp,nextXp:h.nextLevelXp,nickname:h.nickname||"",avatarIndex:h.avatarIndex||0,color:h.color||fe(h.id),lastAim:{x:n(((g=h.lastAimDir)==null?void 0:g.x)||0),y:n(((v=h.lastAimDir)==null?void 0:v.y)||0)}}}),enemies:d.map(({e:h})=>({id:String(h.id||h._id||`${h.x.toFixed(1)}:${h.y.toFixed(1)}`),x:n(h.x),y:n(h.y),hp:h.hp,maxHp:h.maxHp??h.maxHP??0,radius:h.radius||20,kind:h.kind||h.type||"enemy",boss:!!h._isBoss||!!h.isBoss||!!h.boss,elite:!!h.isElite||!!h.elite})),projectiles:y.map(({b:h})=>({id:h.id!=null?h.id:void 0,ownerId:h.ownerId!=null?String(h.ownerId):"",x:n(h.x),y:n(h.y),vx:n(h.vx),vy:n(h.vy),radius:h.radius||4,life:n((h.range||0)-(h.travel||0))})),rockets:b.map(({r:h})=>({id:h.id!=null?h.id:void 0,ownerId:h.ownerId!=null?String(h.ownerId):"",type:h.type||"rocket",x:n(h.x),y:n(h.y),vx:n(h.vx),vy:n(h.vy),radius:h.radius||6,splashRadius:h.splashRadius||0,life:n((h.range||0)-(h.travel||0))})),xpOrbs:x.map(({o:h})=>{const g=h.kind||(h.coins?"coin":"xp");return{x:n(h.x),y:n(h.y),radius:h.radius||8,kind:g,xp:g==="xp"?h.xp||10:void 0,coins:g==="coin"?h.coins||1:void 0}}),buffs:(Array.isArray(e.buffs)?e.buffs:[]).slice(0,16).map(h=>({type:h.type||"",timeLeft:n(h.timeLeft||0),multiplier:n(h.multiplier||0),amount:n(h.amount||0)}))}}function Jo(e,n){var R,P,A,T;if(!n||typeof n!="object")return;const o=typeof n.t=="number"?n.t:null;if(o!=null){const S=typeof e._netLastAppliedSnapshotAt=="number"?e._netLastAppliedSnapshotAt:-1/0;if(o<=S+1e-6)return;e._netLastAppliedSnapshotAt=o}const t=(R=e.net)!=null&&R.playerId?String(e.net.playerId):(P=e.player)!=null&&P.id?String(e.player.id):"local";e._netCache||(e._netCache={players:new Map,enemies:new Map,projectilesById:new Map,rocketsById:new Map,projectiles:[],rockets:[],xpOrbs:[]});const r=e._netCache.players,s=e._netCache.enemies;e._netCache.projectilesById||(e._netCache.projectilesById=new Map),e._netCache.rocketsById||(e._netCache.rocketsById=new Map),Array.isArray(e._netCache.projectiles)||(e._netCache.projectiles=[]),Array.isArray(e._netCache.rockets)||(e._netCache.rockets=[]),Array.isArray(e._netCache.xpOrbs)||(e._netCache.xpOrbs=[]);const l=e._netCache.playersArr||(e._netCache.playersArr=[]);l.length=0;const f=o??(e.time||0);for(const S of n.players||[]){const w=String(S.id);let M=r.get(w);if(!M){M=new ln({x:S.x||0,y:S.y||0},S.level||Re(e.progression)),M.id=w,M.color=S.color||fe(w),M.nickname=S.nickname||`P${w}`,typeof S.avatarIndex=="number"&&(M.avatarIndex=S.avatarIndex|0),Ge(M,e.progression.limits);const N=((A=e._netMetaById)==null?void 0:A.get(w))||null;M._metaSkillMeta=N&&N.skillMeta&&typeof N.skillMeta=="object"?N.skillMeta:((T=e.progression)==null?void 0:T.skillMeta)||{},M._netTx=M.x,M._netTy=M.y,r.set(w,M)}M._netSeenAt=f;const B=Number.isFinite(S.x)?S.x:M.x,I=Number.isFinite(S.y)?S.y:M.y;M._netTx=B,M._netTy=I;const L=B-M.x,H=I-M.y;L*L+H*H>600*600&&(M.x=B,M.y=I),M.hp=S.hp,M.maxHP=S.maxHP,M.level=S.level,M.xp=S.xp,M.nextLevelXp=S.nextXp,M.nickname=S.nickname||M.nickname,typeof S.avatarIndex=="number"&&(M.avatarIndex=S.avatarIndex|0),M.color=S.color||M.color,S.lastAim&&(M.lastAimDir.x=S.lastAim.x||0,M.lastAimDir.y=S.lastAim.y||0),l.push(M)}for(const[S,w]of r)(!w||w._netSeenAt!==f)&&r.delete(S);e.players=l;const i=l.find(S=>String(S.id)===t)||l[0]||e.player;e.player=i;const a=e._netCache.enemiesArr||(e._netCache.enemiesArr=[]);a.length=0;for(const S of n.enemies||[]){const w=String(S.id);let M=s.get(w);M||(M=Qo(S),M.x=Number.isFinite(S.x)?S.x:0,M.y=Number.isFinite(S.y)?S.y:0,M._netTx=M.x,M._netTy=M.y,s.set(w,M)),M._netSeenAt=f;const B=Number.isFinite(S.x)?S.x:M.x,I=Number.isFinite(S.y)?S.y:M.y;M._netTx=B,M._netTy=I;const L=B-M.x,H=I-M.y;L*L+H*H>900*900&&(M.x=B,M.y=I),M.hp=S.hp,M.maxHp=S.maxHp,M.radius=S.radius||M.radius||20,M.kind=S.kind||M.kind||"enemy",M._isBoss=!!S.boss,M.isElite=!!S.elite,a.push(M)}for(const[S,w]of s)(!w||w._netSeenAt!==f)&&s.delete(S);e.enemies=a;const p=e.time||0,u=.3,c=Array.isArray(n.projectiles)?n.projectiles:[],m=e._netCache.projectilesById;for(const S of c){if(!S)continue;const w=S.id!=null?String(S.id):null;if(!w)continue;let M=m.get(w);const B=Number.isFinite(S.x)?S.x:0,I=Number.isFinite(S.y)?S.y:0;M||(M={id:w,type:"bullet",x:B,y:I,vx:Number.isFinite(S.vx)?S.vx:0,vy:Number.isFinite(S.vy)?S.vy:0,radius:S.radius||4,_netTx:B,_netTy:I,_netLife:Number.isFinite(S.life)?S.life:null,_netLastSeenLocalTime:p},m.set(w,M)),M._netLastSeenLocalTime=p,M._netTx=B,M._netTy=I,Number.isFinite(S.vx)&&(M.vx=S.vx),Number.isFinite(S.vy)&&(M.vy=S.vy),M.radius=S.radius||M.radius||4,Number.isFinite(S.life)&&(M._netLife=S.life);const L=M._netTx-M.x,H=M._netTy-M.y;L*L+H*H>1e3*1e3&&(M.x=M._netTx,M.y=M._netTy)}for(const[S,w]of m){const M=w&&typeof w._netLastSeenLocalTime=="number"?w._netLastSeenLocalTime:-1/0;p-M>u&&m.delete(S)}const d=e._netCache.projectiles;d.length=0;for(const S of m.values())d.push(S);e.projectiles=d;const y=Array.isArray(n.rockets)?n.rockets:[],b=e._netCache.rocketsById;for(const S of y){if(!S)continue;const w=S.id!=null?String(S.id):null;if(!w)continue;let M=b.get(w);const B=Number.isFinite(S.x)?S.x:0,I=Number.isFinite(S.y)?S.y:0;M||(M={id:w,x:B,y:I,vx:Number.isFinite(S.vx)?S.vx:0,vy:Number.isFinite(S.vy)?S.vy:0,radius:S.radius||6,splashRadius:S.splashRadius||0,_netTx:B,_netTy:I,_netLife:Number.isFinite(S.life)?S.life:null,_netLastSeenLocalTime:p},b.set(w,M)),M._netLastSeenLocalTime=p,M._netTx=B,M._netTy=I,Number.isFinite(S.vx)&&(M.vx=S.vx),Number.isFinite(S.vy)&&(M.vy=S.vy),M.radius=S.radius||M.radius||6,M.type=S.type||M.type||"rocket",M.splashRadius=S.splashRadius||M.splashRadius||0,Number.isFinite(S.life)&&(M._netLife=S.life);const L=M._netTx-M.x,H=M._netTy-M.y;L*L+H*H>1e3*1e3&&(M.x=M._netTx,M.y=M._netTy)}for(const[S,w]of b){const M=w&&typeof w._netLastSeenLocalTime=="number"?w._netLastSeenLocalTime:-1/0;p-M>u&&b.delete(S)}const x=e._netCache.rockets;x.length=0;for(const S of b.values())x.push(S);e.rockets=x;const h=Array.isArray(n.xpOrbs)?n.xpOrbs:[],g=e._netCache.xpOrbs;g.length=h.length;for(let S=0;S<h.length;S++){const w=h[S]||{};let M=g[S];M||(M=g[S]={x:0,y:0,xp:10,coins:0,kind:"xp",radius:8,age:0}),M.x=w.x||0,M.y=w.y||0,M.kind=w.kind||(w.coins?"coin":"xp"),M.xp=M.kind==="xp"?w.xp||10:0,M.coins=M.kind==="coin"?w.coins||1:0,M.radius=w.radius||8,M.age=0}e.xpOrbs=g,e.runScore=n.runScore||0,e.currentZone=n.zone??e.currentZone,n.flags&&e.flags&&(e.flags.resGuardianKilledThisRun=!!n.flags.resGuardianKilledThisRun);const v=Array.isArray(n.buffs)?n.buffs:[];e._netCache||(e._netCache={players:new Map,enemies:new Map});const k=e._netCache.buffsArr||(e._netCache.buffsArr=[]);k.length=v.length;for(let S=0;S<v.length;S++){const w=v[S]||{};let M=k[S];M||(M=k[S]={type:"",timeLeft:0,multiplier:0,amount:0}),M.type=(w.type||"").toString(),M.timeLeft=typeof w.timeLeft=="number"?w.timeLeft:0,M.multiplier=typeof w.multiplier=="number"?w.multiplier:0,M.amount=typeof w.amount=="number"?w.amount:0}if(e.buffs=k,e.net&&!e.net.isHost){const S=e._netBuffCounts||Object.create(null),w=Object.create(null);for(const B of k){const I=B&&B.type?String(B.type):"";I&&(w[I]=(w[I]||0)+1)}const M=B=>B==="damage"?"Damage":B==="attackSpeed"?"Attack Speed":B==="moveSpeed"?"Move Speed":B==="regen"?"Regen":B==="shield"?"Shield":B==="xpGain"?"XP Gain":B==="ghost"?"Ghost":B;for(const B of Object.keys(w)){const I=w[B]|0,L=(S[B]||0)|0;if(I>L){const H=M(B);e.floatingTexts&&e.player&&e.floatingTexts.push({x:e.player.x,y:e.player.y-24,text:"BUFF: "+H,time:1}),e.popups&&e.popups.push({text:"Temporary buff: "+H,time:2})}}e._netBuffCounts=w}}function Qo(e){return{id:e.id,x:e.x,y:e.y,hp:e.hp,maxHp:e.maxHp,radius:e.radius||20,kind:e.kind||"enemy",_isBoss:!!e.boss,isElite:!!e.elite,update:null,render(o,t){t.save(),t.beginPath();let r="#ff5f6f";if(o.isElite&&(r="#ffdd57"),o._isBoss&&(r="#ff4b7a"),o.kind==="zoneBoss"&&(r="#9b5bff"),o.kind==="roamingBoss"&&(r="#ff3cbe"),o.kind==="resurrectionGuardian"&&(r="#ffdd44"),o.kind==="zone6SuperBoss"&&(r="#1be7ff"),t.fillStyle=r,t.globalAlpha=1,t.arc(o.x,o.y,o.radius,0,Math.PI*2),t.fill(),o._isBoss||o.isElite){const s=o.maxHp>0?o.hp/o.maxHp:1;t.strokeStyle="#ffffff",t.globalAlpha=.9,t.lineWidth=o._isBoss?3:2,t.beginPath(),t.arc(o.x,o.y,o.radius+(o._isBoss?7:5),-Math.PI/2,-Math.PI/2+Math.PI*2*Math.max(0,Math.min(1,s))),t.stroke()}t.restore()}}}function ei(e,n){const o=1-Math.exp(-n*12),t=1-Math.exp(-n*5),r=e.players||[],s=e.player?String(e.player.id):null,l=.05;for(const i of r){if(!i||i._netTx==null||i._netTy==null)continue;const a=s&&String(i.id)===s,p=i._netTx+(a?0:(i._netVx||0)*l),u=i._netTy+(a?0:(i._netVy||0)*l),c=p-i.x,m=u-i.y;if(c*c+m*m<1e-4)continue;const d=a?t:o;i.x+=c*d,i.y+=m*d}const f=e.enemies||[];for(const i of f){if(!i||i._netTx==null||i._netTy==null)continue;const a=i._netTx-i.x,p=i._netTy-i.y;a*a+p*p<1e-4||(i.x+=a*o,i.y+=p*o)}}function ni(e,n){if(!oe(e)||!e.net||e.net.isHost)return;const o=1-Math.exp(-n*10),t=e.projectiles||[];for(const s of t){if(!s)continue;const l=Number.isFinite(s.vx)?s.vx:0,f=Number.isFinite(s.vy)?s.vy:0;s.x+=l*n,s.y+=f*n,s._netTx!=null&&s._netTy!=null&&(s.x+=(s._netTx-s.x)*o,s.y+=(s._netTy-s.y)*o),typeof s._netLife=="number"&&(s._netLife-=n)}const r=e.rockets||[];for(const s of r){if(!s)continue;const l=Number.isFinite(s.vx)?s.vx:0,f=Number.isFinite(s.vy)?s.vy:0;s.x+=l*n,s.y+=f*n,s._netTx!=null&&s._netTy!=null&&(s.x+=(s._netTx-s.x)*o,s.y+=(s._netTy-s.y)*o),typeof s._netLife=="number"&&(s._netLife-=n)}}function ti(e,n=0){if(!e.net||!e.net.isHost)return;const o=e.time,t=1/40;e._netPStateAcc=(e._netPStateAcc||0)+(Number.isFinite(n)?n:0),e._netPStateAcc>.25&&(e._netPStateAcc=.25),!(e._netPStateAcc<t)&&(e._netPStateAcc-=t,e._netLastPlayerStateSentAt=o,typeof e.net.sendPlayerState=="function"&&e.net.sendPlayerState(zo(e)))}function oi(e,n=0){if(!e.net||!e.net.isHost)return;const o=e.time,t=1/40;e._netSnapAcc=(e._netSnapAcc||0)+(Number.isFinite(n)?n:0),e._netSnapAcc>.25&&(e._netSnapAcc=.25),!(e._netSnapAcc<t)&&(e._netSnapAcc-=t,e._netLastSnapshotSendAt=o,e.net.sendSnapshot(Ko(e)))}function it(e){var s;if(!oe(e)||e.mode!=="playing"||!e.player)return;if(e._waitingRespawnAck)if(e.player.hp>0)e._waitingRespawnAck=!1,e._deathHandled=!1;else return;if(e.player.hp>0){e._deathHandled=!1;return}if(e._deathHandled||e.overlayMode)return;const n=Math.floor(e.runScore||0),o=Math.floor(e._lastDeathAwardScore||0),t=Math.max(0,n-o);e._lastDeathAwardScore=n,e.progression.totalScore=Math.max(0,(e.progression.totalScore||0)+t);const r=Math.max(0,Math.floor(t/400));e.progression.upgradePoints=Math.max(0,(e.progression.upgradePoints||0)+r),e.lastRunSummary={runScore:t,gainedPoints:r,startLevel:e.player.level||Re(e.progression)};try{ee(e.progression)}catch{}e.overlayMode=(s=e.flags)!=null&&s.resGuardianKilledThisRun?"resurrection":"upgrade",e._deathHandled=!0}function ii(e,n,o){n&&(o&&tn(e,n,o),n.x=0,n.y=0,n.vx=0,n.vy=0,n.hp=n.maxHP)}function si(e){var n,o;if(oe(e)&&(n=e.net)!=null&&n.isHost)for(const t of de(e)){if(!t||!t._netRespawnRequested)continue;t._netRespawnRequested=!1;const r=String(t.id),s=((o=e._netMetaById)==null?void 0:o.get(r))||null;ii(e,t,s)}}function ri(e,n){var r;const{enemies:o}=e,t=6;for(let s=o.length-1;s>=0;s--){const l=o[s];if(l.update&&l.update(l,n,e),l&&!l._ignoreHub){const i=(l.radius||20)+t,a=l.x||0,p=l.y||0;if(Ve(a,p,i)){const u=Te+i,c=Math.min(Hn+i,u),m=Math.max(u-c,0),d=a<0?-1:1,y=p<0?-1:1,b=Math.abs(a),x=Math.abs(p);let h=a,g=p;if(b>m&&x>m){const v=d*m,k=y*m;let R=a-v,P=p-k;const A=Math.hypot(R,P)||1e-4;R/=A,P/=A,h=v+R*c,g=k+P*c}else{const v=u-b,k=u-x;v<=k?h=d*u:g=y*u}l.x=h,l.y=g}}if(l.hp<=0||l._remove){if(!l._noScore){const f=l.scoreValue||10,i=((r=e.meta)==null?void 0:r.scoreMult)||1;e.runScore+=f*i}l.onDeath&&l.onDeath(l,e),e.spawnSystem&&typeof e.spawnSystem.onEnemyRemoved=="function"&&e.spawnSystem.onEnemyRemoved(l,e),o.splice(s,1)}}}function ai(e,n){const{projectiles:o,rockets:t,enemies:r}=e;for(let s=o.length-1;s>=0;s--){const l=o[s];if(l&&l.id==null&&(l.id=e._nextProjectileId=(e._nextProjectileId||0)+1),l.x+=l.vx*n,l.y+=l.vy*n,l.travel+=l.speed*n,l.travel>=l.range){o.splice(s,1);continue}let f=!1;for(let i=r.length-1;i>=0;i--){const a=r[i],p=a.x-l.x,u=a.y-l.y,c=(a.radius||20)+(l.radius||4);if(p*p+u*u<=c*c){const m=_e(e,l.ownerId)||e.player,d=Le(m,l.damage);a.hp-=d,Pe(m,d),m._lastCombatAt=e.time,m.lastPlayerTarget=a,m.lastPlayerTargetAt=e.time,a._lastHitAt=e.time,a._lastHitBy=m.id||"local",a.aggroed=!0,f=!0;break}}f&&o.splice(s,1)}for(let s=t.length-1;s>=0;s--){const l=t[s];l&&l.id==null&&(l.id=e._nextRocketId=(e._nextRocketId||0)+1),l.x+=l.vx*n,l.y+=l.vy*n,l.travel+=l.speed*n;let f=!1;if(l.travel>=l.range)f=!0;else for(let i=r.length-1;i>=0;i--){const a=r[i],p=a.x-l.x,u=a.y-l.y,c=(a.radius||24)+(l.radius||6);if(p*p+u*u<=c*c){f=!0;break}}f&&(li(l,e),t.splice(s,1))}}function li(e,n){const{enemies:o,floatingTexts:t}=n,r=e.splashRadius*e.splashRadius,s=_e(n,e.ownerId)||n.player;for(const l of o){const f=l.x-e.x,i=l.y-e.y;if(f*f+i*i<=r){const a=Le(s,e.damage);l.hp-=a,Pe(s,a),s._lastCombatAt=n.time,s.lastPlayerTarget=l,s.lastPlayerTargetAt=n.time,l._lastHitAt=n.time,l._lastHitBy=s.id||"local",l.aggroed=!0}}t.push({x:e.x,y:e.y,text:"BOOM",time:.6})}function ci(e,n){var r,s;const{xpOrbs:o}=e,t=e.players&&e.players.length?e.players:e.player?[e.player]:[];for(let l=o.length-1;l>=0;l--){const f=o[l];f.age=(f.age||0)+n,f.y+=Math.sin(f.age*5)*2*n;for(const i of t){const a=i.x-f.x,p=i.y-f.y,u=(i.radius||18)+(f.radius||8),c=(((r=e.meta)==null?void 0:r.pickupBonusRadius)||0)+(i.runPickupBonusRadius||0),m=u+c;if(a*a+p*p<=m*m){if((f.kind||(f.coins?"coin":"xp"))==="coin"){const v=f.coins||1;if(i===e.player&&e.progression){try{te(e.progression)}catch{}e.progression.coins=Math.max(0,(e.progression.coins|0)+(v|0));try{ee(e.progression)}catch{}e.floatingTexts&&e.floatingTexts.push({x:f.x,y:f.y,text:`+${v}ðŸª™`,time:.8})}o.splice(l,1);break}const y=f.xp||10,b=(((s=e.meta)==null?void 0:s.xpGainMult)||1)*(i.runXpGainMult||1),x=1+(e.tempXpGainBoost||0),h=b*x,g=Math.min(3,1+(h-1)*.55);typeof i.gainXP=="function"&&i.gainXP(y*g,e),o.splice(l,1);break}}}}function ui(e,n){const{floatingTexts:o}=e;for(let t=o.length-1;t>=0;t--){const r=o[t];r.y-=20*n,r.time-=n,r.time<=0&&o.splice(t,1)}}function fi(e,n){var o=n.floatingTexts;e.save(),e.font="18px sans-serif",e.textAlign="center";for(var t=0;t<o.length;t++){var r=o[t],s=r.time/1.2;s<0&&(s=0),s>1&&(s=1),e.fillStyle="rgba(255,255,255,"+s.toFixed(2)+")",e.fillText(r.text,r.x,r.y)}e.restore()}function Ye(e,n){const o=e.popups;for(let t=o.length-1;t>=0;t--)o[t].time-=n,o[t].time<=0&&o.splice(t,1)}function di(e,n){var h,g;const o={0:"#0d3a1f",1:"#0b101b",2:"#0e1821",3:"#0d1426",4:"#19121e",5:"#0d0b1f",6:"#0a0714"};n.save(),e._bgPatterns||(e._bgPatterns={});function t(v,k,R){n.beginPath(),n.arc(0,0,k,0,Math.PI*2),n.arc(0,0,v,0,Math.PI*2,!0),n.fillStyle=R,n.fill("evenodd")}function r(v,k,R,P,A){const T=Math.max(0,Math.min(A,Math.min(R,P)*.5));n.beginPath(),n.moveTo(v+T,k),n.lineTo(v+R-T,k),n.quadraticCurveTo(v+R,k,v+R,k+T),n.lineTo(v+R,k+P-T),n.quadraticCurveTo(v+R,k+P,v+R-T,k+P),n.lineTo(v+T,k+P),n.quadraticCurveTo(v,k+P,v,k+P-T),n.lineTo(v,k+T),n.quadraticCurveTo(v,k,v+T,k),n.closePath()}function s(){const v=Te*2;r(-Te,-Te,v,v,Hn)}const l=e.camera,f=e.player,i=(l==null?void 0:l.zoom)||1,a=(((h=e.canvas)==null?void 0:h.width)||800)/(2*i),p=(((g=e.canvas)==null?void 0:g.height)||600)/(2*i);f.x-a,f.x+a,f.y-p,f.y+p,e.net&&e.net.roomCode&&e.net.isHost,n.fillStyle=o[6],n.fillRect(-Z,-Z,Z*2,Z*2);const u=z[0],c=z[1],m=z[2],d=z[3],y=z[4],b=z[5];function x(v,k,R,P){return R}t(y,b,x(y,b,o[5])),t(d,y,x(d,y,o[4])),t(m,d,x(m,d,o[3])),t(c,m,x(c,m,o[2])),t(u,c,x(u,c,o[1])),s(),n.fillStyle=o[0],n.fill(),n.lineWidth=1.5,n.strokeStyle="rgba(255,255,255,0.14)",n.beginPath();for(const v of[c,m,d,y,b])n.moveTo(v,0),n.arc(0,0,v,0,Math.PI*2);n.stroke(),n.strokeStyle="rgba(255,255,255,0.16)",n.lineWidth=1.6,s(),n.stroke(),n.strokeStyle="rgba(255,255,255,0.10)",n.lineWidth=1.5,n.strokeRect(-Z,-Z,Z*2,Z*2),n.restore()}function pi(e,n){const o=!!(e.net&&e.net.roomCode&&!e.net.isHost),t=typeof window<"u"&&window.innerWidth||0,r=typeof window<"u"&&window.innerHeight||0;if(o&&r>t&&Math.max(t,r)<900){for(const l of e.enemies){if(!l)continue;if(typeof l.render=="function"){l.render(l,n);continue}n.save(),n.beginPath();let f="#ff5f6f";l.isElite&&(f="#ffdd57"),l.kind==="zoneBoss"&&(f="#9b5bff"),l.kind==="roamingBoss"&&(f="#ff3cbe"),l.kind==="resurrectionGuardian"&&(f="#ffdd44"),l.kind==="zone6SuperBoss"&&(f="#1be7ff"),n.fillStyle=f,n.arc(l.x,l.y,l.radius||20,0,Math.PI*2),n.fill(),n.restore()}return}for(const l of e.enemies)l&&l.render&&l.render(l,n)}function hi(e,n){const{projectiles:o,rockets:t,_laserVisual:r,_lightningVisual:s,_laserVisuals:l,_lightningVisuals:f}=e,i=!!(e.net&&e.net.roomCode&&!e.net.isHost),a=typeof window<"u"&&window.innerWidth||0,p=typeof window<"u"&&window.innerHeight||0,u=i&&p>a&&Math.max(a,p)<900;if(n.save(),u){const y=o.length>220?Math.ceil(o.length/220):1;n.fillStyle="#f4e9a3";for(let h=0;h<o.length;h+=y){const g=o[h];g&&n.fillRect(g.x-1,g.y-1,2,2)}const b=80,x=t.length>b?Math.ceil(t.length/b):1;n.fillStyle="#cfcfcf";for(let h=0;h<t.length;h+=x){const g=t[h];!g||g.type!=="bomb"||n.fillRect(g.x-2,g.y-2,4,4)}n.fillStyle="#ff7a3c";for(let h=0;h<t.length;h+=x){const g=t[h];!g||g.type==="bomb"||n.fillRect(g.x-2,g.y-2,4,4)}}else{n.fillStyle="#f4e9a3";for(const d of o)n.beginPath(),n.arc(d.x,d.y,d.radius||4,0,Math.PI*2),n.fill();n.fillStyle="#cfcfcf";for(const d of t)!d||d.type!=="bomb"||(n.beginPath(),n.arc(d.x,d.y,d.radius||7,0,Math.PI*2),n.fill());n.fillStyle="#ff7a3c";for(const d of t)!d||d.type==="bomb"||(n.beginPath(),n.arc(d.x,d.y,d.radius||6,0,Math.PI*2),n.fill())}const c=[];l&&typeof l.forEach=="function"?l.forEach(d=>{d&&c.push(d)}):r&&c.push(r);for(const d of c)n.beginPath(),n.strokeStyle="rgba(173,246,255,0.9)",n.lineWidth=6,n.moveTo(d.x1,d.y1),n.lineTo(d.x2,d.y2),n.stroke();const m=[];f&&typeof f.forEach=="function"?f.forEach(d=>{d&&d.length>1&&m.push(d)}):s&&s.length>1&&m.push(s);for(const d of m){n.beginPath(),n.strokeStyle="rgba(220,245,255,0.95)",n.lineWidth=3;for(let y=0;y<d.length-1;y++){const b=d[y],x=d[y+1];n.moveTo(b.x,b.y),n.lineTo(x.x,x.y)}n.stroke()}n.restore()}function mi(e,n){n.save();for(const o of e.xpOrbs){const t=o.kind||(o.coins?"coin":"xp");n.fillStyle=t==="coin"?"#ffd34a":"#5af2ff",n.beginPath(),n.arc(o.x,o.y,o.radius||8,0,Math.PI*2),n.fill(),t==="coin"&&(n.fillStyle="rgba(255,255,255,0.70)",n.beginPath(),n.arc(o.x-2,o.y-2,Math.max(1,(o.radius||8)*.25),0,Math.PI*2),n.fill())}n.restore()}function yi(e,n){var r;const o=e.players&&e.players.length?e.players:e.player?[e.player]:[];n.save();const t=e.time||0;for(const s of o){if(!s||s.hp<=0)continue;const l=s.runSkills||{},f=s.metaRangeMult||1,i=s.runRangeMult||1,a=f*i,p=(l.electricZone||0)|0;if(p>0){const d=(140+(p-1)*9)*a;n.beginPath(),n.fillStyle="rgba(80,220,255,0.07)",n.arc(s.x,s.y,d,0,Math.PI*2),n.fill(),n.beginPath(),n.strokeStyle="rgba(180,245,255,0.20)",n.lineWidth=2,n.arc(s.x,s.y,d,0,Math.PI*2),n.stroke()}const u=(l.energyBarrier||0)|0;if(u>0){const d=(92+(u-1)*5)*(.9+(a-1)*.5),y=.35+.15*Math.sin(t*7.5);n.beginPath(),n.beginPath(),n.fillStyle="rgba(80,220,255,0.05)",n.arc(s.x,s.y,d,0,Math.PI*2),n.fill(),n.beginPath(),n.strokeStyle=`rgba(255,255,255,${.28+y*.18})`,n.lineWidth=3,n.arc(s.x,s.y,d,0,Math.PI*2),n.stroke()}const c=(l.satellites||0)|0;if(c>0){const d=Math.min(8,1+Math.floor((c-1)/3)),y=(58+(c-1)*2)*(.85+(a-1)*.35),b=10,x=t*(1.35+(c-1)*.03),h=Math.PI*2/Math.max(1,d);for(let g=0;g<d;g++){const v=x+g*h,k=s.x+Math.cos(v)*y,R=s.y+Math.sin(v)*y;n.beginPath(),n.fillStyle="rgba(255,255,255,0.65)",n.arc(k,R,b,0,Math.PI*2),n.fill(),n.beginPath(),n.fillStyle="rgba(80,220,255,0.40)",n.arc(k-3,R-3,Math.max(2,b*.3),0,Math.PI*2),n.fill()}}const m=(l.spirit||0)|0;if(m>0){const d=Math.min(3,1+Math.floor((m-1)/5)),y=46+(m-1)*1.5,b=7,x=t*(.9+(m-1)*.02)+1.2,h=Math.PI*2/Math.max(1,d);for(let g=0;g<d;g++){const v=x+g*h,k=s.x+Math.cos(v)*y,R=s.y+Math.sin(v)*y;n.beginPath(),n.fillStyle="rgba(170,255,220,0.65)",n.arc(k,R,b,0,Math.PI*2),n.fill(),n.beginPath(),n.fillStyle="rgba(255,255,255,0.70)",n.arc(k-2,R-2,Math.max(1,b*.35),0,Math.PI*2),n.fill()}}}n.restore();for(const s of o)s&&(typeof s.render=="function"?s.render(n):(n.save(),n.beginPath(),n.fillStyle=s.id===((r=e.player)==null?void 0:r.id)?"#8fe3ff":"#7fb0ff",n.arc(s.x,s.y,s.radius||18,0,Math.PI*2),n.fill(),n.restore()));n.save(),n.font="12px sans-serif",n.textAlign="center",n.fillStyle="rgba(255,255,255,0.9)";for(const s of o){if(!s)continue;const l=(s.nickname||"").toString().slice(0,16);l&&n.fillText(l,s.x,s.y-(s.radius||18)-22)}n.restore()}function gi(e,n){var t;n.save();for(const r of e.enemies){const s=r.hp,l=r.maxHp??r.maxHP??0;if(l<=0||s<=0)continue;const f=Math.max(0,Math.min(1,s/l)),i=(r.radius||20)*2.2,a=4,p=r.x-i/2,u=r.y-(r.radius||20)-10;n.fillStyle="#000000",n.fillRect(p,u,i,a),n.fillStyle="#4cff4c",n.fillRect(p,u,i*f,a)}const o=e.players&&e.players.length?e.players:e.player?[e.player]:[];for(const r of o){if(!r)continue;const s=r.hp,l=r.maxHP??r.maxHp??0;if(l>0&&s>0){const f=Math.max(0,Math.min(1,s/l)),i=(r.radius||18)*2.4,a=5,p=r.x-i/2,u=r.y-(r.radius||18)-14;n.fillStyle="#000000",n.fillRect(p,u,i,a),n.fillStyle=r.id===((t=e.player)==null?void 0:t.id)?"#00ff7a":"#4aa3ff",n.fillRect(p,u,i*f,a)}}n.restore()}function bi(e,n){const{buffs:o}=e;if(!o||!o.length)return;n.save(),n.globalAlpha=.35;const t=e.players&&e.players.length?e.players:e.player?[e.player]:[];for(const r of o){switch(r.type){case"damage":n.strokeStyle="#ff4b7a";break;case"attackSpeed":n.strokeStyle="#ffdd57";break;case"moveSpeed":n.strokeStyle="#57ff9b";break;case"regen":n.strokeStyle="#57c8ff";break;case"shield":n.strokeStyle="#b857ff";break;case"ghost":n.strokeStyle="#ffffff";break;default:n.strokeStyle="#ffffff";break}for(const s of t)n.beginPath(),n.lineWidth=3,n.arc(s.x,s.y,(s.radius||18)+10,0,Math.PI*2),n.stroke()}n.restore()}function vi(e,n){const{canvas:o,popups:t}=n,r=o.width;e.save(),e.font="18px sans-serif",e.textAlign="center";let s=40;for(const l of t){const f=Math.max(0,Math.min(1,l.time/2));e.fillStyle="rgba(255,255,255,"+f+")",e.fillText(l.text,r/2,s),s+=22}e.restore()}function xi(e){const{player:n,progression:o}=e;if(n.hp>0||e.mode!=="playing")return;const t=Math.floor(e.runScore),r=Math.max(1,Math.floor(t/400));o.totalScore+=t,o.upgradePoints+=r,e.flags&&e.flags.resGuardianKilledThisRun?e.mode="resurrection":e.mode="upgrade",e.lastRunSummary={runScore:t,totalScore:o.totalScore,gainedPoints:r},ee(o)}let Pn=!1,E=null,_={},wn=-1,Me=null,ki=0,on=null,Je="",sn=0;function U(e){return document.getElementById(e)}function Mi(e,n,o){return Math.max(n,Math.min(o,e))}function Tt(e){return(e||"").toString().trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,8)}function gn(e){var r,s,l;const n=e==="profile",o=e==="records",t=e==="shop";(r=_.tabProfileBtn)==null||r.classList.toggle("sel",n),(s=_.tabRecordsBtn)==null||s.classList.toggle("sel",o),(l=_.tabShopBtn)==null||l.classList.toggle("sel",t),_.profileTabProfile&&(_.profileTabProfile.style.display=n?"block":"none"),_.profileTabRecords&&(_.profileTabRecords.style.display=o?"block":"none"),_.profileTabShop&&(_.profileTabShop.style.display=t?"block":"none")}function Si(e){if(!_.avatarButtons)return;_.avatarButtons.innerHTML="";const n=an(e.progression);wn=n;for(let o=0;o<ae.length;o++){const t=ae[o],r=Xt(e.progression,o),s=document.createElement("button");s.type="button",s.className="btn avbtn"+(r?"":" locked")+((e.progression.avatarIndex|0)===o?" sel":""),s.textContent=t,s.title=r?`Avatar ${o+1}`:`Locked (${n}/${ae.length})`,s.addEventListener("click",()=>{if(!r)return;e.progression.avatarIndex=o;try{ee(e.progression)}catch{}_.avatarButtons.querySelectorAll(".avbtn").forEach(f=>f.classList.remove("sel")),s.classList.add("sel"),_.profileAvatarPreview&&(_.profileAvatarPreview.textContent=ae[o]||"ðŸ™‚")}),_.avatarButtons.appendChild(s)}}function bn(e,n){var i,a,p,u,c;const o=e.net;if(!o)return;try{if(e.progression){e.progression.nickname=(((i=_.nameInput)==null?void 0:i.value)||e.progression.nickname||"Player").toString().trim().slice(0,16)||"Player",e.progression.roomCode=Tt(((a=_.roomCodeInput)==null?void 0:a.value)||e.progression.roomCode||""),_.roomCodeInput&&(_.roomCodeInput.value=e.progression.roomCode),_.nameInput&&(_.nameInput.value=e.progression.nickname);try{ee(e.progression)}catch{}}}catch{}const t=(((p=e.progression)==null?void 0:p.nickname)||"Player").toString().slice(0,16),r=((u=e.progression)==null?void 0:u.avatarIndex)||0,s=((c=e.progression)==null?void 0:c.roomCode)||"";Me={seq:++ki,action:n,nickname:t,avatarIndex:r,roomCode:s};const f=m=>{if(m)try{m.action==="host"?o.host(m.roomCode,m.nickname,m.avatarIndex):m.action==="join"?o.join(m.roomCode,m.nickname,m.avatarIndex):o.fastJoin(m.nickname,m.avatarIndex)}catch{}};if(o.connect(kt()),o.ws&&o.ws.readyState===1){const m=Me;Me=null,f(m)}else{const m=o.ws;m&&m!==on&&(on=m,m.addEventListener("open",()=>{const d=Me;Me=null,f(d)},{once:!0}))}}function _i(e){var n,o,t,r,s,l,f,i,a,p,u,c,m,d;Pn||(Pn=!0,E=e,_.lobby=U("lobby"),_.lobbyPingMini=U("lobbyPingMini"),_.btnMenuFullscreen=U("btnMenuFullscreen"),_.btnMenuHelp=U("btnMenuHelp"),_.tabProfileBtn=U("tabProfileBtn"),_.tabRecordsBtn=U("tabRecordsBtn"),_.tabShopBtn=U("tabShopBtn"),_.profileTabProfile=U("profileTabProfile"),_.profileTabRecords=U("profileTabRecords"),_.profileTabShop=U("profileTabShop"),_.profCoins=U("profCoins"),_.shopCoins=U("shopCoins"),_.shopMsg=U("shopMsg"),_.shopGridActive=U("shopGridActive"),_.shopGridPassive=U("shopGridPassive"),_.shopGridNew=U("shopGridNew"),_.btnShopReroll=U("btnShopReroll"),_.shopRerollCost=U("shopRerollCost"),_.profileAvatarPreview=U("profileAvatarPreview"),_.nameInput=U("nameInput"),_.profLevel=U("profLevel"),_.profXp=U("profXp"),_.profAv=U("profAv"),_.profXpBar=U("profXpBar"),_.profNext=U("profNext"),_.profAvatarHint=U("profAvatarHint"),_.avatarButtons=U("avatarButtons"),_.btnJoinLeft=U("btnJoinLeft"),_.recTotalScore=U("recTotalScore"),_.recRTier=U("recRTier"),_.recUp=U("recUp"),_.roomCodeInput=U("roomCodeInput"),_.btnRoomApply=U("btnRoomApply"),_.btnCopyInvite=U("btnCopyInvite"),_.roomCodeStatus=U("roomCodeStatus"),_.joinError=U("joinError"),_.lobbyPlayers=U("lobbyPlayers"),_.lobbyInfo=U("lobbyInfo"),_.btnHost=U("btnHost"),_.btnJoinRun=U("btnJoinRun"),_.btnFastJoin=U("btnFastJoin"),_.btnStart=U("btnStart"),_.btnDisconnect=U("btnDisconnect"),_.netStatus=U("netStatus"),_.netRoom=U("netRoom"),_.netPlayers=U("netPlayers"),(n=_.tabProfileBtn)==null||n.addEventListener("click",()=>gn("profile")),(o=_.tabRecordsBtn)==null||o.addEventListener("click",()=>gn("records")),(t=_.tabShopBtn)==null||t.addEventListener("click",()=>gn("shop")),(r=_.btnMenuFullscreen)==null||r.addEventListener("click",async()=>{var y,b,x;try{document.fullscreenElement?await((x=document.exitFullscreen)==null?void 0:x.call(document)):await((b=(y=document.documentElement).requestFullscreen)==null?void 0:b.call(y))}catch{}}),(s=_.btnMenuHelp)==null||s.addEventListener("click",()=>{alert(`Pixel PVE

Host / Join / Fast-Join: Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÐºÐ¾Ð¾Ð¿-ÑÐµÑ€Ð²ÐµÑ€Ñƒ (ws relay 8080).
Start: Ð¾Ñ„Ñ„Ð»Ð°Ð¹Ð½ Ð·Ð°Ð¿ÑƒÑÐº (fallback).

Mobile: 1-Hand (Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾), PC: 2-Hand.`)}),_.nameInput&&_.nameInput.addEventListener("input",()=>{var b;const y=(_.nameInput.value||"").toString().trim().slice(0,16);(b=E==null?void 0:E.state)!=null&&b.progression&&(E.state.progression.nickname=y||"Player")}),(l=_.btnJoinLeft)==null||l.addEventListener("click",()=>{const y=E==null?void 0:E.state;if(!(!y||!y.progression)){y.progression.nickname=(y.progression.nickname||"Player").toString().trim().slice(0,16)||"Player",y.progression.avatarIndex=y.progression.avatarIndex|0;try{ee(y.progression)}catch{}try{y.net&&y.net.status==="connected"&&y.net.setProfile(y.progression.nickname,y.progression.avatarIndex)}catch{}}}),(f=_.btnRoomApply)==null||f.addEventListener("click",()=>{var b;const y=E==null?void 0:E.state;if(!(!y||!y.progression)){y.progression.roomCode=Tt(((b=_.roomCodeInput)==null?void 0:b.value)||""),_.roomCodeInput&&(_.roomCodeInput.value=y.progression.roomCode);try{ee(y.progression)}catch{}}}),(i=_.btnCopyInvite)==null||i.addEventListener("click",async()=>{var h,g,v;const y=E==null?void 0:E.state,b=(((h=y==null?void 0:y.net)==null?void 0:h.roomCode)||((g=y==null?void 0:y.progression)==null?void 0:g.roomCode)||"").toString(),x=`${location.origin}/?code=${encodeURIComponent(b)}`;try{(v=navigator.clipboard)!=null&&v.writeText?await navigator.clipboard.writeText(x):prompt("Invite link",x)}catch{prompt("Invite link",x)}}),(a=_.btnShopReroll)==null||a.addEventListener("click",()=>{const y=E==null?void 0:E.state,b=y==null?void 0:y.progression;if(!b)return;te(b);const x=10+(sn|0)*5;if((b.coins|0)<x){rn("Not enough coins for reroll.");return}b.coins=Math.max(0,(b.coins|0)-x),sn++,Rt(b);try{ee(b)}catch{}rn("Rerolled."),Je=""}),(p=_.btnHost)==null||p.addEventListener("click",()=>{const y=E==null?void 0:E.state;y&&bn(y,"host")}),(u=_.btnJoinRun)==null||u.addEventListener("click",()=>{const y=E==null?void 0:E.state;y&&bn(y,"join")}),(c=_.btnFastJoin)==null||c.addEventListener("click",()=>{const y=E==null?void 0:E.state;y&&bn(y,"fastJoin")}),(m=_.btnStart)==null||m.addEventListener("click",()=>{var b,x;const y=E==null?void 0:E.state;if(y){Me=null,on=null;try{(x=(b=y.net)==null?void 0:b.disconnect)==null||x.call(b)}catch{}typeof(E==null?void 0:E.startOfflineRun)=="function"?E.startOfflineRun():y.mode="playing"}}),(d=_.btnDisconnect)==null||d.addEventListener("click",()=>{var b,x;const y=E==null?void 0:E.state;Me=null,on=null;try{(x=(b=y==null?void 0:y.net)==null?void 0:b.disconnect)==null||x.call(b)}catch{}}))}function rn(e){_.shopMsg&&(_.shopMsg.textContent=e?String(e):"")}function Ri(e){const n=e==null?void 0:e.progression;if(!n)return;te(n),We(n),_.profCoins&&(_.profCoins.textContent=String(n.coins|0)),_.shopCoins&&(_.shopCoins.textContent=String(n.coins|0));const o=10+(sn|0)*5;_.shopRerollCost&&(_.shopRerollCost.textContent=String(o));const t=n.shopOffers||{active:[],passive:[],newSkills:[]},r=JSON.stringify(t)+"|"+(n.coins|0)+"|"+o;if(r===Je)return;Je=r;const s=(l,f,i)=>{if(l){l.innerHTML="";for(let a=0;a<3;a++){const p=i[a],u=p?wt(p):null,c=p?le(n,p):0,m=p?nn(p,c):0,d=At(),y=document.createElement("div");y.className="shopCard";const b=document.createElement("div");b.className="top";const x=document.createElement("div");x.className="name",x.textContent=u?u.name:"â€”";const h=document.createElement("div");h.className="lvl",h.textContent=`Lv ${c}/${d}`,b.appendChild(x),b.appendChild(h);const g=document.createElement("div");g.className="buyRow";const v=document.createElement("div");v.className="price",v.textContent=`Cost: ${m} ðŸª™`,g.appendChild(v);const k=document.createElement("button");k.type="button",k.className="btn";const R=c<=0?"Buy (unlock)":"Upgrade";k.textContent=R;const P=!u||c>=d||(n.coins|0)<m;k.disabled=P,c>=d?(k.textContent="MAX",v.textContent="MAX"):(n.coins|0)<m&&(k.title="Not enough coins"),k.addEventListener("click",()=>{if(!u)return;te(n);const A=le(n,p),T=nn(p,A);if((n.coins|0)<T){rn("Not enough coins.");return}if(!(A>=d)){n.coins=Math.max(0,(n.coins|0)-T),_t(n,p,A+1),Pt(n,f,a),sn=0;try{ee(n)}catch{}rn("Purchased!"),Je=""}}),y.appendChild(b),y.appendChild(g),y.appendChild(k),l.appendChild(y)}}};s(_.shopGridActive,"active",t.active||[]),s(_.shopGridPassive,"passive",t.passive||[]),s(_.shopGridNew,"new",t.newSkills||[])}function Pi(e){if(!Pn||!e)return;const n=e.mode==="startMenu";if(_.lobby&&(_.lobby.style.display=n?"flex":"none"),!n||!e.progression)return;e.progression.nickname||(e.progression.nickname="Player"),typeof e.progression.avatarIndex!="number"&&(e.progression.avatarIndex=0),typeof e.progression.roomCode!="string"&&(e.progression.roomCode=""),_.nameInput&&document.activeElement!==_.nameInput&&(_.nameInput.value=e.progression.nickname),_.roomCodeInput&&document.activeElement!==_.roomCodeInput&&(_.roomCodeInput.value=e.progression.roomCode),_.profileAvatarPreview&&(_.profileAvatarPreview.textContent=ae[e.progression.avatarIndex]||"ðŸ™‚");const o=e.progression.totalScore||0,t=Math.max(1,(Re(e.progression)||0)+1),r=(o%1e3+1e3)%1e3,s=1e3-r,l=r/1e3;_.profLevel&&(_.profLevel.textContent=String(t)),_.profXp&&(_.profXp.textContent=String(r)),_.profNext&&(_.profNext.textContent=`Next: ${s}`),_.profXpBar&&(_.profXpBar.style.width=`${Math.round(Mi(l,0,1)*100)}%`);const f=an(e.progression);_.profAv&&(_.profAv.textContent=`${f}/${ae.length}`),_.profAvatarHint&&(_.profAvatarHint.textContent=`(unlocked ${f}/${ae.length})`),_.recTotalScore&&(_.recTotalScore.textContent=String(o)),_.recRTier&&(_.recRTier.textContent=String(e.progression.resurrectedTier||1)),_.recUp&&(_.recUp.textContent=String(e.progression.upgradePoints||0)),_.avatarButtons&&(wn<0||wn!==f)&&Si(e),Ri(e);const i=e.net,p=(Array.isArray(i==null?void 0:i.roomPlayers)?i.roomPlayers:[]).length||((i==null?void 0:i.status)==="connected"?1:0),u=(i==null?void 0:i.maxPlayers)||7,c=((i==null?void 0:i.roomCode)||e.progression.roomCode||"").toString();if(_.netStatus&&(_.netStatus.textContent=(i==null?void 0:i.status)||"offline"),_.netRoom&&(_.netRoom.textContent=c||"â€”"),_.netPlayers&&(_.netPlayers.textContent=`${p}/${u}`),_.lobbyPlayers&&(_.lobbyPlayers.textContent=`Players on map: ${p}/${u}`),_.roomCodeStatus&&(_.roomCodeStatus.textContent=c?`Room ${c}`:"Public lobby"),_.joinError&&(_.joinError.textContent=i!=null&&i.error?String(i.error):""),_.lobbyInfo&&(!i||i.status==="offline"?_.lobbyInfo.textContent="Offline. Press Start or connect via Host/Join/Fast-Join.":i.status==="connecting"?_.lobbyInfo.textContent="Connecting...":i.status==="connected"?_.lobbyInfo.textContent=i.isHost?"Connected (Host).":"Connected (Join).":_.lobbyInfo.textContent=i.status),_.lobbyPingMini){const m=i==null?void 0:i.pingMs;typeof m=="number"&&m>0?(_.lobbyPingMini.style.display="inline-flex",_.lobbyPingMini.textContent=`Ping: ${m}`):_.lobbyPingMini.style.display="none"}}let An=!1,D={},De="",Fe=0;function W(e,n={},o=[]){const t=document.createElement(e);for(const[r,s]of Object.entries(n))r==="style"&&s&&typeof s=="object"?Object.assign(t.style,s):r==="className"?t.className=s:r==="text"?t.textContent=s:r.startsWith("on")&&typeof s=="function"?t.addEventListener(r.slice(2),s):t.setAttribute(r,String(s));for(const r of o)t.appendChild(r);return t}function wi(){const e=document.activeElement;if(!e)return!1;const n=(e.tagName||"").toLowerCase();return n==="input"||n==="textarea"}function Be(e){D.shopMsg&&(D.shopMsg.textContent=e||"",e&&(clearTimeout(Be._t),Be._t=setTimeout(()=>{D.shopMsg&&(D.shopMsg.textContent="")},1200)))}function Cn(e){e!=null&&e.progression&&(te(e.progression),We(e.progression),e.overlayMode="shop",D.shopOverlay&&(D.shopOverlay.style.display="flex"),De="",cn(e))}function Tn(e){D.shopOverlay&&(D.shopOverlay.style.display="none"),e&&e.overlayMode==="shop"&&(e.overlayMode=null)}function In(e){e.overlayMode="stats",Tn(e)}function It(e){const n=e==null?void 0:e.net,o=e==null?void 0:e.progression;if(!(!n||n.status!=="connected"||n.isHost)&&o)try{n.sendMeta({nickname:o.nickname||"Player",avatarIndex:o.avatarIndex||0,resurrectedTier:o.resurrectedTier||1,totalScore:o.totalScore||0,upgradePoints:o.upgradePoints||0,limits:o.limits||{},skillMeta:o.skillMeta||{}})}catch{}}function cn(e){const n=e==null?void 0:e.progression;if(!n)return;te(n),We(n),D.shopCoins&&(D.shopCoins.textContent=String(n.coins|0));const o=10+(Fe|0)*5;D.shopRerollCost&&(D.shopRerollCost.textContent=String(o));const t=n.shopOffers||{active:[],passive:[],newSkills:[]},r=JSON.stringify(t)+"|"+(n.coins|0)+"|"+o;if(r===De)return;De=r;const s=(l,f,i)=>{if(l){l.innerHTML="";for(let a=0;a<3;a++){const p=i[a],u=p?wt(p):null,c=p?le(n,p):0,m=p?nn(p,c):0,d=At(),y=W("div",{className:"shopCard"}),b=W("div",{className:"top"}),x=W("div",{className:"name",text:u?u.name:"â€”"}),h=W("div",{className:"lvl",text:`Lv ${c}/${d}`});b.appendChild(x),b.appendChild(h);const g=W("div",{className:"buyRow"}),v=W("div",{className:"price",text:`Cost: ${m} ðŸª™`});g.appendChild(v);const k=W("button",{type:"button",className:"btn",text:c<=0?"Buy (unlock)":"Upgrade"}),R=!u||c>=d||(n.coins|0)<m;k.disabled=R,c>=d?(k.textContent="MAX",v.textContent="MAX"):(n.coins|0)<m&&(k.title="Not enough coins"),k.addEventListener("click",()=>{if(!u)return;te(n);const P=le(n,p),A=nn(p,P);if((n.coins|0)<A){Be("Not enough coins.");return}if(!(P>=d)){n.coins=Math.max(0,(n.coins|0)-A),_t(n,p,P+1),Pt(n,f,a),Fe=0;try{ee(n)}catch{}It(e),Be("Purchased!"),De="",cn(e)}}),y.appendChild(b),y.appendChild(g),y.appendChild(k),l.appendChild(y)}}};s(D.shopGridActive,"active",t.active||[]),s(D.shopGridPassive,"passive",t.passive||[]),s(D.shopGridNew,"new",t.newSkills||[])}function Ai(e){if(An)return;An=!0,D.interactWrap=W("div",{id:"hubInteractWrap",style:{position:"fixed",left:"50%",bottom:"22px",transform:"translateX(-50%)",zIndex:9999,display:"none",pointerEvents:"none"}}),D.interactBtn=W("button",{id:"btnHubInteract",className:"btn",type:"button",text:"Interact",style:{pointerEvents:"auto",padding:"12px 18px",fontSize:"14px",borderRadius:"12px",boxShadow:"0 6px 18px rgba(0,0,0,0.35)"}}),D.interactWrap.appendChild(D.interactBtn),document.body.appendChild(D.interactWrap),D.shopOverlay=W("div",{id:"hubShopOverlay",style:{position:"fixed",inset:"0",zIndex:1e4,display:"none",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.72)",padding:"14px"}});const n=W("div",{className:"panel",style:{width:"min(560px, 96vw)",maxHeight:"92vh",overflow:"auto"}}),o=W("div",{className:"header"});o.appendChild(W("h2",{text:"Hub Shop"}));const t=W("button",{className:"btn",type:"button",text:"Close",style:{padding:"7px 10px",fontSize:"12px"}});t.addEventListener("click",()=>Tn(e.state)),o.appendChild(t);const r=W("div",{className:"row",style:{justifyContent:"space-between",alignItems:"center",marginTop:"8px"}}),s=W("div",{style:{fontSize:"13px"}});s.innerHTML='<b>Coins:</b> <span id="hubShopCoins">0</span> <span class="muted">ðŸª™</span>',r.appendChild(s);const l=W("button",{className:"btn",id:"btnHubShopReroll",type:"button",style:{padding:"8px 10px",whiteSpace:"nowrap"}});l.innerHTML='Reroll (<span id="hubShopRerollCost">10</span>)',r.appendChild(l);const f=W("div",{className:"muted",id:"hubShopMsg",style:{minHeight:"16px",marginTop:"6px"}});n.appendChild(o),n.appendChild(r),n.appendChild(f),n.appendChild(W("div",{className:"shopLabel",text:"ÐŸÑ€Ð¾ÐºÐ°Ñ‡ÐºÐ°"})),n.appendChild(W("div",{className:"shopGrid",id:"hubShopGridActive"})),n.appendChild(W("div",{className:"shopLabel",text:"ÐŸÐ°ÑÑÐ¸Ð²ÐºÐ¸",style:{marginTop:"10px"}})),n.appendChild(W("div",{className:"shopGrid",id:"hubShopGridPassive"})),n.appendChild(W("div",{className:"shopLabel",text:"ÐÐ¾Ð²Ñ‹Ðµ ÑÐºÐ¸Ð»Ð»Ñ‹",style:{marginTop:"10px"}})),n.appendChild(W("div",{className:"shopGrid",id:"hubShopGridNew"})),n.appendChild(W("div",{className:"muted",style:{marginTop:"10px",fontSize:"12px",opacity:"0.85"},text:"ÐŸÐ¾Ð´Ð¾Ð¹Ð´Ð¸ Ðº NPC Ð² Ñ…Ð°Ð±Ðµ Ð¸ Ð½Ð°Ð¶Ð¼Ð¸ E/Interact. ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ° Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚/Ð¿Ñ€Ð¾ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ ÑÐºÐ¸Ð»Ð»Ñ‹ Ð½Ð°Ð²ÑÐµÐ³Ð´Ð°."})),D.shopOverlay.appendChild(n),document.body.appendChild(D.shopOverlay),D.shopCoins=n.querySelector("#hubShopCoins"),D.shopRerollCost=n.querySelector("#hubShopRerollCost"),D.shopMsg=n.querySelector("#hubShopMsg"),D.shopGridActive=n.querySelector("#hubShopGridActive"),D.shopGridPassive=n.querySelector("#hubShopGridPassive"),D.shopGridNew=n.querySelector("#hubShopGridNew"),l.addEventListener("click",()=>{const i=e.state,a=i==null?void 0:i.progression;if(!a)return;te(a);const p=10+(Fe|0)*5;if((a.coins|0)<p){Be("Not enough coins.");return}a.coins=Math.max(0,(a.coins|0)-p),Rt(a),Fe=(Fe|0)+1;try{ee(a)}catch{}It(i),Be("Rerolled!"),De="",cn(i)}),D.interactBtn.addEventListener("click",()=>{const i=e.state,a=i==null?void 0:i._hubNearbyNpc;a&&(a.kind==="shop"?Cn(i):a.kind==="tier"&&In(i))}),window.addEventListener("keydown",i=>{if(i.repeat)return;const a=e.state;if(!(!a||a.mode!=="playing")&&!wi()){if(i.code==="Escape"){a.overlayMode==="shop"?(Tn(a),i.preventDefault()):a.overlayMode==="stats"&&(a.overlayMode=null,i.preventDefault());return}if(i.code==="KeyE"){if(a.overlayMode)return;const p=a._hubNearbyNpc;if(!p)return;p.kind==="shop"?Cn(a):p.kind==="tier"&&In(a),i.preventDefault()}}})}function Ci(e){if(!An||!e)return;if(e._hubNpcTap&&!e.overlayMode){const t=String(e._hubNpcTap);e._hubNpcTap=null,t==="shop"?Cn(e):t==="tier"&&In(e)}const n=e.mode==="playing"&&!e.overlayMode&&!!e._hubNearbyNpc;if(D.interactWrap&&(D.interactWrap.style.display=n?"block":"none"),n&&D.interactBtn){const t=e._hubNearbyNpc;D.interactBtn.textContent=t.kind==="tier"?"Tier / Upgrades (E)":"Shop (E)"}const o=e.overlayMode==="shop";D.shopOverlay&&(D.shopOverlay.style.display=o?"flex":"none"),o&&cn(e)}const q=document.getElementById("gameCanvas"),Ti=q.getContext("2d");q.style.touchAction="none";function Ht(){q.width=window.innerWidth,q.height=window.innerHeight}window.addEventListener("resize",Ht);Ht();const Ii=Kt(),X=Vo(q,Ti,Ii);_i(X);Ai(X);let st=performance.now();function Bt(e){const n=Math.min(.05,(e-st)/1e3);st=e,Pi(X.state),X.update(n),Ci(X.state),X.render(),requestAnimationFrame(Bt)}requestAnimationFrame(Bt);q.addEventListener("mousemove",e=>{var r;const n=q.getBoundingClientRect(),o=e.clientX-n.left,t=e.clientY-n.top;((r=X.state)==null?void 0:r.mode)==="playing"&&Dt(o,t),X.handlePointerMove&&X.handlePointerMove(o,t)});q.addEventListener("mousedown",e=>{var r;const n=q.getBoundingClientRect(),o=e.clientX-n.left,t=e.clientY-n.top;e.button===0&&((r=X.state)==null?void 0:r.mode)==="playing"&&Ft(0,o,t),X.handlePointerDown&&X.handlePointerDown(o,t)});window.addEventListener("mouseup",e=>{var n;if(e.button===0&&(((n=X.state)==null?void 0:n.mode)==="playing"&&Ot(0),X.handlePointerUp)){const o=q.getBoundingClientRect(),t=e.clientX-o.left,r=e.clientY-o.top;X.handlePointerUp(t,r)}});q.addEventListener("touchstart",e=>{var t;const n=q.getBoundingClientRect(),o=q.width;for(let r=0;r<e.changedTouches.length;r++){const s=e.changedTouches[r],l=s.clientX-n.left,f=s.clientY-n.top;((t=X.state)==null?void 0:t.mode)==="playing"&&Vt(s.identifier,l,f,o),X.handlePointerDown&&X.handlePointerDown(l,f)}e.preventDefault()},{passive:!1});q.addEventListener("touchmove",e=>{var o;const n=q.getBoundingClientRect();for(let t=0;t<e.changedTouches.length;t++){const r=e.changedTouches[t],s=r.clientX-n.left,l=r.clientY-n.top;((o=X.state)==null?void 0:o.mode)==="playing"&&$t(r.identifier,s,l),X.handlePointerMove&&X.handlePointerMove(s,l)}e.preventDefault()},{passive:!1});q.addEventListener("touchend",e=>{var o;const n=q.getBoundingClientRect();for(let t=0;t<e.changedTouches.length;t++){const r=e.changedTouches[t];if(((o=X.state)==null?void 0:o.mode)==="playing"&&lt(r.identifier),X.handlePointerUp){const s=r.clientX-n.left,l=r.clientY-n.top;X.handlePointerUp(s,l)}}e.preventDefault()},{passive:!1});q.addEventListener("touchcancel",e=>{var o;const n=q.getBoundingClientRect();for(let t=0;t<e.changedTouches.length;t++){const r=e.changedTouches[t];if(((o=X.state)==null?void 0:o.mode)==="playing"&&lt(r.identifier),X.handlePointerUp){const s=r.clientX-n.left,l=r.clientY-n.top;X.handlePointerUp(s,l)}}e.preventDefault()},{passive:!1});
