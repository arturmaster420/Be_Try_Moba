(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))t(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const l of s.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&t(l)}).observe(document,{childList:!0,subtree:!0});function o(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(r){if(r.ep)return;r.ep=!0;const s=o(r);fetch(r.href,s)}})();const ae=new Set;function vn(){vn._initialized||(vn._initialized=!0,window.addEventListener("keydown",e=>{["KeyW","KeyA","KeyS","KeyD","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.code)&&(ae.add(e.code),e.preventDefault())}),window.addEventListener("keyup",e=>{ae.delete(e.code)}))}function lt(){let e=0,n=0;return(ae.has("KeyA")||ae.has("ArrowLeft"))&&(e-=1),(ae.has("KeyD")||ae.has("ArrowRight"))&&(e+=1),(ae.has("KeyW")||ae.has("ArrowUp"))&&(n-=1),(ae.has("KeyS")||ae.has("ArrowDown"))&&(n+=1),{x:e,y:n}}const I={mouseX:0,mouseY:0,mouseDown:!1,moveTouchId:null,moveBaseX:0,moveBaseY:0,moveVecX:0,moveVecY:0,aimTouchId:null,aimBaseX:0,aimBaseY:0,aimVecX:0,aimVecY:0,controlMode:"oneHand"},ct="btm_control_mode";if(typeof window<"u")try{const e=window.localStorage&&window.localStorage.getItem(ct);(e==="oneHand"||e==="twoHand")&&(I.controlMode=e)}catch{}function Vt(e,n){I.mouseX=e,I.mouseY=n}function $t(e,n,o){e===0&&(I.mouseDown=!0,I.mouseX=n,I.mouseY=o)}function Gt(e){e===0&&(I.mouseDown=!1)}function Xt(e,n,o,t){const r=I.controlMode==="oneHand",s=n<t/2;if(r){I.moveTouchId===null&&(I.moveTouchId=e,I.moveBaseX=n,I.moveBaseY=o,I.moveVecX=0,I.moveVecY=0);return}if(s){if(I.moveTouchId===null){I.moveTouchId=e,I.moveBaseX=n,I.moveBaseY=o,I.moveVecX=0,I.moveVecY=0;return}if(I.aimTouchId===null){I.aimTouchId=e,I.aimBaseX=n,I.aimBaseY=o,I.aimVecX=0,I.aimVecY=0;return}}else{if(I.aimTouchId===null){I.aimTouchId=e,I.aimBaseX=n,I.aimBaseY=o,I.aimVecX=0,I.aimVecY=0;return}if(I.moveTouchId===null){I.moveTouchId=e,I.moveBaseX=n,I.moveBaseY=o,I.moveVecX=0,I.moveVecY=0;return}}}function Wt(e,n,o){const t=I.controlMode==="oneHand",r=80;if(t){if(e===I.moveTouchId){let s=n-I.moveBaseX,l=o-I.moveBaseY;const f=Math.hypot(s,l);if(f>4){const i=Math.min(1,f/r);s=s/f*i,l=l/f*i,I.moveVecX=s,I.moveVecY=l}else I.moveVecX=0,I.moveVecY=0}return}if(e===I.moveTouchId){let s=n-I.moveBaseX,l=o-I.moveBaseY;const f=Math.hypot(s,l);if(f>4){const i=Math.min(1,f/r);s=s/f*i,l=l/f*i,I.moveVecX=s,I.moveVecY=l}else I.moveVecX=0,I.moveVecY=0}else if(e===I.aimTouchId){let s=n-I.aimBaseX,l=o-I.aimBaseY;const f=Math.hypot(s,l);if(f>4){const i=Math.min(1,f/r);s=s/f*i,l=l/f*i,I.aimVecX=s,I.aimVecY=l}else I.aimVecX=0,I.aimVecY=0}}function ut(e){const n=I.controlMode==="oneHand";e===I.moveTouchId&&(I.moveTouchId=null,I.moveVecX=0,I.moveVecY=0,n)||e===I.aimTouchId&&(I.aimTouchId=null,I.aimVecX=0,I.aimVecY=0)}function ft(){return{x:I.moveVecX,y:I.moveVecY}}function dt(){return I.controlMode==="oneHand"?!0:I.mouseDown||I.aimTouchId!==null}function pt(e,n,o,t,r,s=0){if(I.controlMode==="oneHand"){const d=Array.isArray(t)&&t.length>0,h=r&&r>0?r:0;if(!d||h<=0)return null;const b=h*h,x=3,p=v=>{if(!v||v.hp<=0)return!1;const M=v.x-e.x,_=v.y-e.y;return!(M*M+_*_>b||t.indexOf(v)===-1)};if(e.lastPlayerTarget&&typeof e.lastPlayerTargetAt=="number"&&s-e.lastPlayerTargetAt<=x&&p(e.lastPlayerTarget)){const v=e.lastPlayerTarget.x-e.x,M=e.lastPlayerTarget.y-e.y,_=Math.hypot(v,M)||1;return{x:v/_,y:M/_}}if(e.lastAttacker&&typeof e.lastAttackerAt=="number"&&s-e.lastAttackerAt<=x&&p(e.lastAttacker)){const v=e.lastAttacker.x-e.x,M=e.lastAttacker.y-e.y,_=Math.hypot(v,M)||1;return{x:v/_,y:M/_}}let g=null;for(const v of t){if(!v||v.hp<=0)continue;const M=v.x-e.x,_=v.y-e.y,w=M*M+_*_;if(w>b)continue;const P=v.maxHp>0?v.maxHp:1,C=v.hp/P;(!g||C<g.hpPct-1e-6||Math.abs(C-g.hpPct)<=1e-6&&w<g.d2)&&(g={e:v,hpPct:C,d2:w,dx:M,dy:_})}if(g){const v=Math.sqrt(g.d2)||1;return{x:g.dx/v,y:g.dy/v}}return null}if(I.aimTouchId!==null){const d=I.aimVecX,h=I.aimVecY,b=Math.hypot(d,h);if(b>.1)return{x:d/b,y:h/b}}const f=o.width,i=o.height,a=(I.mouseX-f/2)/(n.zoom||1)+n.x,m=(I.mouseY-i/2)/(n.zoom||1)+n.y;let u=a-e.x,c=m-e.y;const y=Math.hypot(u,c);return y<.001?null:(u/=y,c/=y,{x:u,y:c})}function Fn(e){if(e==="oneHand"||e==="portraitAuto")I.controlMode="oneHand";else if(e==="twoHand"||e==="classic")I.controlMode="twoHand";else return;if(typeof window<"u")try{window.localStorage&&window.localStorage.setItem(ct,I.controlMode)}catch{}}function On(){return I.controlMode||(I.controlMode="oneHand"),I.controlMode}const He=300,Hn=70;function Ve(e,n,o=0){const t=He+o,r=Math.min(Hn+o,t),s=Math.max(t-r,0),l=Math.abs(e),f=Math.abs(n);if(l>t||f>t)return!1;if(l<=s||f<=s)return!0;const i=l-s,a=f-s;return i*i+a*a<=r*r}const z={0:He,1:5e3,2:1e4,3:15e3,4:2e4,5:25e3,6:3e4},Z=z[6],pn=[{x:Z,y:Z},{x:-Z,y:Z},{x:Z,y:-Z},{x:-Z,y:-Z}];function _e(e,n){if(typeof n>"u"){const i=e;return i<z[1]?1:i<z[2]?2:i<z[3]?3:i<z[4]?4:i<z[5]?5:6}if(Ve(e,n))return 0;const o=Math.hypot(e,n),t=z[1],r=z[2],s=z[3],l=z[4],f=z[5];return o<t?1:o<r?2:o<s?3:o<l?4:o<f?5:6}function se(e){const n=Math.max(0,(e|0)-1);return{hp:1+n*.65+n*n*.05,damage:1+n*.35+n*n*.03,speed:1+n*.08+n*n*.01,xp:1+n*.55}}const Ie=Z,Vn=Ie*2,$n=Ie*2;function jt(){return{minX:-Ie,maxX:Ie,minY:-Ie,maxY:Ie}}const ce=["ðŸ˜€","ðŸ˜ƒ","ðŸ˜„","ðŸ˜","ðŸ˜†","ðŸ˜…","ðŸ¤£","ðŸ˜‚","ðŸ™‚","ðŸ™ƒ","ðŸ˜‰","ðŸ˜Š","ðŸ˜‡","ðŸ¥°","ðŸ˜","ðŸ¤©","ðŸ˜˜","ðŸ˜—","ðŸ˜š","ðŸ˜™","ðŸ˜‹","ðŸ˜›","ðŸ˜œ","ðŸ¤ª","ðŸ˜","ðŸ¤‘","ðŸ¤—","ðŸ¤­","ðŸ¤«","ðŸ¤”","ðŸ¤¨","ðŸ˜","ðŸ˜‘","ðŸ˜¶","ðŸ«¥","ðŸ˜","ðŸ˜’","ðŸ™„","ðŸ˜¬","ðŸ˜®â€ðŸ’¨","ðŸ˜Œ","ðŸ˜”","ðŸ˜ª","ðŸ¤¤","ðŸ˜´","ðŸ˜·","ðŸ¤’","ðŸ¤•","ðŸ¤¢","ðŸ¤®","ðŸ¥µ","ðŸ¥¶","ðŸ˜µ","ðŸ˜µâ€ðŸ’«","ðŸ¤¯","ðŸ˜Ž","ðŸ¥³","ðŸ˜ˆ","ðŸ‘¿","ðŸ’€","ðŸ‘¶","ðŸ§’","ðŸ‘¦","ðŸ‘§","ðŸ§‘","ðŸ‘¨","ðŸ‘©","ðŸ§”","ðŸ‘¨â€ðŸ¦±","ðŸ‘©â€ðŸ¦°","ðŸ§™","ðŸ§š","ðŸ§›","ðŸ§Ÿ","ðŸ§ž","ðŸ§œ","ðŸ§","ðŸ¥·","ðŸ¦¸","ðŸ¦¹","ðŸ¶","ðŸ±","ðŸ­","ðŸ¹","ðŸ°","ðŸ¦Š","ðŸ»","ðŸ¼","ðŸ¨","ðŸ¯","ðŸ¦","ðŸ®","ðŸ·","ðŸ¸","ðŸµ","ðŸ™ˆ","ðŸ™‰","ðŸ™Š","ðŸ”","ðŸ§","ðŸ¦","ðŸ¦‰","ðŸ¦‡","ðŸº","ðŸ—","ðŸ´","ðŸ¦„","ðŸ","ðŸª²","ðŸ¦‹","ðŸŒµ","ðŸŒ²","ðŸŒ³","ðŸŒ´","ðŸŒ±","ðŸ€","ðŸŒ¿","ðŸŒº","ðŸŒ¸","ðŸŒ¼","ðŸŒ™","â­","ðŸŒŸ","âœ¨","âš¡","ðŸ”¥","ðŸ’§","â„ï¸","ðŸŒˆ","â˜€ï¸","ðŸŽ¯","ðŸŽ®","ðŸ•¹ï¸","ðŸŽ²","â™Ÿï¸","ðŸ§©","ðŸŽ§","ðŸŽµ","ðŸŽ¸","ðŸ¥","ðŸ“Œ","ðŸ“Ž","ðŸ’Ž","ðŸ”®","ðŸ§ª","ðŸ§¬","ðŸ›°ï¸","ðŸš€","ðŸ›¸","ðŸ¤–","ðŸ‘¾","ðŸ§ ","ðŸ›¡ï¸","âš”ï¸","ðŸ¹","ðŸ”«","ðŸ’£","ðŸ§¨","ðŸ”§","âš™ï¸","â¤ï¸","ðŸ§¡","ðŸ’›","ðŸ’š","ðŸ’™","ðŸ’œ","ðŸ¤","ðŸ–¤","ðŸ’”","ðŸ’¥","âœ…","âŒ","âš ï¸","ðŸ’«","ðŸ’¤","ðŸŒ€","ðŸ‘‘","ðŸ†","ðŸ¥‡","ðŸ”±"];function an(e){const n=Math.max(0,e|0);return Math.max(2,Math.min(ce.length,2*(n+1)))}function Zt(e,n){const o=n|0;return o<0?!1:o<an(e)}function Yt(e,n){const o=Math.max(0,n|0),t=an(e);return Math.min(o,Math.max(0,t-1))}class ln{constructor(n,o){this.x=n.x,this.y=n.y,this.vx=0,this.vy=0,this.radius=18,this.color="#8fe3ff",this.nickname="",this.avatarIndex=0,this.level=o||0,this._runStartLevel=this.level,this.xp=0,this.baseMaxHP=100,this.baseMoveSpeed=220,this.baseDamage=4,this.baseAttackSpeed=2,this.baseRange=1,this.maxHP=this.baseMaxHP,this.hp=this.maxHP,this.moveSpeed=this.baseMoveSpeed,this.damage=this.baseDamage,this.attackSpeed=this.baseAttackSpeed,this.range=this.baseRange,this.maxAttackSpeed=4,this.maxDamage=20,this.maxMoveSpeed=380,this.rangeLimit=1,this.laserHeat=0,this.laserMaxHeat=100,this.laserHeatRate=1,this.laserOverheated=!1,this.attackCooldown=0,this.rocketCooldown=0,this.lightningCooldown=0,this._pendingLevelUps=0,this.runSkills={bullets:1,bombs:0,rockets:0,satellites:0,energyBarrier:0,spirit:0,summon:0,electricZone:0,laser:0,lightning:0},this.runEvolutions={},this.runPassives={damage:0,attackSpeed:0,moveSpeed:0,hp:0,hpRegen:0,range:0,pickupRadius:0,xpGain:0,critChance:0,critDamage:0,lifeSteal:0},this._runBaseMaxHP=void 0,this.runDamageMult=1,this.runAttackMult=1,this.runMoveMult=1,this.runRangeMult=1,this.runPickupBonusRadius=0,this.runXpGainMult=1,this.runCritChanceAdd=0,this.runCritDamageMult=1,this.runLifeSteal=0,this.runHpRegen=0,this.weaponStage=1,this.lastAimDir={x:0,y:1},this.lastPlayerTarget=null,this.lastPlayerTargetAt=-1/0,this.lastAttacker=null,this.lastAttackerAt=-1/0,this._lastCombatAt=-1/0}reset(n,o){this.x=n.x,this.y=n.y,this.vx=0,this.vy=0,this.level=o||0,this._runStartLevel=this.level,this.xp=0,this.maxHP=this.baseMaxHP,this.hp=this.maxHP,this.moveSpeed=this.baseMoveSpeed,this.damage=this.baseDamage,this.attackSpeed=this.baseAttackSpeed,this.range=this.baseRange,this.attackCooldown=0,this.rocketCooldown=0,this.lightningCooldown=0,this.weaponStage=1,this.laserHeat=0,this.laserOverheated=!1,this._pendingLevelUps=0,this.runSkills={bullets:1,bombs:0,rockets:0,satellites:0,energyBarrier:0,spirit:0,summon:0,electricZone:0,laser:0,lightning:0},this.runEvolutions={},this.runPassives={damage:0,attackSpeed:0,moveSpeed:0,hp:0,hpRegen:0,range:0,pickupRadius:0,xpGain:0,critChance:0,critDamage:0,lifeSteal:0},this._runBaseMaxHP=void 0,this.runDamageMult=1,this.runAttackMult=1,this.runMoveMult=1,this.runRangeMult=1,this.runPickupBonusRadius=0,this.runXpGainMult=1,this.runCritChanceAdd=0,this.runCritDamageMult=1,this.runLifeSteal=0,this.runHpRegen=0,this.lastPlayerTarget=null,this.lastPlayerTargetAt=-1/0,this.lastAttacker=null,this.lastAttackerAt=-1/0,this._lastCombatAt=-1/0}xpToNext(){const n=Math.max(0,(this.level|0)-(this._runStartLevel|0||0)),o=180+n*60+n*n*8,t=n<10?.55+n/10*.45:1;return Math.max(1,Math.floor(o*t))}gainXP(n,o){n*=2,this.xp+=n;let t=!1;for(;this.xp>=this.xpToNext();)this.xp-=this.xpToNext(),this.level+=1,t=!0,this._pendingLevelUps=(this._pendingLevelUps||0)+1,this.hp=this.maxHP;if(t&&o){if(o.net&&o.net.isHost){const r=o.player?String(o.player.id):"",s=String(this.id||"");if(r&&s&&r!==s)return}o.floatingTexts&&o.floatingTexts.push({x:this.x,y:this.y-30,text:"LEVEL UP!",time:1.2}),o.popups&&o.popups.push({text:"Level Up! Lv "+this.level,time:2})}}update(n,o){const t=ft();let r=t.x,s=t.y;if(Math.hypot(r,s)<.1){const c=lt();r=c.x,s=c.y}const l=Math.hypot(r,s);l>.001?(r/=l,s/=l):(r=0,s=0),this.vx=r*this.moveSpeed,this.vy=s*this.moveSpeed,this.x+=this.vx*n,this.y+=this.vy*n;const f=jt(),i=f.minX+this.radius,a=f.maxX-this.radius,m=f.minY+this.radius,u=f.maxY-this.radius;this.x<i&&(this.x=i),this.x>a&&(this.x=a),this.y<m&&(this.y=m),this.y>u&&(this.y=u),this.y<m&&(this.y=m),this.y>u&&(this.y=u),this.attackCooldown>0&&(this.attackCooldown-=n)}render(n){n.save();const o=this.color||"#8fe3ff",t=this.radius||18,r=this.avatarIndex|0,s=ce[r]||ce[0]||"ðŸ˜€",l=Math.max(12,Math.round(t*1.95));n.font=`${l}px "Apple Color Emoji","Segoe UI Emoji","Noto Color Emoji",sans-serif`,n.textAlign="center",n.textBaseline="middle";const f=s?n.measureText(s).width:l,a=Math.max(f,l)*.5;s&&(n.fillStyle="rgba(255,255,255,1)",n.fillText(s,this.x,this.y)),n.save(),n.globalCompositeOperation="destination-over",n.beginPath(),n.arc(this.x,this.y,a,0,Math.PI*2),n.strokeStyle=o,n.lineWidth=2,n.globalAlpha=.55,n.stroke(),n.restore();const m=Math.hypot(this.lastAimDir.x,this.lastAimDir.y)||1,u=this.lastAimDir.x/m,c=this.lastAimDir.y/m,y=this.x+u*(a+1),d=this.y+c*(a+1),h=this.x+u*(a+14),b=this.y+c*(a+14);n.beginPath(),n.strokeStyle="rgba(255,255,255,0.85)",n.lineWidth=2,n.moveTo(y,d),n.lineTo(h,b),n.stroke(),n.restore()}}class zt{constructor(n){this.canvas=n,this.x=0,this.y=0,this.zoom=1,this.positionLerp=8,this.zoomLerp=4,this._lastW=0,this._lastH=0,this._aspect=1,this._isMobile=!1,this._isLandscape=!0,this._zoomLockRange=null}_updateCanvasInfo(){const n=this.canvas.width||1,o=this.canvas.height||1;if(n===this._lastW&&o===this._lastH)return;this._lastW=n,this._lastH=o,this._aspect=n/o;const t=n>o?n:o;this._isMobile=t<1e3,this._isLandscape=this._aspect>=1}update(n,o){this._updateCanvasInfo();const t=this._lastW,r=this._lastH,s=n.x,l=n.y,f=o*this.positionLerp,i=f>1?1:f;this.x+=(s-this.x)*i,this.y+=(l-this.y)*i;const a=Number.isFinite(n.range)?n.range:220,m=a>1?a:220,u=this._isMobile?760:660,y=m/240,d=Math.log(y)/Math.log(2),h=Math.max(-.08,Math.min(.2,d*.12)),b=u*(1+h);let p=(t<r?t:r)/Math.max(1,b);const g=this._isMobile?.65:.55,v=this._isMobile?1.85:2.1;p<g&&(p=g),p>v&&(p=v);const M=o*this.zoomLerp,_=M>1?1:M;this.zoom+=(p-this.zoom)*_}applyTransform(n){const o=this.canvas.width,t=this.canvas.height;n.save(),n.translate(o/2,t/2),n.scale(this.zoom,this.zoom),n.translate(-this.x,-this.y)}resetTransform(n){n.restore()}}function qt(e,n,o,t){const{projectiles:r}=n,s=Math.atan2(o.dy??o.y,o.dx??o.x),l=t.count,f=t.spread*Math.PI/180;for(let i=0;i<l;i++){const m=((l===1?.5:i/(l-1))-.5)*f,u=s+m,c=900,y=n._nextProjectileId=(n._nextProjectileId||0)+1;r.push({id:y,x:e.x,y:e.y,ownerId:e.id||"local",vx:Math.cos(u)*c,vy:Math.sin(u)*c,speed:c,damage:t.damage,range:t.range,travel:0,radius:4,type:"bullet"})}}function Kt(e,n,o,t){const{rockets:r}=n,s=Math.atan2(o.dy??o.y,o.dx??o.x),l=t.count,f=12*Math.PI/180;for(let i=0;i<l;i++){const m=((l===1?.5:i/(l-1))-.5)*f,u=s+m,c=550,y=n._nextRocketId=(n._nextRocketId||0)+1;r.push({id:y,x:e.x,y:e.y,ownerId:e.id||"local",vx:Math.cos(u)*c,vy:Math.sin(u)*c,speed:c,damage:t.damage,range:t.range,travel:0,radius:6,splashRadius:t.splashRadius,type:"rocket"})}}function Jt(e,n,o,t){const{rockets:r}=n,s=Math.atan2(o.dy??o.y,o.dx??o.x),l=t.count||1,f=18*Math.PI/180;for(let i=0;i<l;i++){const m=((l===1?.5:i/(l-1))-.5)*f,u=s+m,c=t.speed||320,y=n._nextRocketId=(n._nextRocketId||0)+1;r.push({id:y,x:e.x,y:e.y,ownerId:e.id||"local",vx:Math.cos(u)*c,vy:Math.sin(u)*c,speed:c,damage:t.damage,range:t.range,travel:0,radius:t.radius||7,splashRadius:t.splashRadius,type:"bomb"})}}const ht="btm_progress",$e=15,xn={attackSpeed:{baseMax:10,perRes:5,unlockRTier:1},damage:{baseMax:15,perRes:10,unlockRTier:1},moveSpeed:{baseMax:10,perRes:5,unlockRTier:1},hp:{baseMax:20,perRes:20,unlockRTier:2},hpRegen:{baseMax:10,perRes:5,unlockRTier:2},range:{baseMax:10,perRes:5,unlockRTier:3},pickupRadius:{baseMax:10,perRes:5,unlockRTier:3},score:{baseMax:10,perRes:5,unlockRTier:4},xpGain:{baseMax:10,perRes:5,unlockRTier:4}},Mn={critChance:{unlockRTier:5,basePercent:5,perResPercent:5,stepPercent:.1},critDamage:{unlockRTier:5,basePercent:20,perResPercent:20,stepPercent:1},lifeSteal:{unlockRTier:6,basePercent:2,perResPercent:2,stepPercent:.1}};function ze(){return{nickname:"Player",avatarIndex:0,roomCode:"",totalScore:0,upgradePoints:0,coins:0,skillMeta:{},shopOffers:{active:[],passive:[]},shopRerollCount:0,metaVersion:6,resurrectedTier:$e,resGuardianKills:0,limits:{attackSpeed:0,damage:0,moveSpeed:0,hp:0,range:0,laserOverheat:0,hpRegen:0,xpGain:0,score:0,pickupRadius:0,critChance:0,critDamage:0,lifeSteal:0}}}function mt(e){if(!e)return 0;let n=0;for(const o in e){const t=e[o];typeof t=="number"&&!Number.isNaN(t)&&(n+=t)}return n}function Be(e,n){const o=Math.max(1,Math.min($e,e||1)),t=xn[n];if(t)return o<t.unlockRTier?0:t.baseMax+t.perRes*(o-t.unlockRTier);const r=Mn[n];if(r){if(o<r.unlockRTier)return 0;const s=o-r.unlockRTier;return(r.basePercent+r.perResPercent*s)/r.stepPercent}return 1/0}function yt(e){const n=Math.max(1,Math.min($e,e||1));let o=0;for(const t in xn){const r=xn[t];n<r.unlockRTier||(o+=r.baseMax+r.perRes*(n-r.unlockRTier))}for(const t in Mn){const r=Mn[t];if(n<r.unlockRTier)continue;const s=n-r.unlockRTier,f=(r.basePercent+r.perResPercent*s)/r.stepPercent;o+=f}return o}function Qt(e){if(!e)return!1;const n=e.limits||{},o=e.resurrectedTier||1,t=yt(o);return!t||!Number.isFinite(t)?!1:mt(n)/t>=.7}function eo(){try{const e=localStorage.getItem(ht);if(!e)return ze();const n=JSON.parse(e)||{},o=ze(),t={nickname:typeof n.nickname=="string"&&n.nickname.trim().length?n.nickname.trim().slice(0,16):o.nickname,avatarIndex:typeof n.avatarIndex=="number"?Math.max(0,n.avatarIndex|0):o.avatarIndex,roomCode:typeof n.roomCode=="string"?n.roomCode.trim().toUpperCase().slice(0,8):o.roomCode,totalScore:typeof n.totalScore=="number"?n.totalScore:o.totalScore,upgradePoints:typeof n.upgradePoints=="number"?n.upgradePoints:o.upgradePoints,coins:typeof n.coins=="number"&&Number.isFinite(n.coins)?Math.max(0,Math.floor(n.coins)):o.coins||0,skillMeta:n.skillMeta&&typeof n.skillMeta=="object"?n.skillMeta:o.skillMeta||{},shopOffers:n.shopOffers&&typeof n.shopOffers=="object"?n.shopOffers:o.shopOffers||{active:[],passive:[]},shopRerollCount:typeof n.shopRerollCount=="number"&&Number.isFinite(n.shopRerollCount)?Math.max(0,Math.floor(n.shopRerollCount)):o.shopRerollCount||0,metaVersion:6,resurrectedTier:typeof n.resurrectedTier=="number"?n.resurrectedTier:1,resGuardianKills:typeof n.resGuardianKills=="number"?n.resGuardianKills:0,limits:{}};t.resurrectedTier=$e;const r=n.limits&&typeof n.limits=="object"?n.limits:{},s=o.limits;for(const i in s){const a=r[i];t.limits[i]=typeof a=="number"&&!Number.isNaN(a)?a:0}const l=t.resurrectedTier||1;for(const i in t.limits){const a=Be(l,i),m=t.limits[i];Number.isFinite(a)&&m>a&&(t.limits[i]=a)}const f=Math.min(100,Math.floor((t.totalScore||0)/1e3));return t.avatarIndex=Yt(f,t.avatarIndex),t}catch(e){return console.error("[Progression] Failed to load progression",e),ze()}}function ne(e){try{localStorage.setItem(ht,JSON.stringify(e))}catch(n){console.error("[Progression] Failed to save progression",n)}}function Bn(e){const n=(e==null?void 0:e.totalScore)||0;return Math.min(100,Math.floor(n/1e3))}function Ge(e,n){if(!n)return null;const o=n.attackSpeed||0,t=n.damage||0,r=n.moveSpeed||0,s=n.hp||0,l=n.range||0,f=n.hpRegen||0,i=n.xpGain||0,a=n.score||0,m=n.pickupRadius||0,u=n.critChance||0,c=n.critDamage||0,y=n.lifeSteal||0,d=.02,h=.02,b=.01,x=.02;e.metaAttackMult=1+o*d,e.metaDamageMult=1+t*h,e.metaMoveMult=1+r*b,e.metaRangeMult=1+l*x;const p=e.baseMaxHP??e.maxHP??100,g=s*5;e.baseMaxHP=p,e.maxHP=p+g,e.hp>e.maxHP&&(e.hp=e.maxHP),e.metaHpRegen=f*.25,e.metaCritChance=u*.1/100,e.metaCritDamageMult=1+c*.01,e.metaLifeSteal=y*.001;const v=1+i*.005,M=1+a*.02,_=m*1;return{xpGainMult:v,scoreMult:M,pickupBonusRadius:_}}function Ne(e,n){const o=((e==null?void 0:e.metaCritChance)||0)+((e==null?void 0:e.runCritChanceAdd)||0),t=((e==null?void 0:e.metaCritDamageMult)||1)*((e==null?void 0:e.runCritDamageMult)||1);return o>0&&Math.random()<o?n*t:n}function we(e,n){if(!e||!Number.isFinite(n)||n<=0)return;const o=(e.metaLifeSteal||0)+(e.runLifeSteal||0);if(!o||o<=0)return;const t=n*o;if(!Number.isFinite(t)||t<=0)return;const r=e.maxHP??e.baseMaxHP??100;e.hp=Math.min(r,e.hp+t)}function no(e){if(!e)return;const n=e.resurrectedTier||1,o=Math.min($e,n+1);e.resurrectedTier=o,e.totalScore=0;const t=ze(),r={};for(const s in t.limits)r[s]=0;e.limits=r,ne(e)}function gt(e,n,o){let t=null;const r=(o||999999)*(o||999999);for(const s of n){if(s.hp<=0)continue;const l=s.x-e.x,f=s.y-e.y,i=l*l+f*f;i<r&&(!t||i<t.d2)&&(t={e:s,d2:i})}return t?t.e:null}function to(e,n,o,t){const r=[e];let s=e;for(;r.length<o;){let l=null;const f=t*t;for(const i of n){if(i===s||i.hp<=0||r.includes(i))continue;const a=i.x-s.x,m=i.y-s.y,u=a*a+m*m;u<=f&&(!l||u<l.d2)&&(l={e:i,d2:u})}if(!l)break;r.push(l.e),s=l.e}return r}function oo(e){return(e&&e.players&&e.players.length?e.players:e&&e.player?[e.player]:[]).filter(o=>o&&o.hp>0)}function fe(e,n,o={}){const t=oo(n),s=(n&&Array.isArray(n.summons)?n.summons:[]).filter(p=>p&&p.isSummon&&p.hp>0);if(!t.length&&!s.length)return(n==null?void 0:n.player)||null;const l=(n==null?void 0:n.time)||0;if(e&&typeof e._tauntedUntil=="number"&&e._tauntedUntil>l&&e._tauntedBySummonId){const p=String(e._tauntedBySummonId),g=s.find(v=>v&&String(v.id)===p);if(g)return g}const f=(e==null?void 0:e.x)||0,i=(e==null?void 0:e.y)||0,a=Number.isFinite(o.aggroRange)?o.aggroRange:Number.isFinite(e==null?void 0:e.aggroRange)?e.aggroRange:520,m=Number.isFinite(o.attackerMemorySec)?o.attackerMemorySec:3,u=Number.isFinite(o.allowSwitchDist)?o.allowSwitchDist:a*1.8;let c=t[0],y=1/0;for(const p of t){const g=p.x-f,v=p.y-i,M=g*g+v*v;M<y&&(y=M,c=p)}let d=null,h=1/0;for(const p of s){const g=Number.isFinite(p.tauntR)?p.tauntR:0;if(g<=0)continue;const v=p.x-f,M=p.y-i,_=v*v+M*M;_<=g*g&&_<h&&(h=_,d=p)}if(d)return d;const b=e&&typeof e._lastHitAt=="number"?e._lastHitAt:null,x=e&&e._lastHitBy!=null?String(e._lastHitBy):null;if(b!=null&&x&&l-b<=m){const p=t.find(g=>String(g.id)===x);if(p){const g=p.x-f,v=p.y-i;if(g*g+v*v<=u*u)return p}}return c}function io(e,n,o,t){const{enemies:r,floatingTexts:s}=n;let l;if(t){let u=null;const c=o.chainRange,y=c*c;for(const d of r){if(d.hp<=0)continue;const h=d.x-e.x,b=d.y-e.y,x=h*h+b*b;if(x>y)continue;const p=Math.sqrt(x),g=h/p,v=b/p;g*t.x+v*t.y<.4||(!u||x<u.d2)&&(u={e:d,d2:x})}l=u?u.e:null}else l=gt(e,r,o.chainRange);if(!l)return;e._lastCombatAt=n.time;const f=Math.max(2,o.maxTargets||2),i=to(l,r,f,o.chainRange);let a=o.damage;const m=[{x:e.x,y:e.y}];if(i&&i.length>0){e.lastPlayerTarget=i[0],e.lastPlayerTargetAt=n.time;for(const u of i)u&&(u._lastHitAt=n.time,u._lastHitBy=e.id||"local",u.aggroed=!0)}for(const u of i){m.push({x:u.x,y:u.y});const c=Ne(e,a);u.hp-=c,we(e,c),s.push({x:u.x,y:u.y-20,text:Math.round(c).toString(),time:.5}),a*=.75}n._lightningVisuals&&typeof n._lightningVisuals.set=="function"?n._lightningVisuals.set(String(e.id||"local"),m):n._lightningVisual=m}function Gn(e,n,o,t,r,s=null){const{enemies:l}=n,f=s&&Number.isFinite(s.range)?s.range:ro(e.level);n._laserVisuals&&typeof n._laserVisuals.delete=="function"?n._laserVisuals.delete(String(e.id||"local")):n._laserVisual=null;const i=Number.isFinite(e.laserMaxHeat)?e.laserMaxHeat:100,a=Number.isFinite(e.laserHeatRate)&&e.laserHeatRate>2?e.laserHeatRate:26,m=a*.85;if(e.laserHeat=Number.isFinite(e.laserHeat)?e.laserHeat:0,!r||!t){e.laserHeat=Math.max(0,e.laserHeat-m*o),e._laserOverheated&&e.laserHeat<=i*.3&&(e._laserOverheated=!1);return}if(e._laserOverheated){e.laserHeat=Math.max(0,e.laserHeat-m*1.15*o),e.laserHeat<=i*.3&&(e._laserOverheated=!1);return}if(e.laserHeat=Math.min(i,e.laserHeat+a*o),e.laserHeat>=i){e._laserOverheated=!0;return}const u=e.x,c=e.y,y=[];let d=0;for(const g of l){if(g.hp<=0)continue;const v=g.x-u,M=g.y-c,_=v*t.x+M*t.y;if(_<=0||_>f)continue;const w=t.x*_,P=t.y*_,C=v-w,k=M-P,A=(g.radius||20)+6;C*C+k*k<=A*A&&(y.push({enemy:g,dist:_}),_>d&&(d=_))}if(y.length>0){let g=y[0];for(const v of y)v.dist<g.dist&&(g=v),v.enemy&&(v.enemy._lastHitAt=n.time,v.enemy._lastHitBy=e.id||"local",v.enemy.aggroed=!0);e.lastPlayerTarget=g.enemy,e.lastPlayerTargetAt=n.time}const b=(s&&Number.isFinite(s.dps)?s.dps:so(e.level))*o;for(const g of y)g.enemy.hp-=b,we(e,b);y.length>0&&(e._lastCombatAt=n.time);const x=y.length>0?d:f,p={x1:u,y1:c,x2:u+t.x*x,y2:c+t.y*x};n._laserVisuals&&typeof n._laserVisuals.set=="function"?n._laserVisuals.set(String(e.id||"local"),p):n._laserVisual=p}function so(e){return 40+Math.max(0,Math.min(150,(e|0)-150))/150*110}function ro(e){return 200+Math.max(0,Math.min(150,(e|0)-150))/150*150}function ao(e,n,o,t){const r=(t==null?void 0:t.level)|0;if(!e||!n||r<=0){e&&(e._satelliteVis=null);return}const s=n.enemies||[],l=n.time||0,f=Math.max(1,t.count|0),i=t.orbitR,a=t.orbR,m=t.hitDamage,u=t.tick;if(e._satelliteVis={count:f,orbitR:i,orbR:a,speed:t.orbitSpeed||1.2},e._satelliteTick=(e._satelliteTick||0)-o,e._satelliteTick>0)return;e._satelliteTick=u;const c=l*(t.orbitSpeed||1.2),y=Math.PI*2/Math.max(1,f);let d=!1;for(let h=0;h<f;h++){const b=c+h*y,x=e.x+Math.cos(b)*i,p=e.y+Math.sin(b)*i;for(const g of s){if(!g||g.hp<=0)continue;const v=g.x-x,M=g.y-p,_=(g.radius||20)+a;if(v*v+M*M<=_*_){const w=Ne(e,m);g.hp-=w,we(e,w),d=!0,g._lastHitAt=n.time,g._lastHitBy=e.id||"local",g.aggroed=!0}}}d&&(e._lastCombatAt=n.time)}function lo(e,n,o,t){const r=(t==null?void 0:t.level)|0;if(!e||!n||r<=0){e&&(e._energyBarrierVis=null);return}const s=n.enemies||[],l=t.radius||0,f=t.pushSpeed||0,i=t.pulseDamage||0,a=t.tick||.3,m=t.slowMult??.85,u=t.dmgMult??.95,c=.45;e._energyBarrierVis={radius:l,lvl:r};const y=l*l;for(const h of s){if(!h||h.hp<=0)continue;const b=h.x-e.x,x=h.y-e.y;b*b+x*x>y||(h._barrierDebuffUntil=n.time+c,h._barrierSlowMult=m,h._barrierDmgMult=u)}if(f>0){const h=Math.max(0,l-26),b=h*h;for(const x of s){if(!x||x.hp<=0)continue;const p=x.x-e.x,g=x.y-e.y,v=p*p+g*g;if(v>b)continue;const M=Math.sqrt(v)||1e-4,_=p/M,w=g/M,P=f*o;x.x+=_*P,x.y+=w*P}}if(i<=0||(e._energyBarrierTick=(e._energyBarrierTick||0)-o,e._energyBarrierTick>0))return;e._energyBarrierTick=a;let d=!1;for(const h of s){if(!h||h.hp<=0)continue;const b=h.x-e.x,x=h.y-e.y,p=l+(h.radius||20);if(b*b+x*x<=p*p){const g=Ne(e,i);h.hp-=g,we(e,g),d=!0,h._lastHitAt=n.time,h._lastHitBy=e.id||"local",h.aggroed=!0}}d&&(e._lastCombatAt=n.time)}function co(e){const o=(e-1)/2,t=[];for(let r=0;r<e;r++)t.push((r-o)*12);return t}function uo(e,n,o,t){const r=(t==null?void 0:t.level)|0;if(!e||!n||r<=0){e&&(e._spiritVis=null);return}const s=n.time||0,l=n.enemies||[],f=n.projectiles||(n.projectiles=[]),i=Math.max(1,t.count|0),a=t.range||260,m=t.damage||1,u=t.rate||1,c=t.projectileSpeed||900;if(e._spiritVis={count:i},e._spiritCd=(e._spiritCd||0)-o,e._spiritCd>0)return;const y=1/Math.max(.01,u);e._spiritCd=y;const d=gt(e,l,a);if(!d)return;const h=co(i),b=e.y-(e.radius||18)-16;for(let x=0;x<i;x++){const p=e.x+h[x],g=b+Math.sin(s*7+x*1.7)*1.2,v=d.x-p,M=d.y-g,_=Math.hypot(v,M)||1e-4,w=v/_,P=M/_,C=n._nextProjectileId=(n._nextProjectileId||0)+1;f.push({id:C,x:p,y:g,ownerId:e.id||"local",vx:w*c,vy:P*c,speed:c,damage:m,range:a,travel:0,radius:4,type:"spiritShot"})}}function fo(e,n,o,t){const r=(t==null?void 0:t.level)|0;if(!e||!n||r<=0){e&&(e._electricZoneVis=null);return}const s=n.enemies||[],l=t.radius;if(e._electricZoneVis={radius:l},e._electricZoneTick=(e._electricZoneTick||0)-o,e._electricZoneTick>0)return;e._electricZoneTick=t.tick;const f=l*l;let i=!1;for(const a of s){if(!a||a.hp<=0)continue;const m=a.x-e.x,u=a.y-e.y;if(m*m+u*u<=f){const c=Ne(e,t.pulseDamage);a.hp-=c,we(e,c),i=!0,a._lastHitAt=n.time,a._lastHitBy=e.id||"local",a.aggroed=!0}}i&&(e._lastCombatAt=n.time)}function Te(e,n,o){return Math.max(n,Math.min(o,e))}function po(e,n,o,t){let r=null;const s=(t||999999)**2;for(const l of o){if(!l||l.hp<=0)continue;const f=l.x-e,i=l.y-n,a=f*f+i*i;a<=s&&(!r||a<r.d2)&&(r={e:l,d2:a})}return r?r.e:null}function bt(e){return e?(Array.isArray(e.summons)||(e.summons=[]),e.summons):[]}function ho(e,n,o,t,r){const s=bt(n),l=(e==null?void 0:e.id)??"local",f=n._nextSummonId=(n._nextSummonId||0)+1,i=Math.PI*2*(t/Math.max(1,r)),a=36+t%2*10,m=((e==null?void 0:e.x)||0)+Math.cos(i)*a,u=((e==null?void 0:e.y)||0)+Math.sin(i)*a,c=Math.max(1,o.hp|0),y=Te(Number(o.def||0),0,.75),d={id:`smn:${l}:${f}`,kind:"tank",isSummon:!0,ownerId:String(l),x:m,y:u,radius:o.radius||18,hp:c,maxHp:c,def:y,moveSpeed:o.moveSpeed||95,tauntR:o.tauntR||260,age:0};return d._dmgInMult=Te(1-y,.15,1),s.push(d),d}function mo(e,n,o,t){if(!e||!n)return;const r=!!(n.net&&n.net.roomCode),s=!!(r&&n.net.isHost);if(r&&!s){const d=t&&(t.count|0)>0?t.count|0:0;e._summonVis=d>0?{count:d}:null;return}const l=bt(n),f=String(e.id??"local"),i=t&&(t.count|0)>0?t.count|0:0;if(i<=0){l.length&&(n.summons=l.filter(d=>!(d&&d.isSummon&&String(d.ownerId)===f))),e._summonVis=null;return}e._summonVis={count:i};let a=l.filter(d=>d&&d.isSummon&&String(d.ownerId)===f&&(d.hp|0)>0);if(a.length<i){n._summonTankCD||(n._summonTankCD={});let d=Number(n._summonTankCD[f]||0);d-=o;const h=Number(t.cooldown||6);if(d<=0){const b=a.length;ho(e,n,t,b,i),d=h}n._summonTankCD[f]=d,a=l.filter(b=>b&&b.isSummon&&String(b.ownerId)===f&&(b.hp|0)>0)}if(a.length>i){const d=new Set;for(let h=0;h<i;h++)d.add(a[h].id);n.summons=l.filter(h=>!h||!h.isSummon||String(h.ownerId)!==f||d.has(h.id)),a=n.summons.filter(h=>h&&h.isSummon&&String(h.ownerId)===f&&(h.hp|0)>0)}const m=n.enemies||[],u=64,c=(t.lureR||t.tauntR||260)*1.05,y=po(e.x,e.y,m,c);for(let d=0;d<a.length;d++){const h=a[d];if(!h)continue;h.age=(h.age||0)+o;const b=Math.max(1,t.hp|0);if(b!==(h.maxHp|0)){const P=h.maxHp>0?Te(h.hp/h.maxHp,0,1):1;h.maxHp=b,h.hp=Math.max(1,Math.round(b*P))}if(h.def=Te(Number(t.def||0),0,.75),h._dmgInMult=Te(1-h.def,.15,1),h.moveSpeed=t.moveSpeed||h.moveSpeed||95,h.tauntR=t.tauntR||h.tauntR||260,h.radius=t.radius||h.radius||18,h.hp<=0)continue;let x,p;if(y&&y.hp>0){const P=y.x,C=y.y,k=P-e.x,A=C-e.y,S=Math.hypot(k,A)||1,B=k/S,T=A/S,L=(y.radius||20)+(h.radius||18)+14;x=P-B*L,p=C-T*L;const H=(d-(a.length-1)/2)*18;x+=-T*H,p+=B*H}else{const P=Math.PI*2*(d/Math.max(1,a.length));x=e.x+Math.cos(P)*u,p=e.y+Math.sin(P)*u}const g=x-h.x,v=p-h.y,M=Math.hypot(g,v)||1,_=Math.max(40,h.moveSpeed||95),w=Te(_*o,0,M);h.x+=g/M*w,h.y+=v/M*w;for(let P=0;P<a.length;P++){if(P===d)continue;const C=a[P];if(!C)continue;const k=h.x-C.x,A=h.y-C.y,S=k*k+A*A,B=(h.radius||18)+(C.radius||18)+2;if(S>1e-4&&S<B*B){const T=Math.sqrt(S),L=(B-T)*.35;h.x+=k/T*L,h.y+=A/T*L}}}if(a.length&&m.length){const d=Number(t.lureR||t.tauntR||0),h=Number(t.tauntHold||.85);if(d>0&&h>0){n._summonTankTauntTick||(n._summonTankTauntTick={});let b=Number(n._summonTankTauntTick[f]||0);if(b-=o,b<=0){const x=d*d,p=n.time||0;for(const g of m){if(!g||g.hp<=0)continue;const v=g.x-e.x,M=g.y-e.y;if(v*v+M*M>x)continue;let w=a[0],P=1/0;for(const C of a){const k=g.x-C.x,A=g.y-C.y,S=k*k+A*A;S<P&&(P=S,w=C)}w&&(g._tauntedBySummonId=w.id,g._tauntedUntil=p+h)}b=.22}n._summonTankTauntTick[f]=b}}n.summons=(n.summons||[]).filter(d=>d&&(!d.isSummon||d.hp>0))}function yo(e,n){return e/(n||1)}function re(e){const n=(e==null?void 0:e.metaRangeMult)||1,o=(e==null?void 0:e.runRangeMult)||1,t=n*o,r=2.2;return!Number.isFinite(t)||t<=r?t:r+(t-r)*.25}function he(e){const n=(e==null?void 0:e.baseDamage)||4,o=Number.isFinite(e==null?void 0:e.damage)?e.damage:n;return yo(o,n||1)}function Ln(e,n){const o=e&&e._metaSkillMeta&&typeof e._metaSkillMeta=="object"?e._metaSkillMeta:null,t=`skill:${n}`,r=o?o[t]:0;return typeof r=="number"&&Number.isFinite(r)?r|0:0}function vt(e){if(!e)return 220;const n=re(e),o=e.runSkills||{},t=(o.bullets||0)|0,r=t>0?(220+(t-1)*12)*n:0,s=(o.bombs||0)|0,l=s>0?(200+(s-1)*8)*n:0,f=(o.rockets||0)|0,i=f>0?(280+(f-1)*10)*n:0,a=(o.lightning||0)|0,m=a>0?(240+(a-1)*10)*n:0,u=(o.laser||0)|0,c=u>0?(260+(u-1)*15)*n:0;return Math.max(220*n,r,l,i,m,c)}function xt(e){if(!e)return 200;const n=re(e),o=e.runSkills||{},t=(o.bullets||0)|0,r=t>0?(220+(t-1)*12)*n:0,s=(o.bombs||0)|0,l=s>0?(200+(s-1)*8)*n:0,f=(o.rockets||0)|0,i=f>0?(280+(f-1)*10)*n:0,a=(o.lightning||0)|0,m=a>0?(240+(a-1)*10)*n:0,u=(o.laser||0)|0,c=u>0?(260+(u-1)*15)*n:0;return Math.max(220*n,r,l,i,m,c)}function go(e){var a;const n=(((a=e.runSkills)==null?void 0:a.bullets)??0)|0;if(n<=0)return null;const o=re(e),t=he(e),r=1+Math.floor((n-1)/4),s=r<=1?0:14,l=4+(n-1)*1.1,i=(e.attackSpeed||e.baseAttackSpeed||2)*(1+(n-1)*.05);return{count:r,spread:s,damage:l*t,range:(220+(n-1)*12)*o,rate:i}}function bo(e){var a;const n=(((a=e.runSkills)==null?void 0:a.bombs)||0)|0;if(n<=0)return null;const o=re(e),t=he(e),r=1+Math.floor((n-1)/5),s=12+(n-1)*4.2,l=(200+(n-1)*8)*o,f=60+(n-1)*4,i=Math.max(1.2,2.8-(n-1)*.06);return{count:r,damage:s*t,range:l,splashRadius:f,cooldown:i,speed:320}}function vo(e){var a;const n=(((a=e.runSkills)==null?void 0:a.rockets)||0)|0;if(n<=0)return null;const o=re(e),t=he(e),r=1+Math.floor((n-1)/4),s=150+(n-1)*28,l=(300+(n-1)*12)*o,f=85+(n-1)*5,i=Math.max(.65,.85-(n-1)*.02);return{count:r,damage:s*t,range:l,splashRadius:f,cooldown:i}}function xo(e){var i;const n=(((i=e.runSkills)==null?void 0:i.lightning)||0)|0;if(n<=0)return null;const o=re(e),t=he(e),r=Math.min(7,2+Math.floor((n-1)/4)),s=22+(n-1)*5,l=(240+(n-1)*10)*o,f=Math.max(.95,2.1-(n-1)*.05);return{maxTargets:r,damage:s*t,chainRange:l,cooldown:f}}function Mo(e){var l;const n=(((l=e.runSkills)==null?void 0:l.laser)||0)|0;if(n<=0)return null;const o=re(e),t=he(e),r=(260+(n-1)*15)*o,s=30+(n-1)*14;return{range:r,dps:s*t}}function ko(e){var y;const n=(((y=e.runSkills)==null?void 0:y.satellites)||0)|0;if(n<=0)return null;const o=re(e),t=he(e),r=Ln(e,"satellites"),s=r>=2?1:0,l=r>=3?1:0;let f=1;n>=5&&(f+=1+s),n>=9&&(f+=1+l),f=Math.min(5,Math.max(1,f));const i=(56+(n-1)*3+Math.max(0,f-1)*2)*(.85+(o-1)*.35),a=9+Math.floor((n-1)/3),m=(9+(n-1)*2)*t,u=Math.max(.11,.24-(n-1)*.011),c=1.1+(n-1)*.06;return{level:n,count:f,orbitR:i,orbR:a,hitDamage:m,tick:u,orbitSpeed:c}}function So(e){var u;const n=(((u=e.runSkills)==null?void 0:u.energyBarrier)||0)|0;if(n<=0)return null;const o=re(e),t=he(e),s=(n<=3?66+(n-1)*4:78+(n-1)*5)*(.9+(o-1)*.5),l=.85,f=.95;let i=0,a=0;n>=4&&n<=6?(i=140+(n-4)*35,a=(10+(n-4)*4)*t):n>=7&&(i=260+(n-7)*24,a=(16+(n-7)*5.5)*t);const m=a>0?Math.max(.18,.38-(n-1)*.012):.35;return{level:n,radius:s,pushSpeed:i,pulseDamage:a,tick:m,slowMult:l,dmgMult:f}}function _o(e){var y;const n=(((y=e.runSkills)==null?void 0:y.spirit)||0)|0;if(n<=0)return null;const o=re(e),t=he(e),r=Ln(e,"spirit"),s=r>=2?1:0,l=r>=3?1:0;let f=1;n>=5&&(f+=1+s),n>=9&&(f+=1+l),f=Math.min(5,Math.max(1,f));const a=(e.attackSpeed||e.baseAttackSpeed||2)*(1+(n-1)*.05)*.7,u=(4+(n-1)*1.1)*t*.7,c=(440+(n-1)*12)*o*.7;return{level:n,count:f,range:c,damage:u,rate:a,projectileSpeed:900}}function Ro(e){var f;const n=(((f=e.runSkills)==null?void 0:f.electricZone)||0)|0;if(n<=0)return null;const o=re(e),t=he(e),r=(140+(n-1)*9)*o,s=Math.max(.16,.34-(n-1)*.01),l=(22+(n-1)*7)*t;return{level:n,radius:r,tick:s,pulseDamage:l}}function Po(e){var d;const n=(((d=e.runSkills)==null?void 0:d.summon)||0)|0;if(n<=0)return null;const o=Ln(e,"summon"),t=o>=2?1:0,r=o>=3?1:0;let s=1;n>=5&&(s+=1+t),n>=9&&(s+=1+r),s=Math.min(5,Math.max(1,s));const l=85+(n-1)*30,f=Math.min(.55,.15+(n-1)*.015),i=92+(n-1)*3.5,a=260+(n-1)*14,m=18+Math.floor((n-1)/4),u=Math.max(3.5,8-(n-1)*.5),c=a*1.8;return{level:n,count:s,hp:l,def:f,moveSpeed:i,tauntR:a,radius:m,cooldown:u,lureR:c,tauntHold:.9}}function wo(e,n,o){if(!e||e.hp<=0)return;const t=vt(e),r=pt(e,n.camera,n.canvas,n.enemies,t,n.time),s=dt();return Mt(e,n,o,{aimDir:r,firing:s})}function Ao(e,n,o,{aimDir:t,firing:r}={}){if(!(!e||e.hp<=0))return Mt(e,n,o,{aimDir:t,firing:r})}function Mt(e,n,o,{aimDir:t,firing:r}={}){t&&Number.isFinite(t.x)&&Number.isFinite(t.y)&&(e.lastAimDir={x:t.x,y:t.y}),e.range=xt(e);const s=go(e);e.attackCooldown=(e.attackCooldown||0)-o,s&&r&&t&&e.attackCooldown<=0&&(qt(e,n,t,{count:s.count,spread:s.spread,damage:s.damage,range:s.range}),e.attackCooldown=1/Math.max(.01,s.rate));const l=bo(e);l&&(e.bombCooldown=(e.bombCooldown||0)-o,r&&t&&e.bombCooldown<=0&&(Jt(e,n,t,{count:l.count,damage:l.damage,range:l.range,splashRadius:l.splashRadius,speed:l.speed}),e.bombCooldown=l.cooldown));const f=vo(e);f&&(e.rocketCooldown=(e.rocketCooldown||0)-o,r&&t&&e.rocketCooldown<=0&&(Kt(e,n,t,{count:f.count,damage:f.damage,range:f.range,splashRadius:f.splashRadius}),e.rocketCooldown=f.cooldown));const i=xo(e);i&&(e.lightningCooldown=(e.lightningCooldown||0)-o,r&&e.lightningCooldown<=0&&(io(e,n,{damage:i.damage,chainRange:i.chainRange,maxTargets:i.maxTargets},t||null),e.lightningCooldown=i.cooldown));const a=Mo(e);a?Gn(e,n,o,t||null,!!r,a):Gn(e,n,o,null,!1,null);const m=ko(e);m?ao(e,n,o,m):e._satelliteVis=null;const u=So(e);u?lo(e,n,o,u):e._energyBarrierVis=null;const c=_o(e);c?uo(e,n,o,c):e._spiritVis=null;const y=Ro(e);y?fo(e,n,o,y):e._electricZoneVis=null;const d=Po(e);mo(e,n,o,d)}function ke(e,n){const o=se(e),t=30,r=6,s=90,l=10,f={type:"basic",zone:e,x:n.x,y:n.y,radius:20,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:10*e,isBoss:!1,isGateEnemy:!1,isElite:!1};return f.update=(i,a,m)=>{const u=fe(i,m,{aggroRange:i.aggroRange||450});if(!u)return;const c=u.x-i.x,y=u.y-i.y,d=Math.hypot(c,y)||1,h=typeof i._barrierDebuffUntil=="number"&&m.time<i._barrierDebuffUntil,b=h&&i._barrierSlowMult||1,x=h&&i._barrierDmgMult||1,p=i.speed*b;let g=c/d*p,v=y/d*p;const M=i.aiMode;if(M&&!i.aggroed){const w=i.aggroRange||450,P=c*c+y*y,C=typeof i._lastHitAt=="number"&&m.time-i._lastHitAt<=3,k=M==="camp"&&i.campCenter&&typeof i.campRadius=="number"&&P<=i.campRadius*i.campRadius;if(P<=w*w||C||k)i.aggroed=!0;else if(M==="patrol"&&i.patrolCenter){i._patrolAngle=(i._patrolAngle||0)+a*.9;const A=i.patrolRadius||360,S=i.patrolCenter.x+Math.cos(i._patrolAngle)*A,B=i.patrolCenter.y+Math.sin(i._patrolAngle)*A,T=S-i.x,L=B-i.y,H=Math.hypot(T,L)||1;g=T/H*p*.45,v=L/H*p*.45}else{const A=M==="camp"?i.campCenter:i.herdCenter;if(A){i._idleAngle=(i._idleAngle||0)+a*.6;const S=M==="camp"?i.campRadius||650:i.herdRadius||420,B=A.x+Math.cos(i._idleAngle)*S*.4,T=A.y+Math.sin(i._idleAngle)*S*.4,L=B-i.x,H=T-i.y,U=Math.hypot(L,H)||1;g=L/U*p*.35,v=H/U*p*.35}else g=0,v=0}}i.x+=g*a,i.y+=v*a;const _=(u.radius||18)+i.radius;if(c*c+y*y<=_*_&&!u._ghostActive&&!u._lvlUpInvuln&&!u._lvlUpChoosing){const w=u._shieldActive?.2:1,P=typeof u._dmgInMult=="number"?u._dmgInMult:1;u.hp-=i.damage*x*a*w*P,u.lastAttacker=i,u.lastAttackerAt=m.time}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#ff5f6f",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.restore()},f.onDeath=(i,a)=>{Math.random()<.22?a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"coin",coins:1,age:0}):a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"xp",xp:i.xpValue,age:0})},f}function Ce(e,n){const o=se(e),t=2.5,r=40,s=8,l=110,f=15,i={type:"elite",zone:e,x:n.x,y:n.y,radius:26,hp:r*o.hp*t,maxHp:r*o.hp*t,damage:s*o.damage*t,speed:l*o.speed*1.1,xpValue:f*o.xp*t,scoreValue:20*e,isBoss:!1,isGateEnemy:!1,isElite:!0};return i.update=(a,m,u)=>{const c=fe(a,u,{aggroRange:a.aggroRange||450});if(!c)return;const y=c.x-a.x,d=c.y-a.y,h=Math.hypot(y,d)||1,b=typeof a._barrierDebuffUntil=="number"&&u.time<a._barrierDebuffUntil,x=b&&a._barrierSlowMult||1,p=b&&a._barrierDmgMult||1,g=a.speed*x;let v=y/h*g,M=d/h*g;const _=a.aiMode;if(_&&!a.aggroed){const P=a.aggroRange||450,C=y*y+d*d,k=typeof a._lastHitAt=="number"&&u.time-a._lastHitAt<=3,A=_==="camp"&&a.campCenter&&typeof a.campRadius=="number"&&C<=a.campRadius*a.campRadius;if(C<=P*P||k||A)a.aggroed=!0;else if(_==="patrol"&&a.patrolCenter){a._patrolAngle=(a._patrolAngle||0)+m*.9;const S=a.patrolRadius||360,B=a.patrolCenter.x+Math.cos(a._patrolAngle)*S,T=a.patrolCenter.y+Math.sin(a._patrolAngle)*S,L=B-a.x,H=T-a.y,U=Math.hypot(L,H)||1;v=L/U*g*.45,M=H/U*g*.45}else{const S=_==="camp"?a.campCenter:a.herdCenter;if(S){a._idleAngle=(a._idleAngle||0)+m*.6;const B=_==="camp"?a.campRadius||650:a.herdRadius||420,T=S.x+Math.cos(a._idleAngle)*B*.4,L=S.y+Math.sin(a._idleAngle)*B*.4,H=T-a.x,U=L-a.y,E=Math.hypot(H,U)||1;v=H/E*g*.35,M=U/E*g*.35}else v=0,M=0}}a.x+=v*m,a.y+=M*m;const w=(c.radius||18)+a.radius;if(y*y+d*d<=w*w&&!c._ghostActive&&!c._lvlUpInvuln&&!c._lvlUpChoosing){const P=c._shieldActive?.25:1,C=typeof c._dmgInMult=="number"?c._dmgInMult:1;c.hp-=a.damage*p*m*P*C,c.lastAttacker=a,c.lastAttackerAt=u.time}},i.render=(a,m)=>{m.save(),m.beginPath(),m.fillStyle="#ffa43c",m.arc(a.x,a.y,a.radius,0,Math.PI*2),m.fill(),m.restore()},i.onDeath=(a,m)=>{if(Math.random()<.55){const c=2+(Math.random()*3|0);m.xpOrbs.push({x:a.x,y:a.y,radius:10,kind:"coin",coins:c,age:0})}else m.xpOrbs.push({x:a.x,y:a.y,radius:10,kind:"xp",xp:a.xpValue,age:0});if(Math.random()<.3){const c=["damage","attackSpeed","moveSpeed","regen","shield","xpGain"],y=c[Math.floor(Math.random()*c.length)];m.buffs.push({type:y,timeLeft:y==="regen"?15:y==="shield"?8:20,multiplier:.4,amount:y==="regen"?5:0});const d=y==="damage"?"Damage":y==="attackSpeed"?"Attack Speed":y==="moveSpeed"?"Move Speed":y==="regen"?"Regen":y==="shield"?"Shield":"XP Gain";m.floatingTexts.push({x:a.x,y:a.y-20,text:"BUFF: "+d,time:1}),m.popups.push({text:"Temporary buff: "+d,time:2})}},i}function hn(e,n){const o=e|0;if(o>=6){const t=[Xn,Wn,jn,Zn,Yn],r=t[Math.floor(Math.random()*t.length)];return r(e,n)}switch(o){case 1:return Xn(o,n);case 2:return Wn(o,n);case 3:return jn(o,n);case 4:return Zn(o,n);case 5:default:return Yn(o||5,n)}}function Xn(e,n){const o=se(e),t=90,r=10,s=65,l=20,f={type:"zone1Bruiser",zone:e,x:n.x,y:n.y,radius:26,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:20*e,isBoss:!1,isGateEnemy:!1,isElite:!0};return f.update=(i,a,m)=>{const u=fe(i,m,{aggroRange:900});if(!u)return;const c=u.x-i.x,y=u.y-i.y,d=Math.hypot(c,y)||1,h=typeof i._barrierDebuffUntil=="number"&&m.time<i._barrierDebuffUntil,b=h&&i._barrierSlowMult||1,x=h&&i._barrierDmgMult||1,g=i.speed*b,v=c/d*g,M=y/d*g;i.x+=v*a,i.y+=M*a;const _=(u.radius||18)+i.radius;if(c*c+y*y<=_*_&&!u._ghostActive&&!u._lvlUpInvuln&&!u._lvlUpChoosing){const w=u._shieldActive?.2:1,P=typeof u._dmgInMult=="number"?u._dmgInMult:1;u.hp-=i.damage*x*a*w*P,u.lastAttacker=i,u.lastAttackerAt=m.time}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#ffb347",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.restore()},f.onDeath=(i,a)=>{if(Math.random()<.35){const u=1+(Math.random()*2|0);a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"coin",coins:u,age:0})}else a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"xp",xp:i.xpValue,age:0})},f}function Wn(e,n){const o=se(e),t=45,r=7,s=150,l=18,f={type:"zone2Runner",zone:e,x:n.x,y:n.y,radius:18,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:22*e,isBoss:!1,isGateEnemy:!1,isElite:!0};return f.update=(i,a,m)=>{const u=fe(i,m,{aggroRange:950});if(!u)return;const c=u.x-i.x,y=u.y-i.y,d=Math.hypot(c,y)||1,h=typeof i._barrierDebuffUntil=="number"&&m.time<i._barrierDebuffUntil,b=h&&i._barrierSlowMult||1,x=h&&i._barrierDmgMult||1;let v=i.speed*b;d>260?v*=1.8:d>140&&(v*=1.3);const M=c/d*v,_=y/d*v;i.x+=M*a,i.y+=_*a;const w=(u.radius||18)+i.radius;if(c*c+y*y<=w*w&&!u._ghostActive&&!u._lvlUpInvuln&&!u._lvlUpChoosing){const P=u._shieldActive?.2:1;u.hp-=i.damage*x*a*P*inMult,u.lastAttacker=i,u.lastAttackerAt=m.time}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#f4ff5a",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.restore()},f.onDeath=(i,a)=>{a.xpOrbs.push({x:i.x,y:i.y,radius:9,xp:i.xpValue,age:0})},f}function jn(e,n){const o=se(e),t=35,r=12,s=85,l=24,f={type:"zone3Sniper",zone:e,x:n.x,y:n.y,radius:18,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:26*e,isBoss:!1,isGateEnemy:!1,isElite:!0,_shootTimer:0,_shootInterval:2.4,_shootFlash:0,_aimDx:0,_aimDy:0};return f.update=(i,a,m)=>{const u=fe(i,m,{aggroRange:1250});if(!u)return;const c=u.x-i.x,y=u.y-i.y,d=Math.hypot(c,y)||1,h=typeof i._barrierDebuffUntil=="number"&&m.time<i._barrierDebuffUntil,b=h&&i._barrierSlowMult||1,x=h&&i._barrierDmgMult||1,g=i.speed*b,v=420;let M=g*.8;if(d>v+80||(d<v-80?M*=-1:M=0),M!==0){const w=c/d*M,P=y/d*M;i.x+=w*a,i.y+=P*a}if(i._shootTimer+=a,i._shootFlash=Math.max(0,i._shootFlash-a*3),i._aimDx=c/d,i._aimDy=y/d,d<325&&i._shootTimer>=i._shootInterval&&(i._shootTimer=0,i._shootFlash=.25,!u._ghostActive&&!u._lvlUpInvuln&&!u._lvlUpChoosing)){const w=u._shieldActive?.4:1;u.hp-=i.damage*x*w,u.lastAttacker=i,u.lastAttackerAt=m.time}},f.render=(i,a)=>{if(a.save(),a.beginPath(),a.fillStyle="#70d6ff",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),i._shootFlash>0){const u=i.x+(i._aimDx||1)*260,c=i.y+(i._aimDy||0)*260;a.beginPath(),a.globalAlpha=i._shootFlash,a.moveTo(i.x,i.y),a.lineTo(u,c),a.lineWidth=3,a.strokeStyle="#ffffff",a.stroke(),a.globalAlpha=1}a.restore()},f.onDeath=(i,a)=>{a.xpOrbs.push({x:i.x,y:i.y,radius:10,xp:i.xpValue,age:0})},f}function Zn(e,n){const o=se(e),t=70,r=6,s=60,l=30,f={type:"zone4Spawner",zone:e,x:n.x,y:n.y,radius:24,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:30*e,isBoss:!1,isGateEnemy:!1,isElite:!0,_spawnTimer:0,_spawnInterval:6};return f.update=(i,a,m)=>{const{enemies:u}=m,c=fe(i,m,{aggroRange:1100});if(!c)return;const y=c.x-i.x,d=c.y-i.y,h=Math.hypot(y,d)||1,b=typeof i._barrierDebuffUntil=="number"&&m.time<i._barrierDebuffUntil,x=b&&i._barrierSlowMult||1,p=b&&i._barrierDmgMult||1,v=i.speed*x,M=y/h*v*.6,_=d/h*v*.6;i.x+=M*a,i.y+=_*a;const w=(c.radius||18)+i.radius;if(y*y+d*d<=w*w&&!c._ghostActive&&!c._lvlUpInvuln&&!c._lvlUpChoosing){const P=c._shieldActive?.2:1;c.hp-=i.damage*p*a*P*inMult,c.lastAttacker=i,c.lastAttackerAt=m.time}if(i._spawnTimer+=a,i._spawnTimer>=i._spawnInterval){i._spawnTimer=0;let P=0;const C=10;for(const k of u){if(k===i||k.type!=="basic")continue;const A=k.x-i.x,S=k.y-i.y;if(A*A+S*S<=500*500&&(P++,P>=C))break}if(P<C)for(let A=0;A<2;A++){const S=Math.random()*Math.PI*2,B=120+Math.random()*60,T=i.x+Math.cos(S)*B,L=i.y+Math.sin(S)*B;u.push(ke(e,{x:T,y:L}))}}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#b388ff",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.beginPath(),a.fillStyle="#ffffff",a.arc(i.x,i.y,i.radius*.45,0,Math.PI*2),a.fill(),a.restore()},f.onDeath=(i,a)=>{a.xpOrbs.push({x:i.x,y:i.y,radius:12,xp:i.xpValue,age:0})},f}function Yn(e,n){const o=se(e),t=200,r=16,s=75,l=80,f={type:"zone5Champion",zone:e,x:n.x,y:n.y,radius:30,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:60*e,isBoss:!1,isGateEnemy:!1,isElite:!0};return f.update=(i,a,m)=>{const u=fe(i,m,{aggroRange:1200});if(!u)return;const c=u.x-i.x,y=u.y-i.y,d=Math.hypot(c,y)||1,h=typeof i._barrierDebuffUntil=="number"&&m.time<i._barrierDebuffUntil,b=h&&i._barrierSlowMult||1,x=h&&i._barrierDmgMult||1,g=i.speed*b,v=c/d*g*.9,M=y/d*g*.9;i.x+=v*a,i.y+=M*a;const _=(u.radius||18)+i.radius;if(c*c+y*y<=_*_&&!u._ghostActive&&!u._lvlUpInvuln&&!u._lvlUpChoosing){const w=u._shieldActive?.25:1;u.hp-=i.damage*x*a*w*inMult,u.lastAttacker=i,u.lastAttackerAt=m.time}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#ff4b5c",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.beginPath(),a.lineWidth=3,a.strokeStyle="#ffffff",a.arc(i.x,i.y,i.radius+4,0,Math.PI*2),a.stroke(),a.restore()},f.onDeath=(i,a)=>{a.xpOrbs.push({x:i.x,y:i.y,radius:14,xp:i.xpValue,age:0})},f}function zn(e,n){const o=se(e),t=30,r=80,s=10,l=70,f=50,i={type:"roamingBoss",isRoamingBoss:!0,zone:e,x:n.x,y:n.y,radius:45,hp:r*o.hp*t,maxHp:r*o.hp*t,damage:s*o.damage*2,speed:l*o.speed*1.1,xpValue:f*o.xp*5,scoreValue:300*e,isBoss:!0,isGateEnemy:!1};return i.update=(a,m,u)=>{const c=fe(a,u,{aggroRange:1600});if(!c)return;const y=c.x-a.x,d=c.y-a.y,h=typeof a._barrierDebuffUntil=="number"&&u.time<a._barrierDebuffUntil,b=h&&a._barrierSlowMult||1,x=h&&a._barrierDmgMult||1,p=a.speed*b,g=Math.atan2(d,y),v=Math.sin(u.time*.6)*.8,M=g+v,_=Math.cos(M)*p,w=Math.sin(M)*p;a.x+=_*m,a.y+=w*m;const P=(c.radius||18)+a.radius;if(y*y+d*d<=P*P&&!c._ghostActive&&!c._lvlUpInvuln&&!c._lvlUpChoosing){const C=c._shieldActive?.4:1,k=typeof c._dmgInMult=="number"?c._dmgInMult:1;c.hp-=a.damage*x*m*C*k,c.lastAttacker=a,c.lastAttackerAt=u.time}},i.render=(a,m)=>{m.save(),m.beginPath(),m.fillStyle="#ff3cbe",m.arc(a.x,a.y,a.radius,0,Math.PI*2),m.fill();const u=a.hp/a.maxHp;m.strokeStyle="#ffffff",m.lineWidth=3,m.beginPath(),m.arc(a.x,a.y,a.radius+6,-Math.PI/2,-Math.PI/2+Math.PI*2*u),m.stroke(),m.restore()},i.onDeath=(a,m)=>{if(Math.random()<.85){const c=8+(Math.random()*9|0);m.xpOrbs.push({x:a.x,y:a.y,radius:8,kind:"coin",coins:c,age:0})}else m.xpOrbs.push({x:a.x,y:a.y,radius:8,kind:"xp",xp:a.xpValue,age:0})},i}function Co(e,n){const o=se(e),t=400,r=35,s=80,l=200,f={type:"resurrectionGuardian",isResGuardian:!0,isResurrectionGuardian:!0,zone:e,x:n.x,y:n.y,radius:40,hp:t*o.hp,maxHp:t*o.hp,damage:r*o.damage,speed:s*o.speed,xpValue:l*o.xp,scoreValue:200,isBoss:!0,isGateEnemy:!1};return f.update=(i,a,m)=>{const u=fe(i,m,{aggroRange:1600});if(!u)return;const c=u.x-i.x,y=u.y-i.y,d=Math.hypot(c,y)||1,h=typeof i._barrierDebuffUntil=="number"&&m.time<i._barrierDebuffUntil,b=h&&i._barrierSlowMult||1;h&&i._barrierDmgMult;const x=i.speed*b,p=c/d*x,g=y/d*x;i.x+=p*a,i.y+=g*a},f.onHitPlayer=(i,a,m)=>{!a._lvlUpInvuln&&!a._lvlUpChoosing&&(a.hp-=i.damage*(typeof i._barrierDebuffUntil=="number"&&m&&m.time<i._barrierDebuffUntil&&i._barrierDmgMult||1)),a.lastAttacker=i,a.lastAttackerAt=m&&m.time||0},f.onDeath=(i,a)=>{a.flags&&(a.flags.resGuardianKilledThisRun=!0),a.progression&&(a.progression.resGuardianKills=(a.progression.resGuardianKills||0)+1),a.popups&&a.popups.push({text:"Guardian of Resurrection defeated!",time:3}),a.floatingTexts&&a.floatingTexts.push({x:i.x,y:i.y-24,text:"RESURECTION READY",time:1.8})},f.render=(i,a)=>{a.save(),a.fillStyle="#ffdd44",a.beginPath(),a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill();const m=i.hp/i.maxHp;a.strokeStyle="#ffffff",a.lineWidth=4,a.beginPath(),a.arc(i.x,i.y,i.radius+6,-Math.PI/2,-Math.PI/2+Math.PI*2*m),a.stroke(),a.restore()},f}function Io(e,n){const o=se(e),t=220,r=18,s=70,l=250,f={type:"zone6SuperBoss",isBoss:!0,isZone6SuperBoss:!0,zone:e,x:n.x,y:n.y,radius:60,hp:t*o.hp*12,maxHp:t*o.hp*12,damage:r*o.damage,speed:s*o.speed*.6,regenPerSec:8*o.hp,xpValue:l*o.xp*6,scoreValue:2e3,spawnTimer:0};return f.update=(i,a,m)=>{const{enemies:u}=m,c=fe(i,m,{aggroRange:1800});if(!c)return;const y=c.x-i.x,d=c.y-i.y,h=Math.hypot(y,d)||1,b=typeof i._barrierDebuffUntil=="number"&&m.time<i._barrierDebuffUntil,x=b&&i._barrierSlowMult||1,p=b&&i._barrierDmgMult||1,g=i.speed*x,v=600,M=900;let _=0,w=0;h<v?(_=-(y/h)*g,w=-(d/h)*g):h>M&&(_=y/h*(g*.5),w=d/h*(g*.5)),i.x+=_*a,i.y+=w*a,i.regenPerSec>0&&i.hp>0&&(i.hp=Math.min(i.maxHp,i.hp+i.regenPerSec*a)),i.spawnTimer+=a;const P=4.5;if(i.spawnTimer>=P){i.spawnTimer=0;const k=3+Math.floor(Math.random()*2);for(let A=0;A<k;A++){const S=Math.random()*Math.PI*2,B=i.radius+80+Math.random()*80,T=i.x+Math.cos(S)*B,L=i.y+Math.sin(S)*B,H=ke(e,{x:T,y:L});H.isFromSuperBoss=!0,u.push(H)}}const C=(c.radius||18)+i.radius;if(y*y+d*d<=C*C&&!c._ghostActive&&!c._lvlUpInvuln&&!c._lvlUpChoosing){const k=c._shieldActive?.4:1,A=typeof c._dmgInMult=="number"?c._dmgInMult:1;c.hp-=i.damage*p*a*k*A,c.lastAttacker=i,c.lastAttackerAt=m.time}},f.render=(i,a)=>{a.save(),a.beginPath(),a.fillStyle="#1be7ff",a.arc(i.x,i.y,i.radius,0,Math.PI*2),a.fill(),a.beginPath(),a.strokeStyle="#ffed00",a.lineWidth=4,a.arc(i.x,i.y,i.radius+6,0,Math.PI*2),a.stroke();const m=i.hp/i.maxHp;a.beginPath(),a.strokeStyle="#ffffff",a.lineWidth=3,a.arc(i.x,i.y,i.radius+12,-Math.PI/2,-Math.PI/2+Math.PI*2*m),a.stroke(),a.restore()},f.onDeath=(i,a)=>{if(Math.random()<.9){const u=14+(Math.random()*15|0);a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"coin",coins:u,age:0})}else a.xpOrbs.push({x:i.x,y:i.y,radius:8,kind:"xp",xp:i.xpValue,age:0})},f}function J(e,n){return e+Math.random()*(n-e)}function ie(e,n){return e+Math.floor(Math.random()*(n-e+1))}const To={1:[2,4],2:[2,4],3:[2,3],4:[2,3],5:[3,4],6:[3,4]},qn={1:{herd:.6,patrol:.4,camp:0},2:{herd:.5,patrol:.35,camp:.15},3:{herd:.45,patrol:.35,camp:.2},4:{herd:.4,patrol:.35,camp:.25},5:{herd:.35,patrol:.35,camp:.3},6:{herd:.3,patrol:.35,camp:.35}};function Ho(e){const n=qn[e]||qn[3],o=Math.random();return o<n.camp?"camp":o<n.camp+n.patrol?"patrol":"herd"}function Bo(e){return e<=1?[4,7]:e===2?[5,8]:e===3?[6,10]:e===4?[7,12]:[8,14]}function Lo(e){return e<=1?[3,5]:e===2?[4,6]:e===3?[5,8]:e===4?[6,9]:[7,11]}function No(e){return e<=1?[3,5]:e===2?[4,6]:e===3?[5,8]:e===4?[6,10]:[7,12]}function Kn(e,n,o){return Math.max(n,Math.min(o,e))}function Ue(e,n,o){if(!e)return;const t=Kn(n|0,1,6),s=(Kn(o|0,1,500)-1)/499,l=[0,.7,.9,1.4,2,2.7,3.4][t],f=[0,.2,.26,.38,.52,.66,.82][t],i=[0,.18,.2,.24,.3,.36,.42][t],a=1+s*l,m=1+s*f,u=1+s*i;Number.isFinite(e.hp)&&(e.hp*=a),Number.isFinite(e.maxHp)&&(e.maxHp*=a),Number.isFinite(e.damage)&&(e.damage*=m),Number.isFinite(e.xpValue)&&(e.xpValue*=u),Number.isFinite(e.scoreValue)&&(e.scoreValue*=u)}function ve(e,n){const o=Math.random()*Math.PI*2,t=Math.sqrt(Math.random()*(n*n-e*e)+e*e);return{x:Math.cos(o)*t,y:Math.sin(o)*t}}function je(e){const n=z[1],o=z[2],t=z[3],r=z[4],s=z[5];if(e===0)return{x:0,y:0};if(e===1){for(let l=0;l<40;l++){const f=Math.random()*Math.PI*2,i=Math.sqrt(Math.random())*n,a={x:Math.cos(f)*i,y:Math.sin(f)*i};if(!Ve(a.x,a.y))return a}return ve(n*.15,n)}if(e===2)return ve(n,o);if(e===3)return ve(o,t);if(e===4)return ve(t,r);if(e===5)return ve(r,s);for(let l=0;l<20;l++){const f=Math.random()<.35;let i;if(f?i={x:J(-Z,Z),y:J(-Z,Z)}:i=ve(s,Z),Math.hypot(i.x,i.y)>=s)return i}return ve(s,Z)}function Uo(e,n){return e+","+n}class Eo{constructor(n){this.state=n,this.cellSize=1800,this.generatedCells=new Set,this.groups=new Map,this.nextGroupId=1,this.nextEnemyId=1,this.roamingTimer=0,this.cornerBossNextRespawnAt=[0,0,0,0],this.cornerBossAlive=[!1,!1,!1,!1],this.guardianSpawned=!1,this.superBossSpawned=!1,this.superBossPoint=null}reset(){this.generatedCells.clear(),this.groups.clear(),this.nextGroupId=1,this.nextEnemyId=1,this.roamingTimer=0,this.cornerBossNextRespawnAt=[0,0,0,0],this.cornerBossAlive=[!1,!1,!1,!1],this.guardianSpawned=!1,this.superBossSpawned=!1;const n=je(6);this.superBossPoint={x:n.x,y:n.y}}ensureEnemyId(n){n&&(n.id==null&&(n.id=`e${this.nextEnemyId++}`),n._id==null&&(n._id=n.id))}onZoneChanged(n){this.roamingTimer=0,this.cornerBossNextRespawnAt=[0,0,0,0],this.cornerBossAlive=[!1,!1,!1,!1]}onEnemyRemoved(n,o){if(n&&n.isZone6CornerBoss){const s=n.cornerIndex|0;s>=0&&s<4&&(this.cornerBossAlive[s]=!1,this.cornerBossNextRespawnAt[s]=o.time+90)}const t=n&&n.groupId;if(!t)return;const r=this.groups.get(t);r&&(r.aliveCount=Math.max(0,(r.aliveCount|0)-1),r.aliveCount<=0&&r.spawned&&!r.isWiped&&(r.isWiped=!0,r.spawned=!1,r.wipedAt=o.time,r.nextRespawnAt=o.time+(r.respawnDelaySec||20)))}createGroup(n,o,t){const r="g"+this.nextGroupId++,s=Math.max(0,Math.min(6,n|0)),l=s<=2?14:s===3?16:s===4?18:20,f=o==="camp"?l+14:o==="patrol"?l+6:l,i={id:r,zone:n,type:o,center:{x:t.x,y:t.y},spawned:!1,aliveCount:0,isWiped:!1,wipedAt:0,nextRespawnAt:0,respawnDelaySec:f,activationDist:(o==="camp"?5400:o==="patrol"?5200:4800)+s*220};return this.groups.set(r,i),i}spawnGroup(n,o){const{enemies:t,player:r}=this.state,s=n.zone,l=n.center.x,f=n.center.y,i=o&&o.level||r&&r.level||1,a=[],m=(u,c)=>{u&&(u.id==null&&(u.id=`e${this.nextEnemyId++}`),u._id==null&&(u._id=u.id),u.zone=s,u.groupId=n.id,u.aiMode=c,u.aggroed=!1,u.aggroRange=c==="camp"||c==="patrol"?520:c==="herdPassive"?360:500,c==="camp"?(u.campCenter={x:l,y:f},u.campRadius=700):c==="patrol"?(u.patrolCenter={x:l,y:f},u.patrolRadius=J(260,520),u._patrolAngle=Math.random()*Math.PI*2):c==="herdPassive"&&(u.herdCenter={x:l,y:f},u.herdRadius=J(280,520),u._idleAngle=Math.random()*Math.PI*2),Ue(u,s,i),t.push(u),a.push(u))};if(n.type==="herd"){const[u,c]=Bo(s),y=ie(u,c);for(let d=0;d<y;d++){const h=Math.random()*Math.PI*2,b=J(50,260),x={x:l+Math.cos(h)*b,y:f+Math.sin(h)*b};s===6?Math.random()<.6?m(Ce(6,x),"herdPassive"):m(hn(6,x),"herdPassive"):m(ke(s,x),"herdPassive")}}if(n.type==="patrol"){const[u,c]=Lo(s),y=ie(u,c);for(let d=0;d<y;d++){const h=Math.random()*Math.PI*2,b=J(80,340),x={x:l+Math.cos(h)*b,y:f+Math.sin(h)*b};s===6?Math.random()<.75?m(Ce(6,x),"patrol"):m(hn(6,x),"patrol"):s===1?m(ke(1,x),"patrol"):Math.random()<.25?m(Ce(s,x),"patrol"):m(ke(s,x),"patrol")}}if(n.type==="camp")if(s===1){const u=ie(6,10);for(let c=0;c<u;c++){const y=Math.random()*Math.PI*2,d=J(80,360),h={x:l+Math.cos(y)*d,y:f+Math.sin(y)*d};m(ke(1,h),"herdPassive")}}else{const u={x:l+J(-60,60),y:f+J(-60,60)},c=Ce(s===0?1:s,u);c.isMiniBoss=!0;const y=Math.max(1,s|0),d=y<=1?2:y===2?2.3:y===3?2.6:2.8,h=y<=1?1.2:y===2?1.25:1.35;c.hp*=d,c.maxHp*=d,c.damage*=h,c.radius=(c.radius||26)+(y<=2?6:8),c.xpValue=(c.xpValue||20)*2,c.scoreValue=(c.scoreValue||20)*2.5,m(c,"camp");const[b,x]=No(s),p=ie(b,x);for(let g=0;g<p;g++){const v=Math.random()*Math.PI*2,M=J(120,420),_={x:l+Math.cos(v)*M,y:f+Math.sin(v)*M};s===6?Math.random()<.6?m(Ce(6,_),"camp"):m(hn(6,_),"camp"):Math.random()<.2?m(Ce(s,_),"camp"):m(ke(s,_),"camp")}}n.spawned=!0,n.isWiped=!1,n.aliveCount=a.length}ensureCellsAroundPlayer(n){if(!n)return;const o=this.cellSize,t=Math.floor(n.x/o),r=Math.floor(n.y/o),l=(this.state.players&&this.state.players.length?this.state.players.length:1)>=4?3:4;for(let f=-l;f<=l;f++)for(let i=-l;i<=l;i++){const a=t+i,m=r+f,u=Uo(a,m);if(this.generatedCells.has(u))continue;this.generatedCells.add(u);const c={x:(a+.5)*o+J(-o*.25,o*.25),y:(m+.5)*o+J(-o*.25,o*.25)},y=_e(c.x,c.y);if(y===0)continue;const[d,h]=To[y]||[2,3],b=ie(d,h);for(let p=0;p<b;p++){const g={x:c.x+J(-o*.25,o*.25),y:c.y+J(-o*.25,o*.25)},v=_e(g.x,g.y);if(v===0)continue;const M=Ho(v);this.createGroup(v,M,g)}const x=Math.max(Math.abs(i),Math.abs(f));this.spawnAmbientOrbsForCell(y,c,x)}}spawnAmbientOrbsForCell(n,o,t=0){const r=this.state;if(!r||!Array.isArray(r.xpOrbs))return;const s=n|0;if(s===0||(t|0)>2)return;const l=(t|0)<=1,f=l?1:s<=2?.7:s<=4?.55:.45;if(Math.random()>f)return;const i=3;let a;s<=2?a=l?ie(4,7):ie(2,4):s<=4?a=l?ie(3,6):ie(1,3):a=l?ie(3,5):ie(1,2);const m=a*i;if(m<=0)return;const u=this.cellSize,c=se(s);for(let y=0;y<m;y++){const d=o.x+J(-u*.38,u*.38),h=o.y+J(-u*.38,u*.38);if((_e(d,h)|0)===0)continue;Math.random()<.18?r.xpOrbs.push({x:d,y:h,radius:8,kind:"coin",coins:1,age:0,ttl:J(600,900),spawnDelay:.2,ambient:!0}):r.xpOrbs.push({x:d,y:h,radius:8,kind:"xp",xp:Math.max(6,Math.round(6*(c.xp||1))),age:0,ttl:J(600,900),spawnDelay:.2,ambient:!0})}}update(n){const o=this.state,t=o.enemies,r=o.players&&o.players.length?o.players.filter(Boolean):o.player?[o.player]:[],s=r.filter(b=>b&&b.hp>0),l=s.length?s:r;if(!l.length)return;const f=l.map(b=>({p:b,z:_e(b.x,b.y)}));let i=0,a=!1;for(const b of f)b&&(i=Math.max(i,b.z|0),b.z|0&&(a=!0));if(a)for(const b of f)!b||!(b.z|0)||this.ensureCellsAroundPlayer(b.p);for(const b of this.groups.values())b.isWiped&&o.time>=b.nextRespawnAt&&(b.isWiped=!1,b.spawned=!1,b.aliveCount=0);let u=(i>=6?5:i>=5?4:i>=4||i>=3?3:(i>=2,2))+Math.min(6,Math.max(0,l.length-1)*2);if(u=Math.min(12,u),a)for(const b of this.groups.values()){if(u<=0)break;if(!b||b.isWiped||b.spawned)continue;let x=null;for(const p of f){if(!p||!(p.z|0)||(p.z|0)!==(b.zone|0))continue;const g=b.center.x-p.p.x,v=b.center.y-p.p.y,M=g*g+v*v,_=b.activationDist||4500;if(M<=_*_){x=p.p;break}}x&&(this.spawnGroup(b,x),u--)}if(a&&this.groups.size>0){const g=[];for(const v of this.groups.values()){if(!v||!v.spawned||v.isWiped)continue;let M=1/0;for(const _ of f){if(!_||!(_.z|0))continue;const w=v.center.x-_.p.x,P=v.center.y-_.p.y,C=w*w+P*P;if(C<M&&(M=C),M<=324e6)break}if(M<=324e6){v._farSince=0;continue}v._farSince||(v._farSince=o.time),o.time-v._farSince>=8&&(g.push(v.id),v.spawned=!1,v.aliveCount=0,v._farSince=0)}if(g.length){const v=new Set(g);for(let M=t.length-1;M>=0;M--){const _=t[M];!_||!_.groupId||v.has(_.groupId)&&t.splice(M,1)}}}if(a&&u>0){const b=f.filter(p=>p&&(p.z|0)!==0),x=b.length;if(x>0){this._densityCursor==null&&(this._densityCursor=0);const p=Math.min(x,2);for(let g=0;g<p&&u>0;g++){const v=b[(this._densityCursor+g)%x],M=v.p,_=v.z|0,w=8200,P=w*w;let C=0;const k=_>=6?32:_>=5?28:_>=4?24:_>=3?20:_>=2?16:12;for(const A of t){if(!A||A.dead)continue;const S=A.x-M.x,B=A.y-M.y;if(S*S+B*B<=P&&(C++,C>=k))break}if(C<k){const A=[];for(const H of this.groups.values()){if(!H||H.spawned||H.isWiped||(H.zone|0)!==_)continue;const U=H.center.x-M.x,E=H.center.y-M.y,O=U*U+E*E;O<=196e6&&A.push({g:H,d2:O})}A.sort((H,U)=>H.d2-U.d2);let T=0;const L=_<=2?1:_<=4?2:3;for(const H of A)if(u<=0||C>=k||(this.spawnGroup(H.g,M),u--,T++,C+=H.g.aliveCount||0,T>=L))break}}this._densityCursor=(this._densityCursor+p)%x}}const c=f.filter(b=>b&&(b.z|0)===6);if(c.length&&Array.isArray(pn))for(let x=0;x<pn.length;x++){const p=pn[x];if(!p)continue;const g=t.some(w=>w&&w.isZone6CornerBoss&&w.cornerIndex===x);if(this.cornerBossAlive[x]=g,g||o.time<(this.cornerBossNextRespawnAt[x]||0))continue;let v=null;for(const w of c){const P=p.x-w.p.x,C=p.y-w.p.y;if(P*P+C*C<=14e3*14e3){v=w.p;break}}if(!v)continue;const M=zn(6,{x:p.x,y:p.y});M.isZone6CornerBoss=!0,M.cornerIndex=x,M.name="Corner Boss",M.hp*=4.8,M.maxHp*=4.8,M.damage*=2,M.speed*=1.05,M.radius*=1.15,M.xpValue*=3;const _=M.onDeath;M.onDeath=(w,P)=>{_&&_(w,P);const C=["damage","attackSpeed","moveSpeed","regen","shield"],k=C[Math.floor(Math.random()*C.length)];P.buffs.push({type:k,timeLeft:k==="regen"?18:k==="shield"?10:25,multiplier:.35,amount:k==="regen"?6:0})},this.ensureEnemyId(M),Ue(M,6,v&&v.level||1),t.push(M),this.cornerBossAlive[x]=!0}if(c.length&&!this.superBossSpawned&&!t.some(x=>x&&x.isZone6SuperBoss)){const x=this.superBossPoint||je(6);let p=1;for(const v of c)p=Math.max(p,v.p&&v.p.level||1);const g=Io(6,{x:x.x,y:x.y});this.ensureEnemyId(g),Ue(g,6,p),t.push(g),this.superBossSpawned=!0}const y=o.progression&&o.progression.resurrectedTier||1,d=Math.max(2,Math.min(5,(y|0)+1));if(!this.guardianSpawned&&Qt(o.progression)){const b=f.filter(x=>x&&(x.z|0)===d);if(b.length&&!t.some(p=>p&&(p.isResGuardian||p.isResurrectionGuardian||p.type==="resurrectionGuardian"))){const p=b[0].p,g=Math.random()*Math.PI*2,v=900+Math.random()*400,M=p.x+Math.cos(g)*v,_=p.y+Math.sin(g)*v,w=Co(d,{x:M,y:_});this.ensureEnemyId(w),Ue(w,d,p&&p.level||1),t.push(w),this.guardianSpawned=!0}}if(this.roamingTimer+=n,!t.some(b=>b&&b.isRoamingBoss)&&a){if((i|0)<2)return;const b=Math.max(2,Math.min(6,i|0)),x=30+b*10;if(this.roamingTimer>=x){this.roamingTimer=0;let p=null;for(const M of f)if(!(!M||!(M.z|0))&&(M.z|0)===b){p=M.p;break}if(!p){const M=f.find(_=>_&&(_.z|0)!==0);p=M?M.p:l[0]}let g=je(b);for(let M=0;M<30;M++){let _=!0;for(const w of f){if(!w||!(w.z|0))continue;const P=g.x-w.p.x,C=g.y-w.p.y;if(P*P+C*C<1400*1400){_=!1;break}}if(_)break;g=je(b)}const v=zn(b,{x:g.x,y:g.y});this.ensureEnemyId(v),Ue(v,b,p&&p.level||1),t.push(v)}}}}function Do(e,n){const o=n.canvas,t=n.player,r=n.progression,s=n.runScore||0,l=n.buffs||[],f=o.width,i=o.height;e.save();const m=Math.min(f,i)<700?.7:1;e.scale(m,m);const u=1/m,c=f*u,y=i*u,d=16,h=16,b=260,x=96;e.fillStyle="rgba(0,0,0,0.35)",e.fillRect(d,h,b,x);const p=t.hp/t.maxHP,g=d+8,v=h+8,M=200,_=16;e.fillStyle="#ff4b6e",e.fillRect(g,v,M*p,_),e.strokeStyle="#ffffff",e.strokeRect(g,v,M,_),e.fillStyle="#ffffff",e.font="14px sans-serif",e.textAlign="left",e.fillText("HP: "+Math.max(0,Math.round(t.hp))+" / "+Math.round(t.maxHP),g,v-4);const w=r&&typeof r.nickname=="string"&&r.nickname.trim().length?r.nickname.trim().slice(0,16):"Player";e.textAlign="right",e.fillText(w,d+b-8,v-4),e.textAlign="left";const P=t.xp/t.xpToNext(),C=v+24;if(n.net&&n.net.status==="connected"){const $=(n.net.roomCode||(r==null?void 0:r.roomCode)||"").toString().trim();$&&(e.fillStyle="rgba(255,255,255,0.78)",e.font="12px sans-serif",e.textAlign="right",e.fillText(`Room ${$}`,d+b-8,C-6),e.font="14px sans-serif",e.textAlign="left")}e.fillStyle="#3bd1ff",e.fillRect(g,C,M*P,10),e.strokeStyle="#ffffff",e.strokeRect(g,C,M,10),e.fillStyle="#ffffff",e.fillText("Lv "+t.level,g+208,C+10);const k=_e(t.x,t.y),A=C+20,S=A+16;e.fillText("Zone "+k,g,A);const B=t.runSkills||{};e.fillText(`Skills Shot:${B.bullets||0} Bombs:${B.bombs||0} Rockets:${B.rockets||0} Laser:${B.laser||0} Chain:${B.lightning||0}`,g+120,A),e.fillText("Score: "+Math.floor(s),g,S);const T=(t.metaHpRegen||0)+(t.runHpRegen||0);T>0&&e.fillText("HP Regen: "+T.toFixed(2)+" HP/s",g+120,S);let L=c-32;const H=y-40;for(let $=0;$<l.length;$++){const j=l[$];e.fillStyle=Fo(j.type),e.beginPath(),e.arc(L,H,10,0,Math.PI*2),e.fill(),L-=26}const U=40,E=16,O=c-U-E,ee=E;if(e.fillStyle=n.paused?"rgba(255,80,80,0.9)":"rgba(0,0,0,0.6)",e.fillRect(O,ee,U,U),e.strokeStyle="#ffffff",e.strokeRect(O,ee,U,U),e.fillStyle="#ffffff",e.font="18px sans-serif",e.textAlign="center",e.textBaseline="middle",n.paused)e.fillText("â–¶",O+U/2,ee+U/2+1);else{const G=O+U/2,Y=ee+10,V=ee+U-10;e.beginPath(),e.moveTo(G-6/2-6,Y),e.lineTo(G-6/2-6,V),e.moveTo(G+6/2+6,Y),e.lineTo(G+6/2+6,V),e.stroke()}n._pauseButtonRect={x:O*m,y:ee*m,w:U*m,h:U*m};const me=(n._runUpPending!=null?n._runUpPending:t._pendingLevelUps||0)|0;if(me>0){const G=c-112-E,Y=ee+U+10,V=!!n._runUpReady;if(e.fillStyle=V?"rgba(80,160,255,0.9)":"rgba(0,0,0,0.45)",e.fillRect(G,Y,112,40),e.strokeStyle="#ffffff",e.strokeRect(G,Y,112,40),e.fillStyle="#ffffff",e.textAlign="center",e.textBaseline="middle",e.font="12px sans-serif",e.fillText(`UPGRADE x${me}`,G+112/2,Y+40/2-6),V)e.font="11px sans-serif",e.fillText("press U",G+112/2,Y+40/2+10);else{e.font="11px sans-serif";const K=n._runUpBlockReason||"";if(K==="combat"){const ge=Math.max(0,Number(n._runUpReadyIn||0));e.fillText(`${ge.toFixed(1)}s`,G+112/2,Y+40/2+10)}else K==="enemies"?e.fillText("DANGER",G+112/2,Y+40/2+10):e.fillText("â€¦",G+112/2,Y+40/2+10)}n._runUpgradeButtonRect={x:G*m,y:Y*m,w:112*m,h:40*m}}else n._runUpgradeButtonRect=null;if(n.mode==="playing"&&n.paused){let un=function(fn,dn,Dt,Ft){const Ot=Et===Ft;e.fillStyle=Ot?"rgba(80,160,255,0.9)":"rgba(0,0,0,0.6)",e.fillRect(fn,dn,V,K),e.strokeStyle="#ffffff",e.strokeRect(fn,dn,V,K),e.fillStyle="#ffffff",e.textAlign="center",e.textBaseline="middle",e.font="16px sans-serif",e.fillText(Dt,fn+V/2,dn+K/2)};var ye=un;const $=c*.7,j=130,G=(c-$)/2,Y=y*.2;e.fillStyle="rgba(0, 0, 0, 0.8)",e.fillRect(G,Y,$,j),e.strokeStyle="#ffffff",e.strokeRect(G,Y,$,j),e.fillStyle="#ffffff",e.font="20px sans-serif",e.textAlign="center",e.textBaseline="top",e.fillText("Control System",G+$/2,Y+10);const V=$*.4,K=36,ge=12,be=Y+60,Ae=G+$*.5-V-ge*.5,Dn=G+$*.5+ge*.5,Et=On?On():"oneHand";un(Ae,be,"1-Hand","oneHand"),un(Dn,be,"2-Hand","twoHand"),n._controlModeClassicRect={x:Ae*m,y:be*m,w:V*m,h:K*m},n._controlModePortraitAutoRect={x:Dn*m,y:be*m,w:V*m,h:K*m}}else n._controlModeClassicRect=null,n._controlModePortraitAutoRect=null;e.restore()}function Fo(e){switch(e){case"damage":return"#ff4b7a";case"attackSpeed":return"#ffdd57";case"moveSpeed":return"#57ff9b";case"regen":return"#57c8ff";case"shield":return"#b857ff";case"ghost":return"#ffffff";default:return"#aaaaaa"}}let Me=[];const Oo=[{key:"attackSpeed",label:"Attack Speed Bonus",step:1},{key:"damage",label:"Damage Bonus",step:1},{key:"moveSpeed",label:"Move Speed Bonus",step:1},{key:"hp",label:"Max HP Bonus",step:1},{key:"hpRegen",label:"HP Regen",step:1},{key:"range",label:"Range Bonus",step:1},{key:"pickupRadius",label:"Pickup Radius Bonus",step:1},{key:"score",label:"Score Bonus",step:1},{key:"xpGain",label:"XP Gain Bonus",step:1},{key:"critChance",label:"Crit Chance Bonus",step:1},{key:"critDamage",label:"Crit Damage Bonus",step:1},{key:"lifeSteal",label:"Life Steal",step:1}];function Vo(e){return Oo.filter(n=>{const o=Be(e,n.key);return Number.isFinite(o)&&o>0})}function mn(e,n){const{canvas:o,progression:t,lastRunSummary:r}=n,s=o.width,l=o.height,i=Math.max(s,l)<900,a=s>=l,m=i?22:28,u=i?13:16,c=i?12:14;e.save(),e.fillStyle="rgba(0,0,0,0.75)",e.fillRect(0,0,s,l),e.fillStyle="#ffffff",e.font=m+"px sans-serif",e.textAlign="center";const y=i&&!a?l*.15:l*.12,d=n.mode==="stats";e.fillText(d?"STATS & UP":"YOU DIED",s/2,y),e.font=u+"px sans-serif";const h=r?r.runScore:Math.floor(n.runScore),b=r?r.totalScore:t.totalScore,x=r?r.gainedPoints:0;let p=y+u*1.8;if(d||(e.fillText("Score this run: "+h,s/2,p),p+=u*1.5),e.fillText("Total Score: "+b,s/2,p),p+=u*1.5,d||(e.fillText("Upgrade Points earned: +"+x,s/2,p),p+=u*1.5),e.fillText("Available Points: "+t.upgradePoints,s/2,p),d){p+=u*1.5;const T=Bn(t);e.fillText("Start level: "+T,s/2,p)}const g=t.limits||{},v=t.resurrectedTier||1,M=mt(g),_=yt(v),w=_>0?Math.round(M/_*100):0;p+=u*1.5,e.fillText("R-Tier: "+v+" (Used Points: "+M+" / "+_+") "+w+"%",s/2,p),Me=[];function P(T,L){if(T.key==="hpRegen"){const H=(L*.25).toFixed(2);return`${T.label}: ${H} HP/s`}else if(T.key==="attackSpeed"||T.key==="damage"||T.key==="range"){const H=(L*2).toFixed(2);return`${T.label}: +${H}%`}else if(T.key==="moveSpeed"){const H=(L*1).toFixed(2);return`${T.label}: +${H}%`}else if(T.key==="xpGain"){const H=(L*.5).toFixed(2);return`${T.label}: +${H}%`}else if(T.key==="score"){const H=(L*2).toFixed(2);return`${T.label}: +${H}%`}else if(T.key==="hp"){const H=(L*5).toFixed(0);return`${T.label}: +${H} HP`}else if(T.key==="pickupRadius"){const H=(L*1).toFixed(0);return`${T.label}: +${H} radius`}else if(T.key==="critChance"){const H=(L*.1).toFixed(2);return`${T.label}: +${H}%`}else if(T.key==="critDamage"){const H=(L*1).toFixed(2);return`${T.label}: +${H}%`}else if(T.key==="lifeSteal"){const H=(L*.1).toFixed(2);return`${T.label}: +${H}%`}return`${T.label}: ${L}`}const C=Vo(v);e.font=c+"px sans-serif",e.textAlign="left";let k=p;if(i&&!a){const T=p+c*2,L=c*1.9,H=s*.08,U=H,E=s-H-40;let O=T;for(const ee of C){const me=g[ee.key]??0,ye=P(ee,me);e.textAlign="left",e.fillStyle="#ffffff",e.fillText(ye,U,O);const $={x:E,y:O-16,w:40,h:24,key:ee.key,step:ee.step,type:"upgrade"},j=Be(v,ee.key),G=Number.isFinite(j)&&me>=j,Y=t.upgradePoints>0&&!G;if(e.fillStyle=Y?"#3cff9f":"#555555",e.fillRect($.x,$.y,$.w,$.h),e.fillStyle="#000000",e.textAlign="center",e.fillText("+",$.x+$.w/2,$.y+17),Number.isFinite(j)){e.textAlign="right",e.fillStyle="#ffffff";const V=`${me}/${j}`;e.fillText(V,$.x-6,O-2)}Me.push($),O+=L}k=O}else{const T=p+c*2,L=c*1.9,H=C.slice(0,6),U=C.slice(6),E=s*.1,O=s*.38,ee=s*.55,me=s*.83;let ye=T,$=T;for(const j of H){const G=g[j.key]??0,Y=P(j,G);e.textAlign="left",e.fillStyle="#ffffff",e.fillText(Y,E,ye);const V={x:O,y:ye-16,w:40,h:24,key:j.key,step:j.step,type:"upgrade"},K=Be(v,j.key),ge=Number.isFinite(K)&&G>=K,be=t.upgradePoints>0&&!ge;if(e.fillStyle=be?"#3cff9f":"#555555",e.fillRect(V.x,V.y,V.w,V.h),e.fillStyle="#000000",e.textAlign="center",e.fillText("+",V.x+V.w/2,V.y+17),Number.isFinite(K)){e.textAlign="right",e.fillStyle="#ffffff";const Ae=`${G}/${K}`;e.fillText(Ae,V.x-6,ye-2)}Me.push(V),ye+=L}for(const j of U){const G=g[j.key]??0,Y=P(j,G);e.textAlign="left",e.fillStyle="#ffffff",e.fillText(Y,ee,$);const V={x:me,y:$-16,w:40,h:24,key:j.key,step:j.step,type:"upgrade"},K=Be(v,j.key),ge=Number.isFinite(K)&&G>=K,be=t.upgradePoints>0&&!ge;if(e.fillStyle=be?"#3cff9f":"#555555",e.fillRect(V.x,V.y,V.w,V.h),e.fillStyle="#000000",e.textAlign="center",e.fillText("+",V.x+V.w/2,V.y+17),Number.isFinite(K)){e.textAlign="right",e.fillStyle="#ffffff";const Ae=`${G}/${K}`;e.fillText(Ae,V.x-6,$-2)}Me.push(V),$+=L}k=Math.max(ye,$)}const A=40;let S=k+c*2;const B=i?16:32;if(S+A>l-B&&(S=l-B-A),d){const U=s/2-209,E={x:U,y:S,w:200,h:A,type:"back"},O={x:U+200+18,y:S,w:200,h:A,type:"start"};e.fillStyle="#333333",e.fillRect(E.x,E.y,E.w,E.h),e.fillStyle="#ffffff",e.textAlign="center",e.fillText("BACK",E.x+E.w/2,E.y+26),e.fillStyle="#111111",e.fillRect(O.x,O.y,O.w,O.h),e.fillStyle="#3cff9f",e.fillText("START",O.x+O.w/2,O.y+26),Me.push(E,O)}else{const L=Math.max(140,Math.min(200,Math.floor((s*.86-16)/2))),H=L*2+16,U=s/2-H/2,E={x:U,y:S,w:L,h:A,type:"menu"},O={x:U+L+16,y:S,w:L,h:A,type:"start"};e.fillStyle="#222222",e.fillRect(E.x,E.y,E.w,E.h),e.fillStyle="#ffffff",e.textAlign="center",e.fillText("MENU/",E.x+E.w/2,E.y+26),e.fillStyle="#333333",e.fillRect(O.x,O.y,O.w,O.h),e.fillStyle="#ffffff",e.fillText("START",O.x+O.w/2,O.y+26),Me.push(E,O)}e.restore()}function Ze(e,n,o){const t=Me.find(r=>e>=r.x&&e<=r.x+r.w&&n>=r.y&&n<=r.y+r.h);if(!t)return null;if(t.type==="upgrade"){const r=o.progression,s=r.limits||{};if(r.upgradePoints<=0)return null;const l=t.key,f=t.step,i=r.resurrectedTier||1,a=Be(i,l),u=(s[l]??0)+f;return Number.isFinite(a)&&u>a?null:(s[l]=u,r.limits=s,r.upgradePoints-=1,ne(r),"upgrade")}return t.type==="start"?"start":t.type==="menu"?"menu":t.type==="back"?"back":null}let kn=[];function Jn(e,n){const{canvas:o,progression:t,lastRunSummary:r}=n,s=o.width,l=o.height,i=Math.max(s,l)<900,a=i?22:28,m=i?13:16;e.save(),e.fillStyle="rgba(0,0,0,0.85)",e.fillRect(0,0,s,l),e.fillStyle="#ffffff",e.font=a+"px sans-serif",e.textAlign="center",e.fillText("RESURRECTION",s/2,l/2-150),e.font=m+"px sans-serif";const u=r?r.runScore:Math.floor(n.runScore),c=r?r.totalScore:t.totalScore,y=r?r.gainedPoints:0,d=t.resurrectedTier||1;e.fillText("Guardian of Resurrection defeated!",s/2,l/2-120),e.fillText("Score this run: "+u,s/2,l/2-100),e.fillText("Total Score: "+c,s/2,l/2-80),e.fillText("Upgrade Points earned: +"+y,s/2,l/2-60),e.fillText("Current R-Tier: "+d,s/2,l/2-40),e.fillText("Resurrect to increase R-Tier (up to 15) and reset all meta-limits for a new build.",s/2,l/2-10),kn=[];const h={x:s/2-140,y:l/2+40,w:120,h:36,type:"resurrect"},b={x:s/2+20,y:l/2+40,w:120,h:36,type:"skip"};e.strokeStyle="#00ff88",e.lineWidth=2,e.strokeRect(h.x,h.y,h.w,h.h),e.fillStyle="#00ff88",e.textAlign="center",e.fillText("RESURECT",h.x+h.w/2,h.y+24),e.strokeStyle="#ffffff",e.lineWidth=2,e.strokeRect(b.x,b.y,b.w,b.h),e.fillStyle="#ffffff",e.fillText("SKIP",b.x+b.w/2,b.y+24),kn.push(h,b),e.restore()}function Qn(e,n,o){const t=kn.find(r=>e>=r.x&&e<=r.x+r.w&&n>=r.y&&n<=r.y+r.h);return t?t.type==="resurrect"?(no(o.progression),o.flags&&(o.flags.resGuardianKilledThisRun=!1),"resurrect"):t.type==="skip"?(o.flags&&(o.flags.resGuardianKilledThisRun=!1),"skip"):null:null}function yn(e,n){const o=[],t=e.slice();for(let r=0;r<n&&t.length>0;r++){let s=0;for(const i of t)s+=Math.max(0,i.weight||0);if(s<=0){const i=Math.random()*t.length|0;o.push(t.splice(i,1)[0]);continue}let l=Math.random()*s,f=0;for(let i=0;i<t.length;i++)if(l-=Math.max(0,t[i].weight||0),l<=0){f=i;break}o.push(t.splice(f,1)[0])}return o}function et(e,n){const o=e&&e._metaSkillMeta&&typeof e._metaSkillMeta=="object"?e._metaSkillMeta:null,t=o?o[n]:0;return typeof t=="number"&&Number.isFinite(t)?Math.max(0,t|0):0}const Nn=[{key:"bullets",name:"Basic Shot",kind:"skill"},{key:"bombs",name:"Bombs",kind:"skill"},{key:"satellites",name:"Satellites",kind:"skill"},{key:"energyBarrier",name:"Energy Barrier",kind:"skill"},{key:"spirit",name:"Spirit",kind:"skill"},{key:"summon",name:"Summon Tanks",kind:"skill"},{key:"electricZone",name:"Electric Zone",kind:"skill"},{key:"laser",name:"Laser",kind:"skill"},{key:"lightning",name:"Chain Lightning",kind:"skill"},{key:"rockets",name:"Rockets",kind:"skill"}],Un=[{key:"damage",name:"Damage",kind:"passive"},{key:"attackSpeed",name:"Attack Speed",kind:"passive"},{key:"moveSpeed",name:"Move Speed",kind:"passive"},{key:"hp",name:"Max HP",kind:"passive"},{key:"hpRegen",name:"HP Regen",kind:"passive"},{key:"range",name:"Range",kind:"passive"},{key:"pickupRadius",name:"Pickup Radius",kind:"passive"},{key:"xpGain",name:"XP Gain",kind:"passive"},{key:"critChance",name:"Crit Chance",kind:"passive"},{key:"critDamage",name:"Crit Damage",kind:"passive"},{key:"lifeSteal",name:"Life Steal",kind:"passive"}];function Xe(e){if(!e)return;const n=e.runSkills||{};e.runSkills={bullets:(n.bullets??1)|0,bombs:(n.bombs??0)|0,rockets:(n.rockets??0)|0,satellites:(n.satellites??0)|0,energyBarrier:(n.energyBarrier??0)|0,spirit:(n.spirit??0)|0,electricZone:(n.electricZone??0)|0,laser:(n.laser??0)|0,lightning:(n.lightning??0)|0},e.runEvolutions=e.runEvolutions||{};const o=e.runPassives||{};e.runPassives={damage:(o.damage??0)|0,attackSpeed:(o.attackSpeed??0)|0,moveSpeed:(o.moveSpeed??0)|0,hp:(o.hp??0)|0,hpRegen:(o.hpRegen??0)|0,range:(o.range??0)|0,pickupRadius:(o.pickupRadius??0)|0,xpGain:(o.xpGain??0)|0,critChance:(o.critChance??0)|0,critDamage:(o.critDamage??0)|0,lifeSteal:(o.lifeSteal??0)|0},Number.isFinite(e._runBaseMaxHP)||(e._runBaseMaxHP=Number.isFinite(e.maxHP)?e.maxHP:e.baseMaxHP||100),Sn(e)}function Sn(e){if(!e)return;const n=e.runPassives||{};e.runDamageMult=1+(n.damage||0)*.08,e.runAttackMult=1+(n.attackSpeed||0)*.05,e.runMoveMult=1+(n.moveSpeed||0)*.05,e.runRangeMult=1+(n.range||0)*.045,e.runPickupBonusRadius=(n.pickupRadius||0)*10,e.runXpGainMult=1+(n.xpGain||0)*.045,e.runCritChanceAdd=(n.critChance||0)*.015,e.runCritDamageMult=1+(n.critDamage||0)*.12,e.runLifeSteal=(n.lifeSteal||0)*.004,e.runHpRegen=(n.hpRegen||0)*.35;const o=(n.hp||0)*12,t=Number.isFinite(e._runBaseMaxHP)?e._runBaseMaxHP:e.maxHP||100;e.maxHP=t+o,e.hp>e.maxHP&&(e.hp=e.maxHP)}function kt(e,n=3){if(!e)return[];Xe(e);const o=e.runSkills||{},t=e.runPassives||{},r=e.level|0,s=[],l=[],f={bullets:10,bombs:10,rockets:10,satellites:10,energyBarrier:10,spirit:10,summon:10,electricZone:10,laser:10,lightning:10},i=e.runEvolutions||{},m=["bullets","bombs","satellites","energyBarrier","spirit","summon","electricZone","laser","lightning","rockets"].reduce((d,h)=>d+((o[h]||0)>0?1:0),0);!i.rocketFusion&&(o.bullets|0)>=f.bullets&&(o.bombs|0)>=f.bombs&&(o.rockets|0)<=0&&s.push({id:"evo:rocketFusion",kind:"evolution",key:"rocketFusion",name:"Fuse â†’ Rockets",from:"MAX",to:"Rockets",weight:999});for(const d of Nn){const h=`skill:${d.key}`,b=et(e,h);if(d.key!=="bullets"&&b<=0||i.rocketFusion&&(d.key==="bullets"||d.key==="bombs")||d.key==="laser"&&r<6||d.key==="lightning"&&r<8)continue;const x=o[d.key]|0;if(d.key==="rockets"&&x<=0&&!i.rocketFusion)continue;const p=f[d.key]||9999;if(x>=p)continue;const g=d.key==="bullets";let v;if(g?v=1:x<=0?v=d.key==="bombs"?9:6:v=Math.max(1.6,3.6-(x-1)*.14),b>1){const _=1+Math.min(.6,(b-1)*.12);v*=_}const M=d.key==="energyBarrier"||d.key==="spirit"||d.key==="summon"||d.key==="electricZone";!g&&x<=0&&!M&&(m>=3?v*=.12:m>=2&&(v*=.25)),s.push({id:`skill:${d.key}`,kind:"skill",key:d.key,name:d.name,from:x,to:x+1,weight:v})}for(const d of Un){const h=d.key,b=`passive:${h}`,x=et(e,b);if(x<=0||(h==="critChance"||h==="critDamage")&&r<8||h==="lifeSteal"&&r<12||h==="xpGain"&&r<4)continue;const p=t[h]|0;let g=p<=0?3.2:Math.max(.8,2.6-p*.12);if(x>1){const v=1+Math.min(.5,(x-1)*.1);g*=v}h==="damage"&&(g*=1.1),h==="hp"&&(g*=1.05),h==="pickupRadius"&&(g*=.9),h==="xpGain"&&(g*=.85),h==="range"&&(g*=.95),h==="hpRegen"&&(g*=.9),(h==="critChance"||h==="critDamage")&&(g*=.75),h==="lifeSteal"&&(g*=.6),l.push({id:`passive:${h}`,kind:"passive",key:h,name:d.name,from:p,to:p+1,weight:g})}const c=(o.bombs||0)>0||(o.satellites||0)>0||(o.energyBarrier||0)>0||(o.spirit||0)>0||(o.electricZone||0)>0||(o.laser||0)>0||(o.lightning||0)>0||(o.rockets||0)>0,y=[];if(n>=1&&s.length){const d=s.find(h=>h.kind==="evolution");d?y.push(d):y.push(...yn(s,1))}if(n>=2&&l.length){const d=yn(l,1);d.length&&y.push(d[0])}for(;y.length<n;){const d=[...s,...l].filter(b=>!y.some(x=>x.id===b.id));if(d.length<=0)break;const h=yn(d,1);if(!h.length)break;y.push(h[0])}if(!c&&!y.some(h=>h.kind==="skill"&&h.key!=="bullets")){const h="bombs",b=s.find(x=>x.kind==="skill"&&x.key===h);if(b){const x=y.findIndex(p=>p.kind!=="skill");x>=0?y[x]=b:y.length>0&&(y[y.length-1]=b)}}for(const d of y)d.desc=$o(e,d);return y}function St(e,n){if(!(!e||!n)){if(Xe(e),n.kind==="evolution"){n.key==="rocketFusion"&&(e.runEvolutions=e.runEvolutions||{},e.runEvolutions.rocketFusion=!0,e.runSkills.bullets=0,e.runSkills.bombs=0,e.runSkills.rockets=Math.max(e.runSkills.rockets|0,1),e.attackCooldown=0,e.rocketCooldown=0),Sn(e);return}n.kind==="skill"?e.runSkills[n.key]=(e.runSkills[n.key]|0)+1:n.kind==="passive"&&(e.runPassives[n.key]=(e.runPassives[n.key]|0)+1),Sn(e)}}function $o(e,n){if(!e||!n)return"";if(n.kind==="evolution")return n.key==="rocketFusion"?"Fuse Basic Shot (MAX) + Bombs (MAX) â†’ Rockets (Lv1). Consumes both.":"Evolution";if(n.kind==="skill")return n.key==="bullets"?`Lv ${n.from} â†’ ${n.to}: +shot power / sometimes +extra bullets`:n.key==="bombs"?n.from<=0?"Unlock bombs (AoE)":`Lv ${n.from} â†’ ${n.to}: +damage / +AoE / faster`:n.key==="rockets"?n.from<=0?"Rockets (via fusion)":`Lv ${n.from} â†’ ${n.to}: +damage / +AoE / faster`:n.key==="laser"?n.from<=0?"Unlock laser beam":`Lv ${n.from} â†’ ${n.to}: +DPS / +range`:n.key==="lightning"?n.from<=0?"Unlock chain lightning":`Lv ${n.from} â†’ ${n.to}: +targets / +damage`:n.key==="satellites"?n.from<=0?"Orbiting satellites (contact damage)":`Lv ${n.from} â†’ ${n.to}: +count / +damage`:n.key==="energyBarrier"?n.from<=0?"Energy barrier (repel + pulse)":`Lv ${n.from} â†’ ${n.to}: +radius / +damage`:n.key==="spirit"?n.from<=0?"Spirit flames (auto basic shots)":`Lv ${n.from} â†’ ${n.to}: +range / +atkspd / +dmg (extra spirits at 5 & 9)`:n.key==="electricZone"?n.from<=0?"Electric zone (AoE pulses)":`Lv ${n.from} â†’ ${n.to}: +radius / +damage`:`Lv ${n.from} â†’ ${n.to}`;const o=n.key;return o==="damage"?"+10% damage (stacking)":o==="attackSpeed"?"+6% attack speed (stacking)":o==="moveSpeed"?"+5% move speed (stacking)":o==="hp"?"+12 Max HP (stacking)":o==="hpRegen"?"+0.35 HP/s (stacking)":o==="range"?"+6% range (stacking)":o==="pickupRadius"?"+10 pickup radius (stacking)":o==="xpGain"?"+6% XP gain (stacking)":o==="critChance"?"+1.5% crit chance (stacking)":o==="critDamage"?"+12% crit damage (stacking)":o==="lifeSteal"?"+0.4% life steal (stacking)":`Lv ${n.from} â†’ ${n.to}`}function nt(e,n){const{buffs:o}=e,t=e.players&&e.players.length?e.players:e.player?[e.player]:[];let r=0,s=0,l=0,f=0,i=0,a=!1,m=!1;for(let c=o.length-1;c>=0;c--){const y=o[c];y.timeLeft-=n,y.type==="damage"&&(r+=y.multiplier||.3),y.type==="attackSpeed"&&(s+=y.multiplier||.3),y.type==="moveSpeed"&&(l+=y.multiplier||.3),y.type==="xpGain"&&(f+=y.multiplier||.4),y.type==="regen"&&(i+=y.amount||4),y.type==="shield"&&(a=!0),y.type==="ghost"&&(m=!0),y.timeLeft<=0&&o.splice(c,1)}e.tempXpGainBoost=Math.min(f,.6);function u(c,y,d){return!Number.isFinite(c)||c<=y?c:y+(c-y)*(d||.35)}for(const c of t){const y=c.metaDamageMult||1,d=c.metaAttackMult||1,h=c.metaMoveMult||1,b=c.runDamageMult||1,x=c.runAttackMult||1,p=c.runMoveMult||1,g=(c.baseDamage||4)*y*b,v=(c.baseAttackSpeed||2)*d*x;c.damage=g*(1+r);const M=v*(1+s);c.attackSpeed=u(M,6,.35),c.moveSpeed=(c.baseMoveSpeed||260)*h*p*(1+l);const _=(c.metaRangeMult||1)*(c.runRangeMult||1),w=u(_,2.2,.25);c._totalRangeMult=w,i>0&&(c.hp=Math.min(c.maxHP,c.hp+i*n)),c._shieldActive=a,c._ghostActive=m}}function _t(){const e=location.protocol==="https:"?"wss":"ws",n=location.hostname||"localhost";return`${e}://${n}:8080`}function Go(e){try{return JSON.parse(e)}catch{return null}}function tt(){const e={ws:null,url:null,status:"offline",error:null,playerId:null,roomCode:null,isHost:!1,maxPlayers:7,roomPlayers:[],ready:!1,pingMs:0,_pingSentAt:0,_pingTimer:0,latestSnapshot:null,latestPlayerState:null,remoteInputs:new Map,onMessage:null};function n(o){if(!(!e.ws||e.ws.readyState!==1))try{e.ws.send(JSON.stringify(o))}catch{}}return e.connect=function(t){if(e.ws&&(e.ws.readyState===0||e.ws.readyState===1))return;e.url=t||_t(),e.status="connecting",e.error=null,e.latestSnapshot=null,e.remoteInputs.clear();const r=new WebSocket(e.url);e.ws=r,r.onopen=()=>{e.status="connected",e.error=null},r.onmessage=s=>{const l=Go(String(s.data));if(!(!l||!l.type)){if(l.type==="hello"){e.maxPlayers=l.maxPlayers||e.maxPlayers;return}if(l.type==="joined"&&(e.playerId=l.playerId,e.roomCode=l.roomCode,e.isHost=!!l.isHost,e.maxPlayers=l.maxPlayers||e.maxPlayers),l.type==="roomInfo"&&(e.roomPlayers=Array.isArray(l.players)?l.players:[]),l.type==="pong"){const f=performance.now()-(e._pingSentAt||performance.now());e.pingMs=Math.max(0,Math.round(f))}l.type==="snapshot"&&(e.latestSnapshot=l.snapshot),l.type==="pstate"&&(e.latestPlayerState=l.state),l.type==="input"&&l.from&&e.remoteInputs.set(String(l.from),l.input||{}),l.type==="error"&&(e.error=l.message||l.code||"error"),l.type==="hostLeft"&&(e.error="Host left",e.roomCode=null,e.playerId=null,e.isHost=!1,e.roomPlayers=[]),typeof e.onMessage=="function"&&e.onMessage(l)}},r.onclose=()=>{e.status="offline",e.ws=null,e.playerId=null,e.roomCode=null,e.isHost=!1,e.roomPlayers=[],e.latestSnapshot=null,e.remoteInputs.clear()},r.onerror=()=>{e.status="error",e.error="WS error"}},e.disconnect=function(){if(e.ws)try{e.ws.close()}catch{}e.ws=null,e.status="offline",e.error=null,e.playerId=null,e.roomCode=null,e.isHost=!1,e.roomPlayers=[],e.latestSnapshot=null,e.remoteInputs.clear()},e.host=function(t,r,s){n({type:"host",roomCode:t,nickname:r,avatarIndex:s})},e.join=function(t,r,s){n({type:"join",roomCode:t,nickname:r,avatarIndex:s})},e.fastJoin=function(t,r){n({type:"fastJoin",nickname:t,avatarIndex:r})},e.sendInput=function(t){n({type:"input",input:t})},e.sendSnapshot=function(t){n({type:"snapshot",snapshot:t})},e.sendPlayerState=function(t){n({type:"pstate",state:t})},e.startRun=function(){n({type:"startRun"})},e.setProfile=function(t,r){n({type:"setProfile",nickname:t,avatarIndex:r})},e.setReady=function(t){e.ready=!!t,n({type:"ready",ready:!!t})},e.sendMeta=function(t){n({type:"syncMeta",meta:t||null})},e.requestRespawn=function(t){n({type:"respawn",meta:t||null})},e.sendRunPause=function(t,r){n({type:"runPause",reason:t||"levelUp",by:r!=null?String(r):void 0})},e.sendRunResume=function(){n({type:"runResume"})},e.sendRunChoices=function(t,r,s){n({type:"runChoices",to:t!=null?String(t):"",choices:Array.isArray(r)?r:[],metaText:s||""})},e.sendRunPick=function(t){n({type:"runPick",choiceId:t||""}),e.sendRunRequest=function(){n({type:"runRequest"})}},e}let Q=null,qe=null,Re=null;function Xo(){if(Q)return Q;const e=document.createElement("style");return e.textContent=`
    #runUpOverlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:60;
      background: rgba(0,0,0,0.55); backdrop-filter: blur(3px); }
    #runUpOverlay .panel{ width:min(980px, 96vw); max-height: 92vh; overflow:auto;
      border:1px solid rgba(255,255,255,0.12); border-radius: 12px; padding: 14px 16px;
      background: rgba(12,16,22,0.92); box-shadow: 0 12px 50px rgba(0,0,0,0.45); }
    #runUpOverlay .head{ display:flex; justify-content:space-between; align-items:flex-end; gap:12px; }
    #runUpOverlay h2{ margin:0; font-size: 18px; }
    #runUpOverlay .muted{ opacity:0.75; font-size:12px; line-height:1.25; }
    #runUpOverlay .cards{ display:flex; gap: 12px; margin-top: 12px; flex-wrap: wrap; }
    #runUpOverlay .card{ flex: 1; min-width: 240px; border-radius: 12px; padding: 12px 12px;
      border: 1px solid rgba(255,255,255,0.14); background: rgba(255,255,255,0.03);
      cursor:pointer; user-select:none; }
    #runUpOverlay .card:hover{ background: rgba(120,170,255,0.10); border-color: rgba(200,220,255,0.22); }
    #runUpOverlay .titleRow{ display:flex; align-items:baseline; justify-content:space-between; gap: 8px; }
    #runUpOverlay .name{ font-size: 14px; font-weight: 700; }
    #runUpOverlay .lvl{ font-size: 12px; opacity: 0.8; }
    #runUpOverlay .desc{ margin-top: 6px; font-size: 12px; opacity: 0.85; line-height: 1.3; }
    #runUpOverlay .hint{ margin-top: 10px; font-size: 12px; opacity: 0.72; }
    @media (max-width: 780px){ #runUpOverlay .cards{ flex-direction: column; } }
  `,document.head.appendChild(e),Q=document.createElement("div"),Q.id="runUpOverlay",Q.innerHTML=`
    <div class="panel" tabindex="0">
      <div class="head">
        <div>
          <h2>Level Up</h2>
          <div class="muted">Choose one upgrade</div>
        </div>
        <div class="muted" id="runUpMeta"></div>
      </div>
      <div class="cards" id="runUpCards"></div>
      <div class="hint">Tip: press 1 / 2 / 3</div>
    </div>
  `,document.body.appendChild(Q),Q.querySelector(".panel").addEventListener("keydown",o=>{if(!Q||Q.style.display!=="flex")return;const t=o.key;if(t==="1"||t==="2"||t==="3"){const r=t.charCodeAt(0)-49|0;Re&&Re[r]&&(o.preventDefault(),Rt(Re[r]))}}),Q}function Rt(e){if(typeof qe=="function"){const n=qe;qe=null,Qe(),n(e)}}function Pt(e,n,o){if(typeof document>"u")return;Xo(),qe=o,Re=Array.isArray(e)?e.slice(0,3):[];const t=Q.querySelector("#runUpCards"),r=Q.querySelector("#runUpMeta");t.innerHTML="",r.textContent=n||"";for(let l=0;l<Re.length;l++){const f=Re[l],i=document.createElement("div");i.className="card",i.innerHTML=`
      <div class="titleRow">
        <div class="name">${l+1}. ${f.name}</div>
        <div class="lvl">Lv ${f.from} â†’ ${f.to}</div>
      </div>
      <div class="desc">${f.desc||""}</div>
    `,i.addEventListener("click",()=>Rt(f)),t.appendChild(i)}Q.style.display="flex";const s=Q.querySelector(".panel");try{s.focus()}catch{}}function Qe(){Q&&(Q.style.display="none",Re=null)}const Oe=10,ot={"skill:bullets":1,"skill:bombs":1,"skill:satellites":1,"skill:energyBarrier":0,"skill:spirit":0,"skill:summon":0,"skill:electricZone":0,"skill:laser":0,"skill:lightning":0,"skill:rockets":0};function en(e,n,o){return e=e|0,Math.max(n,Math.min(o,e))}function te(e){if(!e||typeof e!="object")return e;Number.isFinite(e.coins)||(e.coins=0),e.coins=Math.max(0,Math.floor(e.coins)),(!e.skillMeta||typeof e.skillMeta!="object")&&(e.skillMeta={});const n=e.skillMeta;for(const o of Nn){const t=`skill:${o.key}`,r=t in ot?ot[t]:1;Number.isFinite(n[t])||(n[t]=r),n[t]=en(n[t],0,Oe)}for(const o of Un){const t=`passive:${o.key}`;Number.isFinite(n[t])||(n[t]=1),n[t]=en(n[t],0,Oe)}return(!e.shopOffers||typeof e.shopOffers!="object")&&(e.shopOffers={active:[],passive:[],newSkills:[]}),Array.isArray(e.shopOffers.active)||(e.shopOffers.active=[]),Array.isArray(e.shopOffers.passive)||(e.shopOffers.passive=[]),Array.isArray(e.shopOffers.newSkills)||(e.shopOffers.newSkills=[]),Number.isFinite(e.shopRerollCount)||(e.shopRerollCount=0),e.shopRerollCount=Math.max(0,Math.floor(e.shopRerollCount)),e.skillMeta&&(e.skillMeta["skill:satellites"]|0)<=0&&(e.skillMeta["skill:satellites"]=1),e}function Wo(){const e=Nn.filter(t=>t&&t.kind==="skill").filter(t=>t.key!=="rockets").map(t=>({id:`skill:${t.key}`,key:t.key,kind:"skill",name:t.name||t.key})),n=Un.filter(t=>t&&t.kind==="passive").map(t=>({id:`passive:${t.key}`,key:t.key,kind:"passive",name:t.name||t.key})),o=new Map;for(const t of[...e,...n])o.set(t.id,t);return{active:e,passive:n,byId:o}}const le=Wo();function ue(e,n){const o=e==null?void 0:e.skillMeta,t=o&&typeof o=="object"?o[n]:0;return Number.isFinite(t)?en(t,0,Oe):0}function wt(e,n,o){!e||typeof e!="object"||(te(e),e.skillMeta[n]=en(o,0,Oe))}function nn(e,n){const o=e.startsWith("skill:"),t=o?50:30,r=o?35:22;if((n|0)<=0)return t;const s=r*Math.pow(1.55,Math.max(0,(n|0)-1));return Math.max(1,Math.round(s))}function Ke(e,n){if(!e||e.length===0)return null;for(let o=0;o<12;o++){const t=e[Math.random()*e.length|0];if(t&&!(n&&n.has(t.id)))return t}for(const o of e)if(o&&!(n&&n.has(o.id)))return o;return null}function We(e){te(e);const n=e.shopOffers,o=new Set;n.active=Array.isArray(n.active)?n.active.filter(Boolean).map(String):[],n.passive=Array.isArray(n.passive)?n.passive.filter(Boolean).map(String):[],n.newSkills=Array.isArray(n.newSkills)?n.newSkills.filter(Boolean).map(String):[],n.active=n.active.filter(s=>le.byId.has(s)),n.passive=n.passive.filter(s=>le.byId.has(s)),n.newSkills=n.newSkills.filter(s=>le.byId.has(s)),n.active=n.active.filter(s=>ue(e,s)>0),n.newSkills=n.newSkills.filter(s=>ue(e,s)<=0);const t=le.active.filter(s=>ue(e,s.id)>0),r=le.active.filter(s=>ue(e,s.id)<=0);for(const s of n.active)o.add(s);for(const s of n.passive)o.add(s);for(const s of n.newSkills)o.add(s);for(;n.active.length<3;){const s=Ke(t,o);if(!s)break;n.active.push(s.id),o.add(s.id)}for(;n.passive.length<3;){const s=Ke(le.passive,o);if(!s)break;n.passive.push(s.id),o.add(s.id)}for(;n.newSkills.length<3;){const s=Ke(r,o);if(!s)break;n.newSkills.push(s.id),o.add(s.id)}return n.active=n.active.slice(0,3),n.passive=n.passive.slice(0,3),n.newSkills=n.newSkills.slice(0,3),n}function At(e){te(e);const n=e.shopOffers;return n.active=[],n.passive=[],n.newSkills=[],We(e),e.shopRerollCount=(e.shopRerollCount|0)+1,n}function Ct(e,n,o){te(e);const t=We(e),r=le.active.filter(u=>ue(e,u.id)>0),s=le.active.filter(u=>ue(e,u.id)<=0),l=n==="passive"?t.passive:n==="new"?t.newSkills:t.active,f=n==="passive"?le.passive:n==="new"?s:r,i=new Set([...t.active,...t.passive,...t.newSkills||[]]),a=l[o];a&&i.delete(a);const m=Ke(f,i);return m?l[o]=m.id:l[o]=a||null,t}function It(e){return le.byId.get(e)||null}function Tt(){return Oe}const En=[{id:"shop",kind:"shop",name:"Merchant",emoji:"ðŸ›’",x:-150,y:0,r:120},{id:"tier",kind:"tier",name:"Tier Master",emoji:"ðŸ§™",x:150,y:0,r:120}];function it(e){if(!e||!Ve(e.x,e.y,10))return null;let n=null,o=1/0;for(const t of En){const r=e.x-t.x,s=e.y-t.y,l=r*r+s*s,f=t.r||120;l<=f*f&&l<o&&(n=t,o=l)}return n}function jo(e,n){if(!n||n.mode!=="playing")return;const o=n.player;if(!(!o||!Ve(o.x,o.y,400)))for(const t of En){e.save(),e.globalAlpha=.9;const r=46,s=54;e.beginPath(),e.strokeStyle="rgba(255,255,255,0.22)",e.lineWidth=4,e.arc(t.x,t.y,s,0,Math.PI*2),e.stroke(),e.font=r+"px sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#fff",e.fillText(t.emoji||"ðŸ™‚",t.x,t.y+2),e.globalAlpha=.75,e.font="16px sans-serif",e.fillStyle="rgba(255,255,255,0.9)",e.fillText(t.name||"",t.x,t.y+56),e.restore()}}function Zo(e,n,o){const t=o.camera,r=o.canvas,s=r.width,l=r.height,f=t.zoom||1,i=(e-s/2)/f+t.x,a=(n-l/2)/f+t.y;return{x:i,y:a}}function Yo(e,n){for(const o of En){const t=e-o.x,r=n-o.y,s=(o.r||120)*.9;if(t*t+r*r<=s*s)return o}return null}function zo(e,n,o){vn();try{te(o)}catch{}const t={canvas:e,ctx:n,progression:o,mode:"startMenu",paused:!1,player:null,players:[],camera:null,enemies:[],projectiles:[],rockets:[],xpOrbs:[],buffs:[],floatingTexts:[],popups:[],flags:{resGuardianKilledThisRun:!1},runScore:0,lastRunSummary:null,spawnSystem:null,time:0,currentZone:1,_laserVisual:null,_lightningVisual:null,_pauseButtonRect:null,players:[],net:null,_netLastInputSentAt:0,_netLastSnapshotSentAt:0,_netLastAppliedSnapshotAt:0,_netLastAppliedPStateAt:0,meta:{xpGainMult:1,scoreMult:1,pickupBonusRadius:0},net:tt(),_netLastInputSendAt:0,_netLastSnapshotSendAt:0,overlayMode:null,_deathHandled:!1,_waitingRespawnAck:!1,_netMetaById:new Map,_runUpNet:{sessions:new Map}};t.net=tt();try{const u=new URLSearchParams(location.search||""),c=u.get("code")||u.get("room");if(c&&t.progression){const y=c.toString().trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,8);y&&(t.progression.roomCode=y)}}catch{}xe(t),t.mode="startMenu",t.paused=!1,t.net.onMessage=u=>{var c,y,d,h,b,x,p,g,v,M,_,w;if(u.type==="joined"){try{const P=(u.roomCode||"").toString().trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,8);P&&t.progression&&(t.progression.roomCode=P,ne(t.progression),t.popups&&t.popups.push({text:`Room: ${P}`,time:6}))}catch{}t.net.isHost?(t.player&&(t.player.id=String(t.net.playerId),t.player.color=de(t.player.id),t.player.nickname=((c=t.progression)==null?void 0:c.nickname)||t.player.nickname,typeof((y=t.progression)==null?void 0:y.avatarIndex)=="number"&&(t.player.avatarIndex=t.progression.avatarIndex|0)),_n(t),t.mode="playing",t.paused=!1):(t.player&&t.net.playerId&&(t.player.id=String(t.net.playerId),t.player.color=de(t.player.id),t.player.nickname=((d=t.progression)==null?void 0:d.nickname)||t.player.nickname,typeof((h=t.progression)==null?void 0:h.avatarIndex)=="number"&&(t.player.avatarIndex=t.progression.avatarIndex|0)),t.mode="playing",t.paused=!1),t.net&&t.net.status==="connected"&&!t.net.isHost&&t.net.sendMeta(Ee(t.progression))}if(u.type==="roomInfo"&&t.net.isHost&&_n(t),u.type==="hostLeft"){if(t.net.isHost)return;t._runUpgradeActive=!1;try{Qe()}catch{}t.player&&(t.player._lvlUpChoosing=!1,t.player._lvlUpInvuln=!1),t.overlayMode=null,t.mode="startMenu",t.paused=!1;return}if(u.type==="syncMeta"){if(!t.net.isHost)return;const P=String(u.from||"");if(!P)return;const C=u.meta||null;C&&t._netMetaById.set(P,C);const k=Pe(t,P);k&&C&&tn(t,k,C);return}if(u.type==="respawn"){if(!t.net.isHost)return;const P=String(u.from||"");if(!P)return;const C=u.meta||null;C&&t._netMetaById.set(P,C);const k=Pe(t,P);k&&(k._netRespawnRequested=!0);return}if(u.type==="startRun"){if(t.net.isHost)return;xe(t),t.player&&t.net.playerId&&(t.player.id=String(t.net.playerId),t.player.color=de(t.player.id),t.player.nickname=((b=t.progression)==null?void 0:b.nickname)||t.player.nickname,typeof((x=t.progression)==null?void 0:x.avatarIndex)=="number"&&(t.player.avatarIndex=t.progression.avatarIndex|0)),t.mode="playing",t.paused=!1,t.net&&(t.net.latestSnapshot=null,t.net.latestPlayerState=null),t.enemies=[],t.projectiles=[],t.rockets=[],t.xpOrbs=[],t.buffs=[],t.floatingTexts=[],t.popups=[];return}if(u.type==="runPause"){if(t.net.isHost)return;const P=(p=t.net)!=null&&p.playerId?String(t.net.playerId):(g=t.player)!=null&&g.id?String(t.player.id):"local",C=u.by!=null?String(u.by):"";if(C&&C!==P)return;t._runUpgradeActive=!0,t.player&&(t.player._lvlUpChoosing=!0,t.player._lvlUpInvuln=!0,t.player.vx=0,t.player.vy=0);return}if(u.type==="runResume"){if(t.net.isHost)return;t._runUpgradeActive=!1;try{Qe()}catch{}t.player&&(t.player._lvlUpChoosing=!1,t.player._lvlUpInvuln=!1);return}if(u.type==="runChoices"){if(t.net.isHost)return;const P=(v=t.net)!=null&&v.playerId?String(t.net.playerId):(M=t.player)!=null&&M.id?String(t.player.id):"local",C=u.to!=null?String(u.to):"";if(C&&C!==P)return;const k=Array.isArray(u.choices)?u.choices:[];if(!k.length)return;t._runUpgradeActive=!0,t.player&&(t.player._lvlUpChoosing=!0,t.player._lvlUpInvuln=!0,t.player.vx=0,t.player.vy=0),Pt(k,u.metaText||`Lv ${((_=t.player)==null?void 0:_.level)||0}`,A=>{t.net&&t.net.status==="connected"&&(t.net.sendRunPick((A==null?void 0:A.id)||""),t.player&&(t.player._pendingLevelUps=Math.max(0,(t.player._pendingLevelUps||0)-1))),t._runUpgradeActive=!1,t.player&&(t.player._lvlUpChoosing=!1,t.player._lvlUpInvuln=!1)});return}if(u.type==="runRequest"){if(!((w=t.net)!=null&&w.isHost))return;const P=String(u.from||"");if(!P)return;t._runUpNet||(t._runUpNet={sessions:new Map,requests:new Map}),t._runUpNet.requests||(t._runUpNet.requests=new Map),t._runUpNet.requests.set(P,t.time||0);return}if(u.type==="runPick"){if(!t.net.isHost)return;const P=String(u.from||""),C=String(u.choiceId||"");if(!P||!C)return;ni(t,P,C);return}};function r(u){var b,x;t.time+=u,t._hubNearbyNpc=null;const c=oe(t);if(c&&!t.net.isHost){if(t.mode!=="playing"&&t.net&&t.net.latestSnapshot&&(xe(t),t.player&&t.net.playerId&&(t.player.id=String(t.net.playerId),t.player.color=de(t.player.id),t.player.nickname=((b=t.progression)==null?void 0:b.nickname)||t.player.nickname,typeof((x=t.progression)==null?void 0:x.avatarIndex)=="number"&&(t.player.avatarIndex=t.progression.avatarIndex|0)),t.mode="playing",t.paused=!1),t.mode==="playing"&&!t.paused&&!t._runUpgradeActive&&t.player&&typeof t.player.update=="function"&&t.player.hp>0&&!t.overlayMode&&!t.player._lvlUpChoosing&&t.player.update(u,t),Ye(t,u),t.mode==="playing"){if(ti(t),t.net.latestPlayerState&&ii(t,t.net.latestPlayerState),t.net.latestSnapshot&&ri(t,t.net.latestSnapshot),t.buffs)try{nt(t,0)}catch{}li(t,u),ci(t,u),t.camera&&t.player&&t.camera.update(t.player,u),!t.overlayMode&&t.player&&(t._hubNearbyNpc=it(t.player)),rt(t)}return}if(t.mode!=="playing"){Ye(t,u);return}if(t.paused){Ye(t,u);return}t._laserVisuals&&typeof t._laserVisuals.clear=="function"&&t._laserVisuals.clear(),t._lightningVisuals&&typeof t._lightningVisuals.clear=="function"&&t._lightningVisuals.clear(),t._laserVisual=null,t._lightningVisual=null,nt(t,u),Ko(t,u,c);const y=(t.player.metaHpRegen||0)+(t.player.runHpRegen||0);y>0&&t.player.hp>0&&(t.player.hp=Math.min(t.player.maxHP,t.player.hp+y*u));const d=_e(t.player.x,t.player.y);d!==t.currentZone&&(t.currentZone=d,t.floatingTexts&&t.floatingTexts.push({x:t.player.x,y:t.player.y-80,text:d===0?"Hub":"Zone "+d,time:1.6}),t.popups&&t.popups.push({text:d===0?"Entered Hub":"Entered Zone "+d,time:2.4}),t.spawnSystem&&typeof t.spawnSystem.onZoneChanged=="function"&&t.spawnSystem.onZoneChanged(d)),Jo(t,u,c),t.spawnSystem.update(u);const h=new Map;for(const p of pe(t))p&&h.set(String(p.id||"local"),p.hp);hi(t,u);for(const p of pe(t)){if(!p)continue;const g=h.get(String(p.id||"local"));typeof g=="number"&&p.hp<g-1e-6&&(p._lastCombatAt=t.time)}Qo(t,u),mi(t,u),gi(t,u),c&&t.net&&t.net.isHost&&ei(t),Rn(t),bi(t,u),Ye(t,u),t.camera.update(t.player,u),!t.overlayMode&&t.player&&(t._hubNearbyNpc=it(t.player)),c?(rt(t),pi(t),ui(t,u),fi(t,u)):Ci(t)}function s(u){if(!!(oe(t)&&t.net&&t.net.isHost)&&t.mode==="playing"&&!t.paused){const d=.016666666666666666;t._simAcc=(t._simAcc||0)+u;const h=.25;t._simAcc>h&&(t._simAcc=h);let b=0;const x=10;for(;t._simAcc>=d&&b<x;)r(d),t._simAcc-=d,b++;b===0&&r(Math.min(u,d));return}r(u)}function l(){const{canvas:u,ctx:c,player:y}=t,d=u.width,h=u.height;if(c.clearRect(0,0,d,h),t.camera.applyTransform(c),xi(t,c),jo(c,t),_i(t,c),Mi(t,c),ki(t,c),Si(t,c),Ri(t,c),Pi(t,c),wi(t,c),t.camera.resetTransform(c),vi(c,t),t.mode==="playing"&&Do(c,t),Ai(c,t),t.overlayMode==="resurrection"){Jn(c,t);return}if(t.overlayMode==="upgrade"){mn(c,t);return}if(t.overlayMode==="stats"){mn(c,{...t,mode:"stats"});return}t.mode==="resurrection"?Jn(c,t):t.mode==="upgrade"||t.mode==="stats"?mn(c,t):t.mode==="startMenu"||t.mode}function f(u,c){if(t.overlayMode==="resurrection"){const g=Qn(u,c,t);if(g==="resurrect"){applyResurrection(t.progression);try{ne(t.progression)}catch{}oe(t)&&t.net&&t.net.status==="connected"&&!t.net.isHost&&t.net.sendMeta(Ee(t.progression)),t.overlayMode="upgrade"}else g==="skip"&&(t.overlayMode="upgrade");return}if(t.overlayMode==="upgrade"){const g=Ze(u,c,t);if(g==="upgrade")oe(t)&&t.net&&t.net.status==="connected"&&!t.net.isHost&&t.net.sendMeta(Ee(t.progression));else if(g==="start")if(oe(t)){const v=Ee(t.progression);t.player&&(tn(t,t.player,v),t.net&&t.net.isHost&&(t.player.hp=t.player.maxHP,t.player.x=0,t.player.y=0,t.player.vx=0,t.player.vy=0)),t.net&&t.net.status==="connected"&&(t.net.isHost?t.player&&(t.player._netRespawnRequested=!0):t.net.requestRespawn(v)),t._waitingRespawnAck=!0,t._deathHandled=!0,t.overlayMode=null}else xe(t);else g==="menu"&&(t.overlayMode=null,t.mode="startMenu");return}if(t.overlayMode==="stats"){const g=Ze(u,c,{...t,mode:"stats"});g==="upgrade"?oe(t)&&t.net&&t.net.status==="connected"&&!t.net.isHost&&t.net.sendMeta(Ee(t.progression)):(g==="back"||g==="menu")&&(t.overlayMode=null);return}if(t.mode!=="startMenu"&&t.mode!=="settings"){if(t.mode==="stats"){const g=Ze(u,c,t);g==="back"?t.mode="startMenu":g==="start"&&xe(t);return}if(t.mode==="resurrection"){var y=Qn(u,c,t);(y==="resurrect"||y==="skip")&&(t.mode="upgrade");return}if(t.mode==="upgrade"){var d=Ze(u,c,t);d==="start"?xe(t):d==="menu"&&(t.mode="startMenu");return}if(t.mode==="playing"&&!t.overlayMode&&t._hubNearbyNpc){const g=Zo(u,c,t),v=Yo(g.x,g.y);if(v&&v.id===t._hubNearbyNpc.id){t._hubNpcTap=v.kind;return}}var h=t._runUpgradeButtonRect;if(t.mode==="playing"&&h&&u>=h.x&&u<=h.x+h.w&&c>=h.y&&c<=h.y+h.h){st(t);return}var b=t._pauseButtonRect;if(b&&u>=b.x&&u<=b.x+b.w&&c>=b.y&&c<=b.y+b.h){t.paused=!t.paused;return}if(t.mode==="playing"&&t.paused){var x=t._controlModeClassicRect,p=t._controlModePortraitAutoRect;if(x&&u>=x.x&&u<=x.x+x.w&&c>=x.y&&c<=x.y+x.h){Fn("oneHand");return}if(p&&u>=p.x&&u<=p.x+p.w&&c>=p.y&&c<=p.y+p.h){Fn("twoHand");return}}}}function i(u,c){t.mode}function a(u,c){}function m(){if(typeof document>"u")return!1;const u=document.activeElement;if(!u)return!1;const c=(u.tagName||"").toLowerCase();return c==="input"||c==="textarea"||u.isContentEditable}return typeof window<"u"&&!t._runUpKeyBound&&(t._runUpKeyBound=!0,window.addEventListener("keydown",u=>{if(u.repeat||u.code!=="KeyU"||!t||t.mode!=="playing"||m()||t.overlayMode)return;st(t)&&u.preventDefault()})),{state:t,get player(){return t.player},startOfflineRun(){var u,c;try{(c=(u=t.net)==null?void 0:u.disconnect)==null||c.call(u)}catch{}xe(t),t.mode="playing",t.overlayMode=null,t.paused=!1},update:s,render:l,handlePointerDown:f,handlePointerMove:i,handlePointerUp:a}}function xe(e){var s,l,f,i;try{te(e.progression)}catch{}const n=1;e.flags&&(e.flags.resGuardianKilledThisRun=!1);const o={x:0,y:0},t=new ln(o,n);t.id||(t.id=(s=e.net)!=null&&s.playerId?String(e.net.playerId):"local"),t.nickname=((l=e.progression)==null?void 0:l.nickname)||"Player",t.avatarIndex=((f=e.progression)==null?void 0:f.avatarIndex)||0,t._metaSkillMeta=((i=e.progression)==null?void 0:i.skillMeta)||{};const r=Ge(t,e.progression.limits);e.player=t,e.players=[t],e.meta={xpGainMult:(r==null?void 0:r.xpGainMult)??1,scoreMult:(r==null?void 0:r.scoreMult)??1,pickupBonusRadius:(r==null?void 0:r.pickupBonusRadius)??0},Xe(t),e.camera=new zt(e.canvas),e.currentZone=_e(t.x,t.y),e.enemies=[],e.projectiles=[],e.rockets=[],e.xpOrbs=[],e.buffs=[],e.floatingTexts=[],e.popups=[],e.runScore=0,e.lastRunSummary=null,e._laserVisual=null,e._lightningVisual=null,e._runUpgradeActive=!1,e._runUpgradeChoices=null,e._runUpNet&&e._runUpNet.sessions&&typeof e._runUpNet.sessions.clear=="function"&&e._runUpNet.sessions.clear(),e._laserVisuals=new Map,e._lightningVisuals=new Map,e.spawnSystem=new Eo(e),e.mode="playing",oe(e)&&e.net.isHost&&_n(e)}function oe(e){return!!(e.net&&e.net.status==="connected"&&e.net.roomCode)}function pe(e){return e.players&&e.players.length?e.players:e.player?[e.player]:[]}function Pe(e,n){if(!n)return null;const o=String(n);for(const t of pe(e))if(t&&String(t.id)===o)return t;return null}function de(e){const n=String(e);let o=0;for(let r=0;r<n.length;r++)o=o*31+n.charCodeAt(r)>>>0;return`hsl(${o%360}, 80%, 65%)`}function Ee(e){return e?{nickname:e.nickname||"Player",avatarIndex:e.avatarIndex||0,resurrectedTier:e.resurrectedTier||1,totalScore:e.totalScore||0,upgradePoints:e.upgradePoints||0,limits:e.limits||{},skillMeta:e.skillMeta||{}}:null}function tn(e,n,o){!n||!o||(typeof o.nickname=="string"&&(n.nickname=o.nickname),typeof o.avatarIndex=="number"&&(n.avatarIndex=o.avatarIndex|0),o.limits&&Ge(n,o.limits),o.skillMeta&&typeof o.skillMeta=="object"&&(n._metaSkillMeta=o.skillMeta))}function _n(e){var r,s;const n=Array.isArray(e.net.roomPlayers)?e.net.roomPlayers:[],o=new Set(n.map(l=>String(l.id)));e.player&&e.net.playerId&&(e.player.id=String(e.net.playerId),o.add(String(e.player.id)));for(const l of n){const f=String(l.id);if(Pe(e,f)){const i=Pe(e,f);i&&l.nickname&&(i.nickname=l.nickname),i&&typeof l.avatarIndex=="number"&&(i.avatarIndex=l.avatarIndex|0)}else{const i=new ln({x:0,y:0},1);i.id=f;const a=((r=e._netMetaById)==null?void 0:r.get(f))||null;i._metaSkillMeta=a&&a.skillMeta&&typeof a.skillMeta=="object"?a.skillMeta:((s=e.progression)==null?void 0:s.skillMeta)||{},i.nickname=l.nickname||`P${f}`,i.avatarIndex=l.avatarIndex||0,i.color=de(f);const m=a;m?tn(e,i,m):Ge(i,e.progression.limits),Xe(i),e.players.push(i)}}const t=e.player?String(e.player.id):null;e.players=e.players.filter(l=>{if(!l)return!1;const f=String(l.id);return t&&f===t?!0:o.has(f)})}function qo(e,n,o,t){var h;if(!e||e.hp<=0)return;if(e._lvlUpChoosing){e.vx=0,e.vy=0;return}const r=Math.max(-1,Math.min(1,(n==null?void 0:n.mx)??0)),s=Math.max(-1,Math.min(1,(n==null?void 0:n.my)??0)),l=Math.hypot(r,s),f=l>.001?r/l:0,i=l>.001?s/l:0,a=e.moveSpeed||e.baseMoveSpeed||220;e.vx=f*a,e.vy=i*a,e.x+=e.vx*o,e.y+=e.vy*o;const m=(h=t.spawnSystem)!=null&&h.getWorldBounds?t.spawnSystem.getWorldBounds():null,u=((m==null?void 0:m.minX)??-Vn/2)+e.radius,c=((m==null?void 0:m.maxX)??Vn/2)-e.radius,y=((m==null?void 0:m.minY)??-$n/2)+e.radius,d=((m==null?void 0:m.maxY)??$n/2)-e.radius;e.x<u&&(e.x=u),e.x>c&&(e.x=c),e.y<y&&(e.y=y),e.y>d&&(e.y=d)}function Ko(e,n,o){const t=pe(e);if(o&&e.player&&e.net.playerId&&(e.player.id=String(e.net.playerId)),e.player&&typeof e.player.update=="function"){const r=!!(o&&e.overlayMode),s=!!e._runUpgradeActive||!!e.player._lvlUpChoosing;e.player.hp>0&&!r&&!s&&e.player.update(n,e)}if(!o){e.players=[e.player];return}if(e.net.isHost)for(const r of t){if(!r||String(r.id)===String(e.player.id))continue;const s=e.net.remoteInputs.get(String(r.id))||{};qo(r,s,n,e)}}function Jo(e,n,o){if(e.player){const t=!!(o&&e.overlayMode),r=!!e._runUpgradeActive||!!e.player._lvlUpChoosing;e.player.hp>0&&!t&&!r&&wo(e.player,e,n)}if(o&&e.net.isHost)for(const t of pe(e)){if(!t||String(t.id)===String(e.player.id)||t.hp<=0||t._lvlUpChoosing)continue;const r=e.net.remoteInputs.get(String(t.id))||{},s=r==null?void 0:r.aim,l=s&&typeof s.x=="number"&&typeof s.y=="number"?s:null,f=typeof(r==null?void 0:r.fire)=="boolean"?r.fire:void 0;Ao(t,e,n,{aimDir:l,firing:f})}}function Rn(e){const n=e==null?void 0:e.player,o=n&&n._pendingLevelUps||0;if(e._runUpPending=o,e._runUpReady=!1,e._runUpReadyIn=0,e._runUpBlockReason="",!e||e.mode!=="playing"||!n||n.hp<=0||e.overlayMode||e.paused||e._runUpgradeActive||o<=0)return;const t=3,r=e.time-(Number.isFinite(n._lastCombatAt)?n._lastCombatAt:-1/0);if(r<t){e._runUpReady=!1,e._runUpReadyIn=Math.max(0,t-r),e._runUpBlockReason="combat";return}e._runUpReady=!0}function Qo(e,n){if(!e||!e._repelUntil||e.time>=e._repelUntil)return;const o=e.player;if(!o)return;const t=Array.isArray(e.enemies)?e.enemies:[],r=520,s=r*r,l=980;for(const f of t){if(!f||f.hp<=0||f._remove)continue;const i=f.x-o.x,a=f.y-o.y,m=i*i+a*a;if(m<=1e-6||m>s)continue;const u=Math.sqrt(m),c=i/u,y=a/u,d=Math.max(0,Math.min(1,1-u/r)),h=l*(.25+.75*d);f.x+=c*h*n,f.y+=y*h*n}}function Ht(e){if(!e||e.mode!=="playing")return!1;if(e._runUpgradeActive)return!0;if(e.overlayMode||e.paused)return!1;const n=e.player;if(!n||n.hp<=0)return!1;const o=n._pendingLevelUps||0;if(o<=0)return!1;e._runUpgradeActive=!0,n._lvlUpChoosing=!0,n._lvlUpInvuln=!0,n.vx=0,n.vy=0,e._repelUntil=e.time+1.6;const t=kt(n,3);return e._runUpgradeChoices=t,Pt(t,`Lv ${n.level} Â· Pending ${o}`,r=>{if(St(n,r),n._pendingLevelUps=Math.max(0,(n._pendingLevelUps||0)-1),(n._pendingLevelUps||0)>0){e._runUpgradeActive=!1,setTimeout(()=>{e.mode==="playing"&&Ht(e)},0);return}e._runUpgradeActive=!1,n._lvlUpChoosing=!1,n._lvlUpInvuln=!1}),!0}function st(e){if(!e||e.mode!=="playing")return!1;if(e._runUpgradeActive)return!0;if(!!(oe(e)&&e.net&&!e.net.isHost)){if(Rn(e),e._runUpReady){const t=e.time||0;return t-(e._runUpLastReqAt||0)<.5?!0:(e._runUpLastReqAt=t,e.net&&e.net.status==="connected"&&typeof e.net.sendRunRequest=="function"?(e.net.sendRunRequest(),e.popups&&e.popups.push({text:"Upgrade requested",time:1}),!0):(e.popups&&e.popups.push({text:"Not connected",time:1.2}),!1))}if(e.popups){let t="Can't upgrade yet";e._runUpBlockReason==="combat"?t=`Upgrade: out of combat in ${Math.max(0,e._runUpReadyIn).toFixed(1)}s`:(e._runUpPending||0)<=0&&(t="No upgrades pending"),e.popups.push({text:t,time:1.3})}return!1}if(Rn(e),e._runUpReady)return Ht(e);if(e.popups){let t="Can't upgrade yet";e._runUpBlockReason==="combat"?t=`Upgrade: out of combat in ${Math.max(0,e._runUpReadyIn).toFixed(1)}s`:(e._runUpPending||0)<=0&&(t="No upgrades pending"),e.popups.push({text:t,time:1.3})}return!1}function ei(e){var s;if(!e||e.mode!=="playing"||!oe(e)||!((s=e.net)!=null&&s.isHost))return;e._runUpNet||(e._runUpNet={sessions:new Map,requests:new Map}),e._runUpNet.sessions||(e._runUpNet.sessions=new Map),e._runUpNet.requests||(e._runUpNet.requests=new Map);const n=e._runUpNet.sessions,o=e._runUpNet.requests,t=e.player?String(e.player.id):"",r=e.time||0;for(const l of pe(e)){if(!l)continue;const f=String(l.id),i=l._pendingLevelUps||0;if(f===t){n.delete(f),o.delete(f);continue}if(l.hp<=0||i<=0){l._lvlUpChoosing&&(l._lvlUpChoosing=!1,l._lvlUpInvuln=!1),n.delete(f),o.delete(f);continue}const a=n.get(f);if(!a){if(l._lvlUpChoosing&&(l._lvlUpChoosing=!1,l._lvlUpInvuln=!1),!o.has(f))continue;const m=3;if(r-(Number.isFinite(l._lastCombatAt)?l._lastCombatAt:-1/0)<m)continue;const c=kt(l,3),y=`${l.nickname||"Player"} Â· Lv ${l.level} Â· Pending ${i}`;n.set(f,{choices:c,metaText:y,sentAt:r}),l._lvlUpChoosing=!0,l._lvlUpInvuln=!0,l.vx=0,l.vy=0,e.net&&e.net.status==="connected"&&e.net.sendRunChoices(f,c,y);continue}l._lvlUpChoosing=!0,l._lvlUpInvuln=!0,l.vx=0,l.vy=0,r-(a.sentAt||0)>2.5&&(a.sentAt=r,e.net&&e.net.status==="connected"&&e.net.sendRunChoices(f,a.choices,a.metaText))}}function ni(e,n,o){var u;if(!e||!((u=e.net)!=null&&u.isHost))return;const t=String(n||"");if(!t)return;e._runUpNet||(e._runUpNet={sessions:new Map}),e._runUpNet.sessions||(e._runUpNet.sessions=new Map);const r=e._runUpNet.sessions;e._runUpNet.requests||(e._runUpNet.requests=new Map);const s=e._runUpNet.requests,l=r.get(t);if(!l)return;const f=Pe(e,t);if(!f){r.delete(t);try{s.delete(t)}catch{}return}const i=Array.isArray(l.choices)?l.choices:[],a=i.find(c=>c&&c.id===o)||i[0];if(!a)return;St(f,a),f._pendingLevelUps=Math.max(0,(f._pendingLevelUps||0)-1),r.delete(t);try{s.delete(t)}catch{}f._lvlUpChoosing=!1,f._lvlUpInvuln=!1;const m=e.player?String(e.player.id):"";if(t===m){e._runUpgradeActive=!1;try{Qe()}catch{}}}function ti(e){if(e.mode!=="playing"||e.paused||e._runUpgradeActive)return;const n=e.time;if(n-(e._netLastInputSendAt||0)<.05)return;e._netLastInputSendAt=n;const o=e.player;if(!o||o.hp<=0||e.overlayMode||e.mode!=="playing")return;const t=ft();let r=t.x,s=t.y;if(Math.hypot(r,s)<.01){const i=lt();r=i.x,s=i.y}const l=pt(o,e.camera,e.canvas,e.enemies,vt(o),e.time),f={mx:r,my:s,aim:l?{x:l.x,y:l.y}:null,fire:dt()};e.net.sendInput(f)}function oi(e){const n=r=>Number.isFinite(r)?Math.round(r*10)/10:0,o=pe(e),t=r=>{const s=(r==null?void 0:r.runSkills)||{};return[s.bullets|0,s.bombs|0,s.rockets|0,s.satellites|0,s.energyBarrier|0,s.spirit|0,s.summon|0,s.electricZone|0,s.laser|0,s.lightning|0].join(",")};return{t:e.time,players:o.map(r=>{var s,l;return{id:String(r.id),x:n(r.x),y:n(r.y),vx:n(r.vx),vy:n(r.vy),hp:r.hp,maxHP:r.maxHP,level:r.level,weaponStage:r.weaponStage||1,range:n(Number.isFinite(r.range)?r.range:xt(r)),nickname:r.nickname||"",avatarIndex:r.avatarIndex||0,color:r.color||de(r.id),aim:{x:n(((s=r.lastAimDir)==null?void 0:s.x)||0),y:n(((l=r.lastAimDir)==null?void 0:l.y)||0)},rs:t(r)}})}}function ii(e,n){var i,a,m,u;if(!n||typeof n!="object")return;const o=typeof n.t=="number"?n.t:null;if(o!=null){const c=typeof e._netLastAppliedPStateAt=="number"?e._netLastAppliedPStateAt:-1/0;if(o<=c+1e-6)return;e._netLastAppliedPStateAt=o}const t=(i=e.net)!=null&&i.playerId?String(e.net.playerId):(a=e.player)!=null&&a.id?String(e.player.id):"local";e._netCache||(e._netCache={players:new Map,enemies:new Map,projectilesById:new Map,rocketsById:new Map,projectiles:[],rockets:[],xpOrbs:[]});const r=e._netCache.players,s=e._netCache.playersArr||(e._netCache.playersArr=[]);s.length=0;const l=o??(e.time||0);for(const c of n.players||[]){const y=String(c.id);let d=r.get(y);if(!d){const g=typeof c.level=="number"&&Number.isFinite(c.level)?c.level|0:1;d=new ln({x:c.x||0,y:c.y||0},g),d.id=y,d.color=c.color||de(y),d.nickname=c.nickname||`P${y}`,d.avatarIndex=typeof c.avatarIndex=="number"?c.avatarIndex|0:0,Ge(d,e.progression.limits);const v=((m=e._netMetaById)==null?void 0:m.get(y))||null;d._metaSkillMeta=v&&v.skillMeta&&typeof v.skillMeta=="object"?v.skillMeta:((u=e.progression)==null?void 0:u.skillMeta)||{},Xe(d),d._netTx=d.x,d._netTy=d.y,r.set(y,d)}d._netSeenAt=l;const h=Number.isFinite(c.x)?c.x:d.x,b=Number.isFinite(c.y)?c.y:d.y;d._netTx=h,d._netTy=b,d._netVx=Number.isFinite(c.vx)?c.vx:d._netVx||0,d._netVy=Number.isFinite(c.vy)?c.vy:d._netVy||0;const x=h-d.x,p=b-d.y;if(x*x+p*p>500*500&&(d.x=h,d.y=b),d.hp=c.hp,d.maxHP=c.maxHP,d.level=c.level,typeof c.weaponStage=="number"&&(d.weaponStage=c.weaponStage),typeof c.range=="number"&&Number.isFinite(c.range)&&(d.range=c.range),d.nickname=c.nickname||d.nickname,d.avatarIndex=typeof c.avatarIndex=="number"?c.avatarIndex|0:d.avatarIndex,d.color=c.color||d.color,c.aim&&(d.lastAimDir.x=c.aim.x||0,d.lastAimDir.y=c.aim.y||0),typeof c.rs=="string"&&c.rs.length){const g=c.rs.split(",");if(g.length>=9){const v=g[0]|0,M=g[1]|0,_=g[2]|0,w=g[3]|0,P=g[4]|0,C=g[5]|0,k=g[6]|0,A=g[7]|0,S=g[8]|0;d.runSkills=d.runSkills||{},d.runSkills.bullets=v,d.runSkills.bombs=M,d.runSkills.rockets=_,d.runSkills.satellites=w,d.runSkills.energyBarrier=P,d.runSkills.spirit=C,d.runSkills.electricZone=k,d.runSkills.laser=A,d.runSkills.lightning=S}}s.push(d)}for(const[c,y]of r)(!y||y._netSeenAt!=l)&&r.delete(c);e.players=s;const f=s.find(c=>String(c.id)===t)||s[0]||e.player;if(e.player=f,e.net&&!e.net.isHost&&f){const c=f.level|0;if(typeof e._netLocalLevel!="number")e._netLocalLevel=c;else{const y=e._netLocalLevel|0;if(c<y&&(f._pendingLevelUps=0),c>y){const d=c-y;f._pendingLevelUps=(f._pendingLevelUps||0)+d,e.floatingTexts&&e.floatingTexts.push({x:f.x,y:f.y-30,text:"LEVEL UP!",time:1.2}),e.popups&&e.popups.push({text:d>1?`Level Up! +${d} (Lv ${c})`:`Level Up! Lv ${c}`,time:2})}e._netLocalLevel=c}}}function si(e){const n=p=>Number.isFinite(p)?Math.round(p*10)/10:0,o=typeof navigator<"u"&&navigator.userAgent?navigator.userAgent:"",t=/Android|iPhone|iPad|iPod|Mobile/i.test(o),r=pe(e),s=r.filter(p=>p&&p.hp>0),l=s.length?s:r,f=t?15e3:16500,i=f*f,a=(p,g)=>{let v=1/0;for(const M of l){if(!M)continue;const _=p-M.x,w=g-M.y,P=_*_+w*w;if(P<v&&(v=P),v<=1200*1200)break}return v},m=t?260:420,u=t?220:420,c=t?90:160,y=t?260:420,d=[];for(const p of e.enemies||[]){if(!p||p.dead)continue;const g=a(p.x,p.y);g>i||d.push({e:p,d2:g})}d.length>m&&(d.sort((p,g)=>p.d2-g.d2),d.length=m);const h=[];for(const p of e.projectiles||[]){if(!p)continue;const g=a(p.x,p.y);g>i||h.push({b:p,d2:g})}h.length>u&&(h.sort((p,g)=>p.d2-g.d2),h.length=u);const b=[];for(const p of e.rockets||[]){if(!p)continue;const g=a(p.x,p.y);g>i||b.push({r:p,d2:g})}b.length>c&&(b.sort((p,g)=>p.d2-g.d2),b.length=c);const x=[];for(const p of e.xpOrbs||[]){if(!p)continue;const g=a(p.x,p.y);g>i||x.push({o:p,d2:g})}return x.length>y&&(x.sort((p,g)=>p.d2-g.d2),x.length=y),{t:e.time,runScore:e.runScore,zone:e.currentZone,flags:{resGuardianKilledThisRun:!!(e.flags&&e.flags.resGuardianKilledThisRun)},players:r.map(p=>{var g,v;return{id:String(p.id),x:n(p.x),y:n(p.y),hp:p.hp,maxHP:p.maxHP,level:p.level,xp:p.xp,nextXp:p.nextLevelXp,nickname:p.nickname||"",avatarIndex:p.avatarIndex||0,color:p.color||de(p.id),lastAim:{x:n(((g=p.lastAimDir)==null?void 0:g.x)||0),y:n(((v=p.lastAimDir)==null?void 0:v.y)||0)}}}),enemies:d.map(({e:p})=>({id:String(p.id||p._id||`${p.x.toFixed(1)}:${p.y.toFixed(1)}`),x:n(p.x),y:n(p.y),hp:p.hp,maxHp:p.maxHp??p.maxHP??0,radius:p.radius||20,kind:p.kind||p.type||"enemy",boss:!!p._isBoss||!!p.isBoss||!!p.boss,elite:!!p.isElite||!!p.elite})),projectiles:h.map(({b:p})=>({id:p.id!=null?p.id:void 0,ownerId:p.ownerId!=null?String(p.ownerId):"",x:n(p.x),y:n(p.y),vx:n(p.vx),vy:n(p.vy),radius:p.radius||4,life:n((p.range||0)-(p.travel||0))})),rockets:b.map(({r:p})=>({id:p.id!=null?p.id:void 0,ownerId:p.ownerId!=null?String(p.ownerId):"",type:p.type||"rocket",x:n(p.x),y:n(p.y),vx:n(p.vx),vy:n(p.vy),radius:p.radius||6,splashRadius:p.splashRadius||0,life:n((p.range||0)-(p.travel||0))})),xpOrbs:x.map(({o:p})=>{const g=p.kind||(p.coins?"coin":"xp");return{x:n(p.x),y:n(p.y),radius:p.radius||8,kind:g,xp:g==="xp"?p.xp||10:void 0,coins:g==="coin"?p.coins||1:void 0}}),buffs:(Array.isArray(e.buffs)?e.buffs:[]).slice(0,16).map(p=>({type:p.type||"",timeLeft:n(p.timeLeft||0),multiplier:n(p.multiplier||0),amount:n(p.amount||0)}))}}function ri(e,n){var _,w,P,C;if(!n||typeof n!="object")return;const o=typeof n.t=="number"?n.t:null;if(o!=null){const k=typeof e._netLastAppliedSnapshotAt=="number"?e._netLastAppliedSnapshotAt:-1/0;if(o<=k+1e-6)return;e._netLastAppliedSnapshotAt=o}const t=(_=e.net)!=null&&_.playerId?String(e.net.playerId):(w=e.player)!=null&&w.id?String(e.player.id):"local";e._netCache||(e._netCache={players:new Map,enemies:new Map,projectilesById:new Map,rocketsById:new Map,projectiles:[],rockets:[],xpOrbs:[]});const r=e._netCache.players,s=e._netCache.enemies;e._netCache.projectilesById||(e._netCache.projectilesById=new Map),e._netCache.rocketsById||(e._netCache.rocketsById=new Map),Array.isArray(e._netCache.projectiles)||(e._netCache.projectiles=[]),Array.isArray(e._netCache.rockets)||(e._netCache.rockets=[]),Array.isArray(e._netCache.xpOrbs)||(e._netCache.xpOrbs=[]);const l=e._netCache.playersArr||(e._netCache.playersArr=[]);l.length=0;const f=o??(e.time||0);for(const k of n.players||[]){const A=String(k.id);let S=r.get(A);if(!S){const U=typeof k.level=="number"&&Number.isFinite(k.level)?k.level|0:1;S=new ln({x:k.x||0,y:k.y||0},U),S.id=A,S.color=k.color||de(A),S.nickname=k.nickname||`P${A}`,typeof k.avatarIndex=="number"&&(S.avatarIndex=k.avatarIndex|0),Ge(S,e.progression.limits);const E=((P=e._netMetaById)==null?void 0:P.get(A))||null;S._metaSkillMeta=E&&E.skillMeta&&typeof E.skillMeta=="object"?E.skillMeta:((C=e.progression)==null?void 0:C.skillMeta)||{},S._netTx=S.x,S._netTy=S.y,r.set(A,S)}S._netSeenAt=f;const B=Number.isFinite(k.x)?k.x:S.x,T=Number.isFinite(k.y)?k.y:S.y;S._netTx=B,S._netTy=T;const L=B-S.x,H=T-S.y;L*L+H*H>600*600&&(S.x=B,S.y=T),S.hp=k.hp,S.maxHP=k.maxHP,S.level=k.level,S.xp=k.xp,S.nextLevelXp=k.nextXp,S.nickname=k.nickname||S.nickname,typeof k.avatarIndex=="number"&&(S.avatarIndex=k.avatarIndex|0),S.color=k.color||S.color,k.lastAim&&(S.lastAimDir.x=k.lastAim.x||0,S.lastAimDir.y=k.lastAim.y||0),l.push(S)}for(const[k,A]of r)(!A||A._netSeenAt!==f)&&r.delete(k);e.players=l;const i=l.find(k=>String(k.id)===t)||l[0]||e.player;e.player=i;const a=e._netCache.enemiesArr||(e._netCache.enemiesArr=[]);a.length=0;for(const k of n.enemies||[]){const A=String(k.id);let S=s.get(A);S||(S=ai(k),S.x=Number.isFinite(k.x)?k.x:0,S.y=Number.isFinite(k.y)?k.y:0,S._netTx=S.x,S._netTy=S.y,s.set(A,S)),S._netSeenAt=f;const B=Number.isFinite(k.x)?k.x:S.x,T=Number.isFinite(k.y)?k.y:S.y;S._netTx=B,S._netTy=T;const L=B-S.x,H=T-S.y;L*L+H*H>900*900&&(S.x=B,S.y=T),S.hp=k.hp,S.maxHp=k.maxHp,S.radius=k.radius||S.radius||20,S.kind=k.kind||S.kind||"enemy",S._isBoss=!!k.boss,S.isElite=!!k.elite,a.push(S)}for(const[k,A]of s)(!A||A._netSeenAt!==f)&&s.delete(k);e.enemies=a;const m=e.time||0,u=.3,c=Array.isArray(n.projectiles)?n.projectiles:[],y=e._netCache.projectilesById;for(const k of c){if(!k)continue;const A=k.id!=null?String(k.id):null;if(!A)continue;let S=y.get(A);const B=Number.isFinite(k.x)?k.x:0,T=Number.isFinite(k.y)?k.y:0;S||(S={id:A,type:"bullet",x:B,y:T,vx:Number.isFinite(k.vx)?k.vx:0,vy:Number.isFinite(k.vy)?k.vy:0,radius:k.radius||4,_netTx:B,_netTy:T,_netLife:Number.isFinite(k.life)?k.life:null,_netLastSeenLocalTime:m},y.set(A,S)),S._netLastSeenLocalTime=m,S._netTx=B,S._netTy=T,Number.isFinite(k.vx)&&(S.vx=k.vx),Number.isFinite(k.vy)&&(S.vy=k.vy),S.radius=k.radius||S.radius||4,Number.isFinite(k.life)&&(S._netLife=k.life);const L=S._netTx-S.x,H=S._netTy-S.y;L*L+H*H>1e3*1e3&&(S.x=S._netTx,S.y=S._netTy)}for(const[k,A]of y){const S=A&&typeof A._netLastSeenLocalTime=="number"?A._netLastSeenLocalTime:-1/0;m-S>u&&y.delete(k)}const d=e._netCache.projectiles;d.length=0;for(const k of y.values())d.push(k);e.projectiles=d;const h=Array.isArray(n.rockets)?n.rockets:[],b=e._netCache.rocketsById;for(const k of h){if(!k)continue;const A=k.id!=null?String(k.id):null;if(!A)continue;let S=b.get(A);const B=Number.isFinite(k.x)?k.x:0,T=Number.isFinite(k.y)?k.y:0;S||(S={id:A,x:B,y:T,vx:Number.isFinite(k.vx)?k.vx:0,vy:Number.isFinite(k.vy)?k.vy:0,radius:k.radius||6,splashRadius:k.splashRadius||0,_netTx:B,_netTy:T,_netLife:Number.isFinite(k.life)?k.life:null,_netLastSeenLocalTime:m},b.set(A,S)),S._netLastSeenLocalTime=m,S._netTx=B,S._netTy=T,Number.isFinite(k.vx)&&(S.vx=k.vx),Number.isFinite(k.vy)&&(S.vy=k.vy),S.radius=k.radius||S.radius||6,S.type=k.type||S.type||"rocket",S.splashRadius=k.splashRadius||S.splashRadius||0,Number.isFinite(k.life)&&(S._netLife=k.life);const L=S._netTx-S.x,H=S._netTy-S.y;L*L+H*H>1e3*1e3&&(S.x=S._netTx,S.y=S._netTy)}for(const[k,A]of b){const S=A&&typeof A._netLastSeenLocalTime=="number"?A._netLastSeenLocalTime:-1/0;m-S>u&&b.delete(k)}const x=e._netCache.rockets;x.length=0;for(const k of b.values())x.push(k);e.rockets=x;const p=Array.isArray(n.xpOrbs)?n.xpOrbs:[],g=e._netCache.xpOrbs;g.length=p.length;for(let k=0;k<p.length;k++){const A=p[k]||{};let S=g[k];S||(S=g[k]={x:0,y:0,xp:10,coins:0,kind:"xp",radius:8,age:0}),S.x=A.x||0,S.y=A.y||0,S.kind=A.kind||(A.coins?"coin":"xp"),S.xp=S.kind==="xp"?A.xp||10:0,S.coins=S.kind==="coin"?A.coins||1:0,S.radius=A.radius||8,S.age=0}e.xpOrbs=g,e.runScore=n.runScore||0,e.currentZone=n.zone??e.currentZone,n.flags&&e.flags&&(e.flags.resGuardianKilledThisRun=!!n.flags.resGuardianKilledThisRun);const v=Array.isArray(n.buffs)?n.buffs:[];e._netCache||(e._netCache={players:new Map,enemies:new Map});const M=e._netCache.buffsArr||(e._netCache.buffsArr=[]);M.length=v.length;for(let k=0;k<v.length;k++){const A=v[k]||{};let S=M[k];S||(S=M[k]={type:"",timeLeft:0,multiplier:0,amount:0}),S.type=(A.type||"").toString(),S.timeLeft=typeof A.timeLeft=="number"?A.timeLeft:0,S.multiplier=typeof A.multiplier=="number"?A.multiplier:0,S.amount=typeof A.amount=="number"?A.amount:0}if(e.buffs=M,e.net&&!e.net.isHost){const k=e._netBuffCounts||Object.create(null),A=Object.create(null);for(const B of M){const T=B&&B.type?String(B.type):"";T&&(A[T]=(A[T]||0)+1)}const S=B=>B==="damage"?"Damage":B==="attackSpeed"?"Attack Speed":B==="moveSpeed"?"Move Speed":B==="regen"?"Regen":B==="shield"?"Shield":B==="xpGain"?"XP Gain":B==="ghost"?"Ghost":B;for(const B of Object.keys(A)){const T=A[B]|0,L=(k[B]||0)|0;if(T>L){const H=S(B);e.floatingTexts&&e.player&&e.floatingTexts.push({x:e.player.x,y:e.player.y-24,text:"BUFF: "+H,time:1}),e.popups&&e.popups.push({text:"Temporary buff: "+H,time:2})}}e._netBuffCounts=A}}function ai(e){return{id:e.id,x:e.x,y:e.y,hp:e.hp,maxHp:e.maxHp,radius:e.radius||20,kind:e.kind||"enemy",_isBoss:!!e.boss,isElite:!!e.elite,update:null,render(o,t){t.save(),t.beginPath();let r="#ff5f6f";if(o.isElite&&(r="#ffdd57"),o._isBoss&&(r="#ff4b7a"),o.kind==="zoneBoss"&&(r="#9b5bff"),o.kind==="roamingBoss"&&(r="#ff3cbe"),o.kind==="resurrectionGuardian"&&(r="#ffdd44"),o.kind==="zone6SuperBoss"&&(r="#1be7ff"),t.fillStyle=r,t.globalAlpha=1,t.arc(o.x,o.y,o.radius,0,Math.PI*2),t.fill(),o._isBoss||o.isElite){const s=o.maxHp>0?o.hp/o.maxHp:1;t.strokeStyle="#ffffff",t.globalAlpha=.9,t.lineWidth=o._isBoss?3:2,t.beginPath(),t.arc(o.x,o.y,o.radius+(o._isBoss?7:5),-Math.PI/2,-Math.PI/2+Math.PI*2*Math.max(0,Math.min(1,s))),t.stroke()}t.restore()}}}function li(e,n){const o=1-Math.exp(-n*12),t=1-Math.exp(-n*5),r=e.players||[],s=e.player?String(e.player.id):null,l=.05;for(const i of r){if(!i||i._netTx==null||i._netTy==null)continue;const a=s&&String(i.id)===s,m=i._netTx+(a?0:(i._netVx||0)*l),u=i._netTy+(a?0:(i._netVy||0)*l),c=m-i.x,y=u-i.y;if(c*c+y*y<1e-4)continue;const d=a?t:o;i.x+=c*d,i.y+=y*d}const f=e.enemies||[];for(const i of f){if(!i||i._netTx==null||i._netTy==null)continue;const a=i._netTx-i.x,m=i._netTy-i.y;a*a+m*m<1e-4||(i.x+=a*o,i.y+=m*o)}}function ci(e,n){if(!oe(e)||!e.net||e.net.isHost)return;const o=1-Math.exp(-n*10),t=e.projectiles||[];for(const s of t){if(!s)continue;const l=Number.isFinite(s.vx)?s.vx:0,f=Number.isFinite(s.vy)?s.vy:0;s.x+=l*n,s.y+=f*n,s._netTx!=null&&s._netTy!=null&&(s.x+=(s._netTx-s.x)*o,s.y+=(s._netTy-s.y)*o),typeof s._netLife=="number"&&(s._netLife-=n)}const r=e.rockets||[];for(const s of r){if(!s)continue;const l=Number.isFinite(s.vx)?s.vx:0,f=Number.isFinite(s.vy)?s.vy:0;s.x+=l*n,s.y+=f*n,s._netTx!=null&&s._netTy!=null&&(s.x+=(s._netTx-s.x)*o,s.y+=(s._netTy-s.y)*o),typeof s._netLife=="number"&&(s._netLife-=n)}}function ui(e,n=0){if(!e.net||!e.net.isHost)return;const o=e.time,t=1/40;e._netPStateAcc=(e._netPStateAcc||0)+(Number.isFinite(n)?n:0),e._netPStateAcc>.25&&(e._netPStateAcc=.25),!(e._netPStateAcc<t)&&(e._netPStateAcc-=t,e._netLastPlayerStateSentAt=o,typeof e.net.sendPlayerState=="function"&&e.net.sendPlayerState(oi(e)))}function fi(e,n=0){if(!e.net||!e.net.isHost)return;const o=e.time,t=1/40;e._netSnapAcc=(e._netSnapAcc||0)+(Number.isFinite(n)?n:0),e._netSnapAcc>.25&&(e._netSnapAcc=.25),!(e._netSnapAcc<t)&&(e._netSnapAcc-=t,e._netLastSnapshotSendAt=o,e.net.sendSnapshot(si(e)))}function rt(e){var s;if(!oe(e)||e.mode!=="playing"||!e.player)return;if(e._waitingRespawnAck)if(e.player.hp>0)e._waitingRespawnAck=!1,e._deathHandled=!1;else return;if(e.player.hp>0){e._deathHandled=!1;return}if(e._deathHandled||e.overlayMode)return;const n=Math.floor(e.runScore||0),o=Math.floor(e._lastDeathAwardScore||0),t=Math.max(0,n-o);e._lastDeathAwardScore=n,e.progression.totalScore=Math.max(0,(e.progression.totalScore||0)+t);const r=Math.max(0,Math.floor(t/400));e.progression.upgradePoints=Math.max(0,(e.progression.upgradePoints||0)+r),e.lastRunSummary={runScore:t,gainedPoints:r,startLevel:e.player.level||Bn(e.progression)};try{ne(e.progression)}catch{}e.overlayMode=(s=e.flags)!=null&&s.resGuardianKilledThisRun?"resurrection":"upgrade",e._deathHandled=!0}function di(e,n,o){n&&(o&&tn(e,n,o),n.x=0,n.y=0,n.vx=0,n.vy=0,n.hp=n.maxHP)}function pi(e){var n,o;if(oe(e)&&(n=e.net)!=null&&n.isHost)for(const t of pe(e)){if(!t||!t._netRespawnRequested)continue;t._netRespawnRequested=!1;const r=String(t.id),s=((o=e._netMetaById)==null?void 0:o.get(r))||null;di(e,t,s)}}function hi(e,n){var r;const{enemies:o}=e,t=6;for(let s=o.length-1;s>=0;s--){const l=o[s];if(l.update&&l.update(l,n,e),l&&!l._ignoreHub){const i=(l.radius||20)+t,a=l.x||0,m=l.y||0;if(Ve(a,m,i)){const u=He+i,c=Math.min(Hn+i,u),y=Math.max(u-c,0),d=a<0?-1:1,h=m<0?-1:1,b=Math.abs(a),x=Math.abs(m);let p=a,g=m;if(b>y&&x>y){const v=d*y,M=h*y;let _=a-v,w=m-M;const P=Math.hypot(_,w)||1e-4;_/=P,w/=P,p=v+_*c,g=M+w*c}else{const v=u-b,M=u-x;v<=M?p=d*u:g=h*u}l.x=p,l.y=g}}if(l.hp<=0||l._remove){if(!l._noScore){const f=l.scoreValue||10,i=((r=e.meta)==null?void 0:r.scoreMult)||1;e.runScore+=f*i}l.onDeath&&l.onDeath(l,e),e.spawnSystem&&typeof e.spawnSystem.onEnemyRemoved=="function"&&e.spawnSystem.onEnemyRemoved(l,e),o.splice(s,1)}}}function mi(e,n){const{projectiles:o,rockets:t,enemies:r}=e;for(let s=o.length-1;s>=0;s--){const l=o[s];if(l&&l.id==null&&(l.id=e._nextProjectileId=(e._nextProjectileId||0)+1),l.x+=l.vx*n,l.y+=l.vy*n,l.travel+=l.speed*n,l.travel>=l.range){o.splice(s,1);continue}let f=!1;for(let i=r.length-1;i>=0;i--){const a=r[i],m=a.x-l.x,u=a.y-l.y,c=(a.radius||20)+(l.radius||4);if(m*m+u*u<=c*c){const y=Pe(e,l.ownerId)||e.player,d=Ne(y,l.damage);a.hp-=d,we(y,d),y._lastCombatAt=e.time,y.lastPlayerTarget=a,y.lastPlayerTargetAt=e.time,a._lastHitAt=e.time,a._lastHitBy=y.id||"local",a.aggroed=!0,f=!0;break}}f&&o.splice(s,1)}for(let s=t.length-1;s>=0;s--){const l=t[s];l&&l.id==null&&(l.id=e._nextRocketId=(e._nextRocketId||0)+1),l.x+=l.vx*n,l.y+=l.vy*n,l.travel+=l.speed*n;let f=!1;if(l.travel>=l.range)f=!0;else for(let i=r.length-1;i>=0;i--){const a=r[i],m=a.x-l.x,u=a.y-l.y,c=(a.radius||24)+(l.radius||6);if(m*m+u*u<=c*c){f=!0;break}}f&&(yi(l,e),t.splice(s,1))}}function yi(e,n){const{enemies:o,floatingTexts:t}=n,r=e.splashRadius*e.splashRadius,s=Pe(n,e.ownerId)||n.player;for(const l of o){const f=l.x-e.x,i=l.y-e.y;if(f*f+i*i<=r){const a=Ne(s,e.damage);l.hp-=a,we(s,a),s._lastCombatAt=n.time,s.lastPlayerTarget=l,s.lastPlayerTargetAt=n.time,l._lastHitAt=n.time,l._lastHitBy=s.id||"local",l.aggroed=!0}}t.push({x:e.x,y:e.y,text:"BOOM",time:.6})}function gi(e,n){var r,s;const{xpOrbs:o}=e,t=e.players&&e.players.length?e.players:e.player?[e.player]:[];for(let l=o.length-1;l>=0;l--){const f=o[l];if(f.age=(f.age||0)+n,f.ttl!=null&&f.age>=f.ttl){o.splice(l,1);continue}f.baseY==null&&(f.baseY=f.y),f.y=f.baseY+Math.sin(f.age*5)*2;const i=f.spawnDelay!=null&&f.age<f.spawnDelay;for(const a of t){if(i)continue;const m=a.x-f.x,u=a.y-f.y,c=(a.radius||18)+(f.radius||8),y=(((r=e.meta)==null?void 0:r.pickupBonusRadius)||0)+(a.runPickupBonusRadius||0),d=c+y;if(m*m+u*u<=d*d){if((f.kind||(f.coins?"coin":"xp"))==="coin"){const M=f.coins||1;if(a===e.player&&e.progression){try{te(e.progression)}catch{}e.progression.coins=Math.max(0,(e.progression.coins|0)+(M|0));try{ne(e.progression)}catch{}e.floatingTexts&&e.floatingTexts.push({x:f.x,y:f.y,text:`+${M}ðŸª™`,time:.8})}o.splice(l,1);break}const b=f.xp||10,x=(((s=e.meta)==null?void 0:s.xpGainMult)||1)*(a.runXpGainMult||1),p=1+(e.tempXpGainBoost||0),g=x*p,v=Math.min(3,1+(g-1)*.55);typeof a.gainXP=="function"&&a.gainXP(b*v,e),o.splice(l,1);break}}}}function bi(e,n){const{floatingTexts:o}=e;for(let t=o.length-1;t>=0;t--){const r=o[t];r.y-=20*n,r.time-=n,r.time<=0&&o.splice(t,1)}}function vi(e,n){var o=n.floatingTexts;e.save(),e.font="18px sans-serif",e.textAlign="center";for(var t=0;t<o.length;t++){var r=o[t],s=r.time/1.2;s<0&&(s=0),s>1&&(s=1),e.fillStyle="rgba(255,255,255,"+s.toFixed(2)+")",e.fillText(r.text,r.x,r.y)}e.restore()}function Ye(e,n){const o=e.popups;for(let t=o.length-1;t>=0;t--)o[t].time-=n,o[t].time<=0&&o.splice(t,1)}function xi(e,n){var p,g;const o={0:"#0d3a1f",1:"#0b101b",2:"#0e1821",3:"#0d1426",4:"#19121e",5:"#0d0b1f",6:"#0a0714"};n.save(),e._bgPatterns||(e._bgPatterns={});function t(v,M,_){n.beginPath(),n.arc(0,0,M,0,Math.PI*2),n.arc(0,0,v,0,Math.PI*2,!0),n.fillStyle=_,n.fill("evenodd")}function r(v,M,_,w,P){const C=Math.max(0,Math.min(P,Math.min(_,w)*.5));n.beginPath(),n.moveTo(v+C,M),n.lineTo(v+_-C,M),n.quadraticCurveTo(v+_,M,v+_,M+C),n.lineTo(v+_,M+w-C),n.quadraticCurveTo(v+_,M+w,v+_-C,M+w),n.lineTo(v+C,M+w),n.quadraticCurveTo(v,M+w,v,M+w-C),n.lineTo(v,M+C),n.quadraticCurveTo(v,M,v+C,M),n.closePath()}function s(){const v=He*2;r(-He,-He,v,v,Hn)}const l=e.camera,f=e.player,i=(l==null?void 0:l.zoom)||1,a=(((p=e.canvas)==null?void 0:p.width)||800)/(2*i),m=(((g=e.canvas)==null?void 0:g.height)||600)/(2*i);f.x-a,f.x+a,f.y-m,f.y+m,e.net&&e.net.roomCode&&e.net.isHost,n.fillStyle=o[6],n.fillRect(-Z,-Z,Z*2,Z*2);const u=z[0],c=z[1],y=z[2],d=z[3],h=z[4],b=z[5];function x(v,M,_,w){return _}t(h,b,x(h,b,o[5])),t(d,h,x(d,h,o[4])),t(y,d,x(y,d,o[3])),t(c,y,x(c,y,o[2])),t(u,c,x(u,c,o[1])),s(),n.fillStyle=o[0],n.fill(),n.lineWidth=1.5,n.strokeStyle="rgba(255,255,255,0.14)",n.beginPath();for(const v of[c,y,d,h,b])n.moveTo(v,0),n.arc(0,0,v,0,Math.PI*2);n.stroke(),n.strokeStyle="rgba(255,255,255,0.16)",n.lineWidth=1.6,s(),n.stroke(),n.strokeStyle="rgba(255,255,255,0.10)",n.lineWidth=1.5,n.strokeRect(-Z,-Z,Z*2,Z*2),n.restore()}function Mi(e,n){const o=!!(e.net&&e.net.roomCode&&!e.net.isHost),t=typeof window<"u"&&window.innerWidth||0,r=typeof window<"u"&&window.innerHeight||0;if(o&&r>t&&Math.max(t,r)<900){for(const l of e.enemies){if(!l)continue;if(typeof l.render=="function"){l.render(l,n);continue}n.save(),n.beginPath();let f="#ff5f6f";l.isElite&&(f="#ffdd57"),l.kind==="zoneBoss"&&(f="#9b5bff"),l.kind==="roamingBoss"&&(f="#ff3cbe"),l.kind==="resurrectionGuardian"&&(f="#ffdd44"),l.kind==="zone6SuperBoss"&&(f="#1be7ff"),n.fillStyle=f,n.arc(l.x,l.y,l.radius||20,0,Math.PI*2),n.fill(),n.restore()}return}for(const l of e.enemies)l&&l.render&&l.render(l,n)}function ki(e,n){const o=e&&Array.isArray(e.summons)?e.summons:[];if(o.length)for(const t of o){if(!t||!t.isSummon||t.hp<=0)continue;n.save();const r=t.radius||18;n.beginPath(),n.fillStyle="rgba(90,200,255,0.60)",n.arc(t.x,t.y,r,0,Math.PI*2),n.fill(),n.beginPath(),n.fillStyle="rgba(255,255,255,0.55)",n.arc(t.x-r*.18,t.y-r*.18,Math.max(3,r*.35),0,Math.PI*2),n.fill(),n.beginPath(),n.strokeStyle="rgba(255,255,255,0.45)",n.lineWidth=2,n.arc(t.x,t.y,r,0,Math.PI*2),n.stroke();const s=t.maxHp||1,l=t.hp||0,f=Math.max(0,Math.min(1,l/s)),i=r*2.2,a=4,m=t.x-i/2,u=t.y-r-10;n.fillStyle="rgba(0,0,0,0.45)",n.fillRect(m,u,i,a),n.fillStyle="rgba(80,255,160,0.85)",n.fillRect(m,u,i*f,a),n.restore()}}function Si(e,n){const{projectiles:o,rockets:t,_laserVisual:r,_lightningVisual:s,_laserVisuals:l,_lightningVisuals:f}=e,i=!!(e.net&&e.net.roomCode&&!e.net.isHost),a=typeof window<"u"&&window.innerWidth||0,m=typeof window<"u"&&window.innerHeight||0,u=i&&m>a&&Math.max(a,m)<900;if(n.save(),u){const h=o.length>220?Math.ceil(o.length/220):1;n.fillStyle="#f4e9a3";for(let p=0;p<o.length;p+=h){const g=o[p];g&&n.fillRect(g.x-1,g.y-1,2,2)}const b=80,x=t.length>b?Math.ceil(t.length/b):1;n.fillStyle="#cfcfcf";for(let p=0;p<t.length;p+=x){const g=t[p];!g||g.type!=="bomb"||n.fillRect(g.x-2,g.y-2,4,4)}n.fillStyle="#ff7a3c";for(let p=0;p<t.length;p+=x){const g=t[p];!g||g.type==="bomb"||n.fillRect(g.x-2,g.y-2,4,4)}}else{n.fillStyle="#f4e9a3";for(const d of o)n.beginPath(),n.arc(d.x,d.y,d.radius||4,0,Math.PI*2),n.fill();n.fillStyle="#cfcfcf";for(const d of t)!d||d.type!=="bomb"||(n.beginPath(),n.arc(d.x,d.y,d.radius||7,0,Math.PI*2),n.fill());n.fillStyle="#ff7a3c";for(const d of t)!d||d.type==="bomb"||(n.beginPath(),n.arc(d.x,d.y,d.radius||6,0,Math.PI*2),n.fill())}const c=[];l&&typeof l.forEach=="function"?l.forEach(d=>{d&&c.push(d)}):r&&c.push(r);for(const d of c)n.beginPath(),n.strokeStyle="rgba(173,246,255,0.9)",n.lineWidth=6,n.moveTo(d.x1,d.y1),n.lineTo(d.x2,d.y2),n.stroke();const y=[];f&&typeof f.forEach=="function"?f.forEach(d=>{d&&d.length>1&&y.push(d)}):s&&s.length>1&&y.push(s);for(const d of y){n.beginPath(),n.strokeStyle="rgba(220,245,255,0.95)",n.lineWidth=3;for(let h=0;h<d.length-1;h++){const b=d[h],x=d[h+1];n.moveTo(b.x,b.y),n.lineTo(x.x,x.y)}n.stroke()}n.restore()}function _i(e,n){n.save();for(const o of e.xpOrbs){const t=o.kind||(o.coins?"coin":"xp");n.fillStyle=t==="coin"?"#ffd34a":"#5af2ff",n.beginPath(),n.arc(o.x,o.y,o.radius||8,0,Math.PI*2),n.fill(),t==="coin"&&(n.fillStyle="rgba(255,255,255,0.70)",n.beginPath(),n.arc(o.x-2,o.y-2,Math.max(1,(o.radius||8)*.25),0,Math.PI*2),n.fill())}n.restore()}function Ri(e,n){var r;const o=e.players&&e.players.length?e.players:e.player?[e.player]:[];n.save();const t=e.time||0;for(const s of o){if(!s||s.hp<=0)continue;const l=s.runSkills||{},f=s.metaRangeMult||1,i=s.runRangeMult||1,a=f*i,m=(l.electricZone||0)|0;if(m>0){const d=(140+(m-1)*9)*a;n.beginPath(),n.fillStyle="rgba(80,220,255,0.07)",n.arc(s.x,s.y,d,0,Math.PI*2),n.fill(),n.beginPath(),n.strokeStyle="rgba(180,245,255,0.20)",n.lineWidth=2,n.arc(s.x,s.y,d,0,Math.PI*2),n.stroke()}const u=(l.energyBarrier||0)|0;if(u>0){const d=(92+(u-1)*5)*(.9+(a-1)*.5),h=.35+.15*Math.sin(t*7.5);n.beginPath(),n.beginPath(),n.fillStyle="rgba(80,220,255,0.05)",n.arc(s.x,s.y,d,0,Math.PI*2),n.fill(),n.beginPath(),n.strokeStyle=`rgba(255,255,255,${.28+h*.18})`,n.lineWidth=3,n.arc(s.x,s.y,d,0,Math.PI*2),n.stroke()}const c=(l.satellites||0)|0;if(c>0){const d=s._satelliteVis;let h,b,x,p;if(d&&typeof d=="object")h=Math.max(1,d.count|0),b=Number.isFinite(d.orbitR)?d.orbitR:60,x=Number.isFinite(d.orbR)?d.orbR:10,p=Number.isFinite(d.speed)?d.speed:1.2;else{const M=s._metaSkillMeta&&typeof s._metaSkillMeta=="object"?s._metaSkillMeta:null,_=M?M["skill:satellites"]|0:0,w=_>=2?1:0,P=_>=3?1:0;h=1,c>=5&&(h+=1+w),c>=9&&(h+=1+P),h=Math.min(5,Math.max(1,h)),b=(56+(c-1)*3+Math.max(0,h-1)*2)*(.85+(a-1)*.35),x=9+Math.floor((c-1)/3),p=1.1+(c-1)*.06}const g=t*p,v=Math.PI*2/Math.max(1,h);for(let M=0;M<h;M++){const _=g+M*v,w=s.x+Math.cos(_)*b,P=s.y+Math.sin(_)*b;n.beginPath(),n.fillStyle="rgba(255,255,255,0.65)",n.arc(w,P,x,0,Math.PI*2),n.fill(),n.beginPath(),n.fillStyle="rgba(80,220,255,0.40)",n.arc(w-3,P-3,Math.max(2,x*.3),0,Math.PI*2),n.fill()}}const y=(l.spirit||0)|0;if(y>0){const d=s._metaSkillMeta&&typeof s._metaSkillMeta=="object"?s._metaSkillMeta:null,h=d?d["skill:spirit"]|0:0,b=h>=2?1:0,x=h>=3?1:0;let p=1;y>=5&&(p+=1+b),y>=9&&(p+=1+x),p=Math.min(5,Math.max(1,p));const g=s.y-(s.radius||18)-18,v=12,M=(p-1)/2;for(let _=0;_<p;_++){const w=s.x+(_-M)*v,P=.55+.25*Math.sin(t*9+_*1.3),C=g+Math.sin(t*7+_*1.7)*1.3,k=6.5+P*1.5;n.beginPath(),n.fillStyle=`rgba(255,130,80,${.18+P*.1})`,n.arc(w,C,k*1.8,0,Math.PI*2),n.fill(),n.beginPath(),n.fillStyle=`rgba(255,175,80,${.6+P*.18})`,n.arc(w,C,k,0,Math.PI*2),n.fill(),n.beginPath(),n.fillStyle="rgba(255,255,255,0.75)",n.arc(w-1.2,C-1.8,Math.max(1.2,k*.33),0,Math.PI*2),n.fill()}}}n.restore();for(const s of o)s&&(typeof s.render=="function"?s.render(n):(n.save(),n.beginPath(),n.fillStyle=s.id===((r=e.player)==null?void 0:r.id)?"#8fe3ff":"#7fb0ff",n.arc(s.x,s.y,s.radius||18,0,Math.PI*2),n.fill(),n.restore()));n.save(),n.font="12px sans-serif",n.textAlign="center",n.fillStyle="rgba(255,255,255,0.9)";for(const s of o){if(!s)continue;const l=(s.nickname||"").toString().slice(0,16);l&&n.fillText(l,s.x,s.y-(s.radius||18)-22)}n.restore()}function Pi(e,n){var t;n.save();for(const r of e.enemies){const s=r.hp,l=r.maxHp??r.maxHP??0;if(l<=0||s<=0)continue;const f=Math.max(0,Math.min(1,s/l)),i=(r.radius||20)*2.2,a=4,m=r.x-i/2,u=r.y-(r.radius||20)-10;n.fillStyle="#000000",n.fillRect(m,u,i,a),n.fillStyle="#4cff4c",n.fillRect(m,u,i*f,a)}const o=e.players&&e.players.length?e.players:e.player?[e.player]:[];for(const r of o){if(!r)continue;const s=r.hp,l=r.maxHP??r.maxHp??0;if(l>0&&s>0){const f=Math.max(0,Math.min(1,s/l)),i=(r.radius||18)*2.4,a=5,m=r.x-i/2,u=r.y-(r.radius||18)-14;n.fillStyle="#000000",n.fillRect(m,u,i,a),n.fillStyle=r.id===((t=e.player)==null?void 0:t.id)?"#00ff7a":"#4aa3ff",n.fillRect(m,u,i*f,a)}}n.restore()}function wi(e,n){const{buffs:o}=e;if(!o||!o.length)return;n.save(),n.globalAlpha=.35;const t=e.players&&e.players.length?e.players:e.player?[e.player]:[];for(const r of o){switch(r.type){case"damage":n.strokeStyle="#ff4b7a";break;case"attackSpeed":n.strokeStyle="#ffdd57";break;case"moveSpeed":n.strokeStyle="#57ff9b";break;case"regen":n.strokeStyle="#57c8ff";break;case"shield":n.strokeStyle="#b857ff";break;case"ghost":n.strokeStyle="#ffffff";break;default:n.strokeStyle="#ffffff";break}for(const s of t)n.beginPath(),n.lineWidth=3,n.arc(s.x,s.y,(s.radius||18)+10,0,Math.PI*2),n.stroke()}n.restore()}function Ai(e,n){const{canvas:o,popups:t}=n,r=o.width;e.save(),e.font="18px sans-serif",e.textAlign="center";let s=40;for(const l of t){const f=Math.max(0,Math.min(1,l.time/2));e.fillStyle="rgba(255,255,255,"+f+")",e.fillText(l.text,r/2,s),s+=22}e.restore()}function Ci(e){const{player:n,progression:o}=e;if(n.hp>0||e.mode!=="playing")return;const t=Math.floor(e.runScore),r=Math.max(1,Math.floor(t/400));o.totalScore+=t,o.upgradePoints+=r,e.flags&&e.flags.resGuardianKilledThisRun?e.mode="resurrection":e.mode="upgrade",e.lastRunSummary={runScore:t,totalScore:o.totalScore,gainedPoints:r},ne(o)}let Pn=!1,D=null,R={},wn=-1,Se=null,Ii=0,on=null,Je="",sn=0;function N(e){return document.getElementById(e)}function Ti(e,n,o){return Math.max(n,Math.min(o,e))}function Bt(e){return(e||"").toString().trim().toUpperCase().replace(/[^A-Z0-9]/g,"").slice(0,8)}function gn(e){var r,s,l;const n=e==="profile",o=e==="records",t=e==="shop";(r=R.tabProfileBtn)==null||r.classList.toggle("sel",n),(s=R.tabRecordsBtn)==null||s.classList.toggle("sel",o),(l=R.tabShopBtn)==null||l.classList.toggle("sel",t),R.profileTabProfile&&(R.profileTabProfile.style.display=n?"block":"none"),R.profileTabRecords&&(R.profileTabRecords.style.display=o?"block":"none"),R.profileTabShop&&(R.profileTabShop.style.display=t?"block":"none")}function Hi(e){if(!R.avatarButtons)return;R.avatarButtons.innerHTML="";const n=an(e.progression);wn=n;for(let o=0;o<ce.length;o++){const t=ce[o],r=Zt(e.progression,o),s=document.createElement("button");s.type="button",s.className="btn avbtn"+(r?"":" locked")+((e.progression.avatarIndex|0)===o?" sel":""),s.textContent=t,s.title=r?`Avatar ${o+1}`:`Locked (${n}/${ce.length})`,s.addEventListener("click",()=>{if(!r)return;e.progression.avatarIndex=o;try{ne(e.progression)}catch{}R.avatarButtons.querySelectorAll(".avbtn").forEach(f=>f.classList.remove("sel")),s.classList.add("sel"),R.profileAvatarPreview&&(R.profileAvatarPreview.textContent=ce[o]||"ðŸ™‚")}),R.avatarButtons.appendChild(s)}}function bn(e,n){var i,a,m,u,c;const o=e.net;if(!o)return;try{if(e.progression){e.progression.nickname=(((i=R.nameInput)==null?void 0:i.value)||e.progression.nickname||"Player").toString().trim().slice(0,16)||"Player",e.progression.roomCode=Bt(((a=R.roomCodeInput)==null?void 0:a.value)||e.progression.roomCode||""),R.roomCodeInput&&(R.roomCodeInput.value=e.progression.roomCode),R.nameInput&&(R.nameInput.value=e.progression.nickname);try{ne(e.progression)}catch{}}}catch{}const t=(((m=e.progression)==null?void 0:m.nickname)||"Player").toString().slice(0,16),r=((u=e.progression)==null?void 0:u.avatarIndex)||0,s=((c=e.progression)==null?void 0:c.roomCode)||"";Se={seq:++Ii,action:n,nickname:t,avatarIndex:r,roomCode:s};const f=y=>{if(y)try{y.action==="host"?o.host(y.roomCode,y.nickname,y.avatarIndex):y.action==="join"?o.join(y.roomCode,y.nickname,y.avatarIndex):o.fastJoin(y.nickname,y.avatarIndex)}catch{}};if(o.connect(_t()),o.ws&&o.ws.readyState===1){const y=Se;Se=null,f(y)}else{const y=o.ws;y&&y!==on&&(on=y,y.addEventListener("open",()=>{const d=Se;Se=null,f(d)},{once:!0}))}}function Bi(e){var n,o,t,r,s,l,f,i,a,m,u,c,y,d;Pn||(Pn=!0,D=e,R.lobby=N("lobby"),R.lobbyPingMini=N("lobbyPingMini"),R.btnMenuFullscreen=N("btnMenuFullscreen"),R.btnMenuHelp=N("btnMenuHelp"),R.tabProfileBtn=N("tabProfileBtn"),R.tabRecordsBtn=N("tabRecordsBtn"),R.tabShopBtn=N("tabShopBtn"),R.profileTabProfile=N("profileTabProfile"),R.profileTabRecords=N("profileTabRecords"),R.profileTabShop=N("profileTabShop"),R.profCoins=N("profCoins"),R.shopCoins=N("shopCoins"),R.shopMsg=N("shopMsg"),R.shopGridActive=N("shopGridActive"),R.shopGridPassive=N("shopGridPassive"),R.shopGridNew=N("shopGridNew"),R.btnShopReroll=N("btnShopReroll"),R.shopRerollCost=N("shopRerollCost"),R.profileAvatarPreview=N("profileAvatarPreview"),R.nameInput=N("nameInput"),R.profLevel=N("profLevel"),R.profXp=N("profXp"),R.profAv=N("profAv"),R.profXpBar=N("profXpBar"),R.profNext=N("profNext"),R.profAvatarHint=N("profAvatarHint"),R.avatarButtons=N("avatarButtons"),R.btnJoinLeft=N("btnJoinLeft"),R.recTotalScore=N("recTotalScore"),R.recRTier=N("recRTier"),R.recUp=N("recUp"),R.roomCodeInput=N("roomCodeInput"),R.btnRoomApply=N("btnRoomApply"),R.btnCopyInvite=N("btnCopyInvite"),R.roomCodeStatus=N("roomCodeStatus"),R.joinError=N("joinError"),R.lobbyPlayers=N("lobbyPlayers"),R.lobbyInfo=N("lobbyInfo"),R.btnHost=N("btnHost"),R.btnJoinRun=N("btnJoinRun"),R.btnFastJoin=N("btnFastJoin"),R.btnStart=N("btnStart"),R.btnDisconnect=N("btnDisconnect"),R.netStatus=N("netStatus"),R.netRoom=N("netRoom"),R.netPlayers=N("netPlayers"),(n=R.tabProfileBtn)==null||n.addEventListener("click",()=>gn("profile")),(o=R.tabRecordsBtn)==null||o.addEventListener("click",()=>gn("records")),(t=R.tabShopBtn)==null||t.addEventListener("click",()=>gn("shop")),(r=R.btnMenuFullscreen)==null||r.addEventListener("click",async()=>{var h,b,x;try{document.fullscreenElement?await((x=document.exitFullscreen)==null?void 0:x.call(document)):await((b=(h=document.documentElement).requestFullscreen)==null?void 0:b.call(h))}catch{}}),(s=R.btnMenuHelp)==null||s.addEventListener("click",()=>{alert(`Pixel PVE

Host / Join / Fast-Join: Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ðº ÐºÐ¾Ð¾Ð¿-ÑÐµÑ€Ð²ÐµÑ€Ñƒ (ws relay 8080).
Start: Ð¾Ñ„Ñ„Ð»Ð°Ð¹Ð½ Ð·Ð°Ð¿ÑƒÑÐº (fallback).

Mobile: 1-Hand (Ð²ÐµÑ€Ñ‚Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾), PC: 2-Hand.`)}),R.nameInput&&R.nameInput.addEventListener("input",()=>{var b;const h=(R.nameInput.value||"").toString().trim().slice(0,16);(b=D==null?void 0:D.state)!=null&&b.progression&&(D.state.progression.nickname=h||"Player")}),(l=R.btnJoinLeft)==null||l.addEventListener("click",()=>{const h=D==null?void 0:D.state;if(!(!h||!h.progression)){h.progression.nickname=(h.progression.nickname||"Player").toString().trim().slice(0,16)||"Player",h.progression.avatarIndex=h.progression.avatarIndex|0;try{ne(h.progression)}catch{}try{h.net&&h.net.status==="connected"&&h.net.setProfile(h.progression.nickname,h.progression.avatarIndex)}catch{}}}),(f=R.btnRoomApply)==null||f.addEventListener("click",()=>{var b;const h=D==null?void 0:D.state;if(!(!h||!h.progression)){h.progression.roomCode=Bt(((b=R.roomCodeInput)==null?void 0:b.value)||""),R.roomCodeInput&&(R.roomCodeInput.value=h.progression.roomCode);try{ne(h.progression)}catch{}}}),(i=R.btnCopyInvite)==null||i.addEventListener("click",async()=>{var p,g,v;const h=D==null?void 0:D.state,b=(((p=h==null?void 0:h.net)==null?void 0:p.roomCode)||((g=h==null?void 0:h.progression)==null?void 0:g.roomCode)||"").toString(),x=`${location.origin}/?code=${encodeURIComponent(b)}`;try{(v=navigator.clipboard)!=null&&v.writeText?await navigator.clipboard.writeText(x):prompt("Invite link",x)}catch{prompt("Invite link",x)}}),(a=R.btnShopReroll)==null||a.addEventListener("click",()=>{const h=D==null?void 0:D.state,b=h==null?void 0:h.progression;if(!b)return;te(b);const x=10+(sn|0)*5;if((b.coins|0)<x){rn("Not enough coins for reroll.");return}b.coins=Math.max(0,(b.coins|0)-x),sn++,At(b);try{ne(b)}catch{}rn("Rerolled."),Je=""}),(m=R.btnHost)==null||m.addEventListener("click",()=>{const h=D==null?void 0:D.state;h&&bn(h,"host")}),(u=R.btnJoinRun)==null||u.addEventListener("click",()=>{const h=D==null?void 0:D.state;h&&bn(h,"join")}),(c=R.btnFastJoin)==null||c.addEventListener("click",()=>{const h=D==null?void 0:D.state;h&&bn(h,"fastJoin")}),(y=R.btnStart)==null||y.addEventListener("click",()=>{var b,x;const h=D==null?void 0:D.state;if(h){Se=null,on=null;try{(x=(b=h.net)==null?void 0:b.disconnect)==null||x.call(b)}catch{}typeof(D==null?void 0:D.startOfflineRun)=="function"?D.startOfflineRun():h.mode="playing"}}),(d=R.btnDisconnect)==null||d.addEventListener("click",()=>{var b,x;const h=D==null?void 0:D.state;Se=null,on=null;try{(x=(b=h==null?void 0:h.net)==null?void 0:b.disconnect)==null||x.call(b)}catch{}}))}function rn(e){R.shopMsg&&(R.shopMsg.textContent=e?String(e):"")}function Li(e){const n=e==null?void 0:e.progression;if(!n)return;te(n),We(n),R.profCoins&&(R.profCoins.textContent=String(n.coins|0)),R.shopCoins&&(R.shopCoins.textContent=String(n.coins|0));const o=10+(sn|0)*5;R.shopRerollCost&&(R.shopRerollCost.textContent=String(o));const t=n.shopOffers||{active:[],passive:[],newSkills:[]},r=JSON.stringify(t)+"|"+(n.coins|0)+"|"+o;if(r===Je)return;Je=r;const s=(l,f,i)=>{if(l){l.innerHTML="";for(let a=0;a<3;a++){const m=i[a],u=m?It(m):null,c=m?ue(n,m):0,y=m?nn(m,c):0,d=Tt(),h=document.createElement("div");h.className="shopCard";const b=document.createElement("div");b.className="top";const x=document.createElement("div");x.className="name",x.textContent=u?u.name:"â€”";const p=document.createElement("div");p.className="lvl",p.textContent=`Lv ${c}/${d}`,b.appendChild(x),b.appendChild(p);const g=document.createElement("div");g.className="buyRow";const v=document.createElement("div");v.className="price",v.textContent=`Cost: ${y} ðŸª™`,g.appendChild(v);const M=document.createElement("button");M.type="button",M.className="btn";const _=c<=0?"Buy (unlock)":"Upgrade";M.textContent=_;const w=!u||c>=d||(n.coins|0)<y;M.disabled=w,c>=d?(M.textContent="MAX",v.textContent="MAX"):(n.coins|0)<y&&(M.title="Not enough coins"),M.addEventListener("click",()=>{if(!u)return;te(n);const P=ue(n,m),C=nn(m,P);if((n.coins|0)<C){rn("Not enough coins.");return}if(!(P>=d)){n.coins=Math.max(0,(n.coins|0)-C),wt(n,m,P+1),Ct(n,f,a),sn=0;try{ne(n)}catch{}rn("Purchased!"),Je=""}}),h.appendChild(b),h.appendChild(g),h.appendChild(M),l.appendChild(h)}}};s(R.shopGridActive,"active",t.active||[]),s(R.shopGridPassive,"passive",t.passive||[]),s(R.shopGridNew,"new",t.newSkills||[])}function Ni(e){if(!Pn||!e)return;const n=e.mode==="startMenu";if(R.lobby&&(R.lobby.style.display=n?"flex":"none"),!n||!e.progression)return;e.progression.nickname||(e.progression.nickname="Player"),typeof e.progression.avatarIndex!="number"&&(e.progression.avatarIndex=0),typeof e.progression.roomCode!="string"&&(e.progression.roomCode=""),R.nameInput&&document.activeElement!==R.nameInput&&(R.nameInput.value=e.progression.nickname),R.roomCodeInput&&document.activeElement!==R.roomCodeInput&&(R.roomCodeInput.value=e.progression.roomCode),R.profileAvatarPreview&&(R.profileAvatarPreview.textContent=ce[e.progression.avatarIndex]||"ðŸ™‚");const o=e.progression.totalScore||0,t=Math.max(1,(Bn(e.progression)||0)+1),r=(o%1e3+1e3)%1e3,s=1e3-r,l=r/1e3;R.profLevel&&(R.profLevel.textContent=String(t)),R.profXp&&(R.profXp.textContent=String(r)),R.profNext&&(R.profNext.textContent=`Next: ${s}`),R.profXpBar&&(R.profXpBar.style.width=`${Math.round(Ti(l,0,1)*100)}%`);const f=an(e.progression);R.profAv&&(R.profAv.textContent=`${f}/${ce.length}`),R.profAvatarHint&&(R.profAvatarHint.textContent=`(unlocked ${f}/${ce.length})`),R.recTotalScore&&(R.recTotalScore.textContent=String(o)),R.recRTier&&(R.recRTier.textContent=String(e.progression.resurrectedTier||1)),R.recUp&&(R.recUp.textContent=String(e.progression.upgradePoints||0)),R.avatarButtons&&(wn<0||wn!==f)&&Hi(e),Li(e);const i=e.net,m=(Array.isArray(i==null?void 0:i.roomPlayers)?i.roomPlayers:[]).length||((i==null?void 0:i.status)==="connected"?1:0),u=(i==null?void 0:i.maxPlayers)||7,c=((i==null?void 0:i.roomCode)||e.progression.roomCode||"").toString();if(R.netStatus&&(R.netStatus.textContent=(i==null?void 0:i.status)||"offline"),R.netRoom&&(R.netRoom.textContent=c||"â€”"),R.netPlayers&&(R.netPlayers.textContent=`${m}/${u}`),R.lobbyPlayers&&(R.lobbyPlayers.textContent=`Players on map: ${m}/${u}`),R.roomCodeStatus&&(R.roomCodeStatus.textContent=c?`Room ${c}`:"Public lobby"),R.joinError&&(R.joinError.textContent=i!=null&&i.error?String(i.error):""),R.lobbyInfo&&(!i||i.status==="offline"?R.lobbyInfo.textContent="Offline. Press Start or connect via Host/Join/Fast-Join.":i.status==="connecting"?R.lobbyInfo.textContent="Connecting...":i.status==="connected"?R.lobbyInfo.textContent=i.isHost?"Connected (Host).":"Connected (Join).":R.lobbyInfo.textContent=i.status),R.lobbyPingMini){const y=i==null?void 0:i.pingMs;typeof y=="number"&&y>0?(R.lobbyPingMini.style.display="inline-flex",R.lobbyPingMini.textContent=`Ping: ${y}`):R.lobbyPingMini.style.display="none"}}let An=!1,F={},De="",Fe=0;function W(e,n={},o=[]){const t=document.createElement(e);for(const[r,s]of Object.entries(n))r==="style"&&s&&typeof s=="object"?Object.assign(t.style,s):r==="className"?t.className=s:r==="text"?t.textContent=s:r.startsWith("on")&&typeof s=="function"?t.addEventListener(r.slice(2),s):t.setAttribute(r,String(s));for(const r of o)t.appendChild(r);return t}function Ui(){const e=document.activeElement;if(!e)return!1;const n=(e.tagName||"").toLowerCase();return n==="input"||n==="textarea"}function Le(e){F.shopMsg&&(F.shopMsg.textContent=e||"",e&&(clearTimeout(Le._t),Le._t=setTimeout(()=>{F.shopMsg&&(F.shopMsg.textContent="")},1200)))}function Cn(e){e!=null&&e.progression&&(te(e.progression),We(e.progression),e.overlayMode="shop",F.shopOverlay&&(F.shopOverlay.style.display="flex"),De="",cn(e))}function In(e){F.shopOverlay&&(F.shopOverlay.style.display="none"),e&&e.overlayMode==="shop"&&(e.overlayMode=null)}function Tn(e){e.overlayMode="stats",In(e)}function Lt(e){const n=e==null?void 0:e.net,o=e==null?void 0:e.progression;if(!(!n||n.status!=="connected"||n.isHost)&&o)try{n.sendMeta({nickname:o.nickname||"Player",avatarIndex:o.avatarIndex||0,resurrectedTier:o.resurrectedTier||1,totalScore:o.totalScore||0,upgradePoints:o.upgradePoints||0,limits:o.limits||{},skillMeta:o.skillMeta||{}})}catch{}}function cn(e){const n=e==null?void 0:e.progression;if(!n)return;te(n),We(n),F.shopCoins&&(F.shopCoins.textContent=String(n.coins|0));const o=10+(Fe|0)*5;F.shopRerollCost&&(F.shopRerollCost.textContent=String(o));const t=n.shopOffers||{active:[],passive:[],newSkills:[]},r=JSON.stringify(t)+"|"+(n.coins|0)+"|"+o;if(r===De)return;De=r;const s=(l,f,i)=>{if(l){l.innerHTML="";for(let a=0;a<3;a++){const m=i[a],u=m?It(m):null,c=m?ue(n,m):0,y=m?nn(m,c):0,d=Tt(),h=W("div",{className:"shopCard"}),b=W("div",{className:"top"}),x=W("div",{className:"name",text:u?u.name:"â€”"}),p=W("div",{className:"lvl",text:`Lv ${c}/${d}`});b.appendChild(x),b.appendChild(p);const g=W("div",{className:"buyRow"}),v=W("div",{className:"price",text:`Cost: ${y} ðŸª™`});g.appendChild(v);const M=W("button",{type:"button",className:"btn",text:c<=0?"Buy (unlock)":"Upgrade"}),_=!u||c>=d||(n.coins|0)<y;M.disabled=_,c>=d?(M.textContent="MAX",v.textContent="MAX"):(n.coins|0)<y&&(M.title="Not enough coins"),M.addEventListener("click",()=>{if(!u)return;te(n);const w=ue(n,m),P=nn(m,w);if((n.coins|0)<P){Le("Not enough coins.");return}if(!(w>=d)){n.coins=Math.max(0,(n.coins|0)-P),wt(n,m,w+1),Ct(n,f,a),Fe=0;try{ne(n)}catch{}Lt(e),Le("Purchased!"),De="",cn(e)}}),h.appendChild(b),h.appendChild(g),h.appendChild(M),l.appendChild(h)}}};s(F.shopGridActive,"active",t.active||[]),s(F.shopGridPassive,"passive",t.passive||[]),s(F.shopGridNew,"new",t.newSkills||[])}function Ei(e){if(An)return;An=!0,F.interactWrap=W("div",{id:"hubInteractWrap",style:{position:"fixed",left:"50%",bottom:"22px",transform:"translateX(-50%)",zIndex:9999,display:"none",pointerEvents:"none"}}),F.interactBtn=W("button",{id:"btnHubInteract",className:"btn",type:"button",text:"Interact",style:{pointerEvents:"auto",padding:"12px 18px",fontSize:"14px",borderRadius:"12px",boxShadow:"0 6px 18px rgba(0,0,0,0.35)"}}),F.interactWrap.appendChild(F.interactBtn),document.body.appendChild(F.interactWrap),F.shopOverlay=W("div",{id:"hubShopOverlay",style:{position:"fixed",inset:"0",zIndex:1e4,display:"none",alignItems:"center",justifyContent:"center",background:"rgba(0,0,0,0.72)",padding:"14px"}});const n=W("div",{className:"panel",style:{width:"min(560px, 96vw)",maxHeight:"92vh",overflow:"auto"}}),o=W("div",{className:"header"});o.appendChild(W("h2",{text:"Hub Shop"}));const t=W("button",{className:"btn",type:"button",text:"Close",style:{padding:"7px 10px",fontSize:"12px"}});t.addEventListener("click",()=>In(e.state)),o.appendChild(t);const r=W("div",{className:"row",style:{justifyContent:"space-between",alignItems:"center",marginTop:"8px"}}),s=W("div",{style:{fontSize:"13px"}});s.innerHTML='<b>Coins:</b> <span id="hubShopCoins">0</span> <span class="muted">ðŸª™</span>',r.appendChild(s);const l=W("button",{className:"btn",id:"btnHubShopReroll",type:"button",style:{padding:"8px 10px",whiteSpace:"nowrap"}});l.innerHTML='Reroll (<span id="hubShopRerollCost">10</span>)',r.appendChild(l);const f=W("div",{className:"muted",id:"hubShopMsg",style:{minHeight:"16px",marginTop:"6px"}});n.appendChild(o),n.appendChild(r),n.appendChild(f),n.appendChild(W("div",{className:"shopLabel",text:"ÐŸÑ€Ð¾ÐºÐ°Ñ‡ÐºÐ°"})),n.appendChild(W("div",{className:"shopGrid",id:"hubShopGridActive"})),n.appendChild(W("div",{className:"shopLabel",text:"ÐŸÐ°ÑÑÐ¸Ð²ÐºÐ¸",style:{marginTop:"10px"}})),n.appendChild(W("div",{className:"shopGrid",id:"hubShopGridPassive"})),n.appendChild(W("div",{className:"shopLabel",text:"ÐÐ¾Ð²Ñ‹Ðµ ÑÐºÐ¸Ð»Ð»Ñ‹",style:{marginTop:"10px"}})),n.appendChild(W("div",{className:"shopGrid",id:"hubShopGridNew"})),n.appendChild(W("div",{className:"muted",style:{marginTop:"10px",fontSize:"12px",opacity:"0.85"},text:"ÐŸÐ¾Ð´Ð¾Ð¹Ð´Ð¸ Ðº NPC Ð² Ñ…Ð°Ð±Ðµ Ð¸ Ð½Ð°Ð¶Ð¼Ð¸ E/Interact. ÐŸÐ¾ÐºÑƒÐ¿ÐºÐ° Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚/Ð¿Ñ€Ð¾ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÑ‚ ÑÐºÐ¸Ð»Ð»Ñ‹ Ð½Ð°Ð²ÑÐµÐ³Ð´Ð°."})),F.shopOverlay.appendChild(n),document.body.appendChild(F.shopOverlay),F.shopCoins=n.querySelector("#hubShopCoins"),F.shopRerollCost=n.querySelector("#hubShopRerollCost"),F.shopMsg=n.querySelector("#hubShopMsg"),F.shopGridActive=n.querySelector("#hubShopGridActive"),F.shopGridPassive=n.querySelector("#hubShopGridPassive"),F.shopGridNew=n.querySelector("#hubShopGridNew"),l.addEventListener("click",()=>{const i=e.state,a=i==null?void 0:i.progression;if(!a)return;te(a);const m=10+(Fe|0)*5;if((a.coins|0)<m){Le("Not enough coins.");return}a.coins=Math.max(0,(a.coins|0)-m),At(a),Fe=(Fe|0)+1;try{ne(a)}catch{}Lt(i),Le("Rerolled!"),De="",cn(i)}),F.interactBtn.addEventListener("click",()=>{const i=e.state,a=i==null?void 0:i._hubNearbyNpc;a&&(a.kind==="shop"?Cn(i):a.kind==="tier"&&Tn(i))}),window.addEventListener("keydown",i=>{if(i.repeat)return;const a=e.state;if(!(!a||a.mode!=="playing")&&!Ui()){if(i.code==="Escape"){a.overlayMode==="shop"?(In(a),i.preventDefault()):a.overlayMode==="stats"&&(a.overlayMode=null,i.preventDefault());return}if(i.code==="KeyE"){if(a.overlayMode)return;const m=a._hubNearbyNpc;if(!m)return;m.kind==="shop"?Cn(a):m.kind==="tier"&&Tn(a),i.preventDefault()}}})}function Di(e){if(!An||!e)return;if(e._hubNpcTap&&!e.overlayMode){const t=String(e._hubNpcTap);e._hubNpcTap=null,t==="shop"?Cn(e):t==="tier"&&Tn(e)}const n=e.mode==="playing"&&!e.overlayMode&&!!e._hubNearbyNpc;if(F.interactWrap&&(F.interactWrap.style.display=n?"block":"none"),n&&F.interactBtn){const t=e._hubNearbyNpc;F.interactBtn.textContent=t.kind==="tier"?"Tier / Upgrades (E)":"Shop (E)"}const o=e.overlayMode==="shop";F.shopOverlay&&(F.shopOverlay.style.display=o?"flex":"none"),o&&cn(e)}const q=document.getElementById("gameCanvas"),Fi=q.getContext("2d");q.style.touchAction="none";function Nt(){q.width=window.innerWidth,q.height=window.innerHeight}window.addEventListener("resize",Nt);Nt();const Oi=eo(),X=zo(q,Fi,Oi);Bi(X);Ei(X);let at=performance.now();function Ut(e){const n=Math.min(.05,(e-at)/1e3);at=e,Ni(X.state),X.update(n),Di(X.state),X.render(),requestAnimationFrame(Ut)}requestAnimationFrame(Ut);q.addEventListener("mousemove",e=>{var r;const n=q.getBoundingClientRect(),o=e.clientX-n.left,t=e.clientY-n.top;((r=X.state)==null?void 0:r.mode)==="playing"&&Vt(o,t),X.handlePointerMove&&X.handlePointerMove(o,t)});q.addEventListener("mousedown",e=>{var r;const n=q.getBoundingClientRect(),o=e.clientX-n.left,t=e.clientY-n.top;e.button===0&&((r=X.state)==null?void 0:r.mode)==="playing"&&$t(0,o,t),X.handlePointerDown&&X.handlePointerDown(o,t)});window.addEventListener("mouseup",e=>{var n;if(e.button===0&&(((n=X.state)==null?void 0:n.mode)==="playing"&&Gt(0),X.handlePointerUp)){const o=q.getBoundingClientRect(),t=e.clientX-o.left,r=e.clientY-o.top;X.handlePointerUp(t,r)}});q.addEventListener("touchstart",e=>{var t;const n=q.getBoundingClientRect(),o=q.width;for(let r=0;r<e.changedTouches.length;r++){const s=e.changedTouches[r],l=s.clientX-n.left,f=s.clientY-n.top;((t=X.state)==null?void 0:t.mode)==="playing"&&Xt(s.identifier,l,f,o),X.handlePointerDown&&X.handlePointerDown(l,f)}e.preventDefault()},{passive:!1});q.addEventListener("touchmove",e=>{var o;const n=q.getBoundingClientRect();for(let t=0;t<e.changedTouches.length;t++){const r=e.changedTouches[t],s=r.clientX-n.left,l=r.clientY-n.top;((o=X.state)==null?void 0:o.mode)==="playing"&&Wt(r.identifier,s,l),X.handlePointerMove&&X.handlePointerMove(s,l)}e.preventDefault()},{passive:!1});q.addEventListener("touchend",e=>{var o;const n=q.getBoundingClientRect();for(let t=0;t<e.changedTouches.length;t++){const r=e.changedTouches[t];if(((o=X.state)==null?void 0:o.mode)==="playing"&&ut(r.identifier),X.handlePointerUp){const s=r.clientX-n.left,l=r.clientY-n.top;X.handlePointerUp(s,l)}}e.preventDefault()},{passive:!1});q.addEventListener("touchcancel",e=>{var o;const n=q.getBoundingClientRect();for(let t=0;t<e.changedTouches.length;t++){const r=e.changedTouches[t];if(((o=X.state)==null?void 0:o.mode)==="playing"&&ut(r.identifier),X.handlePointerUp){const s=r.clientX-n.left,l=r.clientY-n.top;X.handlePointerUp(s,l)}}e.preventDefault()},{passive:!1});
